/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

ARENA *__thiscall ServerEntryPoint(ARENA *arenaa, const char *Source);
void __thiscall ShutdownArena(ARENA *arenaa);
void __thiscall DropBrick(ARENA *arenaa, int XTiles, int YTiles, __int16 Team);
void __thiscall PlayerEntering(struct ARENA *arena, struct PLAYER *player);
__int16 __thiscall ArenaRemovePlayer(ARENA *arenaa, PLAYER *buf);
bool __thiscall ProcessArena(struct ARENA *arenaa);
int __cdecl PtFuncCompare(const void *, const void *); // idb
PLAYER **__thiscall ArenaScoreReset(ARENA *arenaa, int buf);
int __thiscall CreateSoccerBall(ARENA *arenaa, int PowerBallId);
int __thiscall FlagPositionUpdateSomething(ARENA *arenaa, int a2);
void __thiscall CarryFlagsSomething(ARENA *arenaa, int a2, int a3);
int __thiscall ResetFlagGame(_DWORD *this);
int __thiscall GetNextFrequencyToJoin(ARENA *arenaa);
int __thiscall ArenaSendPacket(ARENA *arenaa, void *buf, int buf_sz, BOOL bSendReliable);
int __thiscall SomethingWithPrizes(ARENA *arenaa, int a2, int a3, int a4, int a5, int a6);
void __thiscall sub_404980(ARENA *arena, int a2, __int64 a3);
PLAYER *__thiscall AddPlayerToArenaSomething(ARENA *arena, PLAYER *a2, signed int a3, signed int a4);
signed int __thiscall LoadArenaSettings(ARENA *arenaa);
void __thiscall LoadArenaMapSomething(ARENA *arenaa);
int __thiscall GetDeathPrizeGreenId(ARENA *arenaa);
signed int __thiscall ChangeSettings(ARENA *arenaa, PLAYER *player, const CHAR *a3);
int __thiscall sub_405360(ARENA *this, int buf);
int __thiscall SoccerGameSomething(ARENA *this, int a2);
int __thiscall SoccerGame2(ARENA *arenaa, int Frequency, int a3, int a4); // idb
ARENA *__thiscall GetScore(ARENA *arenaa, int a2);
unsigned int __thiscall GetArenaMemoryTotal(ARENA *arena);
int __thiscall GetTotalPlayingPlayers(ARENA *arena);
int __thiscall SendBillerServerConnectPacket(int this, int a2, const char *ServerName, int ServerId, int GroupId, int ScoreId, const char *Password, int a8, int a9); // idb
signed int __thiscall CleanUpBilling(void *this);
void *__thiscall SendBillerUserBannerPacket(void *this, int a2, const void *a3);
void *__thiscall SendBillerUserDemographicsPacket(void *this, int a2, int UserDemographics);
BOOL __thiscall SendBillerUnknownPacket(ENCRYPTION **this, int a1, int a2, const char *a3);
int __thiscall SendBillerUserChannelChatPacket(ENCRYPTION **this, int PlayerId, const char *ChannelName, const char *ChatText);
void __thiscall SendBillerWarningPacket(struct BILLING_SERVER_STRUCT *billingServerStruct, int PlayerId, const char *WarningMessage);
int __thiscall biller_user_command(ENCRYPTION **this, int a1, const char *UserCommand);
BOOL __thiscall SendBillerUserLoginPacket(_DWORD *this, const char *Username, const char *Password, int IPAddress, int MachineId, int Timezone, char IsNewUser, int PlayerId, char Unused0, char isSysop);
int __thiscall SendBillerUserLogoffPacket(ENCRYPTION **this, int PlayerId, __int16 DisconnectReason, __int16 Latency, __int16 Ping, __int16 S2CPacketLoss, __int16 C2SPacketLoss, const void *PlayerScore, unsigned int ExtraSize);
int __thiscall SendBillerUserScorePacket(ENCRYPTION **this, int PlayerId, const void *Score, unsigned int Size);
void __thiscall SendBillerPlayerNamePacketSomething(ENCRYPTION **this, int a2, int a3, int a4, int len);
void __thiscall SendBillerUserPrivateChatPacket(ENCRYPTION **this, int PlayerId, int BillingGroupId, const void *a3, unsigned int len);
void __thiscall SendBillerZoneRevokePermitPacket(ENCRYPTION **this, int a2, int a3, int a4, int len);
int __thiscall GetBillerLastReconnectTime(_DWORD *this);
signed int __thiscall IsBillingServerDisconnected(int this);
struc_2 *__thiscall ReadSettingsSomething(struc_2 *ConfigSETPointer, const char *Filename); // idb
FILE *__thiscall WriteCfgFile(int this);
int __thiscall GetCFGSettingInteger(char *Str1, char *Str2, int, int); // idb
char *__thiscall GetCFGSettingString(char *Str1, char *Str2, int a3, char *Source, char *Dest, size_t Count);
char *__thiscall sub_4066B0(int this, const char *Str2, const char *a3, const char *Source, char *Dest, size_t Count);
void __thiscall FillArenaSettingsStruct(struc_2 *Str1, const char *Str2, const char *a3, const char *Source);
char *__thiscall LoadBMPHeader(char *Filename, char *Source);
void __thiscall sub_406B30(char *Filename);
int __thiscall sub_406BE0(_DWORD *this);
void __thiscall GetTileValue(struct BMP_FILE_STRUCT *BMPFile, int TileCounter, int *TileValuePointer);
signed int __cdecl DoBrickDrop(int a1, signed int XTiles, signed int YTiles, int X1Tile, int a5, int X2Tile, signed int a7, signed int a8); // idb
signed int __cdecl GenerateLVLChecksum(int MapData, signed int Key); // idb
int __cdecl LoadBMPHeader2(char *Filename); // idb
void __thiscall InitializeTextFile(struct TEXT_FILE_STRUCT *textFile, const char *Source, int makeUpperCase, int addAll);
void __thiscall CleanTextFileMemory(TEXT_FILE_STRUCT *textFile);
void __thiscall LoadTextFile(struct TEXT_FILE_STRUCT *textFile, int a2);
void __thiscall WriteTextFileToFile(struct TEXT_FILE_STRUCT *textFile);
int __thiscall ListMachine(int this);
int __thiscall ListMachineByIndex(int this, int listMachineIndex); // idb
void __thiscall AddLineTextFile(struct TEXT_FILE_STRUCT *textFile, char *ChatMsgBuffer);
LPVOID __thiscall ListMachineSomething(int this, int a2);
int __thiscall IsBannedMachineId(int this, int a2);
int __cdecl StrCmpiWrapper(const char *Str1, const char **a2);
char *__cdecl GetSplitNextDirectoryIP(char *a1, char *Src);
BOOL __cdecl IsFileLastWrittenTime(LPCSTR lpFileName, int);
int __cdecl BinarySearch(int ElementToFind, unsigned int Array, int TotalElements, signed int ElementSize, int (__cdecl *CompareFunc)(_DWORD, _DWORD), unsigned int *FoundPointer);
UINT __cdecl GetPrivateProfileIntWrapper(LPCSTR lpAppName, LPCSTR lpKeyName, int a3, LPCSTR lpFileName);
int __cdecl GetPrivateProfileStringWrapper(LPCSTR lpAppName, LPCSTR lpKeyName, LPSTR lpDefault, LPSTR lpReturnedString, DWORD nSize, LPCSTR lpFileName); // idb
int __cdecl config_read_helper_3(int); // idb
signed int __cdecl CRC32(unsigned int a1, int a2);
FILE *__cdecl RewriteSameFileSomething(int a1, char *Filename);
int nullsub_1(void); // weak
_DWORD *__cdecl emalloc(DWORD bytes);
LPVOID __cdecl ExpandMemory(LPVOID lpAddress, int a2, int a3);
void __stdcall efree(LPVOID ptr);
void __thiscall ConnectSocket(SOCKET *Socket, const char *Hostname, u_short ConnectPort, u_short ListenPort);
int __thiscall sub_408740(SOCKET *this);
void __thiscall SendDirectoryServerZoneUpdatePacket(void *this, const void *a2, unsigned int a3);
int __thiscall GetSocketRecvLag(SOCKET Socket, int *TimeElapsed); // idb
PINGSOCKET *__thiscall ListenOnPort(PINGSOCKET *socket, __int16 port, void *callback);
unsigned int __thiscall ProcessZonePings(void *this, int ZonePopulation);
PLAYER *__thiscall CreateNewPlayer(PLAYER *player, struct in_addr in, __int16 a3, NetData *encryption);
void __thiscall DisconnectUser(HANDLE *buf); // idb
void __thiscall PlayerHandleGamePacket(struct PLAYER *playerr, unsigned __int8 *packet, int packetSize);
const char *__thiscall GenerateWarning(PLAYER *playerr, DWORD dwWarningId);
void __thiscall UpdatePowerBallPositionsSomething(PLAYER *playerr);
signed int __thiscall sub_40CF10(PLAYER *playerr);
PLAYER *__thiscall sub_40D870(PLAYER *playerr);
void __thiscall PlayerChangeFrequency(PLAYER *playerr, signed int NewFrequencyy);
void __thiscall SetPlayerShip(PLAYER *playerr, signed int Ship);
ARENA *__thiscall sub_40DEA0(PLAYER *playerr, char *buf, int len, int a4);
ARENA *__thiscall SendPlayerReliablePacket(PLAYER *playerr, char *buf, int len, int a4);
void __thiscall SendToSpectators(struct PLAYER *player, char *buf, int len, int a4, int a5, int a6);
void __thiscall SendEverybodyButYourself(struct PLAYER *player, const void *buf, unsigned int len, int a4);
ARENA *__thiscall SendReliablePacketToMyFrequency(PLAYER *playerr, char *buf, int len, int a4);
ARENA *__thiscall SomethingWithAttachedPlayer(PLAYER *playerr, char *buf, int len, int a4, int a5, int a6);
ARENA *__thiscall sub_40E220(PLAYER *playerr, char *buf, int len, int a4, int a5, int a6); // idb
ARENA *__stdcall SomethingWithAudioByteAndShip8(ARENA *arenaa, char *buf, int len, int a4, int a5, ARENA *a6); // idb
ARENA *__thiscall sub_40E300(void *this, int a2, char *buf, int len, int a4, int a6, int a7);
ARENA *__thiscall SendMessage(PLAYER *this, char *msg, int SoundByte);
ARENA *__thiscall SendChannelMessage(PLAYER *playerr, const char *a2);
void __thiscall SendArenaMessagePlayer(PLAYER *playerr, const char *a2, char SoundByte);
ARENA *__thiscall SendFile(PLAYER *this, char *filename);
ARENA *__thiscall ArenaHandler(PLAYER *this, int ArenaIndex, const char *ArenaName);
int __thiscall SendWeaponPacket(PLAYER *playerr);
int __thiscall SendResetScoresPacket(PLAYER *player);
ARENA *__thiscall SendPlayerScoreUpdate(PLAYER *player);
signed int __thiscall SendPlayerScoreUpdateAll(PLAYER *playerr);
ARENA *__thiscall SendAdvertisement(PLAYER *playerr, int a2);
struc_2 *__cdecl LoadZoneCFGSettings(ARENA_SETTINGS *arenaSettings, SERVERSIDE_ARENA_SETTINGS *serverArenaSettings, const char *a3);
int __cdecl SoccerRelatedMath(int SoccerMode, int a2, signed int a3);
int __cdecl main(int argc, const char **argv, const char **envp);
int __cdecl ServerInitialize();
signed int __cdecl NewConnectionRequest(int IPAddress, __int16 Port, ENCRYPTION *encryption); // idb
void __cdecl PlayerHandleGamePacketWrapperSomething(int packet, int packetSize, int a3);
void __cdecl ServerMainLoop();
int __cdecl IncreaseRadarValueShowHomeOverFourThousand();
FILE *__cdecl ServerUninitialize();
void __cdecl HandleBillerPacket(char *buffer, int a2); // idb
int FormatMessageArena(ARENA *arena, const char *Format, ...);
int WriteSubGameLog(char *Format, ...);
char *__cdecl IsOffensiveName(int *a1);
signed int __cdecl IsBannedIPAddress(int a1, const char *a2);
void __cdecl SendBillerWarnings(const char *a1, PLAYER *player);
void __cdecl ChatProcessor(PLAYER *player, int zonePlayerIndex, signed int zonePlayerIndex_4, char *ChatText, char SoundByte);
void __cdecl SomethingWithSendingChatTypes(struct PLAYER *player, int TargetPlayerId, signed int PlayerId, char *ChatText, char SoundByte);
FILE *__cdecl UpdatePoints(PLAYER *player, DWORD DiffSinceLastUpdate1, DWORD DiffSinceLastUpdate2);
UINT __cdecl ReadServerINI();
int __cdecl LoadTemplateSSS();
int __cdecl LoadMapSomething();
int __cdecl LoadAdvertisements();
int __cdecl CleanUpMemory();
int __cdecl LoadWinsock();
int __stdcall j_WSACleanup();
int __thiscall StartServerListener(int this, int a2, int a3, int a4, int ServerListenPort, int OutgoingBufferSize, int IncomingBufferSize, int PacketHistoryMax);
void __thiscall CleanUpPacketAttachment(struct PACKET_ATTACHMENT *packetAttachment);
int __thiscall sub_41A910(int this, int a2);
ENCRYPTION *__thiscall SomethingBillerServer(_DWORD *this, char *name, u_short hostshort, int ServerKey, int a9);
void __thiscall DumpPacketHistory(struct PACKET_ATTACHMENT *packetAttachment, const char *Filename);
int __thiscall PlayerReadPackets(PLAYER *player, DWORD lpdwBytesRead, DWORD *lpdwSrcIPAddress, WORD *lpwSrcPort); // idb
int __thiscall PlayerDoNetworkOps(PLAYER *this);
void __thiscall PlayerHandlePacket(int this, int a2, signed int Size, int a4, int a5);
void __thiscall ProcessRegularPackets(struct PACKET_ATTACHMENT *packetAttachment, char *buffer, int packetLength, struct CONNECTION *encryption, int a5);
int __thiscall sub_41B1B0(int this, int a2, int a3);
int __thiscall sub_41B3D0(_DWORD *this);
void __thiscall GetPacketStatistics(struct PACKET_ATTACHMENT *packetAttachment, int *TotalPacketSendLength, int *TotalPacketSendCalls, int *TotalPacketRecvLength, int *TotalPacketRecvCalls, int *TotalPacketClustersCalls);
signed int __thiscall sub_41B430(void *this, signed int CommsTransportBufferSize); // idb
void __thiscall SendPacketsToEverybody(struct PACKET_ATTACHMENT *packetAttachment);
int __stdcall sub_41B570(int a1);
int __cdecl DifferentCompareFunction(_DWORD connection, int ConnectionsArray);
int __thiscall InitializeEncryption(ENCRYPTION *encryption, int a2, int a3, int a4, int a5, __int16 a6, signed int ServerKey, int a8, int a9);
void *__thiscall sub_41B7A0(int this);
int __thiscall CheckIfBillingServerIsConnected(int this);
int __thiscall sub_41B960(int this);
int __thiscall GetRelAckDiff(ENCRYPTION *encryption, DWORD *out);
void __thiscall WriteToNetwork(ENCRYPTION *encryption, const void *buf, unsigned int len);
void __thiscall ProcessCorePackets(struct CONNECTION *encryption, char *buffer, int size, int a5);
void __thiscall SendBiDirectionalCorePackets(struct CONNECTION *connection);
BOOL __thiscall WriteData(ENCRYPTION *encryptionn, void *buf, int buf_sz, BOOL bReliable);
FILE *__thiscall LogReliablePackets(char *this, char *filename);
signed int __thiscall GetNewsRequest(int this, int a2, int a3, int a4);
signed int __thiscall GetMapLvlRequest(int this, int a2, int a3, int a4);
int __thiscall sub_41C9B0(int this, int a2, int a3);
void __thiscall GetASyncS2CInfoSomething(struct CONNECTION *encryption, int ASyncS2CEnd, int ASyncS2CStart);
int __thiscall sub_41CA10(int this);
void __thiscall SendPacketCluster(struct CONNECTION *encryptionn, const void *buf, unsigned int len);
void __thiscall sub_41CB20(int this);
int __thiscall sub_41CB70(int this, int a2, int a3);
void __thiscall GetPacketCountInfoSomething(struct CONNECTION *this, int a2, int a3, int a4, int a5);
void __thiscall sub_41CBD0(int this);
char *__cdecl GetIPAddressString(struct in_addr in);
char *__cdecl GetSubspaceEXEChecksum(char *Filename);
char *__cdecl CompressFile(const char *Filename, int *OutSize, int *CRC_32, const void *Buffer, unsigned int bytes, int DoFileCompression, int FileSize);
// int __stdcall compress(_DWORD, _DWORD, _DWORD, _DWORD); weak
// int __stdcall send(SOCKET s, const char *buf, int len, int flags);
// int __stdcall connect(SOCKET s, const struct sockaddr *name, int namelen);
// struct hostent *__stdcall gethostbyname(const char *name);
// unsigned __int32 __stdcall inet_addr(const char *cp);
// int __stdcall bind(SOCKET s, const struct sockaddr *name, int namelen);
// u_long __stdcall htonl(u_long hostlong);
// u_short __stdcall htons(u_short hostshort);
// int __stdcall setsockopt(SOCKET s, int level, int optname, const char *optval, int optlen);
// int __stdcall ioctlsocket(SOCKET s, __int32 cmd, u_long *argp);
// SOCKET __stdcall socket(int af, int type, int protocol);
// int __stdcall closesocket(SOCKET s);
// int __stdcall recv(SOCKET s, char *buf, int len, int flags);
// int __stdcall sendto(SOCKET s, const char *buf, int len, int flags, const struct sockaddr *to, int tolen);
// int __stdcall recvfrom(SOCKET s, char *buf, int len, int flags, struct sockaddr *from, int *fromlen);
// int __stdcall WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);
// int __stdcall WSACleanup();
// char *__stdcall inet_ntoa(struct in_addr in);
int __cdecl setRNGSeed(int SeedRNG); // idb
// int __cdecl rand();
// int printf(const char *Format, ...);
// _DWORD __cdecl time(_DWORD Time); weak
// int sprintf(char *Dest, const char *Format, ...);
// char *__cdecl strrchr(const char *Str, int Ch);
// int __cdecl fclose(FILE *File);
// size_t __cdecl fread(void *DstBuf, size_t ElementSize, size_t Count, FILE *File);
// FILE *__cdecl fopen(const char *Filename, const char *Mode);
// char *__cdecl strncpy(char *Dest, const char *Source, size_t Count);
// size_t __cdecl fwrite(const void *Str, size_t Size, size_t Count, FILE *File);
// void __usercall _alloca_probe(unsigned int a1@<eax>, char a2);
// void *__cdecl memcpy(void *Dst, const void *Src, size_t Size);
// void __cdecl qsort(void *Base, size_t NumOfElements, size_t SizeOfElements, int (__cdecl *PtFuncCompare)(const void *, const void *));
// _DWORD __cdecl shortsort(_DWORD, _DWORD, _DWORD, _DWORD); weak
// _DWORD __cdecl swap(_DWORD, _DWORD, _DWORD); weak
// int __cdecl operator delete(void *Memory); idb
// void *__cdecl operator new(unsigned int); idb
// int __cdecl __CxxFrameHandler(struct EHExceptionRecord *ExceptionRecord, struct EHRegistrationNode *, int, int); idb
// _DWORD __cdecl _local_unwind2(_DWORD, _DWORD); weak
// int __cdecl atoi(const char *Str);
// int __cdecl isalpha(int C);
// int __cdecl isdigit(int C);
// int __cdecl isspace(int C);
// char *__cdecl fgets(char *Buf, int MaxCount, FILE *File);
// int fprintf(FILE *File, const char *Format, ...);
// int __cdecl fseek(FILE *File, __int32 Offset, int Origin);
// _DWORD __cdecl _chsize(_DWORD, _DWORD); weak
// char *__cdecl strstr(const char *Str, const char *SubStr);
// int __cdecl toupper(int C);
// void __cdecl exit(int Code);
// void *__cdecl malloc(size_t Size);
// void *__cdecl realloc(void *Memory, size_t NewSize);
// void __cdecl free(void *Memory);
int __cdecl RunCommandPrompt(char *argumentsPointer); // idb
// int __cdecl _spawnlp(int, char *Str, int); idb
// clock_t __cdecl clock();
// int __cdecl fflush(FILE *File);
// int __cdecl vsprintf(char *Dest, const char *Format, va_list Args);
// char *__cdecl asctime(const struct tm *Tm);
// struct tm *__cdecl localtime(const time_t *Time);
// double __cdecl difftime(_DWORD Time1, _DWORD);
// char *__cdecl strchr(const char *Str, int Val);
// _DWORD __cdecl _filelength(_DWORD); weak
// int __usercall sub_4210C9@<eax>(int a1@<ebp>);
// int __usercall sub_4210D6@<eax>(int a1@<ebp>);
int __cdecl sub_421101();
// int sub_42110A(void); weak
// int __cdecl ExFilterRethrow(struct _EXCEPTION_POINTERS *); idb
// void __usercall __noreturn sub_4214B0(int a2@<ebx>, int a3@<edi>, int a4@<esi>);
void __cdecl j__abort();
// void __usercall __noreturn sub_421540(int a1@<ebx>, int a2@<edi>, int a3@<esi>);
// int __cdecl _spawnvpe(int, char *Str, int, LPVOID lpEnvironment); idb
// signed int __cdecl _spawnve(int a1, char *Str, int a3, LPVOID lpEnvironment);
// int __cdecl comexecmd(int, void *lpApplicationName, int, LPVOID lpEnvironment); idb
// int __cdecl _access(LPCSTR lpFileName, char); idb
// char *__cdecl getenv(const char *VarName);
// _DWORD __cdecl _ftime(_DWORD); weak
BOOL __cdecl DateFunction(int a1);
// _DWORD __cdecl cvtdate(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak
// int __cdecl unknown_libname_6(int, PVOID TargetFrame, int); idb
// int __cdecl _mbsrchr(char *Str, int); idb
// int __cdecl _mbschr(char *Str, int Val); idb
// _DWORD __cdecl _ld12cvt(_DWORD, _DWORD, _DWORD); weak
int __cdecl sub_426670(int a1, int a2);
int __cdecl sub_426690(int a1, int a2);
int __cdecl _atodbl(_CRT_DOUBLE *Result, char *String);
int __cdecl sub_4266F0(int a1, int a2);
// _DWORD __cdecl __strgtold12(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak
// int __cdecl _fileno(FILE *File);
// int __cdecl _strcmpi(const char *Str1, const char *Str2);
// char *__cdecl _strupr(char *String);
int __cdecl getch();
signed int __cdecl console_input_wrapper();
// _DWORD __cdecl _getextendedkeycode(_DWORD); weak
// int __cdecl _memicmp(const void *Buf1, const void *Buf2, size_t Size);
// int __initconin(void); weak
// int __stdcall GetObjectA(HANDLE h, int c, LPVOID pv);
// BOOL __stdcall DeleteObject(HGDIOBJ ho);
// DWORD __stdcall GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// BOOL __stdcall WritePrivateProfileStringA(LPCSTR lpAppName, LPCSTR lpKeyName, LPCSTR lpString, LPCSTR lpFileName);
// DWORD __stdcall GetTickCount();
// BOOL __stdcall CloseHandle(HANDLE hObject);
// BOOL __stdcall GetFileTime(HANDLE hFile, LPFILETIME lpCreationTime, LPFILETIME lpLastAccessTime, LPFILETIME lpLastWriteTime);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// UINT __stdcall GetPrivateProfileIntA(LPCSTR lpAppName, LPCSTR lpKeyName, INT nDefault, LPCSTR lpFileName);
// DWORD __stdcall GetPrivateProfileStringA(LPCSTR lpAppName, LPCSTR lpKeyName, LPCSTR lpDefault, LPSTR lpReturnedString, DWORD nSize, LPCSTR lpFileName);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// BOOL __stdcall VirtualFree(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
// BOOL __stdcall TerminateProcess(HANDLE hProcess, UINT uExitCode);
// BOOL __stdcall GetExitCodeProcess(HANDLE hProcess, LPDWORD lpExitCode);
// BOOL __stdcall CreateProcessA(LPCSTR lpApplicationName, LPSTR lpCommandLine, LPSECURITY_ATTRIBUTES lpProcessAttributes, LPSECURITY_ATTRIBUTES lpThreadAttributes, BOOL bInheritHandles, DWORD dwCreationFlags, LPVOID lpEnvironment, LPCSTR lpCurrentDirectory, LPSTARTUPINFOA lpStartupInfo, LPPROCESS_INFORMATION lpProcessInformation);
// LPSTR __stdcall GetCommandLineA();
// BOOL __stdcall SetConsoleTitleA(LPCSTR lpConsoleTitle);
// void __stdcall Sleep(DWORD dwMilliseconds);
// BOOL __stdcall GetNumberOfConsoleInputEvents(HANDLE hConsoleInput, LPDWORD lpNumberOfEvents);
// BOOL __stdcall PeekConsoleInputA(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead);
// BOOL __stdcall GetConsoleMode(HANDLE hConsoleHandle, LPDWORD lpMode);
// BOOL __stdcall SetConsoleMode(HANDLE hConsoleHandle, DWORD dwMode);
// BOOL __stdcall ReadConsoleInputA(HANDLE hConsoleInput, PINPUT_RECORD lpBuffer, DWORD nLength, LPDWORD lpNumberOfEventsRead);
// int __stdcall MessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);
// HANDLE __stdcall LoadImageA(HINSTANCE hInst, LPCSTR name, UINT type, int cx, int cy, UINT fuLoad);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_4288DE; // weak
_UNKNOWN loc_42904B; // weak
int sub_429128[2] = { -1, 0 }; // weak
_UNKNOWN stru_429140; // weak
int LastBillerPlayerId = 1; // weak
int dword_42C840 = 1; // weak
char *off_42C848[8] =
{
  "Warbird",
  "Javelin",
  "Spider",
  "Leviathan",
  "Weasel",
  "Terrier",
  "Lancaster",
  "Shark"
}; // weak
int RNGSeed = 1; // weak
FILE stru_42E498 = { NULL, 0, NULL, 2, 1, 0, 0, NULL }; // idb
int (__cdecl *off_42E734)(_DWORD, _DWORD, _DWORD, _DWORD) = &sub_4214B0; // weak
int dword_43099C = 1; // weak
int dword_430A30 = -1; // weak
int dword_430A34 = 0; // weak
int dword_430A38 = 0; // weak
int dword_430A40 = -1; // weak
int dword_430A44 = 0; // weak
int dword_430A48 = 0; // weak
int dword_430E60[6] = { 1024, -1023, 53, 11, 64, 1023 }; // weak
int dword_430E78[6] = { 128, -127, 24, 8, 32, 127 }; // weak
int dword_431490 = -1; // weak
HANDLE hConsoleHandle = (HANDLE)0xFFFFFFFE; // idb
char *DirectoryCurrentNamePassword = NULL;
int AdvertiseSendMode = 0; // weak
char DirectoryIPAddresses[] =
{
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
};
char Filename2[];
char *dword_4317B8; // idb
int dword_4317BC; // idb
int LastTimeServerINIWasEdited; // weak
char byte_431BBC[36]; // weak
int MiscDisableSharewareShips; // weak
int DirectoryPort; // idb
int RadarValue; // weak
char *buf; // idb
int len; // idb
int dword_431E9C[75]; // weak
int dword_431FC8[10]; // weak
void *BillingConnectionStructPointer; // idb
int ArenaArrayLength; // weak
int ServerIterations; // weak
int ArenaMinimumPlayers; // weak
int LastTimeMasterCFGWasEdited; // weak
int RecycleServer; // weak
CHAT ChatRelatedArray[64];
void *dword_437B08; // idb
LPVOID dword_437B0C; // idb
int ArenaSpawnKeepScores; // weak
int dword_437B14; // weak
char FileName[]; // idb
int DoubleValue; // weak
int BillingAttemptTime; // weak
char DirectoryNamePassword[];
int CommsMaxQueueToLogin; // weak
int CurrentLogLine; // weak
int IsServerRunning; // weak
char *dword_437CB0; // idb
int dword_437CB4; // idb
int ArenaMaxPlayers; // weak
int CommsPacketHistoryMax;
char SuperModeratorPassword[];
char ModeratorPassword[];
int MiscMaxSharewarePlayer; // weak
ARENA_SETTINGS ArenaSettings;
int MachineIdArrayIndex; // weak
char BillingPassword[];
int dword_4386F8; // weak
int SomeArrayOf256_1[256];
u_short BillingPort; // idb
LPVOID ptr; // idb
int MiscLogPoints; // weak
LPCSTR ObscenePointer; // idb
int ScreenValue; // weak
int CPUSlowIterationWarningLevel; // weak
int MaxArenasMemory; // weak
int PermissionMode; // weak
int CommsEncryptMode; // weak
LPCSTR ModeratePointer; // idb
char VIPPassword[];
LPCSTR PermitPointer; // idb
void *dword_438B70; // idb
int MiscMaxPlayers; // weak
int BillingReconnectTime; // weak
int PermissionMinimumSecondsToLogin; // weak
TEMPLATE_SSS TotalTemplateSSSList[1400];
char EnergyPassword[];
int PermissionMaxPoints; // weak
ENCRYPTION *encryption; // idb
int BillingGroupId; // idb
int BillingServerId; // idb
KICK KickedUsers[1000]; // weak
int MiscKeepAliveDelay; // weak
int AutoPermissionPoints; // weak
char SysopPassword[];
DWORD CPUSleepTime; // idb
int SomeArrayOf256_2[256];
char DirectoryDescription[];
char BillingIP[];
int dword_4AF8F8; // weak
int dword_4AF8FC[5]; // weak
char byte_4AF911[]; // weak
int dword_4C8F38; // weak
int dword_4C8F3C; // weak
PLAYER *playerPointerList[1024];
int CPUSleepPerIteration; // weak
char MiscDefaultLevelFile[];
SERVERSIDE_ARENA_SETTINGS ServersideArenaSettings;
char PermissionAutoPermissionMessage[];
int ServerListenPort; // idb
int MiscPointUpdateDiff; // weak
char PermissionAutoPermissionIDList[];
int BillingLogMessages; // weak
int IncreasesRadarValueSomeHow; // weak
SERVER_BIG_ARRAY Security[10];
int CustomArenaMode; // weak
PLAYER *ZonePlayerList[1025];
int MiscServerLog; // weak
int dword_4D55D0; // weak
int MiscMaxSharkwareTime; // weak
int MiscMenuKickOutDelay; // weak
LPCSTR ReservedPointer; // idb
ARENA *Arenas[200];
int PermissionAllowLowBandwidth; // weak
int CPUProcessMaxTime; // weak
int MaxArenas; // weak
int MiscJackpotBroadcastPoints; // weak
int MiscRegisterKickShareware; // weak
int NewsTxtFileChecksum; // weak
int MiscDisableShareware; // weak
int CommsIncomingBufferSize; // idb
int dword_4D5920; // weak
int LastTimeNewsTxtWasEdited; // weak
int ArenaDesiredPlayers; // weak
char LogArray[12288]; // weak
int AdvertiseDuration; // weak
int BillingScoreId; // idb
LPVOID MapAllocatedMemory; // idb
int CommsOutgoingBufferSize; // idb
char BillingServerName[];
void *dword_4D89C0; // idb
void *SmallServerStruct; // idb
int Wave; // weak
CHAR ShutdownArguments; // idb
LPCSTR IDBlockPointer; // idb
void *ServerStruct; // idb
int AdvertiseDisplayMode; // weak
int ZonePlayerCount; // idb
int MiscDisableSharewareScores; // weak
int TotalTemplateSSSEntries; // weak
int bytes; // idb
signed int CommsTransportBufferSize; // idb
int dword_4D8AF0; // weak
int oldTickCountValue; // weak
int HighestPlayerCountMaybeSomething; // weak
int dword_4D8AFC; // weak
int dword_4D8B00; // weak
int dword_4D8B04; // weak
FILE *PointsFileHandle; // idb
FILE *fileHandle; // idb
int dword_4D8B14; // weak
int ChatCounter64Max; // weak
int dword_4D8B38; // weak
int dword_4D8B44; // weak
int (__cdecl *dword_4D8BDC)(_DWORD, _DWORD, _DWORD, _DWORD); // weak
int dword_4D8C18; // weak
struct _TIME_ZONE_INFORMATION TimeZoneInformation; // idb


//----- (00401000) --------------------------------------------------------
ARENA *__thiscall ServerEntryPoint(ARENA *arenaa, const char *Source)
{
  int v3; // eax
  DWORD (__stdcall *GetTickCountt)(); // esi
  FILE *v5; // eax
  FILE *v6; // esi
  int v7; // eax
  unsigned int v8; // eax
  void *v9; // eax
  char *v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // edx
  int v14; // edi
  int v15; // edi
  DWORD v16; // eax
  __int64 v17; // rax
  int v18; // eax
  int v19; // ecx
  int *v20; // eax
  char String[32]; // [esp+10h] [ebp-120h] BYREF
  char Str[256]; // [esp+30h] [ebp-100h] BYREF

  arenaa->MapAllocatedMemory = 0;
  arenaa->field_10026 = 0;
  arenaa->field_FF30 = 0;
  if ( _strcmpi(Source, "server") )
  {
    strncpy(arenaa->ArenaName, Source, 0x20u);
    arenaa->ArenaName[31] = 0;
  }
  else
  {
    strcpy(arenaa->ArenaName, "unnamed");
  }
  v3 = CustomArenaMode > 0 && arenaa->ArenaName[0];
  GetTickCountt = GetTickCount;
  arenaa->bHasScrFile = v3;
  arenaa->NumberOfContents18ByteBlocks = 0;
  arenaa->FileContentsMemoryPointer = 0;
  arenaa->LastSaveStatsTime = GetTickCount() / 0xA;
  arenaa->playerPointersForSomething[250] = 0;
  arenaa->AllMessagesLocked = 0;
  arenaa->AllMessagesLockedAgainSomething = 0;
  arenaa->PrivateMessagesLocked = 0;
  arenaa->SpecMessageLock = 0;
  if ( arenaa->bHasScrFile )
  {
    strcpy(String, arenaa->ArenaName);
    strcat(String, ".scr");
    v5 = fopen(String, "rb");
    v6 = v5;
    if ( v5 )
    {
      v7 = _fileno(v5);
      v8 = _filelength(v7);
      arenaa->NumberOfContents18ByteBlocks = v8 / 0x12;
      v9 = ExpandMemory(0, 18 * (v8 / 0x12), 1);
      arenaa->FileContentsMemoryPointer = (int)v9;
      fread(v9, 0x12u, arenaa->NumberOfContents18ByteBlocks, v6);
      fclose(v6);
    }
    GetTickCountt = GetTickCount;
  }
  memset(arenaa, 0, 0xFB00u);
  GetModuleFileNameA(0, Str, 0x100u);
  v10 = strrchr(Str, '\\');
  if ( v10 )
    *v10 = 0;
  else
    Str[0] = 0;
  if ( arenaa->bHasScrFile )
  {
    sprintf(arenaa->szConfigFile, "%s\\%s.cfg", Str, arenaa->ArenaName);
    sprintf(arenaa->szLevelFile1, "%s.lvl", arenaa->ArenaName);
    sprintf(arenaa->szLevelFile2, "%s.lvl", arenaa->ArenaName);
    if ( _access(arenaa->szConfigFile, 0) )
      RewriteSameFileSomething((int)arenaa->szConfigFile, "server.cfg");
    if ( !LoadBMPHeader2(arenaa->szLevelFile2) )
    {
      strcpy(arenaa->szLevelFile1, MiscDefaultLevelFile);
      GetTickCountt = GetTickCount;
    }
    v11 = time(0);
    sprintf(String, "%d", v11);
    WritePrivateProfileStringA("Owner", "LastUsedStamp", String, arenaa->szConfigFile);
  }
  else
  {
    sprintf(arenaa->szConfigFile, "%s\\server.cfg", Str);
    strcpy(arenaa->szLevelFile1, MiscDefaultLevelFile);
    strcpy(arenaa->szLevelFile2, MiscDefaultLevelFile);
    GetTickCountt = GetTickCount;
  }
  printf("Arena Created: (%s) using parameters: %s\n", arenaa->ArenaName, arenaa->szConfigFile);
  LoadArenaSettings(arenaa);
  LoadArenaMapSomething(arenaa);
  arenaa->field_1001A = 0;
  arenaa->GetTickCountValue1 = GetTickCountt() / 0xA;
  arenaa->GetTickCountValue2 = GetTickCountt() / 0xA;
  arenaa->TerritoryRewardTimePassed = GetTickCountt() / 0xA;
  arenaa->GetTickCountValue4 = GetTickCountt() / 0xA;
  arenaa->NumOfBricksInArena = 0;
  arenaa->ArenaPlayerCount = 0;
  arenaa->ScoreStructCounter = 0;
  arenaa->ArenaLocked = 0;
  arenaa->ArenaJackpot = 0;
  arenaa->Freq1Score = 0;
  arenaa->Freq2Score = 0;
  arenaa->Freq3Score = 0;
  arenaa->Freq4Score = 0;
  v12 = arenaa->ServersideArenaSettings.RandomFlags;
  arenaa->someCounterBefore = 0;
  arenaa->TotalSoccerBalls = 0;
  if ( v12 && (int)arenaa->ServersideArenaSettings.MaxFlags > 0 )
    v13 = rand() % arenaa->ServersideArenaSettings.MaxFlags + 1;
  else
    v13 = arenaa->ServersideArenaSettings.MaxFlags;
  *(_DWORD *)arenaa->gap_FF6A = v13;
  arenaa->GetTickCountValue8 = GetTickCountt() / 0xA;
  v14 = rand();
  arenaa->RandomTimesRandom1 = rand() * v14;
  v15 = rand();
  arenaa->RandomTimesRandom2 = rand() * v15;
  v16 = GetTickCountt();
  arenaa->field_FF34 = 0;
  arenaa->GetTickCountValue6 = (v16 / 0xA) & 0x7FFFFFFF;
  arenaa->field_FF38 = 0;
  arenaa->MapLVLChecksum = 0;
  arenaa->field_FF40 = 0;
  arenaa->GameTimeStart = 0;
  arenaa->GameTimePassed = 0;
  arenaa->field_FF56 = 0;
  arenaa->field_FF20 = 0;
  v17 = 3435973837i64 * GetTickCountt();
  LOBYTE(v17) = arenaa->ArenaName[0];
  arenaa->RecordPointsToLog = 1;
  arenaa->field_FF4E = HIDWORD(v17) >> 3;
  if ( (_BYTE)v17 && !ArenaSpawnKeepScores )
    arenaa->RecordPointsToLog = 0;
  if ( arenaa->bHasScrFile )
    arenaa->RecordPointsToLog = 0;
  if ( arenaa->ServersideArenaSettings.FlagMode == 2 )
  {
    v18 = arenaa->someCounterAfter;
    if ( arenaa->someCounterBefore < v18 )
    {
      v19 = 0;
      arenaa->someCounterBefore = v18;
      if ( v18 > 0 )
      {
        v20 = &arenaa->Pointer;
        do
        {
          *v20 = v20[2906];
          v20[1] = v20[2907];
          v20[3] = -1;
          v20[2] = -1;
          ++v19;
          v20 += 4;
        }
        while ( v19 < arenaa->someCounterAfter );
      }
    }
  }
  ArenaScoreReset(arenaa, 0);
  arenaa->ScoreStructCounter = 0;
  arenaa->GameTimePassedTwo = GetTickCountt() / 0xA;
  arenaa->field_FF20 = 0;
  SoccerGameSomething(arenaa, -1);
  return arenaa;
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);
// 437B10: using guessed type int ArenaSpawnKeepScores;
// 4D45C0: using guessed type int CustomArenaMode;

//----- (00401590) --------------------------------------------------------
void __thiscall ShutdownArena(ARENA *arenaa)
{
  int v2; // esi
  PLAYER **v3; // eax
  int v4; // ecx
  __int16 *v5; // edx
  int v6; // ecx
  PLAYER *v7; // ecx
  LPVOID v8; // eax
  LPVOID v9; // eax
  DWORD GetTickCountt; // kr00_4
  int v11; // eax
  FILE *v12; // eax
  FILE *v13; // esi
  char Filename[32]; // [esp+10h] [ebp-20h] BYREF

  v2 = 0;
  if ( arenaa->ArenaPlayerCount > 0 )
  {
    v3 = arenaa->playerPointersForSomething;
    do
    {
      if ( !arenaa->ServersideArenaSettings.MiscTimedGame )
      {
        if ( arenaa->bHasScrFile )
        {
          v4 = (*v3)->field_15F;
          if ( v4 >= 0 )
          {
            v5 = &(*v3)->CurrentWins;
            v6 = arenaa->FileContentsMemoryPointer + 18 * v4 + 4;
            *(_DWORD *)v6 = *(_DWORD *)v5;
            *(_DWORD *)(v6 + 4) = *((_DWORD *)v5 + 1);
            *(_DWORD *)(v6 + 8) = *((_DWORD *)v5 + 2);
            *(_WORD *)(v6 + 12) = v5[6];
          }
        }
      }
      v7 = *v3;
      ++v2;
      ++v3;
      v7->MyArena = 0;
      (*(v3 - 1))->AlreadySentReliablePacket = 1;
    }
    while ( v2 < arenaa->ArenaPlayerCount );
  }
  v8 = (LPVOID)arenaa->MapAllocatedMemory;
  if ( v8 && v8 != MapAllocatedMemory )
    efree((LPVOID)arenaa->MapAllocatedMemory);
  v9 = *(LPVOID *)&arenaa->dwLastConfigReadTime[12];
  if ( v9 && v9 != dword_437B0C )
    efree(*(LPVOID *)&arenaa->dwLastConfigReadTime[12]);
  if ( arenaa->FileContentsMemoryPointer )
  {
    GetTickCountt = GetTickCount();
    v11 = arenaa->bHasScrFile;
    arenaa->LastSaveStatsTime = GetTickCountt / 0xA;
    if ( v11 )
    {
      strcpy(Filename, arenaa->ArenaName);
      strcat(Filename, ".scr");
      v12 = fopen(Filename, "wb");
      v13 = v12;
      if ( v12 )
      {
        fwrite((const void *)arenaa->FileContentsMemoryPointer, 0x12u, arenaa->NumberOfContents18ByteBlocks, v12);
        fclose(v13);
      }
    }
    efree((LPVOID)arenaa->FileContentsMemoryPointer);
  }
}

//----- (00401720) --------------------------------------------------------
void __thiscall DropBrick(ARENA *arenaa, int XTiles, int YTiles, __int16 Team)
{
  int v5; // ebp
  int v6; // ecx
  int v7; // eax
  int v8; // ebx
  PLAYER **v9; // edi
  int v10; // ebx
  PLAYER **v11; // edi
  signed int a7; // [esp+10h] [ebp-110h] BYREF
  int a5; // [esp+14h] [ebp-10Ch] BYREF
  int X2Tile; // [esp+18h] [ebp-108h] BYREF
  int X1Tile; // [esp+1Ch] [ebp-104h] BYREF
  char buf; // [esp+20h] [ebp-100h] BYREF
  int v17; // [esp+21h] [ebp-FFh]
  int v18; // [esp+25h] [ebp-FBh]
  int v19; // [esp+29h] [ebp-F7h]
  int v20; // [esp+2Dh] [ebp-F3h]

  if ( arenaa->NumOfBricksInArena < 1024 )
  {
    DoBrickDrop(
      arenaa->MapAllocatedMemory,
      XTiles,
      YTiles,
      (int)&X1Tile,
      (int)&a5,
      (int)&X2Tile,
      (signed int)&a7,
      arenaa->ServersideArenaSettings.BrickSpan);
    if ( X1Tile != X2Tile || a5 != a7 )
    {
      arenaa->Bricks[arenaa->NumOfBricksInArena].X1Tile = X1Tile;
      arenaa->Bricks[arenaa->NumOfBricksInArena].field_2 = a5;
      arenaa->Bricks[arenaa->NumOfBricksInArena].X2Tile = X2Tile;
      arenaa->Bricks[arenaa->NumOfBricksInArena].field_6 = a7;
      arenaa->Bricks[arenaa->NumOfBricksInArena].Team = Team;
      arenaa->Bricks[arenaa->NumOfBricksInArena].field_A = arenaa->field_FF40++;
      v5 = 0;
      arenaa->Bricks[arenaa->NumOfBricksInArena].BrickTimeStamp = (GetTickCount() / 0xA) & 0x7FFFFFFF;
      v6 = arenaa->NumOfBricksInArena;
      buf = 33;
      v17 = *(_DWORD *)&arenaa->Bricks[v6].X1Tile;
      v18 = *(_DWORD *)&arenaa->Bricks[v6].X2Tile;
      v19 = *(_DWORD *)&arenaa->Bricks[v6].Team;
      v7 = arenaa->ServersideArenaSettings.RoutingWallResendCount;
      v20 = arenaa->Bricks[v6].BrickTimeStamp;
      if ( v7 > 0 )
      {
        do
        {
          v8 = 0;
          if ( arenaa->ArenaPlayerCount > 0 )
          {
            v9 = arenaa->playerPointersForSomething;
            do
            {
              if ( !(*v9)->AlreadySentReliablePacket )
                SendPlayerReliablePacket(*v9, &buf, 17, 0);
              ++v8;
              ++v9;
            }
            while ( v8 < arenaa->ArenaPlayerCount );
          }
          SendPacketsToEverybody((struct PACKET_ATTACHMENT *)dword_437B08);
          ++v5;
        }
        while ( v5 < arenaa->ServersideArenaSettings.RoutingWallResendCount );
      }
      v10 = 0;
      if ( arenaa->ArenaPlayerCount > 0 )
      {
        v11 = arenaa->playerPointersForSomething;
        do
        {
          if ( !(*v11)->AlreadySentReliablePacket )
            SendPlayerReliablePacket(*v11, &buf, 17, 1);
          ++v10;
          ++v11;
        }
        while ( v10 < arenaa->ArenaPlayerCount );
      }
      ++arenaa->NumOfBricksInArena;
    }
  }
}

//----- (00401920) --------------------------------------------------------
void __thiscall PlayerEntering(struct ARENA *arena, PLAYER *player)
{
  int v3; // edx
  int v4; // eax
  int v5; // edi
  int v6; // eax
  _DWORD *v7; // edx
  int v8; // esi
  _DWORD *i; // ecx
  int v10; // eax
  char *v11; // eax
  int v12; // ecx
  int v13; // eax
  __int16 *v14; // edx
  int v15; // edi
  int v16; // eax
  int v17; // esi
  int v18; // edx
  SCORE *v19; // ecx
  int v20; // eax
  int v21; // esi
  int v22; // ecx
  int v23; // edx
  PLAYER **v24; // eax
  int v25; // eax
  int v26; // eax
  int v27; // esi
  char *v28; // ecx
  char *v29; // eax
  int v30; // edx
  __int16 v31; // di
  int v32; // edi
  int *v33; // esi
  __int16 v34; // cx
  __int16 v35; // dx
  char *v36; // esi
  int v37; // edx
  int v38; // edi
  char v39; // al
  int v40; // ecx
  int v41; // edx
  char *v42; // eax
  bool v43; // cc
  int v44; // eax
  PLAYER *v45; // eax
  __int16 v46; // ax
  unsigned int v47; // eax
  int v48; // edx
  int v49; // eax
  __int16 v50; // dx
  __int16 v51; // cx
  char v52; // al
  __int16 v53; // dx
  __int16 v54; // ax
  int v55; // ecx
  int v56; // edx
  __int16 *v57; // eax
  int v58; // edx
  int v59; // ecx
  char *v60; // [esp-4h] [ebp-5454h]
  char v61; // [esp+13h] [ebp-543Dh] BYREF
  PLAYER **v62; // [esp+14h] [ebp-543Ch]
  int v63; // [esp+18h] [ebp-5438h]
  __int16 *v64; // [esp+1Ch] [ebp-5434h]
  char *v65; // [esp+20h] [ebp-5430h]
  char String; // [esp+24h] [ebp-542Ch] BYREF
  __int16 v67; // [esp+25h] [ebp-542Bh]
  __int16 v68; // [esp+27h] [ebp-5429h]
  __int16 v69; // [esp+29h] [ebp-5427h]
  __int16 v70; // [esp+2Bh] [ebp-5425h]
  char v71; // [esp+34h] [ebp-541Ch] BYREF
  int v72; // [esp+35h] [ebp-541Bh]
  int v73; // [esp+39h] [ebp-5417h]
  int v74; // [esp+3Dh] [ebp-5413h]
  int v75; // [esp+41h] [ebp-540Fh]
  char v76[3]; // [esp+48h] [ebp-5408h] BYREF
  char Dest[20]; // [esp+4Bh] [ebp-5405h] BYREF
  char v78[20]; // [esp+5Fh] [ebp-53F1h] BYREF
  int v79; // [esp+73h] [ebp-53DDh]
  int v80; // [esp+77h] [ebp-53D9h]
  __int16 v81; // [esp+7Bh] [ebp-53D5h]
  __int16 v82; // [esp+7Dh] [ebp-53D3h]
  __int16 v83; // [esp+7Fh] [ebp-53D1h]
  __int16 v84; // [esp+81h] [ebp-53CFh]
  __int16 v85; // [esp+83h] [ebp-53CDh]
  __int16 v86; // [esp+85h] [ebp-53CBh]
  char v87; // [esp+88h] [ebp-53C8h] BYREF
  char v88[16]; // [esp+89h] [ebp-53C7h] BYREF
  int v89; // [esp+99h] [ebp-53B7h]
  char v90; // [esp+A0h] [ebp-53B0h] BYREF
  __int16 v91; // [esp+A1h] [ebp-53AFh]
  char v92[96]; // [esp+A3h] [ebp-53ADh] BYREF
  char v93[128]; // [esp+104h] [ebp-534Ch] BYREF
  char v94[460]; // [esp+184h] [ebp-52CCh] BYREF
  char buf; // [esp+350h] [ebp-5100h] BYREF
  char v96; // [esp+351h] [ebp-50FFh] BYREF
  char v97; // [esp+1350h] [ebp-4100h] BYREF
  char v98[16639]; // [esp+1351h] [ebp-40FFh] BYREF

  if ( arena->bHasScrFile )
  {
    if ( arena->ServersideArenaSettings.OwnerUserId == -1 && !arena->ArenaPlayerCount )
    {
      v3 = player->UserId;
      if ( v3 >= 0 )
      {
        v4 = 0;
        switch ( CustomArenaMode )
        {
          case 1:
            goto LABEL_11;
          case 2:
            if ( player->isModerator )
              goto LABEL_11;
            break;
          case 3:
            if ( player->isSuperModerator )
              goto LABEL_11;
            break;
          case 4:
            if ( player->isSysop )
LABEL_11:
              v4 = 1;
            break;
          default:
            break;
        }
        if ( v4 )
        {
          arena->ServersideArenaSettings.OwnerUserId = v3;
          strcpy(arena->ServersideArenaSettings.OwnerName, player->Name);
          sprintf(&String, "%d", player->UserId);
          WritePrivateProfileStringA("Owner", "UserId", &String, arena->szConfigFile);
          WritePrivateProfileStringA("Owner", "Name", player->Name, arena->szConfigFile);
        }
      }
    }
  }
  v64 = &player->CurrentWins;
  *(int *)((char *)&player->word24B + 2) = *(_DWORD *)&player->CurrentWins;
  *(_DWORD *)&player->gap_24F[2] = *(_DWORD *)&player->GoalCount;
  *(_DWORD *)&player->gap_24F[6] = *(int *)((char *)&player->KillPoints + 2);
  *(_WORD *)&player->gap_24F[10] = HIWORD(player->FlagPoints);
  arena->playerPointersForSomething[arena->ArenaPlayerCount++] = player;
  player->MyArena = arena;
  *(_DWORD *)player->gap_DC = 0;
  *(int *)((char *)&player->Ping + 2) = 0;
  *(_DWORD *)&player->YPixels = 0;
  *(_DWORD *)&player->XPixels = 0;
  *(_DWORD *)player->gap_EC = 0;
  player->field_F0 = 0;
  *(_WORD *)player->gap_EC = 10000;
  player->field_B4 = 0;
  player->field_11F = 0;
  player->SecurityWeaponCountTotal = 0;
  player->SecurityWeaponCount = 0;
  player->AttachedToPlayerId = -1;
  player->DebtKills = arena->ServersideArenaSettings.KillDebtKills;
  player->KotHDeathCount = 0;
  player->KingCrownKills = 0;
  player->MySoccerReward = 0;
  player->field_15F = -1;
  if ( arena->bHasScrFile )
  {
    v5 = player->UserId;
    if ( v5 >= 0 )
    {
      v6 = arena->NumberOfContents18ByteBlocks;
      v7 = (_DWORD *)arena->FileContentsMemoryPointer;
      v8 = 0;
      for ( i = v7; v8 < v6; ++v8 )
      {
        if ( *i == v5 )
          break;
        i = (_DWORD *)((char *)i + 18);
      }
      if ( v8 == v6 )
      {
        v10 = v6 + 1;
        arena->NumberOfContents18ByteBlocks = v10;
        v11 = (char *)ExpandMemory(v7, 18 * v10, 0x10000);
        arena->FileContentsMemoryPointer = (int)v11;
        *(_DWORD *)&v11[18 * v8] = player->UserId;
        v12 = 18 * v8 + arena->FileContentsMemoryPointer + 4;
        *(_DWORD *)v12 = 0;
        *(_DWORD *)(v12 + 4) = 0;
        *(_DWORD *)(v12 + 8) = 0;
        *(_WORD *)(v12 + 12) = 0;
      }
      player->field_15F = v8;
      v13 = arena->FileContentsMemoryPointer + 18 * v8 + 4;
      v14 = v64;
      *(_DWORD *)v64 = *(_DWORD *)v13;
      *((_DWORD *)v14 + 1) = *(_DWORD *)(v13 + 4);
      *((_DWORD *)v14 + 2) = *(_DWORD *)(v13 + 8);
      v14[6] = *(_WORD *)(v13 + 12);
      *(_DWORD *)&player->PersonalBestWins = *(_DWORD *)v13;
      *(_DWORD *)&player->field_235 = *(_DWORD *)(v13 + 4);
      *(_DWORD *)&player->Points = *(_DWORD *)(v13 + 8);
      player->FlagPointsHiWord = *(_WORD *)(v13 + 12);
    }
  }
  if ( (int)arena->ServersideArenaSettings.MiscTimedGame > 0 )
  {
    v15 = (int)v64;
    v16 = 0;
    player->CurrentLosses = 0;
    player->KillPoints = 0;
    *(_WORD *)v15 = 0;
    player->FlagPoints = 0;
    player->GoalCount = 0;
    v17 = player->UserId;
    if ( v17 >= 0 )
    {
      v18 = arena->ScoreStructCounter;
      if ( v18 > 0 )
      {
        v19 = arena->StructToScore;
        while ( v19->UserId != v17 )
        {
          ++v16;
          ++v19;
          if ( v16 >= v18 )
            goto LABEL_30;
        }
        *(_DWORD *)v15 = *(_DWORD *)&arena->StructToScore[v16].Wins;
        *(_DWORD *)(v15 + 4) = *(_DWORD *)&arena->StructToScore[v16].Goals;
        *(_DWORD *)(v15 + 8) = arena->StructToScore[v16].KillPoints;
        *(_WORD *)(v15 + 12) = arena->StructToScore[v16].FlagPoints;
      }
LABEL_30:
      if ( v16 == arena->ScoreStructCounter )
      {
        *(_DWORD *)v15 = 0;
        *(_DWORD *)(v15 + 4) = 0;
        *(_DWORD *)(v15 + 8) = 0;
        *(_WORD *)(v15 + 12) = 0;
      }
    }
  }
  v20 = arena->ServersideArenaSettings.MiscMaxLossesToPlay;
  if ( v20 > 0 && (unsigned __int16)player->CurrentLosses >= v20 )
    player->Ship = 8;
  if ( !player->isModerator )
  {
    v21 = arena->ServersideArenaSettings.MiscMaxPlaying;
    if ( v21 > 0 )
    {
      v22 = arena->ArenaPlayerCount;
      v23 = 0;
      if ( v22 > 0 )
      {
        v24 = arena->playerPointersForSomething;
        do
        {
          if ( (*v24)->Ship != 8 )
            ++v23;
          ++v24;
          --v22;
        }
        while ( v22 );
      }
      if ( v23 > v21 )
        player->Ship = 8;
    }
  }
  if ( player->DemoPlayer )
  {
    v25 = player->Ship;
    if ( v25 == 5 || v25 == 6 || v25 == 4 || v25 == 7 )
      player->Ship = 8;
  }
  if ( arena->ArenaLocked )
    player->Ship = 8;
  v60 = player->Name;
  if ( player->Ship == 8 )
  {
    printf("Player spectating game: %s\n", v60);
    player->Frequency = arena->ServersideArenaSettings.TeamSpectatorFrequency;
  }
  else
  {
    printf("Player entering game: %s\n", v60);
    v26 = GetNextFrequencyToJoin(arena);
    player->Frequency = v26;
    if ( arena->ServersideArenaSettings.MiscFrequencyShipTypes )
      player->Ship = v26 % 8;
  }
  SendPlayerReliablePacket(player, (char *)&arena->ArenaSettings, 1428, 1);
  if ( arena->ServersideArenaSettings.FlagMode == 2 )
  {
    v27 = arena->someCounterBefore;
    buf = 34;
    v28 = &v96;
    if ( v27 > 0 )
    {
      v29 = &arena->gap_186A2[8];
      v30 = v27;
      do
      {
        v31 = *(_WORD *)v29;
        v29 += 16;
        *(_WORD *)v28 = v31;
        v28 += 2;
        --v30;
      }
      while ( v30 );
    }
    SendPlayerReliablePacket(player, &buf, 2 * v27 + 1, 1);
  }
  else
  {
    v32 = 0;
    if ( arena->someCounterBefore > 0 )
    {
      v33 = &arena->Pointer;
      do
      {
        if ( v33[2] == -1 && *v33 >= 0 && v33[1] >= 0 )
        {
          v34 = *((_WORD *)v33 + 2);
          v35 = *((_WORD *)v33 + 6);
          v68 = *(_WORD *)v33;
          v69 = v34;
          String = 18;
          v70 = v35;
          v67 = v32;
          SendPlayerReliablePacket(player, &String, 9, 1);
        }
        ++v32;
        v33 += 4;
      }
      while ( v32 < arena->someCounterBefore );
    }
  }
  v63 = 0;
  memset(v93, 0, sizeof(v93));
  v36 = v94;
  if ( arena->ArenaPlayerCount > 0 )
  {
    v62 = arena->playerPointersForSomething;
    do
    {
      v37 = (int)v62;
      *v36 = 3;
      v38 = *(_DWORD *)v37;
      *(_WORD *)(v36 + 51) = *(_WORD *)(*(_DWORD *)v37 + 20);
      *(_WORD *)(v36 + 59) = *(_WORD *)(v38 + 611);
      v36[2] = *(_BYTE *)(v38 + 615);
      *(_WORD *)(v36 + 53) = *(_WORD *)(v38 + 279);
      v36[1] = *(_BYTE *)(v38 + 275);
      *(_WORD *)(v36 + 55) = *(_WORD *)(v38 + 547);
      *(_WORD *)(v36 + 57) = *(_WORD *)(v38 + 549);
      *(_DWORD *)(v36 + 43) = *(_DWORD *)(v38 + 553);
      *(_DWORD *)(v36 + 47) = *(_DWORD *)(v38 + 557);
      v36[63] = *(_DWORD *)(v38 + 785) != 0;
      strncpy(v36 + 3, (const char *)(v38 + 375), 0x14u);
      v36[22] = 0;
      strncpy(v36 + 23, (const char *)(v38 + 399), 0x14u);
      v39 = arena->ArenaSettings.CarryFlags;
      v36[42] = 0;
      *(_WORD *)(v36 + 61) = 0;
      if ( v39 )
      {
        v40 = arena->someCounterBefore;
        if ( v40 > 0 )
        {
          v41 = *(__int16 *)(v36 + 51);
          v42 = &arena->gap_186A2[4];
          do
          {
            if ( *(_DWORD *)v42 == v41 )
              ++*(_WORD *)(v36 + 61);
            v42 += 16;
            --v40;
          }
          while ( v40 );
        }
      }
      v36 += 64;
      if ( (unsigned int)(v36 - v94 + 64) > 0x1CC )
      {
        SendPlayerReliablePacket(player, v94, v36 - v94, 1);
        v36 = v94;
      }
      v43 = ++v63 < arena->ArenaPlayerCount;
      ++v62;
    }
    while ( v43 );
  }
  if ( v36 != v94 )
    SendPlayerReliablePacket(player, v94, v36 - v94, 1);
  v44 = arena->ArenaPlayerCount;
  v63 = 0;
  if ( v44 > 0 )
  {
    v62 = arena->playerPointersForSomething;
    do
    {
      v45 = *v62;
      if ( (*v62)->FlagPoints + (*v62)->KillPoints >= arena->ServersideArenaSettings.MiscBannerPoints || v45->dword30 )
      {
        v65 = v45->BannerData;
        if ( memcmp(v93, v45->BannerData, 0x60u) )
        {
          v46 = v45->PlayerId;
          v90 = 31;
          v91 = v46;
          qmemcpy(v92, v65, sizeof(v92));
          SendPlayerReliablePacket(player, &v90, 99, 1);
        }
      }
      v43 = ++v63 < arena->ArenaPlayerCount;
      ++v62;
    }
    while ( v43 );
  }
  v47 = 16 * arena->NumOfBricksInArena;
  v97 = 33;
  qmemcpy(v98, arena->Bricks, v47);
  SendPlayerReliablePacket(player, &v97, v47 + 1, 1);
  v87 = 41;
  strcpy(v88, arena->szLevelFile1);
  v89 = *(_DWORD *)&arena->dwLastConfigReadTime[20];
  SendPlayerReliablePacket(player, &v87, 21, 1);
  if ( AdvertiseSendMode == 3 || AdvertiseSendMode == 1 )
    SendAdvertisement(player, 1);
  v61 = 2;
  SendPlayerReliablePacket(player, &v61, 1, 1);
  player->XPixels = -9999;
  player->YPixels = -9999;
  v48 = arena->RandomTimesRandom2;
  v49 = arena->GetTickCountValue6;
  v73 = arena->RandomTimesRandom1;
  v71 = 24;
  v72 = v48;
  v74 = v49;
  v75 = 0;
  SendPlayerReliablePacket(player, &v71, 17, 1);
  v50 = player->PlayerId;
  v51 = player->Frequency;
  v76[1] = player->Ship;
  v52 = player->AllowAudioByte1;
  v81 = v50;
  v53 = player->AttachedToPlayerId;
  v76[2] = v52;
  v54 = player->CurrentLosses;
  v82 = v51;
  v84 = v54;
  v85 = v53;
  v55 = player->KillPoints;
  v83 = *v64;
  v56 = player->FlagPoints;
  v76[0] = 3;
  v79 = v55;
  v80 = v56;
  v86 = 0;
  strncpy(Dest, player->Name, 0x14u);
  Dest[19] = 0;
  strncpy(v78, player->Squad, 0x14u);
  v78[19] = 0;
  SendEverybodyButYourself(player, v76, 0x40u, 1);
  if ( player->KillPoints + player->FlagPoints >= arena->ServersideArenaSettings.MiscBannerPoints || player->dword30 )
  {
    if ( memcmp(v93, player->BannerData, 0x60u) )
    {
      v91 = player->PlayerId;
      v90 = 31;
      qmemcpy(v92, player->BannerData, sizeof(v92));
      SendEverybodyButYourself(player, &v90, 0x63u, 1);
    }
  }
  v57 = v64;
  v58 = *((_DWORD *)v64 + 1);
  player->dword23F = *(_DWORD *)v64;
  v59 = *((_DWORD *)v57 + 2);
  *(_DWORD *)&player->dword243 = v58;
  LOWORD(v58) = v57[6];
  *(_DWORD *)&player->dword247 = v59;
  LOWORD(player->word24B) = v58;
}
// 4314B0: using guessed type int AdvertiseSendMode;
// 4D45C0: using guessed type int CustomArenaMode;

//----- (004022D0) --------------------------------------------------------
// Arena.RemovePlayer()
__int16 __thiscall ArenaRemovePlayer(ARENA *arenaa, PLAYER *buf)
{
  PLAYER *v2; // ebx
  int v4; // eax
  int v5; // ecx
  int v6; // ecx
  int v7; // eax
  PLAYER **v8; // edi
  int v9; // ecx
  PLAYER **v10; // edx
  int v11; // ecx
  int v12; // edx
  int v13; // eax
  PLAYER **v14; // ecx
  int v15; // eax
  bool v16; // zf
  int v17; // edi
  int v18; // edx
  int v19; // eax
  SCORE *v20; // ecx
  __int16 *v21; // edx
  int v22; // eax
  int v23; // eax
  int v24; // edx
  int v25; // eax
  PLAYER *v26; // eax
  int v27; // edi
  int v28; // eax
  PLAYER **v29; // ebp
  int RecordPointsToLog; // eax
  char *v31; // ecx
  __int16 *v32; // ebx

  v2 = buf;
  UpdatePowerBallPositionsSomething(buf);
  v4 = v2->field_50;
  v5 = v2->field_54;
  v2->MyArena = 0;
  if ( v4 >= 0 && v5 >= 0 && v4 < 8 && v5 < 8 )
  {
    v6 = 251 * (v5 + 8 * v4);
    v7 = 0;
    v8 = &arenaa->PlayerPointers[v6];
    v9 = (int)v8[250];
    if ( v9 > 0 )
    {
      v10 = v8;
      while ( *v10 != v2 )
      {
        ++v7;
        ++v10;
        if ( v7 >= v9 )
          goto LABEL_11;
      }
      v11 = v9 - 1;
      v8[250] = (PLAYER *)v11;
      v8[v7] = v8[v11];
    }
  }
LABEL_11:
  v12 = arenaa->ArenaPlayerCount;
  v13 = 0;
  if ( v12 > 0 )
  {
    v14 = arenaa->playerPointersForSomething;
    while ( *v14 != v2 )
    {
      ++v13;
      ++v14;
      if ( v13 >= v12 )
        goto LABEL_17;
    }
    arenaa->ArenaPlayerCount = v12 - 1;
    memcpy(
      &arenaa->playerPointersForSomething[v13],
      &arenaa->playerPointersForSomething[v13 + 1],
      4 * (v12 - 1 + 0x3FFFFFFF * v13));
  }
LABEL_17:
  v15 = arenaa->ServersideArenaSettings.MiscTimedGame;
  v16 = v15 == 0;
  if ( v15 > 0 )
  {
    v17 = v2->UserId;
    if ( v17 >= 0 )
    {
      v18 = arenaa->ScoreStructCounter;
      v19 = 0;
      if ( v18 > 0 )
      {
        v20 = arenaa->StructToScore;
        while ( v20->UserId != v17 )
        {
          ++v19;
          ++v20;
          if ( v19 >= v18 )
            goto LABEL_25;
        }
        v21 = &arenaa->StructToScore[v19].Wins;
        *(_DWORD *)v21 = *(_DWORD *)&v2->CurrentWins;
        *((_DWORD *)v21 + 1) = *(_DWORD *)&v2->GoalCount;
        *((_DWORD *)v21 + 2) = *(int *)((char *)&v2->KillPoints + 2);
        v21[6] = HIWORD(v2->FlagPoints);
      }
LABEL_25:
      if ( v19 == arenaa->ScoreStructCounter && v19 < 1000 )
      {
        v22 = (int)arenaa + 18 * v19;
        *(_DWORD *)(v22 + 65598) = v2->UserId;
        v22 += 65602;
        *(_DWORD *)v22 = *(_DWORD *)&v2->CurrentWins;
        *(_DWORD *)(v22 + 4) = *(_DWORD *)&v2->GoalCount;
        *(_DWORD *)(v22 + 8) = *(int *)((char *)&v2->KillPoints + 2);
        *(_WORD *)(v22 + 12) = HIWORD(v2->FlagPoints);
        ++arenaa->ScoreStructCounter;
      }
    }
    v16 = arenaa->ServersideArenaSettings.MiscTimedGame == 0;
  }
  if ( v16 )
  {
    if ( arenaa->bHasScrFile )
    {
      v23 = v2->field_15F;
      if ( v23 >= 0 )
      {
        v24 = arenaa->FileContentsMemoryPointer + 18 * v23 + 4;
        *(_DWORD *)v24 = *(_DWORD *)&v2->CurrentWins;
        *(_DWORD *)(v24 + 4) = *(_DWORD *)&v2->GoalCount;
        *(_DWORD *)(v24 + 8) = *(int *)((char *)&v2->KillPoints + 2);
        *(_WORD *)(v24 + 12) = HIWORD(v2->FlagPoints);
      }
    }
  }
  if ( v2->isSysop )
  {
    v25 = v2->ArenaPlayerIndex;
    if ( v25 >= 0 )
    {
      v26 = ZonePlayerList[v25];
      LOWORD(buf) = 0x1C;
      if ( v26 )
        SendPlayerReliablePacket(v26, (char *)&buf, 2, 1);
    }
  }
  if ( ZonePlayerCount > 0 )
  {
    v27 = 0;
    *(_WORD *)((char *)&buf + 1) = v2->PlayerId;
    v28 = arenaa->ArenaPlayerCount;
    LOBYTE(buf) = 4;
    if ( v28 > 0 )
    {
      v29 = arenaa->playerPointersForSomething;
      do
      {
        if ( !(*v29)->AlreadySentReliablePacket )
          SendPlayerReliablePacket(*v29, (char *)&buf, 3, 1);
        ++v27;
        ++v29;
      }
      while ( v27 < arenaa->ArenaPlayerCount );
    }
  }
  CarryFlagsSomething(arenaa, *(_DWORD *)&v2->PlayerId, 0);
  RecordPointsToLog = arenaa->RecordPointsToLog;
  if ( !RecordPointsToLog )
  {
    v31 = (char *)&v2->word24B + 2;
    v32 = &v2->CurrentWins;
    *(_DWORD *)v32 = *(_DWORD *)v31;
    *((_DWORD *)v32 + 1) = *((_DWORD *)v31 + 1);
    *((_DWORD *)v32 + 2) = *((_DWORD *)v31 + 2);
    LOWORD(RecordPointsToLog) = *((_WORD *)v31 + 6);
    v32[6] = RecordPointsToLog;
  }
  return RecordPointsToLog;
}

//----- (00402560) --------------------------------------------------------
bool __thiscall ProcessArena(ARENA *arenaa)
{
  __int64 v3; // rax
  int v4; // edi
  PLAYER **v5; // esi
  DWORD (__stdcall *GetTickCountt)(); // ebx
  __int64 v7; // rax
  FILE *v8; // eax
  FILE *v9; // esi
  __int64 v10; // rax
  ARENA *v11; // eax
  unsigned int v12; // kr1C_4
  int v13; // edi
  PLAYER **v14; // ebx
  bool v15; // cc
  int v16; // esi
  char *v17; // ecx
  char *v18; // eax
  int v19; // edx
  __int16 v20; // di
  int v21; // ebx
  int v22; // esi
  PLAYER **v23; // edi
  __int64 v24; // rax
  int v25; // edx
  int v26; // eax
  int v27; // ebx
  PLAYER **v28; // esi
  DWORD v29; // kr04_4
  PLAYER *v30; // eax
  int v31; // eax
  int v32; // esi
  int v33; // eax
  int v34; // edx
  int v35; // ecx
  ARENA_SETTINGS *v36; // eax
  signed int v37; // ebx
  int v38; // edx
  int v39; // esi
  int v40; // edi
  PLAYER **v41; // esi
  int v42; // esi
  int v43; // esi
  int v44; // edx
  int v45; // esi
  int v46; // ecx
  int v47; // eax
  PLAYER **v48; // edi
  __int64 v49; // rax
  __int64 v50; // rax
  int v51; // eax
  int v52; // esi
  PLAYER **v53; // ebx
  int v54; // edi
  PLAYER **v55; // esi
  PLAYER *v56; // eax
  int v57; // ebx
  int v58; // ecx
  int v59; // eax
  int v60; // edi
  PLAYER **v61; // edx
  int v62; // esi
  PLAYER *v63; // eax
  int v64; // ecx
  int v65; // esi
  int v66; // eax
  PLAYER **v67; // ebx
  PLAYER **v68; // ebx
  int v69; // esi
  PLAYER *v70; // eax
  PLAYER **v71; // edi
  int v72; // esi
  PLAYER **v73; // edi
  int v74; // esi
  int v75; // eax
  __int64 v76; // rax
  int v77; // edi
  int *v78; // ebx
  int v79; // esi
  int v80; // edx
  int v81; // eax
  int *v82; // ecx
  int v83; // ecx
  PLAYER **v84; // eax
  bool v85; // zf
  int v86; // edx
  int v87; // eax
  char *v88; // ebx
  int v89; // esi
  int v90; // eax
  int v91; // ecx
  int v92; // ebx
  int v93; // ecx
  int v94; // edi
  int v95; // ecx
  PLAYER **v96; // ebx
  PLAYER *v97; // eax
  int v98; // esi
  int v99; // edi
  PLAYER **v100; // esi
  int v101; // ebx
  int v102; // eax
  PLAYER *v103; // eax
  int v104; // edi
  int v105; // ecx
  int *v106; // edx
  PLAYER *v107; // eax
  int v108; // edx
  char *v109; // eax
  int j; // ecx
  int v111; // ecx
  int v112; // esi
  PLAYER **v113; // eax
  int v114; // eax
  DWORD v115; // eax
  int v116; // ecx
  int v117; // eax
  int v118; // ebx
  int v119; // esi
  PLAYER **v120; // ecx
  int v121; // edx
  PLAYER *v122; // eax
  int v123; // edi
  PLAYER **v124; // esi
  int v125; // ebx
  PLAYER **v126; // esi
  PLAYER *v127; // eax
  int v128; // edi
  int v129; // eax
  int v130; // ecx
  int v131; // eax
  __int64 v132; // rax
  __int64 v133; // rax
  DWORD v134; // kr10_4
  int v135; // eax
  int v136; // edx
  int *v137; // ebx
  int v138; // edi
  int v139; // esi
  int v140; // eax
  int *v141; // ecx
  PLAYER **v142; // eax
  int v143; // ecx
  int *v144; // ebx
  char *v145; // edi
  int v146; // eax
  int v147; // esi
  signed int v148; // esi
  int *v149; // eax
  __int16 *v150; // edi
  __int16 v151; // cx
  PLAYER **v152; // ebx
  PLAYER *v153; // eax
  int v154; // edi
  int v155; // ebx
  PLAYER **v156; // esi
  __int64 v157; // rax
  int v158; // eax
  int v159; // esi
  PLAYER **v160; // edi
  int v161; // eax
  int v162; // esi
  PLAYER **v163; // edi
  int v164; // esi
  PLAYER **v165; // edi
  int v166; // esi
  signed int v167; // eax
  int v168; // esi
  PLAYER **v169; // edi
  DWORD v170; // eax
  PLAYER **v171; // esi
  int v172; // edi
  int v173; // ecx
  char *v174; // edx
  PLAYER *v175; // eax
  int v176; // ebx
  PLAYER **v177; // esi
  PLAYER *v178; // eax
  __int16 *v179; // ecx
  _WORD *v180; // eax
  int v181; // eax
  int v182; // ecx
  int v183; // edx
  int v184; // eax
  int v185; // esi
  PLAYER **v186; // edi
  int v187; // esi
  PLAYER **v188; // edi
  int v189; // esi
  BRICK *v190; // ebx
  BRICK *v191; // edi
  int v192; // edx
  int *v193; // esi
  __int16 *v194; // ebx
  PLAYER *v195; // eax
  int v196; // esi
  int v197; // eax
  char v198; // dl
  PLAYER **v199; // edi
  ARENA **v200; // [esp+4h] [ebp-27DCh]
  int v201; // [esp+4h] [ebp-27DCh]
  int v202; // [esp+4h] [ebp-27DCh]
  char *v203; // [esp+4h] [ebp-27DCh]
  int v204; // [esp+4h] [ebp-27DCh]
  int v205; // [esp+4h] [ebp-27DCh]
  int *v206; // [esp+8h] [ebp-27D8h]
  int v207; // [esp+8h] [ebp-27D8h]
  int v208; // [esp+8h] [ebp-27D8h]
  int *v209; // [esp+8h] [ebp-27D8h]
  int v210; // [esp+Ch] [ebp-27D4h]
  int v211; // [esp+Ch] [ebp-27D4h]
  int v212; // [esp+Ch] [ebp-27D4h]
  char *v213; // [esp+Ch] [ebp-27D4h]
  int *v214; // [esp+Ch] [ebp-27D4h]
  char *v215; // [esp+Ch] [ebp-27D4h]
  _DWORD *v216; // [esp+Ch] [ebp-27D4h]
  int v217; // [esp+10h] [ebp-27D0h]
  int v218; // [esp+10h] [ebp-27D0h]
  int v219; // [esp+10h] [ebp-27D0h]
  int v220; // [esp+10h] [ebp-27D0h]
  int SoundByte; // [esp+14h] [ebp-27CCh]
  int SoundBytea; // [esp+14h] [ebp-27CCh]
  char *SoundByteb; // [esp+14h] [ebp-27CCh]
  __int64 a3; // [esp+18h] [ebp-27C8h] BYREF
  int *i; // [esp+20h] [ebp-27C0h]
  char buf; // [esp+24h] [ebp-27BCh] BYREF
  _DWORD v227[3]; // [esp+25h] [ebp-27BBh] BYREF
  int v228; // [esp+31h] [ebp-27AFh]
  char v229; // [esp+40h] [ebp-27A0h] BYREF
  char a2[1428]; // [esp+4Ch] [ebp-2794h] BYREF
  int v231[384]; // [esp+5E0h] [ebp-2200h]
  int v232[384]; // [esp+BE0h] [ebp-1C00h] BYREF
  int v233[384]; // [esp+11E0h] [ebp-1600h] BYREF
  char v234; // [esp+17E0h] [ebp-1000h] BYREF
  char v235; // [esp+17E1h] [ebp-FFFh] BYREF

  if ( arenaa->field_10026 )
    return 1;
  v3 = (int)(GetTickCount() / 0xA - arenaa->GetTickCountValue2);
  if ( (int)((HIDWORD(v3) ^ v3) - HIDWORD(v3)) > 6000 || arenaa->playerPointersForSomething[250] )
  {
    arenaa->GetTickCountValue2 = GetTickCount() / 0xA;
    if ( IsFileLastWrittenTime(arenaa->szConfigFile, (int)arenaa->dwLastConfigReadTime)
      || arenaa->playerPointersForSomething[250] )
    {
      arenaa->playerPointersForSomething[250] = 0;
      qmemcpy(a2, &arenaa->ArenaSettings, sizeof(a2));
      LoadArenaSettings(arenaa);
      if ( !memcmp(a2, &arenaa->ArenaSettings, 0x594u) )
      {
        GetTickCountt = GetTickCount;
      }
      else
      {
        printf("Parameters resent for arena(%s)\n", arenaa->ArenaName);
        v4 = 0;
        if ( arenaa->ArenaPlayerCount > 0 )
        {
          v5 = arenaa->playerPointersForSomething;
          do
          {
            if ( !(*v5)->AlreadySentReliablePacket )
              SendPlayerReliablePacket(*v5, (char *)&arenaa->ArenaSettings, 1428, 1);
            ++v4;
            ++v5;
          }
          while ( v4 < arenaa->ArenaPlayerCount );
        }
        GetTickCountt = GetTickCount;
        arenaa->field_FF38 = 0;
        arenaa->MapLVLChecksum = 0;
      }
    }
    else
    {
      GetTickCountt = GetTickCount;
    }
    v7 = (int)(GetTickCountt() / 0xA - arenaa->LastSaveStatsTime);
    if ( (signed int)((HIDWORD(v7) ^ v7) - HIDWORD(v7)) > arenaa->ServersideArenaSettings.CustomSaveStatsTime )
    {
      if ( arenaa->FileContentsMemoryPointer )
      {
        arenaa->LastSaveStatsTime = GetTickCountt() / 0xA;
        if ( arenaa->bHasScrFile )
        {
          strcpy(&buf, arenaa->ArenaName);
          strcat(&buf, ".scr");
          v8 = fopen(&buf, "wb");
          v9 = v8;
          if ( v8 )
          {
            fwrite((const void *)arenaa->FileContentsMemoryPointer, 0x12u, arenaa->NumberOfContents18ByteBlocks, v8);
            fclose(v9);
          }
        }
      }
    }
    v10 = (int)(GetTickCountt() / 0xA - arenaa->LastCheckArenaEmptyTime);
    if ( (int)((HIDWORD(v10) ^ v10) - HIDWORD(v10)) > 60000
      && arenaa->ArenaPlayerCount < ArenaMinimumPlayers
      && !arenaa->ArenaName[0] )
    {
      v210 = 0;
      if ( ArenaArrayLength > 0 )
      {
        v200 = Arenas;
        do
        {
          v11 = *v200;
          if ( *v200 == arenaa )
            break;
          if ( v11->ArenaPlayerCount < ArenaDesiredPlayers && !v11->ArenaName[0] )
          {
            a2[0] = 7;
            a2[1] = 0;
            a2[2] = 2;
            *(_WORD *)&a2[3] = 0;
            strcpy(&a2[5], "Long range scanners indicate enemy activity in another quadrant, type ?GO to warp.");
            v12 = strlen("Long range scanners indicate enemy activity in another quadrant, type ?GO to warp.") + 1;
            v13 = 0;
            if ( arenaa->ArenaPlayerCount > 0 )
            {
              v14 = arenaa->playerPointersForSomething;
              do
              {
                if ( !(*v14)->AlreadySentReliablePacket )
                  SendPlayerReliablePacket(*v14, a2, v12 - 1 + 6, 1);
                ++v13;
                ++v14;
              }
              while ( v13 < arenaa->ArenaPlayerCount );
            }
            GetTickCountt = GetTickCount;
            arenaa->LastCheckArenaEmptyTime = GetTickCount() / 0xA;
          }
          v15 = ++v210 < ArenaArrayLength;
          ++v200;
        }
        while ( v15 );
      }
    }
    if ( arenaa->ServersideArenaSettings.FlagMode == 2 )
    {
      v16 = arenaa->someCounterBefore;
      v234 = 34;
      v17 = &v235;
      if ( v16 > 0 )
      {
        v18 = &arenaa->gap_186A2[8];
        v19 = v16;
        do
        {
          v20 = *(_WORD *)v18;
          v18 += 16;
          *(_WORD *)v17 = v20;
          v17 += 2;
          --v19;
        }
        while ( v19 );
      }
      v21 = 2 * v16 + 1;
      v22 = 0;
      if ( arenaa->ArenaPlayerCount > 0 )
      {
        v23 = arenaa->playerPointersForSomething;
        do
        {
          if ( !(*v23)->AlreadySentReliablePacket )
            SendPlayerReliablePacket(*v23, &v234, v21, 1);
          ++v22;
          ++v23;
        }
        while ( v22 < arenaa->ArenaPlayerCount );
      }
    }
    else
    {
      v24 = (int)(GetTickCountt() / 0xA - arenaa->field_FF4E);
      if ( (int)((HIDWORD(v24) ^ v24) - HIDWORD(v24)) > 12000 )
      {
        if ( arenaa->someCounterBefore < *(_DWORD *)arenaa->gap_FF6A )
        {
          do
          {
            *(&arenaa->Pointer + 4 * arenaa->someCounterBefore) = -1;
            *(_DWORD *)&arenaa->gap_186A2[16 * arenaa->someCounterBefore] = -1;
            *(_DWORD *)&arenaa->gap_186A2[16 * arenaa->someCounterBefore + 4] = -1;
            *(_DWORD *)&arenaa->gap_186A2[16 * arenaa->someCounterBefore + 8] = -1;
            v25 = arenaa->someCounterBefore + 1;
            arenaa->someCounterBefore = v25;
          }
          while ( v25 < *(_DWORD *)arenaa->gap_FF6A );
        }
        v26 = *(_DWORD *)arenaa->gap_FF6A;
        if ( arenaa->someCounterBefore > v26 )
          arenaa->someCounterBefore = v26;
      }
      FlagPositionUpdateSomething(arenaa, 1);
    }
    v27 = 0;
    if ( arenaa->ArenaPlayerCount > 0 )
    {
      v28 = arenaa->playerPointersForSomething;
      do
      {
        if ( (*v28)->field_B4 )
        {
          v29 = GetTickCount();
          v30 = *v28;
          if ( (int)(v29 / 0xA - (*v28)->field_B4) > 5000 && !v30->isSuperModerator )
          {
            if ( arenaa->ServersideArenaSettings.dwordB4 )
            {
              WriteSubGameLog("Player kicked off for not returning security packet: %s\n", v30->PlayerName);
              (*v28)->DisconnectReason = 13;
              (*v28)->AlreadySentReliablePacket = 1;
            }
            if ( GetRelAckDiff((*v28)->encryptionPointer, 0) < 3 )
            {
              sprintf(a2, "WARNING: Security checksum not returned {st=%d,et=%d}", (*v28)->field_B4, v29 / 0xA);
              SendBillerWarnings(a2, *v28);
            }
          }
          (*v28)->field_B4 = 0;
        }
        ++v27;
        ++v28;
      }
      while ( v27 < arenaa->ArenaPlayerCount );
    }
    v31 = arenaa->ServersideArenaSettings.SoccerBallCount;
    if ( arenaa->TotalSoccerBalls != v31 )
    {
      v32 = 0;
      arenaa->TotalSoccerBalls = v31;
      while ( v32 < arenaa->TotalSoccerBalls )
        CreateSoccerBall(arenaa, v32++);
    }
    v33 = arenaa->field_FF30;
    arenaa->field_FF30 = v33 + 1;
    if ( (v33 & 1) != 0 )
    {
      v34 = rand() % 500;
      v35 = 0;
      v36 = &arenaa->ArenaSettings;
      arenaa->field_FF34 = v34;
      v37 = *(_DWORD *)&Security[0].ScrtyData[8 * v34];
      v38 = 357;
      do
      {
        v39 = v36->VersionAndManyBitFields;
        v36 = (ARENA_SETTINGS *)((char *)v36 + 4);
        v35 += v37 ^ v39;
        --v38;
      }
      while ( v38 );
      arenaa->field_FF38 = v35;
      arenaa->MapLVLChecksum = GenerateLVLChecksum(arenaa->MapAllocatedMemory, v37);
      if ( v37 )
      {
        v40 = 0;
        if ( arenaa->ArenaPlayerCount > 0 )
        {
          v41 = arenaa->playerPointersForSomething;
          do
          {
            if ( !(*v41)->AlreadySentReliablePacket && !(*v41)->field_309 )
              (*v41)->field_B4 = GetTickCount() / 0xA;
            ++v40;
            ++v41;
          }
          while ( v40 < arenaa->ArenaPlayerCount );
        }
      }
      v42 = rand();
      arenaa->RandomTimesRandom1 = rand() * v42;
      v43 = rand();
      arenaa->RandomTimesRandom2 = rand() * v43;
      v44 = (GetTickCount() / 0xA) & 0x7FFFFFFF;
      v45 = 0;
      arenaa->GetTickCountValue6 = v44;
      v46 = arenaa->RandomTimesRandom2;
      v227[1] = arenaa->RandomTimesRandom1;
      v47 = arenaa->ArenaPlayerCount;
      buf = 24;
      v227[0] = v46;
      v227[2] = v44;
      v228 = v37;
      if ( v47 > 0 )
      {
        v48 = arenaa->playerPointersForSomething;
        do
        {
          if ( !(*v48)->AlreadySentReliablePacket )
            SendPlayerReliablePacket(*v48, &buf, 17, 1);
          ++v45;
          ++v48;
        }
        while ( v45 < arenaa->ArenaPlayerCount );
      }
    }
  }
  v49 = (int)(GetTickCount() / 0xA - *(_DWORD *)arenaa->gap_FF4A);
  if ( (int)((HIDWORD(v49) ^ v49) - HIDWORD(v49)) > 200 )
  {
    *(_DWORD *)arenaa->gap_FF4A = GetTickCount() / 0xA;
    if ( (int)arenaa->ServersideArenaSettings.KingDeathCount > 0 )
    {
      if ( arenaa->GetTickCountValue1 )
      {
        v50 = (int)(GetTickCount() / 0xA - arenaa->GetTickCountValue1);
        if ( (int)((HIDWORD(v50) ^ v50) - HIDWORD(v50)) > 12000 )
        {
          if ( arenaa->ArenaPlayerCount > 2 )
          {
            arenaa->GetTickCountValue1 = 0;
            *(_DWORD *)((char *)&a3 + 2) = arenaa->ServersideArenaSettings.KingExpireTime;
            v51 = arenaa->ArenaPlayerCount;
            v52 = 0;
            LOWORD(a3) = 300;
            HIWORD(a3) = -1;
            if ( v51 > 0 )
            {
              v53 = arenaa->playerPointersForSomething;
              do
              {
                if ( !(*v53)->AlreadySentReliablePacket )
                  SendPlayerReliablePacket(*v53, (char *)&a3, 8, 1);
                ++v52;
                ++v53;
              }
              while ( v52 < arenaa->ArenaPlayerCount );
            }
            v54 = 0;
            if ( arenaa->ArenaPlayerCount > 0 )
            {
              v55 = arenaa->playerPointersForSomething;
              do
              {
                SendMessage(*v55, "King of the Hill restarted", 103);
                v56 = *v55;
                ++v54;
                ++v55;
                v56->KotHDeathCount = arenaa->ServersideArenaSettings.KingDeathCount;
              }
              while ( v54 < arenaa->ArenaPlayerCount );
            }
            arenaa->field_1001A = arenaa->ArenaPlayerCount
                                * arenaa->ArenaPlayerCount
                                * arenaa->ServersideArenaSettings.KingRewardFactor
                                / 1000;
          }
          else
          {
            arenaa->GetTickCountValue1 = GetTickCount() / 0xA;
          }
        }
      }
      else
      {
        v57 = arenaa->ArenaPlayerCount;
        v58 = -1;
        v59 = 0;
        v60 = 1;
        v201 = 0;
        if ( v57 > 0 )
        {
          v61 = arenaa->playerPointersForSomething;
          v62 = arenaa->ArenaPlayerCount;
          do
          {
            v63 = *v61;
            if ( (int)(*v61)->KotHDeathCount > 0 )
            {
              if ( v58 == -1 )
                v58 = v63->Frequency;
              if ( v63->Frequency == v58 )
                ++v201;
              else
                v60 = 0;
            }
            ++v61;
            --v62;
          }
          while ( v62 );
          v59 = v201;
        }
        if ( v60 )
        {
          v64 = v59;
          if ( v59 <= 1 )
            v64 = 1;
          v65 = 0;
          v66 = arenaa->field_1001A / v64;
          strcpy((char *)&a3, ",");
          HIWORD(a3) = -1;
          v211 = v66;
          if ( v57 > 0 )
          {
            v67 = arenaa->playerPointersForSomething;
            do
            {
              if ( !(*v67)->AlreadySentReliablePacket )
                SendPlayerReliablePacket(*v67, (char *)&a3, 8, 1);
              ++v65;
              ++v67;
            }
            while ( v65 < arenaa->ArenaPlayerCount );
          }
          SoundByte = 103;
          arenaa->GetTickCountValue1 = GetTickCount() / 0xA;
          v202 = 0;
          if ( arenaa->ArenaPlayerCount > 0 )
          {
            v68 = arenaa->playerPointersForSomething;
            do
            {
              v69 = 0;
              if ( (int)(*v68)->KotHDeathCount > 0 )
              {
                (*v68)->KotHDeathCount = 0;
                (*v68)->FlagPoints += v211;
                v70 = *v68;
                buf = 9;
                LOWORD(v227[0]) = v70->PlayerId;
                *(_QWORD *)((char *)v227 + 2) = *(_QWORD *)&v70->KillPoints;
                HIWORD(v227[2]) = v70->CurrentWins;
                LOWORD(v228) = v70->CurrentLosses;
                if ( arenaa->ArenaPlayerCount > 0 )
                {
                  v71 = arenaa->playerPointersForSomething;
                  do
                  {
                    if ( !(*v71)->AlreadySentReliablePacket )
                      SendPlayerReliablePacket(*v71, &buf, 15, 1);
                    ++v69;
                    ++v71;
                  }
                  while ( v69 < arenaa->ArenaPlayerCount );
                }
                sprintf(a2, "King of the Hill: %s given %d points", (*v68)->Name, v211);
                v72 = 0;
                if ( arenaa->ArenaPlayerCount > 0 )
                {
                  v73 = arenaa->playerPointersForSomething;
                  do
                  {
                    SendMessage(*v73, a2, SoundByte);
                    ++v72;
                    ++v73;
                  }
                  while ( v72 < arenaa->ArenaPlayerCount );
                }
                SoundByte = 0;
              }
              ++v68;
              ++v202;
            }
            while ( v202 < arenaa->ArenaPlayerCount );
          }
        }
      }
    }
    v74 = arenaa->someCounterBefore;
    if ( v74 <= 0 )
    {
LABEL_295:
      if ( arenaa->GameTimeStart > 0 )
      {
        v157 = (int)(GetTickCount() / 0xA - arenaa->GameTimePassed);
        v158 = arenaa->GameTimeStart - ((HIDWORD(v157) ^ v157) - HIDWORD(v157));
        if ( v158 > 0 )
        {
          if ( v158 >= 6000 || arenaa->field_FF56 >= 2 )
          {
            if ( v158 < 30000 && v158 > 29000 && arenaa->field_FF56 < 1 )
            {
              arenaa->field_FF56 = 1;
              v164 = 0;
              if ( arenaa->ArenaPlayerCount > 0 )
              {
                v165 = arenaa->playerPointersForSomething;
                do
                {
                  SendMessage(*v165, "NOTICE: 5 minutes remaining.", 0);
                  ++v164;
                  ++v165;
                }
                while ( v164 < arenaa->ArenaPlayerCount );
              }
            }
          }
          else
          {
            v161 = arenaa->ArenaPlayerCount;
            v162 = 0;
            arenaa->field_FF56 = 2;
            if ( v161 > 0 )
            {
              v163 = arenaa->playerPointersForSomething;
              do
              {
                SendMessage(*v163, "NOTICE: 1 minute remaining.", 0);
                ++v162;
                ++v163;
              }
              while ( v162 < arenaa->ArenaPlayerCount );
            }
          }
        }
        else
        {
          v159 = 0;
          if ( arenaa->ArenaPlayerCount > 0 )
          {
            v160 = arenaa->playerPointersForSomething;
            do
            {
              SendMessage(*v160, "NOTICE: Game over", 5);
              ++v159;
              ++v160;
            }
            while ( v159 < arenaa->ArenaPlayerCount );
          }
          arenaa->GameTimeStart = 0;
          arenaa->field_FF56 = 0;
        }
      }
      if ( (int)arenaa->ServersideArenaSettings.MiscTimedGame > 0 )
      {
        v166 = arenaa->GameTimePassedTwo;
        v167 = arenaa->ServersideArenaSettings.MiscTimedGame - abs32(GetTickCount() / 0xA - v166);
        if ( !v166 )
          v167 = -1;
        if ( v167 > 0 )
        {
          if ( v167 >= 6000 || arenaa->field_FF20 >= 2 )
          {
            if ( v167 < 30000 && arenaa->field_FF20 < 1 )
            {
              arenaa->field_FF20 = 1;
              v187 = 0;
              if ( arenaa->ArenaPlayerCount > 0 )
              {
                v188 = arenaa->playerPointersForSomething;
                do
                {
                  SendMessage(*v188, "NOTICE: 5 minutes remaining in current game.", 0);
                  ++v187;
                  ++v188;
                }
                while ( v187 < arenaa->ArenaPlayerCount );
              }
            }
          }
          else
          {
            v184 = arenaa->ArenaPlayerCount;
            v185 = 0;
            arenaa->field_FF20 = 2;
            if ( v184 > 0 )
            {
              v186 = arenaa->playerPointersForSomething;
              do
              {
                SendMessage(
                  *v186,
                  "NOTICE: 1 minute remaining in current game.",
                  arenaa->ArenaSettings.VictoryMusic != 0 ? 0x64 : 0);
                ++v185;
                ++v186;
              }
              while ( v185 < arenaa->ArenaPlayerCount );
            }
          }
        }
        else
        {
          if ( arenaa->ServersideArenaSettings.SoccerCapturePoints && arenaa->ServersideArenaSettings.SoccerBallCount )
          {
            GetScore(arenaa, 0);
            v168 = 0;
            if ( arenaa->ArenaPlayerCount > 0 )
            {
              v169 = arenaa->playerPointersForSomething;
              do
              {
                SendMessage(*v169, "Soccer game over.", 103);
                ++v168;
                ++v169;
              }
              while ( v168 < arenaa->ArenaPlayerCount );
            }
            ArenaScoreReset(arenaa, 1);
            arenaa->ScoreStructCounter = 0;
            v170 = GetTickCount();
          }
          else
          {
            v171 = arenaa->playerPointersForSomething;
            qsort(arenaa->playerPointersForSomething, arenaa->ArenaPlayerCount, 4u, PtFuncCompare);
            v172 = arenaa->ArenaPlayerCount;
            buf = 36;
            v173 = 0;
            v174 = &v229;
            v216 = (_DWORD *)((char *)&v227[1] + 3);
            do
            {
              if ( v173 >= v172 )
              {
                *(_WORD *)v174 = -1;
              }
              else
              {
                v175 = *v171;
                *(_WORD *)v174 = (*v171)->PlayerId;
                *v216 = v175->FlagPoints + v175->KillPoints;
              }
              ++v173;
              ++v171;
              v174 += 2;
              ++v216;
            }
            while ( v173 < 5 );
            v176 = 0;
            if ( v172 > 0 )
            {
              v177 = arenaa->playerPointersForSomething;
              do
              {
                v178 = *v177;
                *(_DWORD *)((char *)v227 + 3) = (*v177)->FlagPoints + (*v177)->KillPoints;
                *(_WORD *)((char *)v227 + 1) = v176 + 1;
                if ( *(_DWORD *)&v178->PersonalBestGoalCount + *(_DWORD *)&v178->PersonalBestPoints1of2 >= *(_DWORD *)((char *)v227 + 3) )
                {
                  LOBYTE(v227[0]) = 0;
                }
                else if ( v172 > 10 )
                {
                  v179 = &v178->CurrentWins;
                  LOBYTE(v227[0]) = 1;
                  v180 = &v178->PersonalBestWins;
                  *(_DWORD *)v180 = *(_DWORD *)v179;
                  *((_DWORD *)v180 + 1) = *((_DWORD *)v179 + 1);
                  *((_DWORD *)v180 + 2) = *((_DWORD *)v179 + 2);
                  v180[6] = v179[6];
                  if ( arenaa->bHasScrFile )
                  {
                    v181 = (*v177)->field_15F;
                    if ( v181 >= 0 )
                    {
                      v182 = (int)&(*v177)->PersonalBestWins;
                      v183 = arenaa->FileContentsMemoryPointer + 18 * v181 + 4;
                      *(_DWORD *)v183 = *(_DWORD *)v182;
                      *(_DWORD *)(v183 + 4) = *(_DWORD *)(v182 + 4);
                      *(_DWORD *)(v183 + 8) = *(_DWORD *)(v182 + 8);
                      *(_WORD *)(v183 + 12) = *(_WORD *)(v182 + 12);
                    }
                  }
                  else if ( BillingConnectionStructPointer && arenaa->RecordPointsToLog )
                  {
                    SendBillerUserScorePacket(
                      (ENCRYPTION **)BillingConnectionStructPointer,
                      (*v177)->BillerPlayerId,
                      &(*v177)->PersonalBestWins,
                      0xEu);
                  }
                }
                SendPlayerReliablePacket(*v177, &buf, 38, 1);
                v172 = arenaa->ArenaPlayerCount;
                ++v176;
                ++v177;
              }
              while ( v176 < v172 );
            }
            ArenaScoreReset(arenaa, 0);
            arenaa->ScoreStructCounter = 0;
            v170 = GetTickCount();
          }
          arenaa->GameTimePassedTwo = v170 / 0xA;
          arenaa->field_FF20 = 0;
          SoccerGameSomething(arenaa, -1);
        }
      }
      v205 = 0;
      if ( arenaa->NumOfBricksInArena > 0 )
      {
        v189 = 0;
        v190 = arenaa->Bricks;
        v191 = &arenaa->Bricks[1];
        v209 = &arenaa->Bricks[0].BrickTimeStamp;
        do
        {
          if ( (int)abs32(GetTickCount() / 0xA - *v209) > (__int16)arenaa->ArenaSettings.BrickTime )
          {
            v192 = arenaa->NumOfBricksInArena - 1;
            arenaa->NumOfBricksInArena = v192;
            memcpy(v190, v191, 16 * (v189 + v192));
            v189 -= 0xFFFFFFF;
            --v191;
            --v205;
            v209 -= 4;
            --v190;
          }
          v189 += 0xFFFFFFF;
          ++v191;
          ++v190;
          v15 = ++v205 < arenaa->NumOfBricksInArena;
          v209 += 4;
        }
        while ( v15 );
      }
      goto LABEL_358;
    }
    v75 = arenaa->ServersideArenaSettings.FlagMode;
    if ( v75 == 2 )
    {
      v76 = (int)(GetTickCount() / 0xA - arenaa->TerritoryRewardTimePassed);
      if ( (signed int)((HIDWORD(v76) ^ v76) - HIDWORD(v76)) > arenaa->ServersideArenaSettings.TerritoryRewardDelay )
      {
        arenaa->TerritoryRewardTimePassed = GetTickCount() / 0xA;
        if ( arenaa->ArenaPlayerCount >= 16 )
        {
          v77 = 0;
          SoundBytea = 0;
          if ( arenaa->someCounterBefore > 0 )
          {
            v78 = v232;
            v203 = &arenaa->gap_186A2[8];
            v79 = 0;
            v212 = arenaa->someCounterBefore;
            do
            {
              v80 = *(_DWORD *)v203;
              if ( *(int *)v203 >= 0 )
              {
                v81 = 0;
                if ( v79 > 0 )
                {
                  v82 = v233;
                  while ( *v82 != v80 )
                  {
                    ++v81;
                    ++v82;
                    if ( v81 >= v77 )
                      goto LABEL_140;
                  }
                  ++v231[v81];
                }
LABEL_140:
                if ( v81 == v77 )
                {
                  v83 = arenaa->ArenaPlayerCount;
                  v233[v79] = v80;
                  v231[v79] = 1;
                  *v78 = 0;
                  if ( v83 > 0 )
                  {
                    v84 = arenaa->playerPointersForSomething;
                    do
                    {
                      if ( (*v84)->Frequency == v80 )
                        ++*v78;
                      ++v84;
                      --v83;
                    }
                    while ( v83 );
                    v77 = SoundBytea;
                  }
                  ++v77;
                  ++v79;
                  SoundBytea = v77;
                  ++v78;
                }
              }
              v85 = v212 == 1;
              v203 += 16;
              --v212;
            }
            while ( !v85 );
          }
          v86 = 0;
          v87 = 0;
          i = 0;
          if ( v77 > 0 )
          {
            do
            {
              if ( v232[v87] >= arenaa->ServersideArenaSettings.TerritoryRewardMinimumPlayers
                && v231[v87] >= arenaa->ServersideArenaSettings.TerritoryRewardBaseFlags )
              {
                ++v86;
              }
              ++v87;
            }
            while ( v87 < v77 );
            i = (int *)v86;
          }
          if ( v86 > 1 )
          {
            v88 = &a2[1];
            a2[0] = 35;
            v213 = &a2[1];
            v204 = 0;
            if ( v77 > 0 )
            {
              v206 = v233;
              do
              {
                v89 = v232[v204];
                if ( v89 >= arenaa->ServersideArenaSettings.TerritoryRewardMinimumPlayers )
                {
                  v90 = v231[v204];
                  v91 = arenaa->ServersideArenaSettings.TerritoryRewardBaseFlags;
                  if ( v90 >= v91 )
                  {
                    v92 = arenaa->ArenaPlayerCount;
                    v93 = v92 * arenaa->ServersideArenaSettings.TerritoryRewardPoints * ((_DWORD)i - 1) * (v90 - v91);
                    v94 = v93 / 50 / v89;
                    if ( v94 > 0 )
                    {
                      *(_WORD *)v213 = *(_WORD *)v206;
                      v95 = v93 / 50 / v89;
                      if ( v94 >= 30000 )
                        LOWORD(v95) = 30000;
                      *((_WORD *)v213 + 1) = v95;
                      v213 += 4;
                      v217 = 0;
                      if ( v92 > 0 )
                      {
                        v96 = arenaa->playerPointersForSomething;
                        LODWORD(a3) = *v206;
                        do
                        {
                          v97 = *v96;
                          if ( (*v96)->Frequency == (_DWORD)a3 && v97->Ship != 8 && (v97->ShipTogglables & 0x20) == 0 )
                          {
                            v98 = v97->KillPoints + v97->FlagPoints;
                            UpdatePoints(v97, 0, v94);
                            if ( v98 < AutoPermissionPoints
                              && AutoPermissionPoints > 0
                              && (*v96)->KillPoints + (*v96)->FlagPoints >= AutoPermissionPoints )
                            {
                              SendMessage(*v96, PermissionAutoPermissionMessage, 0);
                            }
                          }
                          ++v96;
                          ++v217;
                        }
                        while ( v217 < arenaa->ArenaPlayerCount );
                      }
                    }
                  }
                }
                v15 = ++v204 < SoundBytea;
                ++v206;
              }
              while ( v15 );
              v88 = v213;
            }
            v99 = 0;
            if ( arenaa->ArenaPlayerCount > 0 )
            {
              v100 = arenaa->playerPointersForSomething;
              do
              {
                if ( !(*v100)->AlreadySentReliablePacket )
                  SendPlayerReliablePacket(*v100, a2, v88 - a2, 1);
                ++v99;
                ++v100;
              }
              while ( v99 < arenaa->ArenaPlayerCount );
            }
            dword_4C8F3C = 0;
          }
        }
      }
      goto LABEL_250;
    }
    if ( v75 && v75 != 1 || (int)arenaa->ServersideArenaSettings.FlagReward <= 0 )
    {
LABEL_250:
      if ( (int)arenaa->ServersideArenaSettings.PeriodicRewardDelay > 0 )
      {
        v133 = (int)(GetTickCount() / 0xA - arenaa->GetTickCountValue4);
        if ( (signed int)((HIDWORD(v133) ^ v133) - HIDWORD(v133)) > arenaa->ServersideArenaSettings.PeriodicRewardDelay )
        {
          v134 = GetTickCount();
          v135 = arenaa->ServersideArenaSettings.PeriodicRewardMinimumPlayers;
          arenaa->GetTickCountValue4 = v134 / 0xA;
          v136 = arenaa->ArenaPlayerCount;
          if ( v136 > v135 )
          {
            v208 = 0;
            if ( arenaa->someCounterBefore > 0 )
            {
              v137 = v233;
              v214 = v233;
              SoundByteb = &arenaa->gap_186A2[8];
              v138 = 0;
              v218 = arenaa->someCounterBefore;
              do
              {
                v139 = *(_DWORD *)SoundByteb;
                if ( *(int *)SoundByteb >= 0 )
                {
                  v140 = 0;
                  if ( v138 > 0 )
                  {
                    v141 = v232;
                    while ( *v141 != v139 )
                    {
                      ++v140;
                      ++v141;
                      if ( v140 >= v208 )
                        goto LABEL_262;
                    }
                    ++v231[v140];
                  }
LABEL_262:
                  if ( v140 == v208 )
                  {
                    v232[v138] = v139;
                    v231[v138] = 1;
                    *v137 = 0;
                    if ( v136 > 0 )
                    {
                      v142 = arenaa->playerPointersForSomething;
                      v143 = v136;
                      do
                      {
                        v137 = v214;
                        if ( (*v142)->Frequency == v139 )
                          ++*v214;
                        ++v142;
                        --v143;
                      }
                      while ( v143 );
                    }
                    ++v138;
                    ++v137;
                    ++v208;
                    v214 = v137;
                  }
                }
                v85 = v218 == 1;
                SoundByteb += 16;
                --v218;
              }
              while ( !v85 );
            }
            v144 = 0;
            a2[0] = 35;
            v145 = &a2[1];
            for ( i = 0; (int)v144 < v208; i = v144 )
            {
              v146 = arenaa->ServersideArenaSettings.PeriodicRewardPoints;
              v147 = v231[(_DWORD)v144];
              if ( v146 <= 0 )
                v148 = -(v136 * v146 * v147);
              else
                v148 = v146 * v147;
              if ( v148 > 0 )
              {
                v149 = &v232[(_DWORD)v144];
                *(_WORD *)v145 = *(_WORD *)v149;
                v150 = (__int16 *)(v145 + 2);
                v151 = v148;
                if ( v148 >= 30000 )
                  v151 = 30000;
                *v150 = v151;
                v145 = (char *)(v150 + 1);
                v215 = v145;
                v219 = 0;
                if ( v136 > 0 )
                {
                  v152 = arenaa->playerPointersForSomething;
                  LODWORD(a3) = *v149;
                  do
                  {
                    v153 = *v152;
                    if ( (*v152)->Frequency == (_DWORD)a3 && v153->Ship != 8 && (v153->ShipTogglables & 0x20) == 0 )
                    {
                      v154 = v153->KillPoints + v153->FlagPoints;
                      UpdatePoints(v153, 0, v148);
                      if ( v154 < AutoPermissionPoints
                        && AutoPermissionPoints > 0
                        && (*v152)->KillPoints + (*v152)->FlagPoints >= AutoPermissionPoints )
                      {
                        SendMessage(*v152, PermissionAutoPermissionMessage, 0);
                      }
                    }
                    v136 = arenaa->ArenaPlayerCount;
                    ++v152;
                    ++v219;
                  }
                  while ( v219 < v136 );
                  v145 = v215;
                  v144 = i;
                }
              }
              v144 = (int *)((char *)v144 + 1);
            }
            v155 = 0;
            if ( arenaa->ArenaPlayerCount > 0 )
            {
              v156 = arenaa->playerPointersForSomething;
              do
              {
                if ( !(*v156)->AlreadySentReliablePacket )
                  SendPlayerReliablePacket(*v156, a2, v145 - a2, 1);
                ++v155;
                ++v156;
              }
              while ( v155 < arenaa->ArenaPlayerCount );
            }
            dword_4C8F3C = 0;
          }
        }
      }
      goto LABEL_295;
    }
    v101 = -1;
    v207 = -1;
    if ( v75 )
    {
      v108 = *(_DWORD *)&arenaa->gap_186A2[8];
      v109 = &arenaa->gap_186A2[8];
      if ( v108 < 0 || *(_DWORD *)&arenaa->gap_186A2[4] != -1 )
        goto LABEL_204;
      for ( j = 0; j < v74; ++j )
      {
        if ( *((_DWORD *)v109 - 1) != -1 )
          break;
        if ( *(_DWORD *)v109 != v108 )
          break;
        v109 += 16;
      }
      if ( j != v74 )
        goto LABEL_204;
      v101 = *(_DWORD *)&arenaa->gap_186A2[8];
    }
    else
    {
      v102 = *(_DWORD *)&arenaa->gap_186A2[4];
      if ( v102 < 0 )
        goto LABEL_204;
      v103 = ZonePlayerList[v102];
      if ( !v103 )
        goto LABEL_204;
      v104 = v103->Frequency;
      v105 = 1;
      if ( v74 > 1 )
      {
        v106 = (int *)&arenaa->gap_186A2[20];
        do
        {
          if ( *v106 < 0 )
            break;
          v107 = ZonePlayerList[*v106];
          if ( !v107 )
            break;
          if ( v107->Frequency != v104 )
            break;
          ++v105;
          v106 += 4;
        }
        while ( v105 < v74 );
      }
      if ( v105 != v74 )
        goto LABEL_204;
      v101 = v104;
    }
    v207 = v101;
LABEL_204:
    if ( v101 >= 0 )
    {
      v111 = arenaa->ArenaPlayerCount;
      v112 = 0;
      if ( v111 > 0 )
      {
        v113 = arenaa->playerPointersForSomething;
        do
        {
          if ( (*v113)->Ship != 8 )
            ++v112;
          ++v113;
          --v111;
        }
        while ( v111 );
      }
      v114 = arenaa->ServersideArenaSettings.RandomFlags;
      arenaa->someCounterBefore = 0;
      if ( v114 && (int)arenaa->ServersideArenaSettings.MaxFlags > 0 )
        *(_DWORD *)arenaa->gap_FF6A = rand() % arenaa->ServersideArenaSettings.MaxFlags + 1;
      else
        *(_DWORD *)arenaa->gap_FF6A = arenaa->ServersideArenaSettings.MaxFlags;
      v115 = GetTickCount();
      v116 = arenaa->ServersideArenaSettings.FlagReward * v112 * v112;
      LOBYTE(a3) = 20;
      *(_WORD *)((char *)&a3 + 1) = v207;
      arenaa->GetTickCountValue8 = v115 / 0xA;
      v117 = arenaa->ServersideArenaSettings.FlagRewardMode;
      v118 = arenaa->ArenaJackpot + v116 / 1000;
      arenaa->ArenaJackpot = 0;
      *(_DWORD *)((char *)&a3 + 3) = v118;
      if ( v117 == 1 )
      {
        v119 = 0;
        if ( arenaa->ArenaPlayerCount > 0 )
        {
          v120 = arenaa->playerPointersForSomething;
          v121 = arenaa->ArenaPlayerCount;
          do
          {
            v122 = *v120;
            if ( (*v120)->Frequency == v207 && v122->Ship != 8 && (v122->ShipTogglables & 0x20) == 0 )
              ++v119;
            ++v120;
            --v121;
          }
          while ( v121 );
        }
        if ( v119 <= (unsigned __int8)arenaa->ArenaSettings.MaxPerTeam >> 1 )
          v119 = (unsigned __int8)arenaa->ArenaSettings.MaxPerTeam >> 1;
        *(_DWORD *)((char *)&a3 + 3) = (unsigned __int8)arenaa->ArenaSettings.MaxPerTeam * v118 / v119;
      }
      v123 = 0;
      if ( arenaa->ArenaPlayerCount > 0 )
      {
        v124 = arenaa->playerPointersForSomething;
        do
        {
          if ( !(*v124)->AlreadySentReliablePacket )
            SendPlayerReliablePacket(*v124, (char *)&a3, 7, 1);
          ++v123;
          ++v124;
        }
        while ( v123 < arenaa->ArenaPlayerCount );
      }
      v125 = 0;
      if ( arenaa->ArenaPlayerCount > 0 )
      {
        v126 = arenaa->playerPointersForSomething;
        do
        {
          v127 = *v126;
          if ( (*v126)->Frequency == v207 && v127->Ship != 8 && (v127->ShipTogglables & 0x20) == 0 )
          {
            v128 = v127->KillPoints + v127->FlagPoints;
            UpdatePoints(v127, 0, *(DWORD *)((char *)&a3 + 3));
            ++(*v126)->GoalCount;
            if ( !arenaa->ServersideArenaSettings.MiscTimedGame )
            {
              if ( arenaa->bHasScrFile )
              {
                v129 = (*v126)->field_15F;
                if ( v129 >= 0 )
                {
                  v130 = (int)&(*v126)->CurrentWins;
                  v131 = arenaa->FileContentsMemoryPointer + 18 * v129 + 4;
                  *(_DWORD *)v131 = *(_DWORD *)v130;
                  *(_DWORD *)(v131 + 4) = *(_DWORD *)(v130 + 4);
                  *(_DWORD *)(v131 + 8) = *(_DWORD *)(v130 + 8);
                  *(_WORD *)(v131 + 12) = *(_WORD *)(v130 + 12);
                }
              }
              else if ( BillingConnectionStructPointer && arenaa->RecordPointsToLog )
              {
                SendBillerUserScorePacket(
                  (ENCRYPTION **)BillingConnectionStructPointer,
                  (*v126)->BillerPlayerId,
                  &(*v126)->CurrentWins,
                  0xEu);
              }
            }
            if ( v128 < AutoPermissionPoints
              && AutoPermissionPoints > 0
              && (*v126)->KillPoints + (*v126)->FlagPoints >= AutoPermissionPoints )
            {
              SendMessage(*v126, PermissionAutoPermissionMessage, 0);
            }
          }
          ++v125;
          ++v126;
        }
        while ( v125 < arenaa->ArenaPlayerCount );
      }
      dword_4C8F3C = 0;
    }
    v132 = (int)(GetTickCount() / 0xA - arenaa->GetTickCountValue8);
    if ( (signed int)((HIDWORD(v132) ^ v132) - HIDWORD(v132)) > arenaa->ServersideArenaSettings.FlagResetDelay )
      ResetFlagGame(arenaa);
    goto LABEL_250;
  }
LABEL_358:
  v220 = 0;
  if ( arenaa->TotalSoccerBalls > 0 )
  {
    v193 = arenaa->SoccerBallTimers;
    v194 = &arenaa->SoccerBalls[0].PlayerId;
    i = arenaa->SoccerBallTimers;
    do
    {
      if ( (signed int)abs32(GetTickCount() / 0xA - *v193) > arenaa->ServersideArenaSettings.SoccerSendTime )
      {
        if ( !*(_DWORD *)(v194 + 1) && *v194 >= 0 )
        {
          v195 = ZonePlayerList[*v194];
          if ( v195 )
          {
            *(v194 - 4) = v195->XPixels;
            *(v194 - 3) = v195->YPixels;
          }
        }
        *v193 = GetTickCount() / 0xA;
        v196 = 0;
        buf = 46;
        v227[0] = *(_DWORD *)((char *)v194 - 9);
        v227[1] = *(_DWORD *)((char *)v194 - 5);
        v227[2] = *(_DWORD *)((char *)v194 - 1);
        v197 = arenaa->ArenaPlayerCount;
        v198 = *((_BYTE *)v194 + 5);
        LOWORD(v228) = *(__int16 *)((char *)v194 + 3);
        BYTE2(v228) = v198;
        if ( v197 > 0 )
        {
          v199 = arenaa->playerPointersForSomething;
          do
          {
            if ( !(*v199)->AlreadySentReliablePacket )
              SendPlayerReliablePacket(*v199, &buf, 16, 0);
            ++v196;
            ++v199;
          }
          while ( v196 < arenaa->ArenaPlayerCount );
        }
      }
      v193 = i + 1;
      v194 = (__int16 *)((char *)v194 + 15);
      v15 = ++v220 < arenaa->TotalSoccerBalls;
      ++i;
    }
    while ( v15 );
  }
  return arenaa->ArenaPlayerCount == 0;
}
// 4033B7: conditional instruction was optimized away because of 'eax.4==1'
// 4033D5: conditional instruction was optimized away because of 'esi.4>=1'
// 431FF4: using guessed type int ArenaArrayLength;
// 431FFC: using guessed type int ArenaMinimumPlayers;
// 4AF32C: using guessed type int AutoPermissionPoints;
// 4C8F3C: using guessed type int dword_4C8F3C;
// 4D5928: using guessed type int ArenaDesiredPlayers;
// 402560: using guessed type int var_1C00[384];
// 402560: using guessed type int var_1600[384];
// 402560: using guessed type int var_2200[384];

//----- (00403F60) --------------------------------------------------------
int __cdecl PtFuncCompare(const void *a1, const void *a2)
{
  return *(_DWORD *)(*(_DWORD *)a2 + 553)
       + *(_DWORD *)(*(_DWORD *)a2 + 557)
       - *(_DWORD *)(*(_DWORD *)a1 + 553)
       - *(_DWORD *)(*(_DWORD *)a1 + 557);
}

//----- (00403F90) --------------------------------------------------------
PLAYER **__thiscall ArenaScoreReset(ARENA *arenaa, int buf)
{
  PLAYER **result; // eax
  int v4; // ecx
  PLAYER *v5; // edx
  int v6; // ebp
  PLAYER **v7; // ebx

  result = (PLAYER **)arenaa->ArenaPlayerCount; // Suppose to be int
  v4 = 0;
  if ( (int)result > 0 )
  {
    result = arenaa->playerPointersForSomething;
    do                                          // (result -1) bug happens because result variable is mutated from different type.
    {
      v5 = *result;
      ++v4;
      ++result;
      v5->DebtKills = arenaa->ServersideArenaSettings.KillDebtKills;
      (*(result - 1))->CurrentLosses = 0;
      (*(result - 1))->CurrentWins = 0;
      (*(result - 1))->KillPoints = 0;
      (*(result - 1))->FlagPoints = 0;
      (*(result - 1))->GoalCount = 0;
    }
    while ( v4 < arenaa->ArenaPlayerCount );
  }
  if ( buf )
  {
    result = (PLAYER **)arenaa->ArenaPlayerCount;
    v6 = 0;
    LOBYTE(buf) = 26;
    *(_WORD *)((char *)&buf + 1) = -1;
    if ( (int)result > 0 )
    {
      v7 = arenaa->playerPointersForSomething;
      do
      {
        if ( !(*v7)->AlreadySentReliablePacket )
          SendPlayerReliablePacket(*v7, (char *)&buf, 3, 1);
        result = (PLAYER **)arenaa->ArenaPlayerCount;
        ++v6;
        ++v7;
      }
      while ( v6 < (int)result );
    }
  }
  return result;
}

//----- (00404050) --------------------------------------------------------
int __thiscall CreateSoccerBall(ARENA *arenaa, int PowerBallId)
{
  int v3; // eax
  __int16 v4; // cx
  char *v5; // esi
  __int16 v6; // ax
  __int64 v7; // rax
  int a2; // [esp+Ch] [ebp-8h] BYREF
  int a3; // [esp+10h] [ebp-4h] BYREF

  v3 = (__int16)arenaa->ArenaSettings.PrizeMinimumVirtual
     + (__int16)arenaa->ArenaSettings.PrizeUpgradeVirtual * arenaa->ArenaPlayerCount;
  if ( v3 >= 1024 )
    v3 = 1024;
  SomethingWithPrizes(arenaa, (int)&a2, (int)&a3, 512, 512, v3 / 2);
  v4 = 16 * a3;
  v5 = (char *)arenaa + 12 * PowerBallId + 3 * PowerBallId;
  v6 = 16 * a2;
  v5[65394] = PowerBallId;
  *(_WORD *)(v5 + 65395) = v6;
  *(_WORD *)(v5 + 65397) = v4;
  *(_WORD *)(v5 + 65399) = 0;
  *(_WORD *)(v5 + 65401) = 0;
  *(_WORD *)(v5 + 65403) = -1;
  v7 = 3435973837i64 * GetTickCount();
  *(_DWORD *)(v5 + 65405) = HIDWORD(v7) >> 3;
  arenaa->SoccerBallTimers[PowerBallId] = 0;
  return v7;
}

//----- (00404120) --------------------------------------------------------
int __thiscall FlagPositionUpdateSomething(ARENA *arenaa, int a2)
{
  int result; // eax
  int *v4; // esi
  int v5; // ebx
  int v6; // eax
  BOOL v7; // eax
  int v8; // eax
  __int16 v9; // cx
  __int16 v10; // dx
  int v11; // eax
  int v12; // ebp
  PLAYER **v13; // ebx
  int v14; // [esp+4h] [ebp-10h]
  char buf; // [esp+8h] [ebp-Ch] BYREF
  __int16 v16; // [esp+9h] [ebp-Bh]
  __int16 v17; // [esp+Bh] [ebp-9h]
  __int16 v18; // [esp+Dh] [ebp-7h]
  __int16 v19; // [esp+Fh] [ebp-5h]

  v14 = 0;
  result = arenaa->someCounterBefore;
  if ( result > 0 )
  {
    v4 = &arenaa->Pointer;
    do
    {
      v5 = *v4;
      v7 = 1;
      if ( *v4 >= 0 )
      {
        v6 = v4[1];
        if ( v6 >= 0 && v5 < 1024 && v6 < 1024 )
          v7 = 0;
      }
      if ( v4[2] == -1 && (a2 || v7) )
      {
        if ( v7 )
        {
          if ( v5 == -1 || !arenaa->ServersideArenaSettings.FlagTerritoryRadius )
          {
            v8 = (__int16)arenaa->ArenaSettings.PrizeMinimumVirtual
               + (__int16)arenaa->ArenaSettings.PrizeUpgradeVirtual * arenaa->ArenaPlayerCount;
            if ( v8 >= 1024 )
              v8 = 1024;
            SomethingWithPrizes(arenaa, (int)v4, (int)(v4 + 1), 512, 512, v8 / 2);
          }
          else
          {
            SomethingWithPrizes(
              arenaa,
              (int)v4,
              (int)(v4 + 1),
              abs32(v5),
              abs32(v4[1]),
              arenaa->ServersideArenaSettings.FlagTerritoryRadius);
          }
        }
        v9 = *(_WORD *)v4;
        v10 = *((_WORD *)v4 + 2);
        v19 = *((_WORD *)v4 + 6);               // Owner Frequency
        v11 = arenaa->ArenaPlayerCount;
        v17 = v9;                               // X Tiles
        v12 = 0;
        buf = 0x12;                             // 0x12 - Flag Position
        v18 = v10;                              // Y Tiles
        v16 = v14;                              // Flag ID
        if ( v11 > 0 )
        {
          v13 = arenaa->playerPointersForSomething;
          do
          {
            if ( !(*v13)->AlreadySentReliablePacket )
              SendPlayerReliablePacket(*v13, &buf, 9, 1);
            ++v12;
            ++v13;
          }
          while ( v12 < arenaa->ArenaPlayerCount );
        }
      }
      result = v14 + 1;
      v4 += 4;
      ++v14;
    }
    while ( v14 < arenaa->someCounterBefore );
  }
  return result;
}

//----- (00404280) --------------------------------------------------------
void __thiscall CarryFlagsSomething(ARENA *arenaa, int a2, int a3)
{
  int v3; // ebx
  PLAYER *v5; // ecx
  unsigned int v6; // esi
  unsigned int v7; // eax
  int v8; // ebp
  int v9; // ebx
  int v10; // esi
  int v11; // eax
  int v12; // esi
  int v13; // edx
  int v14; // eax
  int v15; // edx
  char *v16; // ecx
  int v17; // [esp+10h] [ebp-4h]
  int v18; // [esp+10h] [ebp-4h]

  v3 = a2;
  if ( a2 >= 0 && arenaa->ArenaSettings.CarryFlags )
  {
    v5 = ZonePlayerList[a2];
    v6 = -1;
    v7 = -1;
    if ( v5 )
    {
      v8 = v5->XPixels / 16;
      v9 = v5->YPixels / 16;
      if ( arenaa->ServersideArenaSettings.FlagTerritoryRadiusCentroid )
      {
        v17 = 0;
        while ( 1 )
        {
          v10 = arenaa->ServersideArenaSettings.FlagTerritoryRadiusCentroid;
          v11 = 2 * (rand() % v10) - v10;
          if ( v11 + v8 > 1 && v11 + v8 < 1024 )
            break;
          if ( ++v17 >= 50 )
            goto LABEL_11;
        }
        v8 += v11;
LABEL_11:
        v18 = 0;
        while ( 1 )
        {
          v12 = arenaa->ServersideArenaSettings.FlagTerritoryRadiusCentroid;
          v13 = rand() % (2 * v12) - v12;
          if ( v13 + v9 > 1 && v13 + v9 < 1024 )
            break;
          if ( ++v18 >= 50 )
            goto LABEL_17;
        }
        v9 += v13;
      }
LABEL_17:
      v14 = v9;
      v3 = a2;
      v6 = -abs32(v8);
      v7 = -abs32(v14);
    }
    v15 = 0;
    if ( arenaa->someCounterBefore > 0 )
    {
      v16 = &arenaa->gap_186A2[4];
      do
      {
        if ( *(_DWORD *)v16 == v3 )
        {
          if ( !a3 )
            *((_DWORD *)v16 + 1) = -1;
          *(_DWORD *)v16 = -1;
          *((_DWORD *)v16 - 2) = v6;
          *((_DWORD *)v16 - 1) = v7;
        }
        ++v15;
        v16 += 16;
      }
      while ( v15 < arenaa->someCounterBefore );
    }
  }
}

//----- (004043C0) --------------------------------------------------------
// Arena.ResetFlagGame()
int __thiscall ResetFlagGame(_DWORD *this)
{
  int v2; // ebx
  int v3; // eax
  int v4; // eax
  _DWORD *v5; // ecx
  int v6; // edi
  char *v7; // ecx
  __int16 *v8; // eax
  int v9; // edx
  __int16 v10; // bp
  int result; // eax
  int v12; // ebp
  int v13; // edi
  PLAYER **v14; // ebx
  int v15; // eax
  DWORD v16; // kr00_4
  PLAYER **v17; // edi
  char v18; // [esp+10h] [ebp-1008h] BYREF
  __int16 v19; // [esp+11h] [ebp-1007h]
  int v20; // [esp+13h] [ebp-1005h]
  char buf; // [esp+18h] [ebp-1000h] BYREF
  char v22; // [esp+19h] [ebp-FFFh] BYREF

  v2 = 0;
  v3 = *(_DWORD *)((char *)this + 109746);
  *(_DWORD *)((char *)this + 65382) = 0;
  if ( v3 == 2 )
  {
    v4 = 0;
    if ( *(int *)((char *)this + 108190) > 0 )
    {
      v5 = (_DWORD *)((char *)this + 100010);
      do
      {
        *v5 = -1;
        ++v4;
        v5 += 4;
      }
      while ( v4 < *(_DWORD *)((char *)this + 108190) );
    }
    v6 = *(_DWORD *)((char *)this + 108190);
    buf = 0x22;                                 // 0x22 - Turf Flag Update
    v7 = &v22;
    if ( v6 > 0 )
    {
      v8 = (__int16 *)this + 50005;
      v9 = v6;
      do
      {
        v10 = *v8;
        v8 += 8;
        *(_WORD *)v7 = v10;
        v7 += 2;
        --v9;
      }
      while ( v9 );
    }
    result = this[16323];
    v12 = 2 * v6 + 1;
    v13 = 0;
    if ( result > 0 )
    {
      v14 = (PLAYER **)(this + 16072);
      do
      {
        if ( !(*v14)->AlreadySentReliablePacket )
          SendPlayerReliablePacket(*v14, &buf, v12, 1);
        result = this[16323];
        ++v13;
        ++v14;
      }
      while ( v13 < result );
    }
  }
  else
  {
    v15 = *(_DWORD *)((char *)this + 109710);
    *(_DWORD *)((char *)this + 108190) = 0;
    if ( v15 && *(int *)((char *)this + 109714) > 0 )
      *(_DWORD *)((char *)this + 65386) = rand() % *(_DWORD *)((char *)this + 109714) + 1;
    else
      *(_DWORD *)((char *)this + 65386) = *(_DWORD *)((char *)this + 109714);
    v16 = GetTickCount();
    result = this[16323];
    v18 = 0x14;                                 // 0x14 - Flag Victory
    *(_DWORD *)((char *)this + 65346) = v16 / 0xA;
    v19 = -1;                                   // Team
    v20 = 0;                                    // Jackpot Points
    if ( result > 0 )
    {
      v17 = (PLAYER **)(this + 16072);
      do
      {
        if ( !(*v17)->AlreadySentReliablePacket )
          SendPlayerReliablePacket(*v17, &v18, 7, 1);
        result = this[16323];
        ++v2;
        ++v17;
      }
      while ( v2 < result );
    }
  }
  return result;
}

//----- (00404530) --------------------------------------------------------
int __thiscall GetNextFrequencyToJoin(ARENA *arenaa)
{
  int TotalPlaying; // ebp
  PLAYER **eachPlayer; // edx
  int ArenaPlayerCount; // esi
  int v5; // eax
  int CurrentFrequency; // esi
  int *NumPlayersPerFreqArrayy; // edi
  int NumPlayersThisFreq; // ecx
  int TotalPlayingg; // [esp+10h] [ebp-324h]
  int NumPlayersPerFreqArray[200]; // [esp+14h] [ebp-320h] BYREF

  memset(NumPlayersPerFreqArray, 0, sizeof(NumPlayersPerFreqArray));
  TotalPlaying = 0;
  TotalPlayingg = 0;
  if ( arenaa->ArenaPlayerCount > 0 )
  {
    eachPlayer = arenaa->playerPointersForSomething;
    ArenaPlayerCount = arenaa->ArenaPlayerCount;
    do
    {
      v5 = (*eachPlayer)->Frequency;
      if ( v5 >= 0 && (*eachPlayer)->Ship != 8 )
      {
        if ( v5 < 200 )
          ++NumPlayersPerFreqArray[v5];
        ++TotalPlaying;
      }
      ++eachPlayer;
      --ArenaPlayerCount;
    }
    while ( ArenaPlayerCount );
    TotalPlayingg = TotalPlaying;
  }
  CurrentFrequency = 0;
  for ( NumPlayersPerFreqArrayy = NumPlayersPerFreqArray; ; ++NumPlayersPerFreqArrayy )
  {
    if ( CurrentFrequency >= arenaa->ArenaSettings.MaxFrequency )
      return rand() % arenaa->ArenaSettings.MaxFrequency;
    NumPlayersThisFreq = *NumPlayersPerFreqArrayy;
    if ( !*NumPlayersPerFreqArrayy
      || NumPlayersThisFreq < (unsigned __int8)arenaa->ArenaSettings.MaxPerTeam
      && NumPlayersThisFreq <= TotalPlayingg / arenaa->ServersideArenaSettings.TeamDesiredTeams )
    {
      break;
    }
    if ( ++CurrentFrequency >= 200 )
      return rand() % arenaa->ArenaSettings.MaxFrequency;
  }
  return CurrentFrequency;
}
// 404530: using guessed type int NumPlayersPerFreqArray[200];

//----- (00404600) --------------------------------------------------------
// Arena.SendPacket()
int __thiscall ArenaSendPacket(ARENA *arenaa, void *buf, int buf_sz, BOOL bSendReliable)
{
  int v5; // edi
  int result; // eax
  PLAYER **v7; // esi

  v5 = 0;
  result = arenaa->ArenaPlayerCount;
  if ( result > 0 )
  {
    v7 = arenaa->playerPointersForSomething;
    do
    {
      if ( !(*v7)->AlreadySentReliablePacket )
        SendPlayerReliablePacket(*v7, (char *)buf, buf_sz, bSendReliable);
      result = arenaa->ArenaPlayerCount;
      ++v5;
      ++v7;
    }
    while ( v5 < result );
  }
  return result;
}

//----- (00404650) --------------------------------------------------------
int __thiscall SomethingWithPrizes(ARENA *arenaa, int a2, int a3, int a4, int a5, int a6)
{
  int v6; // ebp
  int v7; // ebx
  int v8; // eax
  int v9; // edi
  int v10; // ebp
  ARENA *v11; // esi
  int v12; // edx
  int v13; // eax
  int v14; // ebx
  int v15; // eax
  int v16; // eax
  int v17; // ecx
  int v18; // eax
  int v19; // ebx
  int v20; // eax
  int v21; // esi
  int v22; // esi
  int v23; // esi
  int v24; // edx
  int v25; // esi
  int v26; // ecx
  ARENA *v27; // edx
  int v28; // eax
  int v29; // esi
  int v30; // ecx
  char *v31; // eax
  int result; // eax
  int v34; // [esp+Ch] [ebp-Ch]
  int v35; // [esp+10h] [ebp-8h]
  int v36; // [esp+24h] [ebp+Ch]
  int v37; // [esp+28h] [ebp+10h]
  int v38; // [esp+2Ch] [ebp+14h]
  int v39; // [esp+2Ch] [ebp+14h]
  int v40; // [esp+2Ch] [ebp+14h]
  int v41; // [esp+2Ch] [ebp+14h]
  int v42; // [esp+2Ch] [ebp+14h]
  int v43; // [esp+2Ch] [ebp+14h]

  v6 = 2 * a6;
  v7 = a5 - a6;
  v8 = a4 - a5;
  v35 = 0;
  v34 = 2 * a6;
  v37 = a5 - a6;
  v36 = v8;
  while ( 1 )
  {
    v9 = (v7 + v8 < 0 ? 0 : v7 + v8) + rand() % v6;
    v10 = (v7 < 0 ? 0 : v7) + rand() % v6;
    if ( v9 < 0 || v10 < 0 || v9 >= 1024 || v10 >= 1024 )
    {
      v11 = arenaa;
      v38 = 1;
    }
    else
    {
      v11 = arenaa;
      v38 = *(unsigned __int8 *)(arenaa->MapAllocatedMemory + (v10 << 10) + v9);
    }
    v12 = v9 + 1;
    if ( v9 + 1 < 0 || v10 < 0 || v12 >= 1024 || v10 >= 1024 )
      v13 = 1;
    else
      v13 = *(unsigned __int8 *)(v11->MapAllocatedMemory + (v10 << 10) + v12);
    v14 = v13 + v38;
    v15 = v9 - 1;
    if ( v9 - 1 < 0 || v10 < 0 || v15 >= 1024 || v10 >= 1024 )
      v16 = 1;
    else
      v16 = *(unsigned __int8 *)(v11->MapAllocatedMemory + (v10 << 10) + v15);
    v39 = v16 + v14;
    v17 = v10 + 1;
    if ( v9 < 0 || v17 < 0 || v9 >= 1024 || v17 >= 1024 )
      v18 = 1;
    else
      v18 = *(unsigned __int8 *)(v11->MapAllocatedMemory + (v17 << 10) + v9);
    v19 = v18 + v39;
    v20 = v10 - 1;
    if ( v9 < 0 || v20 < 0 || v9 >= 1024 || v20 >= 1024 )
      v21 = 1;
    else
      v21 = *(unsigned __int8 *)(v11->MapAllocatedMemory + (v20 << 10) + v9);
    v40 = v21 + v19;
    if ( v12 < 0 || v17 < 0 || v12 >= 1024 || v17 >= 1024 )
      v22 = 1;
    else
      v22 = *(unsigned __int8 *)(arenaa->MapAllocatedMemory + (v17 << 10) + v12);
    v41 = v22 + v40;
    if ( v12 < 0 || v20 < 0 || v12 >= 1024 || v20 >= 1024 )
      v23 = 1;
    else
      v23 = *(unsigned __int8 *)(arenaa->MapAllocatedMemory + (v20 << 10) + v12);
    v24 = v23 + v41;
    v25 = v9 - 1;
    if ( v9 - 1 < 0 || v17 < 0 || v25 >= 1024 || v17 >= 1024 )
      v26 = 1;
    else
      v26 = *(unsigned __int8 *)(arenaa->MapAllocatedMemory + (v17 << 10) + v25);
    v42 = v26 + v24;
    if ( v25 < 0 || v20 < 0 || v25 >= 1024 || v20 >= 1024 )
    {
      v27 = arenaa;
      v28 = 1;
    }
    else
    {
      v27 = arenaa;
      v28 = *(unsigned __int8 *)(arenaa->MapAllocatedMemory + (v20 << 10) + v25);
    }
    v29 = v27->someCounterBefore;
    v43 = v28 + v42;
    v30 = 0;
    if ( v29 > 0 )
    {
      v31 = v27->gap_186A2;
      while ( *((_DWORD *)v31 - 1) != v9 || *(_DWORD *)v31 != v10 )
      {
        ++v30;
        v31 += 16;
        if ( v30 >= v29 )
          goto LABEL_64;
      }
      ++v43;
    }
LABEL_64:
    if ( !v43 )
      v35 = 1;
    v7 = --v37;
    v34 += 2;
    if ( v35 )
      break;
    v8 = v36;
    v6 = v34;
  }
  result = a3;
  *(_DWORD *)a2 = v9;
  *(_DWORD *)a3 = v10;
  return result;
}

//----- (00404980) --------------------------------------------------------
void __thiscall sub_404980(ARENA *arena, int a2, __int64 a3)
{
  int v3; // eax
  char *v4; // esi
  int v5; // ecx
  _DWORD *i; // edx
  int v7; // ecx

  if ( (int)a3 >= 0 && a3 >= 0 && (int)a3 < 8 && SHIDWORD(a3) < 8 )
  {
    v3 = 0;
    v4 = (char *)arena + 8032 * a3 + 1004 * HIDWORD(a3);
    v5 = *((_DWORD *)v4 + 250);
    if ( v5 > 0 )
    {
      for ( i = v4; *i != a2; ++i )
      {
        if ( ++v3 >= v5 )
          return;
      }
      v7 = v5 - 1;
      *((_DWORD *)v4 + 250) = v7;
      *(_DWORD *)&v4[4 * v3] = *(_DWORD *)&v4[4 * v7];
    }
  }
}

//----- (004049F0) --------------------------------------------------------
PLAYER *__thiscall AddPlayerToArenaSomething(ARENA *arena, PLAYER *a2, signed int a3, signed int a4)
{
  PLAYER *result; // eax
  int v5; // eax
  PLAYER **v6; // edx

  if ( a3 >= 0 )
  {
    result = (PLAYER *)a4;
    if ( a4 >= 0 && a3 < 8 && a4 < 8 )
    {
      v5 = a4 + 8 * a3;
      v6 = &arena->PlayerPointers[251 * v5 + 250];
      arena->PlayerPointers[(_DWORD)*v6 + 251 * v5] = a2;
      result = (PLAYER *)((char *)&(*v6)->unknownIthoughtItWasPlayerPointerDupe + 1);
      *v6 = result;
    }
  }
  return result;
}

//----- (00404A50) --------------------------------------------------------
signed int __thiscall LoadArenaSettings(ARENA *arenaa)
{
  char *v2; // esi
  signed int result; // eax
  int v4; // esi

  v2 = arenaa->szConfigFile;
  if ( _strcmpi(arenaa->szConfigFile, Filename2) )
  {
    IsFileLastWrittenTime(v2, (int)arenaa->dwLastConfigReadTime);
    LoadZoneCFGSettings(&arenaa->ArenaSettings, &arenaa->ServersideArenaSettings, v2);
  }
  else
  {
    qmemcpy(&arenaa->ArenaSettings, &ArenaSettings, sizeof(arenaa->ArenaSettings));
    qmemcpy(&arenaa->ServersideArenaSettings, &ServersideArenaSettings, sizeof(arenaa->ServersideArenaSettings));
  }
  result = 0;
  *(_DWORD *)&arenaa->dwLastConfigReadTime[8] = ((__int16)arenaa->ArenaSettings.MapZoomFactor << 14) / 96;
  *(_DWORD *)&arenaa->dwLastConfigReadTime[4] = 0;
  do
  {
    v4 = (unsigned __int8)arenaa->ArenaSettings.SomeUnknownStuffToo[result + 7]
       + *(_DWORD *)&arenaa->dwLastConfigReadTime[4];
    ++result;
    *(_DWORD *)&arenaa->dwLastConfigReadTime[4] = v4;
  }
  while ( result < 29 );
  return result;
}
/* Orphan comments:
If fail occurs (arena.cfg is missing) uses default server.cfg settings.
Attempt to load arena settings from file
*/

//----- (00404B10) --------------------------------------------------------
void __thiscall LoadArenaMapSomething(ARENA *arenaa)
{
  char *v2; // ebx
  int v3; // esi
  struct BMP_FILE_STRUCT *v4; // edi
  int v5; // ebx
  int v6; // eax
  char *v7; // eax
  char *v8; // esi
  _DWORD *v9; // edi
  int v10; // edi
  int v11; // ebx
  int v12; // ecx
  unsigned int v13; // edx
  int j; // edi
  int k; // esi
  int v16; // ecx
  int v17; // eax
  _BYTE *v18; // eax
  unsigned int v19; // [esp+10h] [ebp-2Ch] BYREF
  unsigned int v20; // [esp+14h] [ebp-28h] BYREF
  char *i; // [esp+18h] [ebp-24h]
  int v22[4]; // [esp+1Ch] [ebp-20h] BYREF
  char v23; // [esp+2Ch] [ebp-10h]
  int v24; // [esp+38h] [ebp-4h]

  v2 = arenaa->szLevelFile1;
  if ( _strcmpi(MiscDefaultLevelFile, arenaa->szLevelFile1) )
  {
    v22[0] = 42;
    v22[1] = 0;
    v22[2] = 0;
    v22[3] = 0;
    v23 = 0;
    strcpy((char *)v22 + 1, v2);
    *(_DWORD *)&arenaa->dwLastConfigReadTime[12] = CompressFile(
                                                     v2,
                                                     (int *)&arenaa->dwLastConfigReadTime[16],
                                                     (int *)&arenaa->dwLastConfigReadTime[20],
                                                     v22,
                                                     0x11u,
                                                     1,
                                                     0);
    v7 = (char *)operator new(0x110u);
    i = v7;
    v24 = 0;
    if ( v7 )
    {
      v8 = LoadBMPHeader(v7, v2);
      v20 = (unsigned int)v8;
    }
    else
    {
      v20 = 0;
      v8 = 0;
    }
    v24 = -1;
    arenaa->someCounterAfter = 0;
    v9 = emalloc(0x100000u);
    arenaa->MapAllocatedMemory = (int)v9;
    memset(v9, 0, 0x100000u);
    v10 = sub_406BE0(v8);
    v11 = 0;
    for ( i = (char *)v10; v11 < v10; ++v11 )
    {
      GetTileValue((struct BMP_FILE_STRUCT *)v8, v11, (int *)&v19);
      if ( (v19 & 0xFF000000) == 0xAA000000 )
      {
        v12 = arenaa->someCounterAfter;
        if ( v12 < 510 )
        {
          *(_DWORD *)&arenaa->dwLastConfigReadTime[16 * v12 + 24] = v19 & 0xFFF;// Y Coord
          *(_DWORD *)&arenaa->dwLastConfigReadTime[16 * arenaa->someCounterAfter++ + 28] = (v19 >> 12) & 0xFFF;// X Coord
        }
      }
      else
      {
        *(_BYTE *)((v19 & 0xFFF) + (((v19 >> 12) & 0xFFF) << 10) + arenaa->MapAllocatedMemory) = HIBYTE(v19);
        v13 = v19;
        if ( (v19 & 0xFF000000) >= 0xD8000000 )
        {
          for ( j = 0; j < 7; ++j )
          {
            for ( k = 0; k < 7; ++k )
            {
              v16 = j + (v13 & 0xFFF);          // Y Coord
              v17 = k + ((v13 >> 12) & 0xFFF);  // X Coord
              if ( v16 < 1024 && v17 < 1024 )
              {
                v18 = (_BYTE *)(arenaa->MapAllocatedMemory + v16 + (v17 << 10));
                if ( !*v18 )
                {
                  *v18 = -16;
                  v13 = v19;
                }
              }
            }
          }
          v10 = (int)i;
          v8 = (char *)v20;
        }
      }
    }
    if ( v8 )
    {
      sub_406B30(v8);
      operator delete(v8);
    }
  }
  else
  {
    v3 = 0;
    *(_DWORD *)&arenaa->dwLastConfigReadTime[12] = dword_437B0C;
    *(_DWORD *)&arenaa->dwLastConfigReadTime[16] = dword_4D8AF0;
    *(_DWORD *)&arenaa->dwLastConfigReadTime[20] = dword_4386F8;
    arenaa->MapAllocatedMemory = (int)MapAllocatedMemory;
    arenaa->someCounterAfter = 0;
    v4 = (struct BMP_FILE_STRUCT *)dword_438B70;
    v5 = sub_406BE0(dword_438B70);
    if ( v5 > 0 )
    {
      do
      {
        GetTileValue(v4, v3, (int *)&v20);
        if ( (v20 & 0xFF000000) == 0xAA000000 )
        {
          v6 = arenaa->someCounterAfter;
          if ( v6 < 510 )
          {
            *(_DWORD *)&arenaa->dwLastConfigReadTime[16 * v6 + 24] = v20 & 0xFFF;// X Coord
            *(_DWORD *)&arenaa->dwLastConfigReadTime[16 * arenaa->someCounterAfter++ + 28] = (v20 >> 12) & 0xFFF;// Y Coord
          }
        }
        ++v3;
      }
      while ( v3 < v5 );
    }
  }
}
// 4386F8: using guessed type int dword_4386F8;
// 4D8AF0: using guessed type int dword_4D8AF0;

//----- (00404E20) --------------------------------------------------------
int __thiscall GetDeathPrizeGreenId(ARENA *arenaa)
{
  int limitValue; // edx
  int increasingValue; // ecx
  int iterationsBreakAtCounter; // esi
  int result; // eax
  int v6; // edx

  limitValue = rand() % *(_DWORD *)&arenaa->dwLastConfigReadTime[4];
  increasingValue = 0;
  iterationsBreakAtCounter = 0;
  while ( 1 )
  {
    if ( arenaa->ArenaSettings.SomeUnknownStuffToo[iterationsBreakAtCounter + 7] )
    {
      if ( limitValue >= increasingValue )
      {
        increasingValue += (unsigned __int8)arenaa->ArenaSettings.SomeUnknownStuffToo[iterationsBreakAtCounter + 7];
        if ( limitValue < increasingValue )
          break;
      }
    }
    if ( ++iterationsBreakAtCounter >= 29 )
      return 0;
  }
  v6 = rand() % (__int16)arenaa->ArenaSettings.PrizeNegativeFactor;
  result = iterationsBreakAtCounter;
  if ( !v6 )
    result = -iterationsBreakAtCounter;
  return result;
}

//----- (00404E80) --------------------------------------------------------
signed int __thiscall ChangeSettings(ARENA *arenaa, PLAYER *player, const CHAR *a3)
{
  const CHAR *v3; // eax
  CHAR v4; // cl
  CHAR *i; // edx
  CHAR v6; // cl
  CHAR v8; // cl
  const CHAR *v9; // eax
  CHAR *j; // edx
  CHAR v11; // cl
  int v12; // ebp
  int v13; // edi
  int v14; // ebx
  TEMPLATE_SSS *v15; // esi
  char *v16; // esi
  int v17; // [esp+10h] [ebp-514h]
  int v18; // [esp+14h] [ebp-510h]
  int v20; // [esp+1Ch] [ebp-508h]
  int v21; // [esp+20h] [ebp-504h]
  char Str2[256]; // [esp+24h] [ebp-500h] BYREF
  CHAR KeyName[256]; // [esp+124h] [ebp-400h] BYREF
  CHAR Str[256]; // [esp+224h] [ebp-300h] BYREF
  CHAR Str1[256]; // [esp+324h] [ebp-200h] BYREF
  char a2[256]; // [esp+424h] [ebp-100h] BYREF

  v3 = a3;
  v4 = *a3;
  for ( i = Str1; v4; ++v3 )
  {
    if ( v4 == 58 )
      break;
    *i = v4;
    v4 = v3[1];
    ++i;
  }
  v6 = *v3;
  *i = 0;
  if ( !v6 )
    return 1;
  v8 = v3[1];
  v9 = v3 + 1;
  for ( j = KeyName; v8; ++v9 )
  {
    if ( v8 == 58 )
      break;
    *j = v8;
    v8 = v9[1];
    ++j;
  }
  v11 = *v9;
  *j = 0;
  if ( !v11 )
    return 1;
  v12 = 0;
  strcpy(Str, v9 + 1);
  if ( !player->isSysop )
  {
    strcpy(Str2, Str1);
    if ( !_strcmpi(Str2, "Warbird")
      || !_strcmpi(Str2, "Javelin")
      || !_strcmpi(Str2, "Spider")
      || !_strcmpi(Str2, "Leviathan")
      || !_strcmpi(Str2, "Weasel")
      || !_strcmpi(Str2, "Terrier")
      || !_strcmpi(Str2, "Lancaster")
      || !_strcmpi(Str2, "Shark") )
    {
      strcpy(Str2, "All");
    }
    v18 = 0;
    v20 = 0;
    v17 = atoi(Str);
    v21 = 0;
    if ( TotalTemplateSSSEntries <= 0 )
    {
      v13 = v17;
      v14 = v17;
    }
    else
    {
      v13 = v17;
      v14 = v17;
      v15 = TotalTemplateSSSList;
      while ( 1 )
      {
        if ( (!_strcmpi(v15->SomeString32, Str2) || !_strcmpi(v15->SomeString32, Str1))
          && !_strcmpi(v15->KeyName, KeyName)
          && !v15->SomeChar1a )
        {
          v13 = v15->someInteger;
          v14 = v15->someInteger2;
          v12 = 1;
          v18 = v15->SomeChar1b;
          if ( v13 == -999 || v17 >= v13 && v17 <= v14 )
            break;
        }
        ++v15;
        if ( ++v21 >= TotalTemplateSSSEntries )
          goto LABEL_34;
      }
      v20 = 1;
    }
LABEL_34:
    if ( !v12 )
    {
      sprintf(a2, "%s:%s is not a valid user parameter.", Str1, KeyName);
      SendMessage(player, a2, 0);
      return 1;
    }
    if ( !v20 )
    {
      sprintf(a2, "Valid range for parameter %s:%s is (%d through %d)", Str1, KeyName, v13, v14);
      SendMessage(player, a2, 0);
      return 1;
    }
    if ( v18 )
    {
      arenaa->field_10026 = 1;
      if ( !_strcmpi(arenaa->szConfigFile, Filename2) )
        RecycleServer = 1;
    }
  }
  arenaa->playerPointersForSomething[250] = (PLAYER *)1;
  v16 = arenaa->szConfigFile;
  if ( !_strcmpi(arenaa->szConfigFile, Filename2) )
    dword_4D5920 = 1;
  if ( _strcmpi(Str1, "All") )
  {
    WritePrivateProfileStringA(Str1, KeyName, Str, v16);
  }
  else
  {
    WritePrivateProfileStringA("Warbird", KeyName, Str, v16);
    WritePrivateProfileStringA("Javelin", KeyName, Str, v16);
    WritePrivateProfileStringA("Spider", KeyName, Str, v16);
    WritePrivateProfileStringA("Leviathan", KeyName, Str, v16);
    WritePrivateProfileStringA("Terrier", KeyName, Str, v16);
    WritePrivateProfileStringA("Weasel", KeyName, Str, v16);
    WritePrivateProfileStringA("Lancaster", KeyName, Str, v16);
    WritePrivateProfileStringA("Shark", KeyName, Str, v16);
  }
  return 0;
}
// 432004: using guessed type int RecycleServer;
// 4D5920: using guessed type int dword_4D5920;
// 4D8AE4: using guessed type int TotalTemplateSSSEntries;

//----- (00405360) --------------------------------------------------------
int __thiscall sub_405360(ARENA *this, int buf)
{
  ArenaScoreReset(this, buf);
  this->ScoreStructCounter = 0;
  this->GameTimePassedTwo = GetTickCount() / 0xA;
  this->field_FF20 = 0;
  return SoccerGameSomething(this, -1);
}

//----- (004053B0) --------------------------------------------------------
int __thiscall SoccerGameSomething(ARENA *this, int a2)
{
  PLAYER **v3; // ebx
  int v4; // eax
  PLAYER **v5; // ecx
  PLAYER *v6; // esi
  int v7; // eax
  int result; // eax
  __int16 *v9; // esi
  int v10; // ecx
  int v11; // edi
  PLAYER **v12; // ebx
  int v13; // [esp+10h] [ebp-118h]
  int *v14; // [esp+10h] [ebp-118h]
  int v15; // [esp+14h] [ebp-114h]
  char buf; // [esp+18h] [ebp-110h] BYREF
  int v17; // [esp+19h] [ebp-10Fh]
  int v18; // [esp+1Dh] [ebp-10Bh]
  int v19; // [esp+21h] [ebp-107h]
  __int16 v20; // [esp+25h] [ebp-103h]
  char v21; // [esp+27h] [ebp-101h]
  char a2a[256]; // [esp+28h] [ebp-100h] BYREF

  if ( a2 >= 0 )
  {
    v13 = 0;
    if ( this->ArenaPlayerCount > 0 )
    {
      v3 = this->playerPointersForSomething;
      do
      {
        if ( (*v3)->Frequency == a2 && (*v3)->MySoccerReward > 0 )
        {
          sprintf(a2a, "Soccer game over.  Personal Reward: %d", (*v3)->MySoccerReward);
          UpdatePoints(*v3, 0, (*v3)->MySoccerReward);
        }
        else
        {
          strcpy(a2a, "Soccer game over.");
        }
        SendMessage(*v3, a2a, 103);
        if ( !SendPlayerScoreUpdateAll(*v3) )
          SendPlayerScoreUpdate(*v3);
        ++v3;
        ++v13;
      }
      while ( v13 < this->ArenaPlayerCount );
    }
  }
  v4 = 0;
  if ( this->ArenaPlayerCount > 0 )
  {
    v5 = this->playerPointersForSomething;
    do
    {
      v6 = *v5;
      ++v4;
      ++v5;
      v6->MySoccerReward = 0;
    }
    while ( v4 < this->ArenaPlayerCount );
  }
  this->Freq1Score = 0;
  this->Freq2Score = 0;
  this->Freq3Score = 0;
  this->Freq4Score = 0;
  v7 = this->ServersideArenaSettings.SoccerCapturePoints;
  if ( v7 > 0 )
  {
    this->Freq1Score = v7;
    this->Freq2Score = v7;
    this->Freq3Score = v7;
    this->Freq4Score = v7;
  }
  result = 0;
  v15 = 0;
  if ( this->TotalSoccerBalls > 0 )
  {
    v9 = &this->SoccerBalls[0].YPixels;
    v14 = this->SoccerBallTimers;
    do
    {
      *((_BYTE *)v9 - 3) = result;
      *(v9 - 1) = 0;
      *v9 = 0;
      v9[1] = 0;
      v9[2] = 0;
      v9[3] = -1;
      *((_DWORD *)v9 + 2) = 0;
      *v14 = 0;
      v17 = *(_DWORD *)((char *)v9 - 3);
      v18 = *(_DWORD *)((char *)v9 + 1);
      v19 = *(_DWORD *)((char *)v9 + 5);
      v20 = *(__int16 *)((char *)v9 + 9);
      v21 = *((_BYTE *)v9 + 11);
      v10 = this->ArenaPlayerCount;
      v11 = 0;
      buf = 46;
      if ( v10 > 0 )
      {
        v12 = this->playerPointersForSomething;
        do
        {
          if ( !(*v12)->AlreadySentReliablePacket )
            SendPlayerReliablePacket(*v12, &buf, 16, 1);
          ++v11;
          ++v12;
        }
        while ( v11 < this->ArenaPlayerCount );
        result = v15;
      }
      ++result;
      v9 = (__int16 *)((char *)v9 + 15);
      v15 = result;
      ++v14;
    }
    while ( result < this->TotalSoccerBalls );
  }
  this->TotalSoccerBalls = 0;
  return result;
}

//----- (004055D0) --------------------------------------------------------
int __thiscall SoccerGame2(ARENA *arenaa, int Frequency, int a3, int a4)
{
  int v5; // edi
  int v6; // ebx
  int v7; // ebp
  int result; // eax
  int v9; // eax
  int v10; // edi
  PLAYER **v11; // ebx
  int *i; // ecx
  int v13; // edx
  int v14; // ecx
  int *v15; // ecx

  v5 = -1;
  v6 = -1;
  v7 = 0;
  result = SoccerRelatedMath((unsigned __int8)arenaa->ArenaSettings.SoccerMode, a3, a4);
  switch ( arenaa->ArenaSettings.SoccerMode )
  {
    case 1:
    case 2:
      v7 = 2;
      v5 = Frequency & 1;
      v6 = result;
      break;
    case 3:
    case 5:
      v7 = 4;
      v5 = Frequency & 3;
      v6 = result;
      break;
    case 4:
    case 6:
      v7 = 4;
      v5 = Frequency & 3;
      switch ( Frequency & 3 )
      {
        case 0:
          v6 = 3;
          break;
        case 1:
          v6 = 2;
          break;
        case 2:
          v6 = 1;
          break;
        case 3:
          v6 = 0;
          break;
        default:
          goto LABEL_9;
      }
      break;
    default:
      break;
  }
LABEL_9:
  if ( v5 >= 0 )
  {
    result = arenaa->ServersideArenaSettings.SoccerCapturePoints;
    if ( result <= 0 )
    {
      if ( result < 0 )
      {
        ++arenaa->SoccerBallTimers[v5 + 8];
        GetScore(arenaa, 0);
        result = arenaa->SoccerBallTimers[v5 + 8];
        if ( result >= -arenaa->ServersideArenaSettings.SoccerCapturePoints )
        {
          v13 = arenaa->ServersideArenaSettings.SoccerWinBy;
          v14 = 1;
          if ( v13 > 0 )
          {
            result = 0;
            if ( v7 > 0 )
            {
              v15 = &arenaa->Freq1Score;
              while ( result == v5 || arenaa->SoccerBallTimers[v5 + 8] - *v15 >= v13 )
              {
                ++result;
                ++v15;
                if ( result >= v7 )
                {
                  v14 = 1;
                  goto LABEL_33;
                }
              }
              v14 = 0;
            }
          }
LABEL_33:
          if ( v14 )
            return SoccerGameSomething(arenaa, Frequency);
        }
      }
    }
    else
    {
      v9 = arenaa->SoccerBallTimers[v6 + 8];
      if ( v9 )
      {
        arenaa->SoccerBallTimers[v6 + 8] = v9 - 1;
        ++arenaa->SoccerBallTimers[v5 + 8];
      }
      else
      {
        v10 = 0;
        if ( arenaa->ArenaPlayerCount > 0 )
        {
          v11 = arenaa->playerPointersForSomething;
          do
          {
            SendMessage(*v11, "Enemy goal had no points to give.", 0);
            ++v10;
            ++v11;
          }
          while ( v10 < arenaa->ArenaPlayerCount );
        }
      }
      GetScore(arenaa, 0);
      result = 0;
      if ( v7 > 0 )
      {
        for ( i = &arenaa->Freq1Score; *i != arenaa->ServersideArenaSettings.SoccerCapturePoints * v7; ++i )
        {
          if ( ++result >= v7 )
            return result;
        }
        return SoccerGameSomething(arenaa, Frequency);
      }
    }
  }
  return result;
}

//----- (004057C0) --------------------------------------------------------
ARENA *__thiscall GetScore(ARENA *arenaa, int a2)
{
  ARENA *result; // eax
  char v4; // al
  ARENA *v5; // ebx
  PLAYER **v6; // esi
  PLAYER *v7; // ecx
  int v8; // [esp-8h] [ebp-214h]
  char *v9; // [esp-8h] [ebp-214h]
  int v10; // [esp-4h] [ebp-210h]
  char Dest[256]; // [esp+Ch] [ebp-200h] BYREF
  char a2a[256]; // [esp+10Ch] [ebp-100h] BYREF

  result = (ARENA *)arenaa->ServersideArenaSettings.SoccerBallCount;
  if ( (int)result > 0 )
  {
    result = (ARENA *)arenaa->ServersideArenaSettings.SoccerCapturePoints;
    if ( result )
    {
      v4 = arenaa->ArenaSettings.SoccerMode;
      if ( v4 == 1 || v4 == 2 )
      {
        v10 = arenaa->Freq2Score;
        v8 = arenaa->Freq1Score;
        if ( arenaa->ServersideArenaSettings.MiscFrequencyShipTypes )
          sprintf(Dest, "SCORE: Warbirds:%d  Javelins:%d", v8, v10);
        else
          sprintf(Dest, "SCORE: Evens:%d  Odds:%d", v8, v10);
      }
      else if ( arenaa->ServersideArenaSettings.MiscFrequencyShipTypes )
      {
        sprintf(
          Dest,
          "SCORE: Warbirds:%d  Javelins:%d  Spiders:%d  Leviathans:%d",
          arenaa->Freq1Score,
          arenaa->Freq2Score,
          arenaa->Freq3Score,
          arenaa->Freq4Score);
      }
      else
      {
        sprintf(
          Dest,
          "SCORE: Team0:%d  Team1:%d  Team2:%d  Team3:%d",
          arenaa->Freq1Score,
          arenaa->Freq2Score,
          arenaa->Freq3Score,
          arenaa->Freq4Score);
      }
      if ( a2 )
      {
        if ( *(int *)(a2 + 216) <= 0 )
        {
          result = SendMessage((PLAYER *)a2, Dest, 0);
        }
        else
        {
          sprintf(a2a, "%s  REWARD:%d", Dest, *(_DWORD *)(a2 + 216));
          result = SendMessage((PLAYER *)a2, a2a, 0);
        }
      }
      else
      {
        result = (ARENA *)arenaa->ArenaPlayerCount;
        v5 = 0;
        if ( (int)result > 0 )
        {
          v6 = arenaa->playerPointersForSomething;
          do
          {
            v7 = *v6;
            if ( (*v6)->MySoccerReward <= 0 )
            {
              v9 = Dest;
            }
            else
            {
              sprintf(a2a, "%s  REWARD:%d", Dest, (*v6)->MySoccerReward);
              v9 = a2a;
              v7 = *v6;
            }
            SendMessage(v7, v9, 0);
            result = (ARENA *)arenaa->ArenaPlayerCount;
            v5 = (ARENA *)((char *)v5 + 1);
            ++v6;
          }
          while ( (int)v5 < (int)result );
        }
      }
    }
  }
  return result;
}

//----- (00405970) --------------------------------------------------------
unsigned int __thiscall GetArenaMemoryTotal(ARENA *arena)
{
  int v1; // edx

  v1 = 0x75;
  if ( (LPVOID)arena->MapAllocatedMemory != MapAllocatedMemory )
    v1 = 0x525;
  return v1 + ((unsigned int)(18 * arena->NumberOfContents18ByteBlocks) >> 10);
}

//----- (004059A0) --------------------------------------------------------
int __thiscall GetTotalPlayingPlayers(ARENA *arena)
{
  int ArenaPlayerCount; // edx
  int result; // eax
  PLAYER **v3; // ecx

  ArenaPlayerCount = arena->ArenaPlayerCount;
  result = 0;
  if ( ArenaPlayerCount > 0 )
  {
    v3 = arena->playerPointersForSomething;
    do
    {
      if ( (*v3)->Ship != 8 )
        ++result;
      ++v3;
      --ArenaPlayerCount;
    }
    while ( ArenaPlayerCount );
  }
  return result;
}

//----- (004059D0) --------------------------------------------------------
int __thiscall SendBillerServerConnectPacket(int this, int a2, const char *ServerName, int ServerId, int GroupId, int ScoreId, const char *Password, int a8, int a9)
{
  ENCRYPTION *v10; // ecx
  char buf[172]; // [esp+8h] [ebp-B0h] BYREF
  char v13; // [esp+B4h] [ebp-4h]

  *(_DWORD *)this = a8;
  *(_DWORD *)(this + 4) = a9;
  memset(buf, 0, sizeof(buf));
  v13 = 0;
  *(_DWORD *)(this + 12) = a2;
  *(_DWORD *)(this + 20) = 0;
  buf[0] = 2;                                   // 0x02 - Billing Server Connect
  strncpy(&buf[13], ServerName, 0x80u);
  buf[140] = 0;
  strncpy(&buf[141], Password, 0x20u);
  *(_DWORD *)&buf[1] = ServerId;
  v10 = *(ENCRYPTION **)(this + 4);
  v13 = 0;
  *(_DWORD *)&buf[5] = GroupId;
  *(_DWORD *)&buf[9] = ScoreId;
  WriteData(v10, buf, 173, 1);
  *(_DWORD *)(this + 16) = GetTickCount() / 0xA;
  return this;
}

//----- (00405AB0) --------------------------------------------------------
signed int __thiscall CleanUpBilling(void *this)
{
  ENCRYPTION *v2; // ecx
  DWORD StartDelayTime; // esi
  signed int result; // eax
  char buf; // [esp+1h] [ebp-1h] BYREF

  buf = HIBYTE(this);
  v2 = (ENCRYPTION *)*((_DWORD *)this + 1);
  buf = 3;                                      // 0x03 - Billing Server DisconnectPacket
  WriteData(v2, &buf, 1, 1);
  StartDelayTime = GetTickCount() / 0xA;
  for ( result = GetRelAckDiff(*((ENCRYPTION **)this + 1), 0);
        result > 0;
        result = GetRelAckDiff(*((ENCRYPTION **)this + 1), 0) )
  {
    result = abs32(GetTickCount() / 0xA - StartDelayTime);
    if ( result >= 800 )                        // Process Player Packets for only 800 milliseconds?
      break;
    PlayerDoNetworkOps(*(PLAYER **)this);
  }
  return result;
}

//----- (00405B30) --------------------------------------------------------
void *__thiscall SendBillerUserBannerPacket(void *this, int a2, const void *a3)
{
  void *result; // eax
  char buf; // [esp+0h] [ebp-68h] BYREF
  int v5; // [esp+1h] [ebp-67h]
  char v6[96]; // [esp+5h] [ebp-63h] BYREF

  result = this;
  if ( a2 >= 0 )
  {
    v5 = a2;
    buf = 0x10;                                 // 0x10 - Billing User Banner Packet
    qmemcpy(v6, a3, sizeof(v6));
    result = (void *)WriteData(*((ENCRYPTION **)this + 1), &buf, 0x65, 1);
  }
  return result;
}

//----- (00405B70) --------------------------------------------------------
void *__thiscall SendBillerUserDemographicsPacket(void *this, int a2, int UserDemographics)
{
  void *result; // eax
  ENCRYPTION *v4; // ecx
  char buf; // [esp+0h] [ebp-304h] BYREF
  int v6; // [esp+1h] [ebp-303h]
  char v7[767]; // [esp+5h] [ebp-2FFh] BYREF

  result = this;
  if ( a2 >= 0 )
  {
    v6 = a2;
    buf = 0xD;                                  // 0x0D - Billing User Demographics Packet
    qmemcpy(v7, (const void *)UserDemographics, 0x2FCu);
    v4 = (ENCRYPTION *)*((_DWORD *)this + 1);
    v7[764] = *(_BYTE *)(UserDemographics + 764);
    result = (void *)WriteData(v4, &buf, 770, 1);
  }
  return result;
}

//----- (00405BC0) --------------------------------------------------------
BOOL __thiscall SendBillerUnknownPacket(ENCRYPTION **this, int a1, int a2, const char *a3)
{
  char buf; // [esp+10h] [ebp-9h] BYREF
  int v6; // [esp+11h] [ebp-8h]
  int v7; // [esp+15h] [ebp-4h]
  char v8[2039]; // [esp+19h] [ebp+0h] BYREF

  v6 = a1;
  v7 = a2;
  buf = 0xE;                                    // 0x0E - Some Unknown Biller Packet (Contains a String)
  strcpy(v8, a3);
  return WriteData(this[1], &buf, strlen(a3) + 10, 1);
}

//----- (00405C40) --------------------------------------------------------
int __thiscall SendBillerUserChannelChatPacket(ENCRYPTION **this, int PlayerId, const char *ChannelName, const char *ChatText)
{
  int result; // eax
  char buf; // [esp+4h] [ebp-800h] BYREF
  int v7; // [esp+5h] [ebp-7FFh]
  char Dest[32]; // [esp+9h] [ebp-7FBh] BYREF
  char v9[2011]; // [esp+29h] [ebp-7DBh] BYREF

  result = PlayerId;
  if ( PlayerId >= 0 )
  {
    v7 = PlayerId;
    buf = 0x14;                                 // 0x14 - Billing User Channel Chat
    strncpy(Dest, ChannelName, 0x20u);
    Dest[31] = 0;
    strcpy(v9, ChatText);
    result = WriteData(this[1], &buf, strlen(ChatText) + 38, 1);
  }
  return result;
}

//----- (00405CD0) --------------------------------------------------------
void __thiscall SendBillerWarningPacket(struct BILLING_SERVER_STRUCT *billingServerStruct, int PlayerId, const char *WarningMessage)
{
  char buf; // [esp+4h] [ebp-400h] BYREF
  int v4; // [esp+5h] [ebp-3FFh]
  char v5[1019]; // [esp+9h] [ebp-3FBh] BYREF

  if ( PlayerId >= 0 )
  {
    v4 = PlayerId;
    buf = 0xF;                                  // 0x0F - Biller Warning Packet
    strcpy(v5, WarningMessage);
    WriteData(*((ENCRYPTION **)billingServerStruct + 1), &buf, strlen(WarningMessage) + 6, 1);
  }
}

//----- (00405D50) --------------------------------------------------------
int __thiscall biller_user_command(ENCRYPTION **this, int a1, const char *UserCommand)
{
  int result; // eax
  char buf; // [esp+4h] [ebp-400h] BYREF
  int v5; // [esp+5h] [ebp-3FFh]
  char v6[1019]; // [esp+9h] [ebp-3FBh] BYREF

  result = a1;
  if ( a1 >= 0 )
  {
    v5 = a1;
    buf = 0x13;                                 // 0x13 - Billing User Command
    strcpy(v6, UserCommand);
    result = WriteData(this[1], &buf, strlen(UserCommand) + 6, 1);
  }
  return result;
}

//----- (00405DD0) --------------------------------------------------------
BOOL __thiscall SendBillerUserLoginPacket(_DWORD *this, const char *Username, const char *Password, int IPAddress, int MachineId, int Timezone, char IsNewUser, int PlayerId, char Unused0, char isSysop)
{
  ENCRYPTION *v11; // ecx
  BOOL result; // eax
  char buf[2]; // [esp+8h] [ebp-54h] BYREF
  int v14; // [esp+Ah] [ebp-52h]
  char Dest[32]; // [esp+Eh] [ebp-4Eh] BYREF
  char v16[32]; // [esp+2Eh] [ebp-2Eh] BYREF
  int v17; // [esp+4Eh] [ebp-Eh]
  int v18; // [esp+52h] [ebp-Ah]
  int v19; // [esp+56h] [ebp-6h]
  char v20; // [esp+5Ah] [ebp-2h]
  char v21; // [esp+5Bh] [ebp-1h]

  if ( PlayerId >= 0 )
  {
    buf[0] = 4;                                 // 0x04 - Billing User Login
    strncpy(Dest, Username, 0x20u);
    Dest[31] = 0;
    strncpy(v16, Password, 0x20u);
    v14 = IPAddress;
    buf[1] = IsNewUser;
    v18 = MachineId;
    v19 = Timezone;
    v11 = (ENCRYPTION *)this[1];
    v16[31] = 0;                                // Terminate with NULL Password
    v17 = PlayerId;
    v20 = Unused0;
    v21 = isSysop;
    result = WriteData(v11, buf, 84, 1);
  }
  return result;
}

//----- (00405E70) --------------------------------------------------------
int __thiscall SendBillerUserLogoffPacket(ENCRYPTION **this, int PlayerId, __int16 DisconnectReason, __int16 Latency, __int16 Ping, __int16 S2CPacketLoss, __int16 C2SPacketLoss, const void *PlayerScore, unsigned int ExtraSize)
{
  int result; // eax
  int Size; // eax
  char buf; // [esp+0h] [ebp-400h] BYREF
  int v12; // [esp+1h] [ebp-3FFh]
  __int16 v13; // [esp+5h] [ebp-3FBh]
  __int16 v14; // [esp+7h] [ebp-3F9h]
  __int16 v15; // [esp+9h] [ebp-3F7h]
  __int16 v16; // [esp+Bh] [ebp-3F5h]
  __int16 v17; // [esp+Dh] [ebp-3F3h]
  char v18[1009]; // [esp+Fh] [ebp-3F1h] BYREF

  result = PlayerId;
  if ( PlayerId >= 0 )
  {
    v12 = PlayerId;                             // PlayerId
    v13 = DisconnectReason;                     // Disconnect Reason
    v14 = Latency;                              // Latency
    v15 = Ping;                                 // Ping
    buf = 5;                                    // 0x05 - Billing User Logoff
    v17 = C2SPacketLoss;
    v16 = S2CPacketLoss;
    Size = 15;
    if ( PlayerScore )
    {
      qmemcpy(v18, PlayerScore, ExtraSize);
      Size = ExtraSize + 15;
    }
    result = WriteData(this[1], &buf, Size, 1);
  }
  return result;
}
// 405E70: using guessed type char var_3F1[1009];

//----- (00405F20) --------------------------------------------------------
int __thiscall SendBillerUserScorePacket(ENCRYPTION **this, int PlayerId, const void *Score, unsigned int Size)
{
  int result; // eax
  char buf; // [esp+0h] [ebp-400h] BYREF
  int v6; // [esp+1h] [ebp-3FFh]
  char v7[1019]; // [esp+5h] [ebp-3FBh] BYREF

  result = PlayerId;
  if ( PlayerId >= 0 )
  {
    v6 = PlayerId;
    buf = 0x11;                                 // 0x11 - Billing User Score
    qmemcpy(v7, Score, Size);
    result = WriteData(this[1], &buf, Size + 5, 1);
  }
  return result;
}

//----- (00405F80) --------------------------------------------------------
void __thiscall SendBillerPlayerNamePacketSomething(ENCRYPTION **this, int a2, int a3, int a4, int len)
{
  _DWORD *v6; // ebx
  int lena; // [esp+24h] [ebp+10h]

  lena = len + 9;
  v6 = emalloc(lena);
  qmemcpy((char *)v6 + 9, (const void *)a4, len);
  *(_DWORD *)((char *)v6 + 5) = a3;
  *(_BYTE *)v6 = 6;                             // 0x06 - Billing PlayerName Packet
  *(_DWORD *)((char *)v6 + 1) = a2;
  qmemcpy((char *)v6 + 9, (const void *)a4, len);
  WriteData(this[1], v6, lena, 1);
  efree(v6);
}

//----- (00406010) --------------------------------------------------------
void __thiscall SendBillerUserPrivateChatPacket(ENCRYPTION **this, int PlayerId, int BillingGroupId, const void *a3, unsigned int len)
{
  _DWORD *v6; // ebx
  int lena; // [esp+24h] [ebp+10h]

  lena = len + 9;
  v6 = emalloc(lena);
  qmemcpy((char *)v6 + 9, a3, len);
  *(_DWORD *)((char *)v6 + 5) = BillingGroupId;
  *(_BYTE *)v6 = 7;                             // 0x07 - Billing User Private Chat
  *(_DWORD *)((char *)v6 + 1) = PlayerId;
  qmemcpy((char *)v6 + 9, a3, len);
  WriteData(this[1], v6, lena, 1);
  efree(v6);
}

//----- (004060A0) --------------------------------------------------------
void __thiscall SendBillerZoneRevokePermitPacket(ENCRYPTION **this, int a2, int a3, int a4, int len)
{
  _DWORD *v6; // ebx
  int lena; // [esp+24h] [ebp+10h]

  lena = len + 9;
  v6 = emalloc(lena);
  qmemcpy((char *)v6 + 9, (const void *)a4, len);
  *(_DWORD *)((char *)v6 + 5) = a3;
  *(_BYTE *)v6 = 0x12;                          // 0x12 - Billing Something with Zone Player *Revoke or *Permit
  *(_DWORD *)((char *)v6 + 1) = a2;
  qmemcpy((char *)v6 + 9, (const void *)a4, len);
  WriteData(this[1], v6, lena, 1);
  efree(v6);
}

//----- (00406130) --------------------------------------------------------
int __thiscall GetBillerLastReconnectTime(_DWORD *this)
{
  return *(_DWORD *)(this[1] + 58);
}

//----- (00406140) --------------------------------------------------------
signed int __thiscall IsBillingServerDisconnected(int this)
{
  __int64 v2; // rax
  DWORD v3; // eax
  ENCRYPTION *v4; // ecx
  int i; // eax
  void (__cdecl *v6)(int, int); // ecx
  char buf; // [esp+Bh] [ebp-9h] BYREF
  int v9; // [esp+Ch] [ebp-8h] BYREF
  char v10[4]; // [esp+10h] [ebp-4h] BYREF

  if ( CheckIfBillingServerIsConnected(*(_DWORD *)(this + 4)) != 2
    || GetRelAckDiff(*(ENCRYPTION **)(this + 4), 0) >= 255 )
  {
    return 1;
  }
  v2 = (int)(GetTickCount() / 0xA - *(_DWORD *)(this + 16));
  if ( (int)((HIDWORD(v2) ^ v2) - HIDWORD(v2)) > 3000 )
  {
    v3 = GetTickCount();
    v4 = *(ENCRYPTION **)(this + 4);
    *(_DWORD *)(this + 16) = v3 / 0xA;
    buf = 1;
    WriteData(v4, &buf, 1, 1);
  }
  for ( i = sub_41B1B0(*(_DWORD *)this, (int)&v9, (int)v10); i; i = sub_41B1B0(*(_DWORD *)this, (int)&v9, (int)v10) )
  {
    v6 = *(void (__cdecl **)(int, int))(this + 12);
    if ( v6 )
      v6(i, v9);
  }
  return 0;
}

//----- (00406210) --------------------------------------------------------
struc_2 *__thiscall ReadSettingsSomething(struc_2 *ConfigSETPointer, const char *Filename)
{
  int v3; // esi
  FILE *v4; // eax
  FILE *v5; // edi
  char *v6; // edx
  char v7; // al
  char *v8; // edi
  char *i; // ecx
  char *v10; // eax
  char *v11; // edx
  char j; // cl
  char k; // cl
  char *v14; // eax
  char v15; // cl
  char *l; // edx
  FILE *v18; // [esp+10h] [ebp-204h]
  char Buf; // [esp+14h] [ebp-200h] BYREF
  char v20; // [esp+15h] [ebp-1FFh] BYREF

  strcpy((char *)ConfigSETPointer + 177740, Filename);
  *((_DWORD *)ConfigSETPointer + 2432) = 0;
  *((_DWORD *)ConfigSETPointer + 44433) = 0;
  *((_DWORD *)ConfigSETPointer + 44434) = 0;
  v3 = -1;
  v4 = fopen((const char *)ConfigSETPointer + 177740, "rt");
  v5 = v4;
  v18 = v4;
  if ( v4 )
  {
    if ( (v4->_flag & 0x10) == 0 )
    {
      do
      {
        Buf = 0;
        fgets(&Buf, 512, v5);
        if ( Buf == '[' )
        {
          v3 = *((_DWORD *)ConfigSETPointer + 2432);
          *((_DWORD *)ConfigSETPointer + 2432) = v3 + 1;
          v6 = &v20;
          v7 = v20;
          v8 = (char *)ConfigSETPointer + 38 * v3;
          for ( i = v8; v7; ++v6 )
          {
            if ( v7 == ']' )
              break;
            *i = v7;
            v7 = v6[1];
            ++i;
          }
          *i = 0;
          *(_DWORD *)(v8 + 30) = *((_DWORD *)ConfigSETPointer + 44433);
          *(_DWORD *)(v8 + 34) = 0;
          v5 = v18;
        }
        else if ( isalpha(Buf) && v3 != -1 )
        {
          v10 = &Buf;
          v11 = (char *)ConfigSETPointer + 140 * *((_DWORD *)ConfigSETPointer + 44433) + 9732;
          for ( j = Buf; j; ++v10 )
          {
            if ( j == '=' )
              break;
            if ( j == ' ' )
              break;
            *v11 = j;
            j = v10[1];
            ++v11;
          }
          *v11 = 0;
          for ( k = *v10; k; k = *++v10 )
          {
            if ( k == '=' )
              break;
          }
          if ( *v10 )
          {
            v14 = v10 + 1;
            v15 = *v14;
            for ( l = (char *)ConfigSETPointer + 140 * *((_DWORD *)ConfigSETPointer + 44433) + 9772; v15 >= 32; ++v14 )
            {
              *l = v15;
              v15 = v14[1];
              ++l;
            }
            *l = 0;
            config_read_helper_3((int)ConfigSETPointer + 140 * *((_DWORD *)ConfigSETPointer + 44433) + 9772);
            ++*((_DWORD *)ConfigSETPointer + 44433);
            ++*(_DWORD *)((char *)ConfigSETPointer + 38 * v3 + 34);
          }
        }
      }
      while ( (v5->_flag & 0x10) == 0 );
    }
    fclose(v5);
  }
  return ConfigSETPointer;
}

//----- (004063F0) --------------------------------------------------------
FILE *__thiscall WriteCfgFile(int this)
{
  int v1; // esi
  FILE *result; // eax
  FILE *v3; // ebp
  _DWORD *v4; // edi
  int v5; // ebx
  const char *v6; // esi
  int v7; // [esp+8h] [ebp-8h]

  v1 = this;
  result = *(FILE **)(this + 177736);
  if ( result )
  {
    result = fopen((const char *)(this + 177740), "wt");
    v3 = result;
    if ( result )
    {
      v7 = 0;
      if ( *(int *)(v1 + 9728) > 0 )
      {
        v4 = (_DWORD *)(v1 + 34);
        do
        {
          if ( (int)*v4 > 0 )
          {
            fprintf(v3, "[%s]\n", (const char *)v4 - 34);
            v5 = 0;
            if ( (int)*v4 > 0 )
            {
              v6 = (const char *)(v1 + 140 * *(v4 - 1) + 9732);
              do
              {
                fprintf(v3, "%s=%s\n", v6, v6 + 40);
                ++v5;
                v6 += 140;
              }
              while ( v5 < *v4 );
              v1 = this;
            }
            fprintf(v3, "\n");
          }
          v4 = (_DWORD *)((char *)v4 + 38);
          ++v7;
        }
        while ( v7 < *(_DWORD *)(v1 + 9728) );
      }
      result = (FILE *)fclose(v3);
    }
  }
  return result;
}

//----- (004064D0) --------------------------------------------------------
int __thiscall GetCFGSettingInteger(char *Str1, char *Str2, int a3, int a4)
{
  char *v4; // ebp
  int *v5; // edi
  int v6; // esi
  int v7; // ebx
  const char *v8; // ebp
  int result; // eax
  int v10; // [esp+10h] [ebp-18h]
  char Source[16]; // [esp+18h] [ebp-10h] BYREF

  v4 = Str1;
  v10 = 0;
  if ( *((int *)Str1 + 2432) <= 0 )
  {
LABEL_10:
    sprintf(Source, "%d", a4);
    FillArenaSettingsStruct((struc_2 *)v4, Str2, (const char *)a3, Source);
    result = a4;
  }
  else
  {
    v5 = (int *)(Str1 + 34);
    while ( 1 )
    {
      if ( !_strcmpi((const char *)v5 - 34, Str2) )
      {
        v6 = *(v5 - 1);
        v7 = 0;
        if ( *v5 > 0 )
          break;
      }
LABEL_9:
      v5 = (int *)((char *)v5 + 38);
      if ( ++v10 >= *((_DWORD *)v4 + 2432) )
        goto LABEL_10;
    }
    v8 = &v4[140 * v6 + 9732];
    while ( _strcmpi(v8, (const char *)a3) )
    {
      ++v7;
      ++v6;
      v8 += 140;
      if ( v7 >= *v5 )
      {
        v4 = Str1;
        goto LABEL_9;
      }
    }
    result = atoi(&Str1[140 * v6 + 9772]);
  }
  return result;
}

//----- (004065C0) --------------------------------------------------------
char *__thiscall GetCFGSettingString(char *Str1, char *Str2, int a3, char *Source, char *Dest, size_t Count)
{
  char *v6; // ebx
  int *v7; // edi
  int v8; // esi
  int v9; // ebp
  const char *v10; // ebx
  size_t v11; // edi
  char *v13; // [esp-8h] [ebp-20h]
  size_t v14; // [esp-4h] [ebp-1Ch]
  int v15; // [esp+10h] [ebp-8h]

  v6 = Str1;
  v15 = 0;
  if ( *((int *)Str1 + 2432) <= 0 )
  {
LABEL_10:
    FillArenaSettingsStruct((struc_2 *)v6, Str2, (const char *)a3, Source);
    v11 = Count;
    v14 = Count;
    v13 = Source;
  }
  else
  {
    v7 = (int *)(Str1 + 34);
    while ( 1 )
    {
      if ( !_strcmpi((const char *)v7 - 34, Str2) )
      {
        v8 = *(v7 - 1);
        v9 = 0;
        if ( *v7 > 0 )
          break;
      }
LABEL_9:
      v7 = (int *)((char *)v7 + 38);
      if ( ++v15 >= *((_DWORD *)v6 + 2432) )
        goto LABEL_10;
    }
    v10 = &v6[140 * v8 + 9732];
    while ( _strcmpi(v10, (const char *)a3) )
    {
      ++v9;
      ++v8;
      v10 += 140;
      if ( v9 >= *v7 )
      {
        v6 = Str1;
        goto LABEL_9;
      }
    }
    v11 = Count;
    v14 = Count;
    v13 = &Str1[140 * v8 + 9772];
  }
  strncpy(Dest, v13, v14);
  Dest[v11 - 1] = 0;
  return Dest;
}

//----- (004066B0) --------------------------------------------------------
char *__thiscall sub_4066B0(int this, const char *Str2, const char *a3, const char *Source, char *Dest, size_t Count)
{
  int v6; // ebx
  int *v7; // edi
  int v8; // esi
  int v9; // ebp
  const char *v10; // ebx
  size_t v11; // edi
  size_t v14; // [esp-4h] [ebp-1Ch]
  int v15; // [esp+10h] [ebp-8h]

  v6 = this;
  v15 = 0;
  if ( *(int *)(this + 9728) <= 0 )
  {
LABEL_10:
    v11 = Count;
    v14 = Count;
  }
  else
  {
    v7 = (int *)(this + 34);
    while ( 1 )
    {
      if ( !_strcmpi((const char *)v7 - 34, Str2) )
      {
        v8 = *(v7 - 1);
        v9 = 0;
        if ( *v7 > 0 )
          break;
      }
LABEL_9:
      v7 = (int *)((char *)v7 + 38);
      if ( ++v15 >= *(_DWORD *)(v6 + 9728) )
        goto LABEL_10;
    }
    v10 = (const char *)(v6 + 140 * v8 + 9732);
    while ( _strcmpi(v10, a3) )
    {
      ++v9;
      ++v8;
      v10 += 140;
      if ( v9 >= *v7 )
      {
        v6 = this;
        goto LABEL_9;
      }
    }
    v11 = Count;
    v14 = Count;
    Source = (const char *)(this + 140 * v8 + 9772);
  }
  strncpy(Dest, Source, v14);
  Dest[v11 - 1] = 0;
  return Dest;
}

//----- (00406790) --------------------------------------------------------
void __thiscall FillArenaSettingsStruct(struc_2 *Str1, const char *Str2, const char *a3, const char *Source)
{
  struc_2 *v4; // ebp
  int v5; // esi
  int v6; // eax
  struc_2 *v7; // edi
  int v8; // eax
  char *v9; // esi
  int v10; // ebx
  int v11; // ecx
  char *v12; // esi
  const char *v13; // edi
  char *v14; // ebx
  int v15; // eax
  _DWORD *v16; // ecx
  int v17; // [esp+10h] [ebp-Ch]
  char *v18; // [esp+14h] [ebp-8h]
  char *Str2a; // [esp+20h] [ebp+4h]

  v4 = Str1;
  v5 = 0;
  v6 = *((_DWORD *)Str1 + 2432);
  *((_DWORD *)Str1 + 44434) = 1;
  if ( v6 <= 0 )
  {
LABEL_5:
    strcpy((char *)v4 + 38 * *((_DWORD *)v4 + 2432), Str2);
    *(_DWORD *)((char *)v4 + 38 * *((_DWORD *)v4 + 2432) + 30) = *((_DWORD *)v4 + 44433);
    *(_DWORD *)((char *)v4 + 38 * *((_DWORD *)v4 + 2432) + 34) = 1;
    v8 = 7 * *((_DWORD *)v4 + 44433);
    ++*((_DWORD *)v4 + 2432);
    strcpy((char *)v4 + 20 * v8 + 9732, a3);
    v9 = (char *)v4 + 140 * *((_DWORD *)v4 + 44433) + 9772;
    strncpy(v9, Source, 0x64u);
    v9[99] = 0;
    ++*((_DWORD *)v4 + 44433);
  }
  else
  {
    v7 = Str1;
    while ( _strcmpi((const char *)v7, Str2) )
    {
      ++v5;
      v7 = (struc_2 *)((char *)v7 + 38);
      if ( v5 >= *((_DWORD *)v4 + 2432) )
        goto LABEL_5;
    }
    v17 = v5;
    v10 = 0;
    v11 = 19 * v5;
    v12 = *(char **)((char *)v4 + 38 * v5 + 30);
    Str2a = v12;
    v18 = (char *)v4 + 2 * v11;
    if ( *(int *)(v18 + 34) <= 0 )
    {
LABEL_12:
      memcpy(
        (char *)v4 + 140 * (_DWORD)v12 + 9872,
        (char *)v4 + 140 * (_DWORD)v12 + 9732,
        140 * *((_DWORD *)v4 + 44433) - 140 * (_DWORD)v12);
      v14 = (char *)v4 + 140 * (_DWORD)v12 + 9772;
      strcpy((char *)v4 + 140 * (_DWORD)v12 + 9732, a3);
      strncpy(v14, Source, 0x64u);
      v14[99] = 0;
      ++*((_DWORD *)v4 + 44433);
      ++*(_DWORD *)(v18 + 34);
      v15 = 0;
      if ( *((int *)v4 + 2432) > 0 )
      {
        v16 = (_DWORD *)((char *)v4 + 30);
        do
        {
          if ( *v16 >= (int)Str2a && v15 != v17 )
            ++*v16;
          ++v15;
          v16 = (_DWORD *)((char *)v16 + 38);
        }
        while ( v15 < *((_DWORD *)v4 + 2432) );
      }
    }
    else
    {
      v13 = (char *)v4 + 140 * (_DWORD)v12 + 9732;
      while ( _strcmpi(v13, a3) )
      {
        ++v10;
        ++v12;
        v13 += 140;
        if ( v10 >= *(_DWORD *)(v18 + 34) )
        {
          Str2a = v12;
          goto LABEL_12;
        }
      }
      strcpy((char *)v4 + 140 * (_DWORD)v12 + 9772, Source);
    }
  }
}

//----- (00406A30) --------------------------------------------------------
char *__thiscall LoadBMPHeader(char *Filename, char *Source)
{
  FILE *v3; // eax
  FILE *v4; // edi
  int v5; // eax
  unsigned int v6; // eax
  _DWORD *v7; // eax
  size_t v8; // edx
  char DstBuf[2]; // [esp+Ch] [ebp-8h] BYREF
  int v11; // [esp+Eh] [ebp-6h]

  strncpy(Filename, Source, 0x100u);
  Filename[255] = 0;
  *((_DWORD *)Filename + 66) = 0;
  *((_DWORD *)Filename + 67) = 0;
  v3 = fopen(Filename, "rb");
  v4 = v3;
  if ( v3 )
  {
    *((_DWORD *)Filename + 64) = 0;
    if ( fread(DstBuf, 1u, 6u, v3) == 6 && DstBuf[0] == 'B' && DstBuf[1] == 'M' )// Load BMP Header.
      *((_DWORD *)Filename + 64) = v11;
    fseek(v4, *((_DWORD *)Filename + 64), 0);
    v5 = _fileno(v4);
    v6 = (unsigned int)(_filelength(v5) - *((_DWORD *)Filename + 64)) >> 2;
    *((_DWORD *)Filename + 67) = v6;
    v7 = emalloc(4 * v6);
    v8 = *((_DWORD *)Filename + 67);
    *((_DWORD *)Filename + 66) = v7;
    fread(v7, v8, 4u, v4);
    fclose(v4);
  }
  *((_DWORD *)Filename + 65) = 0;
  return Filename;
}
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);

//----- (00406B30) --------------------------------------------------------
void __thiscall sub_406B30(char *Filename)
{
  FILE *v2; // edi
  int v3; // eax
  void *v4; // esi
  int v5; // [esp-4h] [ebp-Ch]

  if ( *((_DWORD *)Filename + 65) )
  {
    if ( *((_DWORD *)Filename + 66) )
    {
      v2 = fopen(Filename, "rb+");
      if ( v2 || (v2 = fopen(Filename, "wb")) != 0 )
      {
        fseek(v2, *((_DWORD *)Filename + 64), 0);
        fwrite(*((const void **)Filename + 66), *((_DWORD *)Filename + 67), 4u, v2);
        v5 = *((_DWORD *)Filename + 64) + 4 * *((_DWORD *)Filename + 67);
        v3 = _fileno(v2);
        _chsize(v3, v5);
        fclose(v2);
      }
    }
  }
  v4 = (void *)*((_DWORD *)Filename + 66);
  if ( v4 )
    efree(v4);
}
// 41E210: using guessed type _DWORD __cdecl _chsize(_DWORD, _DWORD);

//----- (00406BE0) --------------------------------------------------------
int __thiscall sub_406BE0(_DWORD *this)
{
  return this[67];
}

//----- (00406BF0) --------------------------------------------------------
void __thiscall GetTileValue(struct BMP_FILE_STRUCT *BMPFile, int TileCounter, int *TileValuePointer)
{
  int v3; // edx
  int v4; // eax
  int v5; // esi

  v3 = *TileValuePointer ^ ((unsigned __int16)*TileValuePointer ^ (unsigned __int16)*(_DWORD *)(*((_DWORD *)BMPFile + 66)
                                                                                              + 4 * TileCounter)) & 0xFFF;
  *TileValuePointer = v3;
  v4 = v3 ^ (v3 ^ *(_DWORD *)(*((_DWORD *)BMPFile + 66) + 4 * TileCounter)) & 0xFFF000;
  *TileValuePointer = v4;
  v5 = *(_DWORD *)(*((_DWORD *)BMPFile + 66) + 4 * TileCounter);
  *TileValuePointer = v5 ^ (v5 ^ v4) & 0xFFFFFF;
}

//----- (00406C50) --------------------------------------------------------
signed int __cdecl DoBrickDrop(int a1, signed int XTiles, signed int YTiles, int X1Tile, int a5, int X2Tile, signed int a7, signed int a8)
{
  signed int v8; // ebx
  int v9; // esi
  int v10; // ebx
  signed int i; // edi
  int v12; // edi
  signed int v13; // ecx
  _BYTE *v14; // eax
  int v15; // ecx
  signed int v16; // esi
  _BYTE *v17; // eax
  int v18; // esi
  int v19; // eax
  int v20; // eax
  signed int j; // ecx
  signed int result; // eax
  int v23; // eax
  signed int v24; // eax
  int v25; // edi
  _BYTE *v26; // ebx

  v8 = XTiles;
  if ( XTiles < 0 )
  {
    v9 = a1;
  }
  else
  {
    v9 = a1;
    do
    {
      if ( *(_BYTE *)(v8 + a1 + (YTiles << 10)) )
        break;
      --v8;
    }
    while ( v8 >= 0 );
  }
  v10 = v8 + 1;
  for ( i = XTiles; i < 1024; ++i )
  {
    if ( *(_BYTE *)(i + (YTiles << 10) + v9) )
      break;
  }
  v12 = i - 1;
  if ( v12 < v10 )
    v12 = v10;
  v13 = YTiles;
  if ( YTiles >= 0 )
  {
    v14 = (_BYTE *)(v9 + XTiles + (YTiles << 10));
    do
    {
      if ( *v14 )
        break;
      --v13;
      v14 -= 1024;
    }
    while ( v13 >= 0 );
  }
  v15 = v13 + 1;
  v16 = YTiles;
  if ( YTiles < 1024 )
  {
    v17 = (_BYTE *)(a1 + XTiles + (YTiles << 10));
    do
    {
      if ( *v17 )
        break;
      ++v16;
      v17 += 1024;
    }
    while ( v16 < 1024 );
  }
  v18 = v16 - 1;
  if ( v18 < v15 )
    v18 = v15;
  v19 = a8 / 2;
  if ( v12 - v10 >= v18 - v15 )
  {
    if ( v15 <= YTiles - v19 )
      v15 = YTiles - v19;
    v23 = YTiles + v19;
    if ( v18 >= v23 )
      v18 = v23;
    v24 = v18 - v15 + 1;
    if ( v24 < a8 )
    {
      v25 = a1 + XTiles + (v15 << 10);
      v26 = (_BYTE *)(a1 + XTiles + ((v18 + 1) << 10));
      do
      {
        if ( v15 - 1 < 0 || *(_BYTE *)(v25 - 1024) )
        {
          if ( v18 >= 1023 || *v26 )
            break;
          ++v18;
          v26 += 1024;
        }
        else
        {
          --v15;
          v25 -= 1024;
        }
        ++v24;
      }
      while ( v24 < a8 );
    }
    *(_DWORD *)a5 = v15;
    *(_DWORD *)a7 = v18;
    result = XTiles;
    *(_DWORD *)X1Tile = XTiles;
    *(_DWORD *)X2Tile = XTiles;
  }
  else
  {
    if ( v10 <= XTiles - v19 )
      v10 = XTiles - v19;
    v20 = XTiles + v19;
    if ( v12 >= v20 )
      v12 = v20;
    for ( j = v12 - v10 + 1; j < a8; ++j )
    {
      if ( v10 - 1 < 0 || *(_BYTE *)(v10 + (YTiles << 10) + a1 - 1) )
      {
        if ( v12 >= 1023 || *(_BYTE *)(v12 + (YTiles << 10) + a1 + 1) )
          break;
        ++v12;
      }
      else
      {
        --v10;
      }
    }
    *(_DWORD *)X1Tile = v10;
    result = a7;
    *(_DWORD *)X2Tile = v12;
    *(_DWORD *)a5 = YTiles;
    *(_DWORD *)a7 = YTiles;
  }
  return result;
}

//----- (00406E30) --------------------------------------------------------
signed int __cdecl GenerateLVLChecksum(int MapData, signed int Key)
{
  signed int v2; // edi
  int v3; // ecx
  int v4; // eax
  unsigned int v5; // esi
  unsigned int v6; // ebx
  unsigned int v7; // edx
  unsigned __int8 *v8; // ecx
  unsigned __int8 v9; // al
  int MapDataa; // [esp+8h] [ebp+4h]

  v2 = Key;
  v3 = Key % 32;
  if ( Key % 32 < 1024 )
  {
    v4 = 1024 - Key % 31;
    v5 = Key % 31 + MapData + (v3 << 10);
    MapDataa = v4;
    v6 = (unsigned int)(1055 - v3) >> 5;
    do
    {
      v7 = v4 + v5;
      v8 = (unsigned __int8 *)v5;
      if ( v5 < v4 + v5 )
      {
        do
        {
          v9 = *v8;
          if ( *v8 && v9 < 0xA1u || v9 == 0xAB )
            Key += *v8 ^ v2;
          v8 += 31;
        }
        while ( (unsigned int)v8 < v7 );
        v4 = MapDataa;
      }
      v5 += 0x8000;
      --v6;
    }
    while ( v6 );
  }
  return Key;
}

//----- (00406ED0) --------------------------------------------------------
int __cdecl LoadBMPHeader2(char *Filename)
{
  int v1; // ebx
  FILE *v2; // eax
  FILE *v3; // ebp
  __int32 v4; // edi
  int v5; // eax
  __int32 v6; // eax
  unsigned __int32 v7; // eax
  signed int v8; // esi
  _DWORD *v9; // edi
  int *v10; // ecx
  int v11; // eax
  int result; // eax
  char DstBuf[2]; // [esp+8h] [ebp-8h] BYREF
  int v14; // [esp+Ah] [ebp-6h]

  v1 = 1;
  v2 = fopen(Filename, "rb");
  v3 = v2;
  if ( !v2 )
    return 0;
  v4 = 0;
  if ( fread(DstBuf, 1u, 6u, v2) == 6 && DstBuf[0] == 'B' && DstBuf[1] == 'M' )// Load BMP Header
    v4 = v14;
  v5 = _fileno(v3);
  v6 = _filelength(v5);
  if ( v4 < v6 && v4 >= 0 && (v7 = v6 - v4, v8 = v7 >> 2, 4 * (v7 >> 2) == v7) && (fseek(v3, v4, 0), v8 > 0) )
  {
    v9 = emalloc(4 * v8);
    fread(v9, v8, 4u, v3);
    v10 = v9;
    do
    {
      v11 = *v10;
      if ( (*v10 & 0xFFFu) > 0x400 || (v11 & 0xFFF000u) > 0x400000 || (v11 & 0xFF000000) == 0 )
        v1 = 0;
      ++v10;
      --v8;
    }
    while ( v8 );
    efree(v9);
    fclose(v3);
    result = v1;
  }
  else
  {
    fclose(v3);
    result = 0;
  }
  return result;
}
// 406F8B: conditional instruction was optimized away because of 'esi.4>=1'
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);

//----- (00407000) --------------------------------------------------------
void __thiscall InitializeTextFile(struct TEXT_FILE_STRUCT *textFile, const char *Source, int makeUpperCase, int addAll)
{
  *((_DWORD *)textFile + 66) = makeUpperCase;
  *((_DWORD *)textFile + 67) = addAll;
  if ( Source )
  {
    strncpy((char *)textFile, Source, 0x100u);
    *((_BYTE *)textFile + 255) = 0;
  }
  else
  {
    *(_BYTE *)textFile = 0;
  }
  *((_DWORD *)textFile + 65) = 0;
  *((_DWORD *)textFile + 64) = 0;
  LoadTextFile(textFile, 1);
}

//----- (00407060) --------------------------------------------------------
void __thiscall CleanTextFileMemory(TEXT_FILE_STRUCT *textFile)
{
  int i; // edi

  if ( *((_DWORD *)textFile + 64) )
  {
    for ( i = 0; i < *((_DWORD *)textFile + 65); ++i )
      efree(*(LPVOID *)(*((_DWORD *)textFile + 64) + 4 * i));
    ExpandMemory(*((LPVOID *)textFile + 64), 0, 1);
    *((_DWORD *)textFile + 64) = 0;
    *((_DWORD *)textFile + 65) = 0;
  }
}

//----- (004070D0) --------------------------------------------------------
void __thiscall LoadTextFile(struct TEXT_FILE_STRUCT *textFile, int a2)
{
  int i; // esi
  FILE *v4; // eax
  FILE *v5; // esi
  char *j; // eax
  char Buf[512]; // [esp+10h] [ebp-200h] BYREF

  if ( a2 || !*(_BYTE *)textFile || IsFileLastWrittenTime((LPCSTR)textFile, (int)textFile + 272) )
  {
    if ( *((_DWORD *)textFile + 64) )
    {
      for ( i = 0; i < *((_DWORD *)textFile + 65); ++i )
        efree(*(LPVOID *)(*((_DWORD *)textFile + 64) + 4 * i));
      ExpandMemory(*((LPVOID *)textFile + 64), 0, 1);
      *((_DWORD *)textFile + 64) = 0;
      *((_DWORD *)textFile + 65) = 0;
    }
    if ( *(_BYTE *)textFile )
    {
      v4 = fopen((const char *)textFile, "rt");
      v5 = v4;
      if ( v4 )
      {
        if ( (v4->_flag & 0x10) == 0 )
        {
          do
          {
            if ( fgets(Buf, 512, v5) )
            {
              for ( j = &Buf[strlen(Buf)]; j != Buf; --j )
              {
                if ( *(j - 1) >= 32 )
                  break;
              }
              *j = 0;
              if ( strlen(Buf) )
                AddLineTextFile(textFile, Buf);
            }
          }
          while ( (v5->_flag & 0x10) == 0 );
        }
        fclose(v5);
      }
    }
  }
}
// 4070D0: using guessed type char Buf[512];

//----- (00407200) --------------------------------------------------------
void __thiscall WriteTextFileToFile(struct TEXT_FILE_STRUCT *textFile)
{
  FILE *v2; // ebx
  int i; // esi

  if ( *(_BYTE *)textFile )
  {
    v2 = fopen((const char *)textFile, "wt");
    if ( v2 )
    {
      for ( i = 0; i < *((_DWORD *)textFile + 65); ++i )
        fprintf(v2, "%s\n", *(const char **)(*((_DWORD *)textFile + 64) + 4 * i));
      fclose(v2);
    }
  }
}

//----- (00407260) --------------------------------------------------------
int __thiscall ListMachine(int this)
{
  return *(_DWORD *)(this + 260);
}

//----- (00407270) --------------------------------------------------------
int __thiscall ListMachineByIndex(int this, int listMachineIndex)
{
  return *(_DWORD *)(*(_DWORD *)(this + 256) + 4 * listMachineIndex);
}

//----- (00407280) --------------------------------------------------------
void __thiscall AddLineTextFile(struct TEXT_FILE_STRUCT *textFile, char *ChatMsgBuffer)
{
  int v3; // esi
  int v4; // eax
  char *v5; // eax
  size_t v6; // ecx
  unsigned int v8; // [esp+10h] [ebp-4h] BYREF
  char *ChatMsgBuffera; // [esp+18h] [ebp+4h]

  v3 = 0;
  v4 = BinarySearch(
         (int)ChatMsgBuffer,
         *((_DWORD *)textFile + 64),
         *((_DWORD *)textFile + 65),
         4,
         (int (__cdecl *)(_DWORD, _DWORD))StrCmpiWrapper,
         &v8);
  if ( !v8 || !*((_DWORD *)textFile + 67) )
  {
    if ( v4 )
      v3 = (v4 - *((_DWORD *)textFile + 64)) >> 2;
    v5 = (char *)ExpandMemory(*((LPVOID *)textFile + 64), 4 * *((_DWORD *)textFile + 65) + 4, 2048);
    v6 = 4 * (*((_DWORD *)textFile + 65) + 0x3FFFFFFF * v3);
    *((_DWORD *)textFile + 64) = v5;
    memcpy(&v5[4 * v3 + 4], &v5[4 * v3], v6);
    ChatMsgBuffera = (char *)emalloc(strlen(ChatMsgBuffer) + 1);
    strcpy(ChatMsgBuffera, ChatMsgBuffer);
    *(_DWORD *)(*((_DWORD *)textFile + 64) + 4 * v3) = ChatMsgBuffera;
    if ( *((_DWORD *)textFile + 66) )
      _strupr(*(char **)(*((_DWORD *)textFile + 64) + 4 * v3));
    ++*((_DWORD *)textFile + 65);
  }
}
/* Orphan comments:
Make more memory for chat message
Copy chat message into memory
*/

//----- (004073A0) --------------------------------------------------------
LPVOID __thiscall ListMachineSomething(int this, int a2)
{
  int v3; // ecx
  LPVOID result; // eax

  efree(*(LPVOID *)(*(_DWORD *)(this + 256) + 4 * a2));
  v3 = *(_DWORD *)(this + 260) - 1;
  *(_DWORD *)(this + 260) = v3;
  memcpy(
    (void *)(4 * a2 + *(_DWORD *)(this + 256)),
    (const void *)(*(_DWORD *)(this + 256) + 4 * a2 + 4),
    4 * (v3 + 0x3FFFFFFF * a2));
  result = ExpandMemory(*(LPVOID *)(this + 256), 4 * *(_DWORD *)(this + 260), 2048);
  *(_DWORD *)(this + 256) = result;
  return result;
}

//----- (00407420) --------------------------------------------------------
int __thiscall IsBannedMachineId(int this, int a2)
{
  int v3; // eax
  int result; // eax

  v3 = BinarySearch(
         a2,
         *(_DWORD *)(this + 256),
         *(_DWORD *)(this + 260),
         4,
         (int (__cdecl *)(_DWORD, _DWORD))StrCmpiWrapper,
         (unsigned int *)&a2);
  if ( a2 )
    result = (v3 - *(_DWORD *)(this + 256)) >> 2;
  else
    result = -1;
  return result;
}

//----- (00407470) --------------------------------------------------------
int __cdecl StrCmpiWrapper(const char *Str1, const char **a2)
{
  return _strcmpi(Str1, *a2);
}

//----- (00407490) --------------------------------------------------------
char *__cdecl GetSplitNextDirectoryIP(char *a1, char *Src)
{
  char *v2; // esi
  int v3; // ecx
  char v4; // al
  char *i; // ecx

  *a1 = 0;
  v2 = Src;
  if ( isspace(*Src) == ' ' )
  {
    do
      v3 = *++v2;
    while ( isspace(v3) == ' ' );
  }
  v4 = *v2;
  for ( i = a1; v4; ++v2 )
  {
    if ( v4 == 44 )
      break;
    *i = v4;
    v4 = v2[1];
    ++i;
  }
  *i = 0;
  if ( *v2 == 44 )
    ++v2;
  strcpy(Src, v2);
  return a1;
}

//----- (00407510) --------------------------------------------------------
BOOL __cdecl IsFileLastWrittenTime(LPCSTR lpFileName, int a2)
{
  HANDLE v2; // eax
  void *v3; // esi
  struct _FILETIME LastWriteTime; // [esp+4h] [ebp-18h] BYREF
  struct _FILETIME LastAccessTime; // [esp+Ch] [ebp-10h] BYREF
  struct _FILETIME CreationTime; // [esp+14h] [ebp-8h] BYREF

  v2 = CreateFileA(lpFileName, 0x80000000, 0, 0, 3u, 0x80u, 0);
  v3 = v2;
  if ( v2 != (HANDLE)-1 )
  {
    GetFileTime(v2, &CreationTime, &LastAccessTime, &LastWriteTime);
    CloseHandle(v3);
    v2 = (HANDLE)LastWriteTime.dwLowDateTime;
  }
  if ( *(HANDLE *)a2 == v2 )
    return 0;
  *(_DWORD *)a2 = v2;
  return 1;
}

//----- (00407580) --------------------------------------------------------
int __cdecl BinarySearch(int ElementToFind, unsigned int Array, int TotalElements, signed int ElementSize, int (__cdecl *CompareFunc)(_DWORD, _DWORD), unsigned int *FoundPointer)
{
  unsigned int v6; // esi
  int result; // eax
  unsigned int v8; // ebp
  unsigned int v9; // edi

  v6 = 0;
  result = 0;
  *FoundPointer = 0;
  if ( !TotalElements )
    return result;
  v8 = Array;
  v9 = Array + ElementSize * (TotalElements - 1);
  if ( Array > v9 )
  {
LABEL_9:
    if ( result > 0 )
      v6 += ElementSize;
    return v6;
  }
  while ( 1 )
  {
    v6 = v8 + ElementSize * ((int)(v9 - v8) / ElementSize / 2);
    result = CompareFunc(ElementToFind, v6);
    if ( result < 0 )
    {
      if ( v6 == Array )
        goto LABEL_9;
      v9 = v6 - ElementSize;
      goto LABEL_8;
    }
    if ( result <= 0 )
      break;
    v8 = v6 + ElementSize;
LABEL_8:
    if ( v8 > v9 )
      goto LABEL_9;
  }
  *FoundPointer = 1;
  if ( v6 == Array )
    return Array;
  while ( 1 )
  {
    v6 -= ElementSize;
    if ( CompareFunc(ElementToFind, v6) )
      break;
    if ( v6 == Array )
      return Array;
  }
  return v6 + ElementSize;
}

//----- (00407630) --------------------------------------------------------
UINT __cdecl GetPrivateProfileIntWrapper(LPCSTR lpAppName, LPCSTR lpKeyName, int a3, LPCSTR lpFileName)
{
  UINT v4; // esi
  CHAR Dest[16]; // [esp+10h] [ebp-10h] BYREF

  v4 = GetPrivateProfileIntA(lpAppName, lpKeyName, -12345678, lpFileName);
  if ( v4 == -12345678 )
  {
    v4 = a3;
    sprintf(Dest, "%d", a3);
    WritePrivateProfileStringA(lpAppName, lpKeyName, Dest, lpFileName);
  }
  return v4;
}

//----- (00407690) --------------------------------------------------------
int __cdecl GetPrivateProfileStringWrapper(LPCSTR lpAppName, LPCSTR lpKeyName, LPSTR lpDefault, LPSTR lpReturnedString, DWORD nSize, LPCSTR lpFileName)
{
  int result; // eax

  GetPrivateProfileStringA(lpAppName, lpKeyName, "1x2y3z4", lpReturnedString, nSize, lpFileName);
  result = strcmp(lpReturnedString, "1x2y3z4");
  if ( !result )
  {
    strcpy(lpReturnedString, lpDefault);
    result = WritePrivateProfileStringA(lpAppName, lpKeyName, lpReturnedString, lpFileName);
  }
  return result;
}

//----- (00407730) --------------------------------------------------------
int __cdecl config_read_helper_3(int a1)
{
  int result; // eax
  char *v2; // ecx
  _BYTE *v3; // esi
  char v4; // dl
  char i; // dl
  char v6; // bl

  result = a1;
  v2 = (char *)a1;
  v3 = (_BYTE *)a1;
  if ( *(_BYTE *)a1 == ' ' )
  {
    do
      v4 = *++v2;
    while ( v4 == ' ' );
  }
  for ( i = *v2; i; ++v2 )
  {
    if ( i != ' ' || (v6 = v2[1], v6 != ' ') && v6 )
      *v3++ = i;
    i = v2[1];
  }
  *v3 = 0;
  return result;
}

//----- (00407780) --------------------------------------------------------
signed int __cdecl CRC32(unsigned int a1, int a2)
{
  unsigned __int8 *v2; // ecx
  int v3; // eax
  int v5[256]; // [esp+4h] [ebp-400h]

  v5[0] = 0;
  v5[1] = 1996959894;
  v5[2] = -301047508;
  v5[3] = -1727442502;
  v5[4] = 124634137;
  v5[5] = 1886057615;
  v5[6] = -379345611;
  v5[7] = -1637575261;
  v5[8] = 249268274;
  v5[9] = 2044508324;
  v5[10] = -522852066;
  v5[11] = -1747789432;
  v5[12] = 162941995;
  v5[13] = 2125561021;
  v5[14] = -407360249;
  v5[15] = -1866523247;
  v5[16] = 498536548;
  v5[17] = 1789927666;
  v5[18] = -205950648;
  v5[19] = -2067906082;
  v5[20] = 450548861;
  v5[21] = 1843258603;
  v5[22] = -187386543;
  v5[23] = -2083289657;
  v5[24] = 325883990;
  v5[25] = 1684777152;
  v5[26] = -43845254;
  v5[27] = -1973040660;
  v5[28] = 335633487;
  v5[29] = 1661365465;
  v5[30] = -99664541;
  v5[31] = -1928851979;
  v5[32] = 997073096;
  v5[33] = 1281953886;
  v5[34] = -715111964;
  v5[35] = -1570279054;
  v5[36] = 1006888145;
  v5[37] = 1258607687;
  v5[38] = -770865667;
  v5[39] = -1526024853;
  v5[40] = 901097722;
  v5[41] = 1119000684;
  v5[42] = -608450090;
  v5[43] = -1396901568;
  v5[44] = 853044451;
  v5[45] = 1172266101;
  v5[46] = -589951537;
  v5[47] = -1412350631;
  v5[48] = 651767980;
  v5[49] = 1373503546;
  v5[50] = -925412992;
  v5[51] = -1076862698;
  v5[52] = 565507253;
  v5[53] = 1454621731;
  v5[54] = -809855591;
  v5[55] = -1195530993;
  v5[56] = 671266974;
  v5[57] = 1594198024;
  v5[58] = -972236366;
  v5[59] = -1324619484;
  v5[60] = 795835527;
  v5[61] = 1483230225;
  v5[62] = -1050600021;
  v5[63] = -1234817731;
  v5[64] = 1994146192;
  v5[65] = 31158534;
  v5[66] = -1731059524;
  v5[67] = -271249366;
  v5[68] = 1907459465;
  v5[69] = 112637215;
  v5[70] = -1614814043;
  v5[71] = -390540237;
  v5[72] = 2013776290;
  v5[73] = 251722036;
  v5[74] = -1777751922;
  v5[75] = -519137256;
  v5[76] = 2137656763;
  v5[77] = 141376813;
  v5[78] = -1855689577;
  v5[79] = -429695999;
  v5[80] = 1802195444;
  v5[81] = 476864866;
  v5[82] = -2056965928;
  v5[83] = -228458418;
  v5[84] = 1812370925;
  v5[85] = 453092731;
  v5[86] = -2113342271;
  v5[87] = -183516073;
  v5[88] = 1706088902;
  v5[89] = 314042704;
  v5[90] = -1950435094;
  v5[91] = -54949764;
  v5[92] = 1658658271;
  v5[93] = 366619977;
  v5[94] = -1932296973;
  v5[95] = -69972891;
  v5[96] = 1303535960;
  v5[97] = 984961486;
  v5[98] = -1547960204;
  v5[99] = -725929758;
  v5[100] = 1256170817;
  v5[101] = 1037604311;
  v5[102] = -1529756563;
  v5[103] = -740887301;
  v5[104] = 1131014506;
  v5[105] = 879679996;
  v5[106] = -1385723834;
  v5[107] = -631195440;
  v5[108] = 1141124467;
  v5[109] = 855842277;
  v5[110] = -1442165665;
  v5[111] = -586318647;
  v5[112] = 1342533948;
  v5[113] = 654459306;
  v5[114] = -1106571248;
  v5[115] = -921952122;
  v5[116] = 1466479909;
  v5[117] = 544179635;
  v5[118] = -1184443383;
  v5[119] = -832445281;
  v5[120] = 1591671054;
  v5[121] = 702138776;
  v5[122] = -1328506846;
  v5[123] = -942167884;
  v5[124] = 1504918807;
  v5[125] = 783551873;
  v5[126] = -1212326853;
  v5[127] = -1061524307;
  v5[128] = -306674912;
  v5[129] = -1698712650;
  v5[130] = 62317068;
  v5[131] = 1957810842;
  v5[132] = -355121351;
  v5[133] = -1647151185;
  v5[134] = 81470997;
  v5[135] = 1943803523;
  v5[136] = -480048366;
  v5[137] = -1805370492;
  v5[138] = 225274430;
  v5[139] = 2053790376;
  v5[140] = -468791541;
  v5[141] = -1828061283;
  v5[142] = 167816743;
  v5[143] = 2097651377;
  v5[144] = -267414716;
  v5[145] = -2029476910;
  v5[146] = 503444072;
  v5[147] = 1762050814;
  v5[148] = -144550051;
  v5[149] = -2140837941;
  v5[150] = 426522225;
  v5[151] = 1852507879;
  v5[152] = -19653770;
  v5[153] = -1982649376;
  v5[154] = 282753626;
  v5[155] = 1742555852;
  v5[156] = -105259153;
  v5[157] = -1900089351;
  v5[158] = 397917763;
  v5[159] = 1622183637;
  v5[160] = -690576408;
  v5[161] = -1580100738;
  v5[162] = 953729732;
  v5[163] = 1340076626;
  v5[164] = -776247311;
  v5[165] = -1497606297;
  v5[166] = 1068828381;
  v5[167] = 1219638859;
  v5[168] = -670225446;
  v5[169] = -1358292148;
  v5[170] = 906185462;
  v5[171] = 1090812512;
  v5[172] = -547295293;
  v5[173] = -1469587627;
  v5[174] = 829329135;
  v5[175] = 1181335161;
  v5[176] = -882789492;
  v5[177] = -1134132454;
  v5[178] = 628085408;
  v5[179] = 1382605366;
  v5[180] = -871598187;
  v5[181] = -1156888829;
  v5[182] = 570562233;
  v5[183] = 1426400815;
  v5[184] = -977650754;
  v5[185] = -1296233688;
  v5[186] = 733239954;
  v5[187] = 1555261956;
  v5[188] = -1026031705;
  v5[189] = -1244606671;
  v5[190] = 752459403;
  v5[191] = 1541320221;
  v5[192] = -1687895376;
  v5[193] = -328994266;
  v5[194] = 1969922972;
  v5[195] = 40735498;
  v5[196] = -1677130071;
  v5[197] = -351390145;
  v5[198] = 1913087877;
  v5[199] = 83908371;
  v5[200] = -1782625662;
  v5[201] = -491226604;
  v5[202] = 2075208622;
  v5[203] = 213261112;
  v5[204] = -1831694693;
  v5[205] = -438977011;
  v5[206] = 2094854071;
  v5[207] = 198958881;
  v5[208] = -2032938284;
  v5[209] = -237706686;
  v5[210] = 1759359992;
  v5[211] = 534414190;
  v5[212] = -2118248755;
  v5[213] = -155638181;
  v5[214] = 1873836001;
  v5[215] = 414664567;
  v5[216] = -2012718362;
  v5[217] = -15766928;
  v5[218] = 1711684554;
  v5[219] = 285281116;
  v5[220] = -1889165569;
  v5[221] = -127750551;
  v5[222] = 1634467795;
  v5[223] = 376229701;
  v5[224] = -1609899400;
  v5[225] = -686959890;
  v5[226] = 1308918612;
  v5[227] = 956543938;
  v5[228] = -1486412191;
  v5[229] = -799009033;
  v5[230] = 1231636301;
  v5[231] = 1047427035;
  v5[232] = -1362007478;
  v5[233] = -640263460;
  v5[234] = 1088359270;
  v5[235] = 936918000;
  v5[236] = -1447252397;
  v5[237] = -558129467;
  v5[238] = 1202900863;
  v5[239] = 817233897;
  v5[240] = -1111625188;
  v5[241] = -893730166;
  v2 = (unsigned __int8 *)a1;
  v3 = -1;
  v5[242] = 1404277552;
  v5[243] = 615818150;
  v5[244] = -1160759803;
  v5[245] = -841546093;
  v5[246] = 1423857449;
  v5[247] = 601450431;
  v5[248] = -1285129682;
  v5[249] = -1000256840;
  v5[250] = 1567103746;
  v5[251] = 711928724;
  v5[252] = -1274298825;
  v5[253] = -1022587231;
  v5[254] = 1510334235;
  v5[255] = 0x2D02EF8D;
  if ( a1 < a2 + a1 )
  {
    do
      v3 = v5[*v2++ ^ (unsigned __int8)v3] ^ (v3 >> 8) & 0xFFFFFF;
    while ( (unsigned int)v2 < a2 + a1 );
  }
  return ~v3;
}

//----- (00408270) --------------------------------------------------------
FILE *__cdecl RewriteSameFileSomething(int a1, char *Filename)
{
  FILE *result; // eax
  int v3; // esi
  FILE *v4; // edi
  int v5; // eax
  char DstBuf[2048]; // [esp+8h] [ebp-800h] BYREF

  result = fopen(Filename, "rb");
  v3 = (int)result;
  if ( result )
  {
    v4 = fopen(Filename, "wb");
    if ( v4 )
    {
      while ( (*(_BYTE *)(v3 + 12) & 0x10) == 0 )
      {
        v5 = fread(DstBuf, 1u, 0x800u, (FILE *)v3);
        if ( v5 > 0 )
          fwrite(DstBuf, 1u, v5, v4);
      }
      fclose(v4);
    }
    result = (FILE *)fclose((FILE *)v3);
  }
  return result;
}

//----- (00408310) --------------------------------------------------------
// returns ptr to alloced space, with a preceding dword with the allocced size
// 
// uses virtualalloc if sz is >= half a meg
// 
// ex:
// emalloc(DWORD sz)
//    DWORD *buf = malloc(sz + 4);
//    buf[0] = sz + 4;
//    return &buf[1];
// 
_DWORD *__cdecl emalloc(DWORD bytes)
{
  _DWORD *v1; // eax
  _DWORD *v2; // esi
  CHAR Dest[256]; // [esp+8h] [ebp-100h] BYREF

  if ( (int)(bytes + 4) <= 0x80000 )
    v1 = malloc(bytes + 4);
  else
    v1 = VirtualAlloc(0, bytes + 4, 0x1000u, 4u);
  if ( v1 )
  {
    *v1 = bytes + 4;
    v2 = v1 + 1;
  }
  else
  {
    v2 = 0;
  }
  if ( !v2 )
  {
    sprintf(Dest, "Out of memory (Alloc:%d)", bytes);
    MessageBoxA(0, Dest, "Error", 0x30u);
    exit(1);
  }
  return v2;
}

//----- (004083A0) --------------------------------------------------------
LPVOID __cdecl ExpandMemory(LPVOID lpAddress, int a2, int a3)
{
  int v3; // ecx
  int v4; // edi
  _DWORD *v5; // eax
  LPVOID v6; // esi
  LPVOID result; // eax
  char *v8; // eax
  int v9; // esi
  signed int v10; // edi
  _DWORD *v11; // eax
  _DWORD *v12; // eax
  void *v13; // ebp
  unsigned int v14; // ecx
  int *Memory; // [esp+10h] [ebp-104h]
  CHAR Dest[256]; // [esp+14h] [ebp-100h] BYREF

  v3 = a3;
  if ( a2 > 0x80000 )
    v3 = 16 * a3;
  v4 = v3 * ((v3 + a2 - 1) / v3);
  if ( lpAddress )
  {
    if ( v4 )
    {
      v9 = *((_DWORD *)lpAddress - 1);
      v10 = v4 + 4;
      Memory = (int *)((char *)lpAddress - 4);
      if ( v10 == v9 )
      {
        result = lpAddress;
      }
      else if ( v9 > 0x80000 || v10 > 0x80000 )
      {
        if ( v10 <= 0x80000 )
          v12 = malloc(v10);
        else
          v12 = VirtualAlloc(0, v10, 0x1000u, 4u);
        if ( v12 )
        {
          *v12 = v10;
          v13 = v12 + 1;
        }
        else
        {
          v13 = 0;
        }
        if ( !v13 )
        {
          sprintf(Dest, "Out of memory (Alloc:%d)", v10 - 4);
          MessageBoxA(0, Dest, "Error", 0x30u);
          exit(1);
        }
        v14 = v9 - 4;
        if ( v9 - 4 >= v10 - 4 )
          v14 = v10 - 4;
        qmemcpy(v13, lpAddress, v14);
        if ( *Memory <= 0x80000 )
          free(Memory);
        else
          VirtualFree(Memory, 0, 0x8000u);
        result = v13;
      }
      else
      {
        v11 = realloc((char *)lpAddress - 4, v10);
        if ( !v11 )
        {
          MessageBoxA(0, "Out of memory (Resize)", "Error", 0x30u);
          exit(1);
        }
        *v11 = v10;
        result = v11 + 1;
      }
    }
    else
    {
      v8 = (char *)lpAddress - 4;
      if ( *((int *)lpAddress - 1) <= 0x80000 )
        free(v8);
      else
        VirtualFree(v8, 0, 0x8000u);
      result = 0;
    }
  }
  else
  {
    if ( v4 + 4 <= 0x80000 )
      v5 = malloc(v4 + 4);
    else
      v5 = VirtualAlloc(0, v4 + 4, 0x1000u, 4u);
    if ( v5 )
    {
      *v5 = v4 + 4;
      v6 = v5 + 1;
    }
    else
    {
      v6 = 0;
    }
    if ( !v6 )
    {
      sprintf(Dest, "Out of memory (Alloc:%d)", v4);
      MessageBoxA(0, Dest, "Error", 0x30u);
      exit(1);
    }
    result = v6;
  }
  return result;
}

//----- (004085C0) --------------------------------------------------------
// see emalloc()
void __stdcall efree(LPVOID ptr)
{
  if ( *((int *)ptr - 1) <= 0x80000 )
    free((char *)ptr - 4);
  else
    VirtualFree((char *)ptr - 4, 0, 0x8000u);
}
// 4085C0: inconsistent function type and number of purged bytes

//----- (004085F0) --------------------------------------------------------
// local variable allocation has failed, the output may be wrong!
void __thiscall ConnectSocket(SOCKET *Socket, const char *Hostname, u_short ConnectPort, u_short ListenPort)
{
  SOCKET v5; // eax
  u_long v6; // eax
  SOCKET v7; // ecx
  unsigned __int32 v8; // edi
  struct hostent *v9; // eax
  DWORD v10; // kr00_4
  SOCKET v11; // eax
  SOCKET v12; // [esp-14h] [ebp-48h]
  SOCKET v13; // [esp-14h] [ebp-48h]
  SOCKET v14; // [esp-14h] [ebp-48h]
  char optval[4]; // [esp+Ch] [ebp-28h] BYREF
  u_long argp; // [esp+10h] [ebp-24h] BYREF
  struct sockaddr name; // [esp+14h] [ebp-20h] BYREF
  struct sockaddr v18; // [esp+24h] [ebp-10h] BYREF

  v5 = socket(2, 2, 0);
  *Socket = v5;
  argp = 1;
  ioctlsocket(v5, 0x8004667E, &argp);
  v12 = *Socket;
  *(_DWORD *)optval = -1;
  setsockopt(v12, 6, 1, optval, 4);
  v13 = *Socket;
  *(_DWORD *)optval = 1024;
  setsockopt(v13, 0xFFFF, 4097, optval, 4);
  v14 = *Socket;
  *(_DWORD *)optval = 1024;
  setsockopt(v14, 0xFFFF, 4098, optval, 4);
  name.sa_family = 2;
  *(_WORD *)name.sa_data = htons(ListenPort);
  v6 = htonl(0);
  v7 = *Socket;
  *(_DWORD *)&name.sa_data[2] = v6;
  bind(v7, &name, 16);
  v8 = inet_addr(Hostname);
  if ( v8 == -1 )
  {
    v9 = gethostbyname(Hostname);
    if ( v9 )
      v8 = **(_DWORD **)v9->h_addr_list;
  }
  v18.sa_family = 2;
  *(_DWORD *)&v18.sa_data[2] = v8;
  *(_WORD *)v18.sa_data = htons(ConnectPort);
  connect(*Socket, &v18, 16);
  Socket[1] = -1;
  Socket[2] = -1;
  v10 = GetTickCount();
  v11 = *Socket;
  *(_DWORD *)&ListenPort = v10 / 0xA;
  send(v11, (const char *)&ListenPort, 4, 0);
}
// 408716: inconsistent variable size for '^54.2(ListenPort)'

//----- (00408740) --------------------------------------------------------
int __thiscall sub_408740(SOCKET *this)
{
  return closesocket(*this);
}

//----- (00408750) --------------------------------------------------------
void __thiscall SendDirectoryServerZoneUpdatePacket(void *this, const void *a2, unsigned int a3)
{
  DWORD v4; // [esp+Ch] [ebp-404h] BYREF
  char buf[4]; // [esp+10h] [ebp-400h] BYREF
  char v6[1020]; // [esp+14h] [ebp-3FCh] BYREF

  if ( a2 && (int)a3 > 0 )
  {
    *(_DWORD *)buf = 0;
    qmemcpy(v6, a2, a3);
    send(*(_DWORD *)this, buf, a3 + 4, 0);
  }
  else
  {
    v4 = GetTickCount() / 0xA;
    send(*(_DWORD *)this, (const char *)&v4, 4, 0);
  }
}
// 408750: using guessed type char var_3FC[1020];

//----- (004087D0) --------------------------------------------------------
int __thiscall GetSocketRecvLag(SOCKET Socket, int *TimeElapsed)
{
  int sizeRecieved; // esi
  char buf[4]; // [esp+Ch] [ebp-200h] BYREF
  int v6; // [esp+10h] [ebp-1FCh]

  do
  {
    if ( recv(*(_DWORD *)Socket, buf, 512, 2) == -1 )
      break;
    sizeRecieved = recv(*(_DWORD *)Socket, buf, 512, 0);
    if ( sizeRecieved == 8 )
    {
      *(_DWORD *)(Socket + 4) = *(_DWORD *)buf;
      *(_DWORD *)(Socket + 8) = GetTickCount() / 0xA - v6;
    }
  }
  while ( sizeRecieved != -1 );
  *TimeElapsed = *(_DWORD *)(Socket + 8);
  return *(_DWORD *)(Socket + 4);
}

//----- (00408860) --------------------------------------------------------
// PINGSOCKET.PingSocket()
PINGSOCKET *__thiscall ListenOnPort(PINGSOCKET *socket, __int16 port, void *callback)
{
  SOCKET v4; // eax
  u_long v5; // eax
  SOCKET v6; // ecx
  SOCKET v8; // [esp-14h] [ebp-2Ch]
  SOCKET v9; // [esp-14h] [ebp-2Ch]
  SOCKET v10; // [esp-14h] [ebp-2Ch]
  u_long argp; // [esp+4h] [ebp-14h] BYREF
  struct sockaddr name; // [esp+8h] [ebp-10h] BYREF

  *((_DWORD *)socket + 1) = callback;
  v4 = ::socket(2, 2, 0);
  *(_DWORD *)socket = v4;
  argp = 1;
  ioctlsocket(v4, 0x8004667E, &argp);
  v8 = *(_DWORD *)socket;
  callback = (void *)-1;
  setsockopt(v8, 6, IP_OPTIONS, (const char *)&callback, 4);
  v9 = *(_DWORD *)socket;
  callback = (void *)0x2000;
  setsockopt(v9, 0xFFFF, 4097, (const char *)&callback, 4);
  v10 = *(_DWORD *)socket;
  callback = (void *)0x2000;
  setsockopt(v10, 0xFFFF, 4098, (const char *)&callback, 4);
  name.sa_family = 2;
  *(_WORD *)name.sa_data = htons(port);
  v5 = htonl(0);
  v6 = *(_DWORD *)socket;
  *(_DWORD *)&name.sa_data[2] = v5;
  bind(v6, &name, 16);
  return socket;
}

//----- (00408930) --------------------------------------------------------
unsigned int __thiscall ProcessZonePings(void *this, int ZonePopulation)
{
  int i; // ebp
  unsigned int result; // eax
  int (__cdecl *v5)(_DWORD, char *, unsigned int); // ecx
  SOCKET v6; // eax
  SOCKET v7; // [esp-18h] [ebp-244h]
  int fromlen; // [esp+10h] [ebp-21Ch] BYREF
  int v9[2]; // [esp+14h] [ebp-218h] BYREF
  struct sockaddr from; // [esp+1Ch] [ebp-210h] BYREF
  char buf[4]; // [esp+2Ch] [ebp-200h] BYREF
  char v12[508]; // [esp+30h] [ebp-1FCh] BYREF

  for ( i = 0; i < 20; ++i )
  {
    v7 = *(_DWORD *)this;
    fromlen = 16;
    result = recvfrom(v7, buf, 512, 0, &from, &fromlen);
    if ( result == -1 )
      break;
    if ( result >= 4 )
    {
      if ( *(_DWORD *)buf )
      {
        v6 = *(_DWORD *)this;
        v9[1] = *(_DWORD *)buf;
        v9[0] = ZonePopulation;
        result = sendto(v6, (const char *)v9, 8, 0, &from, 16);
      }
      else
      {
        v5 = (int (__cdecl *)(_DWORD, char *, unsigned int))*((_DWORD *)this + 1);
        if ( v5 )
        {
          if ( result > 4 )
            result = v5(*(_DWORD *)&from.sa_data[2], v12, result - 4);
        }
      }
    }
  }
  return result;
}

//----- (004089E0) --------------------------------------------------------
// Player.Player()
PLAYER *__thiscall CreateNewPlayer(PLAYER *player, struct in_addr in, __int16 a3, NetData *encryption)
{
  ENCRYPTION *encryptionPointer; // edx
  int v6; // eax

  player->unknownIthoughtItWasPlayerPointerDupe = 0;
  player->dword4 = 0;
  player->dword8 = 0;
  player->dwordC = 0;
  memset(player->someStringBuffer, 0, sizeof(player->someStringBuffer));
  player->TypedName[0] = 0;
  player->DemoPlayer = 0;
  player->KingCrownKills = 0;
  player->KotHDeathCount = 0;
  player->field_15F = -1;
  player->isEnergyShowing = 0;
  player->field_60 = -1;
  player->field_5C = -1;
  player->field_58 = -1;
  player->IsSilenced = 0;
  player->field_15B = 0;
  player->field_50 = -1;
  player->field_54 = -1;
  player->field_157 = 0;
  player->field_A8 = 0;
  player->field_BC = 0;
  player->field_3C = 0;
  player->field_4C = -1;
  player->field_153 = 0;
  player->BillerPlayerId = LastBillerPlayerId++;
  player->field_305 = 0;
  player->SlowModem = 0;
  player->AlreadySentReliablePacket = 0;
  player->KickOffDelayTimer = 0;
  player->field_FD = 0;
  player->encryptionPointer = (ENCRYPTION *)encryption;
  player->MyArena = 0;
  player->field_20 = 0;
  memset(player->field_33D, 0, sizeof(player->field_33D));
  player->PlayerName[0] = 0;
  player->field_11F = 0;
  memset(player->gap_12B, 0, 0x28u);
  player->S2CPacketLossPercentage = 1000;
  player->C2SPacketLossPercentage = 1000;
  player->field_283 = 0;
  player->IPAddressDWORD = in.S_un.S_addr;
  player->Port = a3;
  player->pfile329 = 0;
  player->char32d = 0;
  player->Frequency = -1;
  player->isSysop = 0;
  player->isModerator = 0;
  player->isSuperModerator = 0;
  player->AttachedToPlayerId = -1;
  memset(player->Name, 0, 0xACu);
  player->UserId = -1;
  *(_DWORD *)&player->CurrentWins = 0;
  *(_DWORD *)&player->GoalCount = 0;
  *(int *)((char *)&player->KillPoints + 2) = 0;
  HIWORD(player->FlagPoints) = 0;
  *(_DWORD *)&player->PersonalBestWins = 0;
  *(_DWORD *)&player->field_235 = 0;
  *(_DWORD *)&player->Points = 0;
  player->FlagPointsHiWord = 0;
  player->ArenaPlayerIndex = -1;
  encryptionPointer = player->encryptionPointer;
  player->Ship = 8;
  player->IsSpeced = 0;
  player->TotalShipChanges = 0;
  player->dword30 = 0;
  v6 = encryptionPointer->PlayerId;
  *(_DWORD *)&player->PlayerId = v6;
  ZonePlayerList[v6] = player;
  player->NoPasswordPacketDelayTimer = GetTickCount() / 0xA;
  player->TotalUsageSeconds2 = time(0);
  player->field_297 = 0;
  player->field_287 = 0;
  player->field_28B = 0;
  player->field_29F = 0;
  player->GetTickCountValueDividedByTen2 = GetTickCount() / 0xA;
  player->dword293 = 0;
  player->field_29B = 0;
  player->field_29F = 0;
  player->field_B4 = 0;
  player->C2SCurrentFast = 0;
  player->C2SCurrentSlow = 0;
  player->C2SCurrentTotalFast = 0;
  player->C2SCurrentTotalSlow = 0;
  player->DisconnectReason = 0;
  player->C2SAverageLatencyFirst = 0;
  player->C2SAverageLatencySecond = 0;
  player->field_30D = 0;
  player->LatencyKickOutDelayTimer = 0;
  player->field_309 = 1;
  return player;
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 42A534: using guessed type int LastBillerPlayerId;

//----- (00408C30) --------------------------------------------------------
void __thiscall DisconnectUser(HANDLE *buf)
{
  char *v2; // esi
  char *v3; // ebp
  int v4; // ecx
  int v5; // ebp
  char i; // al
  ARENA *v7; // ecx
  HANDLE v8; // ecx
  LPVOID *v9; // esi
  int v10; // ebp
  BOOL v11; // eax
  __int16 Ping[2]; // [esp+10h] [ebp-B0h] BYREF
  __int16 Latency[2]; // [esp+14h] [ebp-ACh] BYREF
  int MiscTimedGame; // [esp+18h] [ebp-A8h]
  char Dest[32]; // [esp+1Ch] [ebp-A4h] BYREF
  char v16; // [esp+3Ch] [ebp-84h]
  char Str[128]; // [esp+40h] [ebp-80h] BYREF

  if ( *buf )
  {
    TerminateProcess(*buf, 0);
    CloseHandle(*buf);
  }
  if ( *(HANDLE *)((char *)buf + 809) )
  {
    fclose(*(FILE **)((char *)buf + 809));
    *(HANDLE *)((char *)buf + 809) = 0;
  }
  if ( AutoPermissionPoints > 0 && *(int *)((char *)buf + 553) + *(int *)((char *)buf + 557) >= AutoPermissionPoints )
  {
    v2 = PermissionAutoPermissionIDList;
    while ( *v2 )
    {
      v3 = Str;
      if ( isdigit(*v2) )
      {
        do
        {
          v4 = v2[1];
          *v3++ = *v2++;
        }
        while ( isdigit(v4) );
      }
      *v3 = 0;
      v5 = atoi(Str);
      if ( v5 && BillingConnectionStructPointer )
      {
        Dest[0] = 1;
        strncpy(&Dest[1], (const char *)buf + 375, 0x20u);
        v16 = 0;
        SendBillerPlayerNamePacketSomething((ENCRYPTION **)BillingConnectionStructPointer, -1, v5, (int)Dest, 33);
      }
      for ( i = *v2; i; i = *++v2 )
      {
        if ( isdigit(i) )
          break;
      }
    }
  }
  v7 = (ARENA *)buf[7];
  MiscTimedGame = 0;
  if ( v7 )
  {
    MiscTimedGame = v7->ServersideArenaSettings.MiscTimedGame;
    ArenaRemovePlayer(v7, (PLAYER *)buf);
    buf[7] = 0;
  }
  sub_41CB70((int)buf[10], (int)Latency, (int)Ping);
  v8 = buf[10];
  *(_DWORD *)Latency = 1000 - *(_DWORD *)Latency;
  *(_DWORD *)Ping = 1000 - *(_DWORD *)Ping;
  sub_41B7A0((int)v8);
  v9 = (HANDLE *)((char *)buf + 829);
  v10 = 4;
  ZonePlayerList[(_DWORD)buf[5]] = 0;
  do
  {
    if ( *v9 )
    {
      efree(*v9);
      *v9 = 0;
    }
    v9 += 2;
    --v10;
  }
  while ( v10 );
  if ( BillingConnectionStructPointer )
  {
    v11 = buf[18] != 0;
    if ( MiscTimedGame
      || *(int *)((char *)buf + 557)
       + *(int *)((char *)buf + 553)
       + *(unsigned __int16 *)((char *)buf + 547)
       + *(unsigned __int16 *)((char *)buf + 549) <= 5
      && !*(HANDLE *)((char *)buf + 781) )
    {
      v11 = 1;
    }
    if ( v11 )
      SendBillerUserLogoffPacket(
        (ENCRYPTION **)BillingConnectionStructPointer,
        (int)buf[4],
        (__int16)*(HANDLE *)((char *)buf + 789),
        Latency[0],
        Ping[0],
        10 * *((_WORD *)buf + 165),
        10 * *(int *)((char *)buf + 793) / (*(int *)((char *)buf + 797) + 1),
        0,
        0);
    else
      SendBillerUserLogoffPacket(
        (ENCRYPTION **)BillingConnectionStructPointer,
        (int)buf[4],
        (__int16)*(HANDLE *)((char *)buf + 789),// TODO: This might be WORD not DWORD
        Latency[0],
        Ping[0],
        10 * *((_WORD *)buf + 165),
        10 * *(int *)((char *)buf + 793) / (*(int *)((char *)buf + 797) + 1),
        (char *)buf + 547,
        0xEu);
  }
}
// 4AF32C: using guessed type int AutoPermissionPoints;

//----- (00408E80) --------------------------------------------------------
void __thiscall PlayerHandleGamePacket(PLAYER *playerr, unsigned __int8 *packet, int packetSize)
{
  unsigned __int8 *packett; // ebx
  int v5; // ecx
  ARENA *v6; // ecx
  unsigned __int8 *v7; // esi
  int v8; // eax
  int v9; // eax
  ARENA *v10; // ebp
  int v11; // eax
  ARENA *v12; // esi
  int v13; // eax
  int v14; // edx
  int v15; // ecx
  PLAYER **v16; // eax
  int v17; // esi
  int v18; // esi
  ARENA *v19; // eax
  int v20; // ecx
  PLAYER *v21; // ebx
  PLAYER *v22; // ebx
  unsigned int v23; // kr08_4
  unsigned int v24; // kr14_4
  bool v25; // cc
  ARENA *v26; // ecx
  __int16 v27; // ax
  ARENA *v28; // ecx
  ARENA *v29; // ecx
  ARENA *v30; // ebp
  int v31; // eax
  ARENA *v32; // esi
  int v33; // edx
  int v34; // ecx
  SOCCER_BALL *v35; // eax
  ARENA *v36; // ebp
  int v37; // eax
  ARENA *v38; // ecx
  int v39; // eax
  int v40; // esi
  const CHAR *v41; // esi
  unsigned int v42; // kr20_4
  CHAR v43; // al
  __int16 v44; // ax
  __int16 v45; // bx
  ARENA *v46; // eax
  DWORD v47; // eax
  int v48; // ecx
  ARENA_SETTINGS *v49; // eax
  int v50; // edx
  int v51; // edx
  ARENA *v52; // edx
  int v53; // ecx
  int v54; // eax
  int v55; // esi
  char *v56; // eax
  int v57; // edx
  int v58; // eax
  int v59; // eax
  int v60; // esi
  ARENA *v61; // ecx
  unsigned int v62; // kr30_4
  ARENA *v63; // eax
  _DWORD *v64; // eax
  int v65; // edx
  int v66; // eax
  int v67; // ecx
  int v68; // eax
  int v69; // ecx
  unsigned __int8 v70; // dl
  char v71; // al
  unsigned __int8 *v72; // ecx
  int v73; // esi
  int v74; // esi
  int v75; // esi
  ENCRYPTION *v76; // edi
  int v77; // edx
  int v78; // esi
  ARENA *v79; // ecx
  unsigned int v80; // kr38_4
  __int16 v81; // cx
  __int64 v82; // rax
  __int64 v83; // rax
  int v84; // eax
  int v85; // edx
  int v86; // eax
  PLAYER *v87; // eax
  __int16 v88; // ax
  __int16 v89; // dx
  int v90; // eax
  PLAYER *v91; // eax
  int v92; // eax
  __int16 v93; // ax
  ARENA *v94; // ecx
  ARENA *v95; // edx
  __int16 v96; // ax
  PLAYER *v97; // esi
  ARENA *v98; // ecx
  __int16 v99; // ax
  ARENA *v100; // ecx
  int v101; // eax
  __int16 v102; // ax
  ARENA *v103; // ecx
  ARENA *v104; // ecx
  int v105; // eax
  int v106; // eax
  int v107; // eax
  ARENA *v108; // ecx
  ARENA *v109; // eax
  ARENA *v110; // eax
  int v111; // eax
  int v112; // edx
  ARENA *v113; // eax
  int v114; // ecx
  __int16 v115; // cx
  ARENA *v116; // ecx
  ARENA *v117; // eax
  int v118; // eax
  ARENA *v119; // edi
  char *v120; // edx
  int v121; // eax
  __int16 v122; // ax
  ARENA *v123; // ecx
  int v124; // eax
  int v125; // ebx
  ARENA *v126; // ecx
  int v127; // edi
  ARENA *v128; // ecx
  int v129; // edi
  int v130; // eax
  int v131; // edi
  int v132; // edx
  int v133; // eax
  int v134; // edi
  int v135; // eax
  int v136; // edx
  char *v137; // ecx
  int v138; // ebx
  char *v139; // eax
  int v140; // eax
  int v141; // ebx
  int v142; // eax
  int v143; // eax
  ARENA *v144; // eax
  int v145; // edx
  int v146; // ecx
  char *v147; // esi
  DWORD v148; // eax
  int v149; // edi
  int v150; // ebx
  int v151; // edi
  unsigned int v152; // kr40_4
  char *v153; // edi
  ARENA *v154; // ecx
  __int16 v155; // bx
  int v156; // esi
  ARENA *v157; // edi
  __int16 v158; // ax
  __int16 v159; // dx
  ARENA *v160; // ecx
  int v161; // esi
  ARENA *v162; // eax
  int v163; // edi
  PLAYER *v164; // eax
  int v165; // ecx
  int v166; // edx
  int v167; // ecx
  int v168; // ecx
  int v169; // ebx
  PLAYER *v170; // ecx
  PLAYER *v171; // esi
  int v172; // edx
  int v173; // edx
  int v174; // eax
  int v175; // esi
  int v176; // edx
  signed int v177; // edi
  __int64 v178; // rax
  __int64 v179; // rax
  int v180; // edx
  int v181; // eax
  ARENA *v182; // eax
  __int16 v183; // ax
  __int16 v184; // ax
  int v185; // esi
  ENCRYPTION *v186; // edi
  int v187; // edx
  ARENA *v188; // eax
  __int16 v189; // dx
  __int16 v190; // cx
  int v191; // edx
  __int16 v192; // cx
  int v193; // ebx
  int v194; // edi
  int v195; // esi
  PLAYER *v196; // eax
  ARENA *v197; // eax
  ARENA *v198; // esi
  __int64 v199; // rax
  __int16 v200; // ax
  int v201; // ecx
  int v202; // edx
  int v203; // edi
  char *v204; // eax
  __int16 v205; // ax
  ARENA *v206; // eax
  ARENA *v207; // eax
  int v208; // ecx
  int v209; // ecx
  char v210; // al
  ARENA *v211; // eax
  __int16 v212; // cx
  int v213; // edi
  int v214; // esi
  PLAYER *v215; // eax
  ARENA *v216; // ecx
  __int16 v217; // ax
  ARENA *v218; // ecx
  int v219; // eax
  __int16 v220; // bx
  int v221; // esi
  PLAYER *v222; // eax
  PLAYER *v223; // ecx
  int v224; // ebp
  PLAYER *v225; // ecx
  ARENA *v226; // eax
  ARENA *v227; // ecx
  char *v228; // ebp
  int v229; // esi
  ARENA *v230; // eax
  __int16 v231; // dx
  char v232; // al
  __int16 v233; // bx
  int v234; // ebx
  _DWORD *v235; // eax
  __int16 v236; // dx
  ARENA *v237; // eax
  char v238; // al
  ARENA *v239; // ecx
  struct ARENA *v240; // eax
  ARENA *v241; // eax
  int v242; // eax
  unsigned int v243; // kr60_4
  _BYTE *v244; // edx
  int v245; // eax
  PLAYER *v246; // eax
  unsigned int v247; // kr6C_4
  _BYTE *v248; // edx
  char *v249; // edi
  unsigned int v250; // kr78_4
  BOOL v251; // esi
  char *v252; // edi
  FILE *v253; // eax
  FILE *v254; // esi
  unsigned int v255; // kr88_4
  unsigned int v256; // kr90_4
  __int16 v257; // ax
  PLAYER *v258; // eax
  __int16 v259; // dx
  int v260; // eax
  int v261; // ecx
  ARENA *v262; // eax
  int v263; // edi
  int v264; // esi
  PLAYER *v265; // eax
  ARENA *v266; // eax
  int v267; // ecx
  char *v268; // ebx
  int v269; // edi
  char *v270; // esi
  int v271; // ecx
  signed __int8 v272; // al
  char *v273; // eax
  int v274; // eax
  KICK *v275; // ecx
  int v276; // edx
  int v277; // esi
  PLAYER **v278; // eax
  int v279; // ecx
  int v280; // ebx
  PLAYER **v281; // eax
  PLAYER *v282; // eax
  unsigned int v283; // krA0_4
  _DWORD *v284; // ecx
  int v285; // ecx
  int v286; // eax
  int v287; // ecx
  int v288; // eax
  ARENA *v289; // eax
  __int64 v290; // rax
  const char *v291; // [esp-8h] [ebp-6FCh]
  PLAYER *v292; // [esp-4h] [ebp-6F8h]
  char v293; // [esp-4h] [ebp-6F8h]
  int Password; // [esp+10h] [ebp-6E4h] BYREF
  __int64 v295; // [esp+14h] [ebp-6E0h] BYREF
  int v296; // [esp+1Ch] [ebp-6D8h]
  int a2; // [esp+20h] [ebp-6D4h]
  char *playerra; // [esp+24h] [ebp-6D0h]
  char v299; // [esp+28h] [ebp-6CCh] BYREF
  char v300; // [esp+29h] [ebp-6CBh]
  int v301; // [esp+2Ah] [ebp-6CAh]
  int v302; // [esp+2Eh] [ebp-6C6h]
  int v303; // [esp+32h] [ebp-6C2h]
  int v304; // [esp+36h] [ebp-6BEh]
  char v305; // [esp+3Ah] [ebp-6BAh]
  char v306; // [esp+3Bh] [ebp-6B9h]
  int v307; // [esp+3Ch] [ebp-6B8h]
  int v308; // [esp+40h] [ebp-6B4h]
  char v309; // [esp+4Ch] [ebp-6A8h] BYREF
  SOCCER_BALL v310; // [esp+4Dh] [ebp-6A7h]
  char v311; // [esp+6Ch] [ebp-688h] BYREF
  char v312; // [esp+6Dh] [ebp-687h]
  int v313; // [esp+6Eh] [ebp-686h]
  char v314; // [esp+7Fh] [ebp-675h]
  char a3[5]; // [esp+90h] [ebp-664h] BYREF
  char v316[507]; // [esp+95h] [ebp-65Fh] BYREF
  char a1[256]; // [esp+290h] [ebp-464h] BYREF
  char v318; // [esp+390h] [ebp-364h] BYREF
  __int16 v319; // [esp+391h] [ebp-363h]
  char v320[96]; // [esp+393h] [ebp-361h] BYREF
  char Dest[256]; // [esp+3F4h] [ebp-300h] BYREF
  char buf[3]; // [esp+4F4h] [ebp-200h] BYREF
  __int16 v323; // [esp+4F7h] [ebp-1FDh]
  char v324[507]; // [esp+4F9h] [ebp-1FBh] BYREF

  packett = packet;
  v5 = (char)*packet;
  LODWORD(v295) = v5;
  switch ( v5 )
  {
    case 1:                                     // 0x01 - Arena login
      if ( playerr->Name[0] )
      {
        if ( playerr->isSuperModerator || sub_41B960((int)playerr->encryptionPointer) == 1 )
        {
          v238 = packet[1];
          if ( v238 > 8 || v238 < 0 )
          {
            if ( !playerr->isSuperModerator )
            {
              sprintf(a1, "Packet tampering(%d)", (char)*packet);
              SendBillerWarnings(a1, playerr);
              v241 = playerr->MyArena;
              if ( v241 )
              {
                if ( v241->ServersideArenaSettings.dwordB4 )
                {
                  playerr->DisconnectReason = 0x10;// 0x10 - Restricted Zone - Compare against local Subspace.exe to determine if an Update is needed.
                  playerr->AlreadySentReliablePacket = 1;
                }
              }
            }
          }
          else
          {
            v239 = playerr->MyArena;
            if ( v239 )
            {
              ArenaRemovePlayer(v239, playerr);
              playerr->MyArena = 0;
            }
            playerr->ArenaPlayerIndex = -1;
            playerr->Ship = (char)packet[1];
            playerr->AllowAudioByte1 = (char)packet[2];
            playerr->XResolution = *((__int16 *)packet + 2);
            playerr->YResolution = *((__int16 *)packet + 3);
            playerr->AllowAudioByte2 = (char)packet[3];
            if ( playerr->IsSpeced )
              playerr->Ship = 8;
            playerr->field_309 = 1;
            *(_WORD *)((char *)&Password + 1) = playerr->PlayerId;// New PlayerId
            LOBYTE(Password) = 1;               // 0x01 - PlayerID Change
            SendPlayerReliablePacket(playerr, (char *)&Password, 3, 1);
            v240 = ArenaHandler(playerr, *((__int16 *)packet + 4), (const char *)packet + 10);
            playerr->MyArena = v240;
            playerr->field_20 = (int)v240;
            PlayerEntering(v240, playerr);
          }
        }
        else
        {
          SendBillerWarnings("Incompatible network protocol attempting to enter game", playerr);
          playerr->AlreadySentReliablePacket = 1;
        }
      }
      return;
    case 2:                                     // 0x02 - Leave arena
      v227 = playerr->MyArena;
      if ( v227 )
      {
        ArenaRemovePlayer(v227, playerr);
        playerr->MyArena = 0;                   // Reset your arena pointer
      }
      printf("Player leaving game: %s\n", playerr->Name);
      v228 = playerr->field_33D;
      v229 = 4;
      do
      {
        if ( *(_DWORD *)v228 )
        {
          efree(*(LPVOID *)v228);
          *(_DWORD *)v228 = 0;
        }
        v228 += 8;
        --v229;
      }
      while ( v229 );
      return;
    case 3:                                     // 0x03 - Position packet
      playerr->field_309 = 0;
      if ( !playerr->MyArena )
        return;
      v70 = packet[10];                         // Checksum BYTE
      v71 = 0;
      packet[10] = 0;
      v72 = packet;
      v73 = 22;
      do
      {
        v71 ^= *v72++;
        --v73;
      }
      while ( v73 );
      if ( v71 != v70 )
      {
        if ( !playerr->isSysop )
        {
          v74 = playerr->field_157 + 1;
          playerr->field_157 = v74;
          if ( v74 >= playerr->MyArena->ServersideArenaSettings.SecurityPacketModificationMax )
          {
            SendBillerWarnings("C2S position packet checksum error", playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;    // 0x03 - Arena is Full
              playerr->AlreadySentReliablePacket = 1;
            }
          }
        }
        return;
      }
      if ( (packet[11] & 0x40) != 0 && !playerr->field_3C )// Togglables
        return;
      if ( *((__int16 *)packet + 8) > 10000 && !playerr->isSuperModerator && !playerr->field_305 )// Bounty
        goto LABEL_358;
      if ( (packet[20] & 0x1F) != 0 )
        playerr->field_BC = 0;
      v75 = *(_DWORD *)(packet + 2);
      v76 = playerr->encryptionPointer;
      v77 = ((v76->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v75;// Timestamp
      v78 = v77;
      v296 = v77;
      if ( v77 < 0 || v77 > 30000 )
      {
        v78 = 0;
        v296 = 0;
      }
      if ( v78 > playerr->MyArena->ServersideArenaSettings.LatencyMaxLatencyForWeapons )
        *((_WORD *)packet + 10) &= 0x7F80u;     // Weapon Info
      if ( v78 < playerr->MyArena->ServersideArenaSettings.LatencyMaxLatencyForKickOut || v78 > 800 || playerr->isSysop )
        playerr->LatencyKickOutDelayTimer = GetTickCount() / 0xA;
      if ( v78 < playerr->MyArena->ServersideArenaSettings.LatencySlowPacketTime || v78 > 800 || playerr->isSysop )
        ++playerr->C2SCurrentFast;
      else
        ++playerr->C2SCurrentSlow;
      if ( playerr->C2SCurrentSlow + playerr->C2SCurrentFast > playerr->MyArena->ServersideArenaSettings.LatencySlowPacketSampleSize )
      {
        playerr->C2SCurrentTotalFast += playerr->C2SCurrentFast;
        playerr->C2SCurrentTotalSlow += playerr->C2SCurrentSlow;
        if ( playerr->Ship != 8 )
        {
          v79 = playerr->MyArena;
          if ( 1000 * playerr->C2SCurrentSlow / (playerr->C2SCurrentSlow + playerr->C2SCurrentFast) > v79->ServersideArenaSettings.LatencySlowPacketKickoutPercent )
          {
            if ( v79 )
            {
              *(_WORD *)a3 = 7;                 // 0x07 - Chat
              a3[2] = 0;
              *(_WORD *)&a3[3] = -1;
              strcpy(v316, "You have been put in spectator mode due to high latency (C2S)");
              v80 = strlen("You have been put in spectator mode due to high latency (C2S)") + 1;
              if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                SendPlayerReliablePacket(playerr, a3, v80 - 1 + 6, 1);
            }
            SetPlayerShip(playerr, 8);
            packett = packet;
            v78 = v296;
          }
        }
        playerr->C2SCurrentFast = 0;
        playerr->C2SCurrentSlow = 0;
      }
      if ( v78 < 800 && v78 > 0 )
      {
        playerr->C2SAverageLatencyFirst += v78;
        ++playerr->C2SAverageLatencySecond;
      }
      v81 = *((_WORD *)packett + 6);            // X Pixels (0 ... 16384)
      if ( v81 >= 0 && *((__int16 *)packett + 4) >= 0 && playerr->Ship != 8 )// Y Pixels (0 ... 16384)
      {
        if ( playerr->MyArena->ServersideArenaSettings.PacketLossDisableWeapons && rand() % 1000 < playerr->field_153 )
          *((_WORD *)packett + 10) &= 0x7F80u;
        v82 = *((__int16 *)packett + 6) - playerr->XPixels;// X Pixels (0 ... 16384)
        if ( (int)((HIDWORD(v82) ^ v82) - HIDWORD(v82)) > 512
          || (v83 = *((__int16 *)packett + 4) - playerr->YPixels,// Y Pixels (0 ... 16384)
              (int)((HIDWORD(v83) ^ v83) - HIDWORD(v83)) > 512) )
        {
          playerr->field_10F = 1;
        }
        if ( (packett[11] & 0x20) != 0 && (playerr->ShipTogglables & 0x20) == 0 )// Togglables 
          playerr->field_10F = 1;
        qmemcpy(playerr->gap_DC, packet, 0x16u);
        if ( (playerr->field_F0 & 0x1F) == 8 )
        {
          v84 = playerr->field_283;
          v85 = v84;
          if ( v84 >= 3 )
            v85 = 3;
          if ( v85 >= 0 )
          {
            if ( v84 >= 3 )
              LOBYTE(v84) = 3;
          }
          else
          {
            LOBYTE(v84) = 0;
          }
          playerr->field_F0 = (32 * (v84 & 3)) | playerr->field_F0 & 0xFF9F;
        }
        if ( (unsigned int)packetSize > 0x16 )
        {
          playerr->EnergyOptional = *(_DWORD *)(packet + 22);// Energy (Optional)
          playerr->TimerOptional = *(_DWORD *)(packet + 26);// Timer (Optional)
          playerr->SharpnelMinesBombsBulletsMultifireInformationOptional = *((_WORD *)packet + 15);
          playerr->field_10B = 1;
        }
        sub_40D870(playerr);
        playerr->field_FD = 1;
        if ( (playerr->field_F0 & 0x1F) != 0 )
          SendWeaponPacket(playerr);
        return;
      }
      v86 = playerr->ArenaPlayerIndex;
      if ( v86 < 0 )
      {
        if ( v81 < 0 || *((__int16 *)packett + 4) < 0 )// X Pixel & Y Pixel Checks
        {
          v88 = playerr->XPixels;
          v89 = playerr->YPixels;
          qmemcpy(playerr->gap_DC, packet, 0x16u);
          playerr->XPixels = v88;
          playerr->YPixels = v89;
        }
        else
        {
          qmemcpy(playerr->gap_DC, packet, 0x16u);
        }
      }
      else
      {
        v87 = ZonePlayerList[v86];
        if ( !v87 )
          goto LABEL_196;
        playerr->XPixels = v87->XPixels;
        playerr->YPixels = v87->YPixels;
      }
      sub_40D870(playerr);
LABEL_196:
      v90 = playerr->AttachedToPlayerId;
      if ( v90 >= 0 )
      {
        v91 = ZonePlayerList[v90];
        if ( v91 )
        {
          playerr->XPixels = v91->XPixels;
          playerr->YPixels = v91->YPixels;
          sub_40D870(playerr);
        }
      }
      return;
    case 5:                                     // 0x05 - Death message
      if ( !playerr->MyArena )
        return;
      UpdatePowerBallPositionsSomething(playerr);
      playerr->KingCrownKills = 0;
      v96 = *(_WORD *)(packet + 1);             // Killer's Player ID
      if ( v96 <= 1024 && *(__int16 *)(packet + 3) <= 20000 && v96 >= 0 )// 20000 Bounty
      {
        a2 = 0;
        playerra = (char *)ZonePlayerList[v96];
        v97 = (PLAYER *)playerra;
        if ( playerra && (ARENA *)*((_DWORD *)playerra + 7) != playerr->MyArena )
        {
          v97 = 0;
          playerra = 0;
        }
        v98 = playerr->MyArena;
        if ( !v98->ServersideArenaSettings.FlagFriendlyTransfer )
        {
          if ( !v97 )
            goto LABEL_223;
          if ( v97->Frequency == playerr->Frequency )// Check for Team Kills?
          {
            v99 = playerr->PlayerId;
            LOBYTE(Password) = 0x16;            // 0x16 - Drop Flag
            *(_WORD *)((char *)&Password + 1) = v99;
            ArenaSendPacket(v98, &Password, 3, 1);
            v100 = playerr->MyArena;
            v101 = v100->ServersideArenaSettings.FlagMode;
            if ( v101 )
            {
              if ( v101 == 1 )
              {
                CarryFlagsSomething(v100, *(_DWORD *)&playerr->PlayerId, 1);
                FlagPositionUpdateSomething(playerr->MyArena, 0);
              }
            }
            else
            {
              CarryFlagsSomething(v100, *(_DWORD *)&playerr->PlayerId, 0);
            }
          }
        }
        if ( v97 && v97->Ship == 8 )
        {
          v102 = playerr->PlayerId;
          v103 = playerr->MyArena;
          LOBYTE(Password) = 0x16;              // 0x16 - Drop Flag
          *(_WORD *)((char *)&Password + 1) = v102;
          ArenaSendPacket(v103, &Password, 3, 1);
          v104 = playerr->MyArena;
          v105 = v104->ServersideArenaSettings.FlagMode;
          if ( v105 )
          {
            if ( v105 == 1 )
            {
              CarryFlagsSomething(v104, *(_DWORD *)&playerr->PlayerId, 1);
              FlagPositionUpdateSomething(playerr->MyArena, 0);
            }
          }
          else
          {
            CarryFlagsSomething(v104, *(_DWORD *)&playerr->PlayerId, 0);
          }
        }
LABEL_223:
        v106 = playerr->KotHDeathCount;
        if ( v106 <= 0 )
        {
          if ( v97 )
          {
            if ( (int)v97->KotHDeathCount > 0 )
            {
              v117 = playerr->MyArena;
              if ( (int)v117->ServersideArenaSettings.KingNonCrownAdjustTime > 0
                && *(__int16 *)(packet + 3) >= v117->ServersideArenaSettings.KingNonCrownMinimumBounty
                && playerr->Frequency != v97->Frequency )
              {
                LOBYTE(v295) = 0x2D;            // 0x2D - Add KotH time
                *(_DWORD *)((char *)&v295 + 1) = v117->ServersideArenaSettings.KingNonCrownAdjustTime;
                SendPlayerReliablePacket(v97, (char *)&v295, 5, 1);
              }
            }
          }
        }
        else
        {
          v107 = v106 - 1;
          playerr->KotHDeathCount = v107;
          if ( v107 )
          {
            v109 = playerr->MyArena;
            LOBYTE(v295) = 0x2B;                // 0x2B - Set Personal KotH Timer
            *(_DWORD *)((char *)&v295 + 1) = v109->ServersideArenaSettings.KingExpireTime;
            SendPlayerReliablePacket(playerr, (char *)&v295, 5, 1);
          }
          else
          {
            HIWORD(v295) = playerr->PlayerId;
            v108 = playerr->MyArena;
            LOWORD(v295) = 0x2C;                // 0x2C - KotH Game Reset
            *(_DWORD *)((char *)&v295 + 2) = 0;
            ArenaSendPacket(v108, &v295, 8, 1);
          }
          if ( v97 )
          {
            if ( (int)v97->KotHDeathCount <= 0 )
            {
              v111 = v97->KingCrownKills + 1;
              v97->KingCrownKills = v111;
              v112 = v111;
              v113 = playerr->MyArena;
              v114 = v113->ServersideArenaSettings.KingCrownRecoverKills;
              if ( v114 > 0 && v112 >= v114 )
              {
                v115 = v97->PlayerId;
                v97->KotHDeathCount = v113->ServersideArenaSettings.KingDeathCount;
                HIWORD(v295) = v115;
                v116 = playerr->MyArena;
                LOWORD(v295) = 0x12C;           // 0x2C - KotH Game Reset
                *(_DWORD *)((char *)&v295 + 2) = v116->ServersideArenaSettings.KingExpireTime;
                ArenaSendPacket(v116, &v295, 8, 1);
              }
            }
            else
            {
              v110 = playerr->MyArena;
              LOBYTE(v295) = 0x2B;              // 0x2B - Set Personal KotH Timer
              *(_DWORD *)((char *)&v295 + 1) = v110->ServersideArenaSettings.KingExpireTime;
              SendPlayerReliablePacket(v97, (char *)&v295, 5, 1);
            }
          }
        }
        playerr->DebtKills = playerr->MyArena->ServersideArenaSettings.KillDebtKills;
        v118 = playerr->field_BC + 1;
        playerr->field_BC = v118;
        if ( v118 > playerr->MyArena->ServersideArenaSettings.SecurityMaxDeathWithoutFiring && !playerr->isModerator )
        {
          WriteSubGameLog("Played kicked off for too many deaths without firing: %s\n", playerr->PlayerName);
          playerr->DisconnectReason = 10;       // 0x0A - Server is Full
          playerr->AlreadySentReliablePacket = 1;
        }
        v119 = playerr->MyArena;
        Password = 0;
        v296 = 0;
        if ( v119->ArenaSettings.CarryFlags && v119->someCounterBefore > 0 )
        {
          v120 = &v119->gap_186A2[4];
          LODWORD(v295) = v119->someCounterBefore;
          do
          {
            v121 = *(_DWORD *)v120;
            if ( *(_DWORD *)v120 == *(_DWORD *)&playerr->PlayerId )
              ++Password;
            if ( v121 == *(__int16 *)(packet + 1) )
              ++v296;
            v120 += 16;
            LODWORD(v295) = v295 - 1;
          }
          while ( (_DWORD)v295 );
        }
        if ( v119->ArenaSettings.CarryFlags == 2 && Password > 0 && v296 > 0 )
        {
          v122 = playerr->PlayerId;
          LOBYTE(Password) = 22;
          *(_WORD *)((char *)&Password + 1) = v122;
          ArenaSendPacket(v119, &Password, 3, 1);
          v123 = playerr->MyArena;
          v124 = v123->ServersideArenaSettings.FlagMode;
          if ( v124 )
          {
            if ( v124 == 1 )
            {
              CarryFlagsSomething(v123, *(_DWORD *)&playerr->PlayerId, 1);
              FlagPositionUpdateSomething(playerr->MyArena, 0);
            }
          }
          else
          {
            CarryFlagsSomething(v123, *(_DWORD *)&playerr->PlayerId, 0);
          }
          Password = 0;
        }
        if ( *(__int16 *)(packet + 1) == *(_DWORD *)&playerr->PlayerId )// Killer's Player ID
        {
          v125 = -*(__int16 *)(packet + 3);
          a2 = v125;
          printf("%s(%d) killed by self\n", playerr->Name, v125);
          FormatMessageArena(playerr->MyArena, "%s(%d) killed by self\n", playerr->Name, v125);
          v126 = playerr->MyArena;
          v127 = playerr->field_297 + 1;
          playerr->field_297 = v127;
          if ( v127 > v126->ServersideArenaSettings.SecuritySuicideLimit )
          {
            WriteSubGameLog("Played kicked off for too many suicides: %s\n", playerr->PlayerName);
            playerr->DisconnectReason = 0x13;   // 0x13 - Demo Versions not Allowed
            playerr->AlreadySentReliablePacket = 1;
          }
          CarryFlagsSomething(playerr->MyArena, *(_DWORD *)&playerr->PlayerId, 0);
LABEL_300:
          LODWORD(v295) = -1;
          if ( v97 )
          {
            v147 = playerra;
            v148 = 0;
            v149 = *(_DWORD *)(playerra + 557);
            v150 = *(_DWORD *)(playerra + 553);
            LODWORD(v295) = *(_DWORD *)(playerra + 279);
            v151 = v150 + v149;
            if ( a2 > 0 && v296 > 0 )
              v148 = a2 * (__int16)playerr->MyArena->ArenaSettings.FlaggerKillMultiplier;
            UpdatePoints((PLAYER *)playerra, a2, v148);
            if ( *(int *)(v147 + 553) < 0 )
              *(_DWORD *)(v147 + 553) = 0;
            if ( v151 < AutoPermissionPoints
              && AutoPermissionPoints > 0
              && *(_DWORD *)(playerra + 553) + *(_DWORD *)(playerra + 557) >= AutoPermissionPoints )
            {
              if ( *((_DWORD *)playerra + 7) )
              {
                *(_WORD *)a3 = 7;               // 0x07 - Chat
                a3[2] = 0;
                *(_WORD *)&a3[3] = -1;
                strcpy(v316, PermissionAutoPermissionMessage);
                v152 = strlen(PermissionAutoPermissionMessage) + 1;
                v153 = playerra;
                if ( GetRelAckDiff(*((ENCRYPTION **)playerra + 10), 0) < 128 )
                  SendPlayerReliablePacket((PLAYER *)v153, a3, v152 - 1 + 6, 1);
              }
            }
          }
          v154 = playerr->MyArena;
          ++playerr->CurrentLosses;
          v155 = a2;
          v156 = v154->ArenaJackpot;
          v154->ArenaJackpot = v156 + a2 * v154->ServersideArenaSettings.KillJackpotBountyPercent / 1000;
          if ( MiscJackpotBroadcastPoints > 0 )
          {
            v157 = playerr->MyArena;
            v296 = v157->ArenaJackpot / MiscJackpotBroadcastPoints;
            if ( v156 / MiscJackpotBroadcastPoints < v296 )
            {
              *(_WORD *)a3 = 2;
              sprintf(
                &a3[2],
                "Jackpot just passed %d points in %s",
                MiscJackpotBroadcastPoints * (v157->ArenaJackpot / MiscJackpotBroadcastPoints),
                BillingServerName);
              if ( BillingConnectionStructPointer )
                SendBillerUserPrivateChatPacket(
                  (ENCRYPTION **)BillingConnectionStructPointer,
                  -1,
                  BillingGroupId,
                  a3,
                  strlen(&a3[2]) + 3);
            }
          }
          v158 = playerr->PlayerId;
          v309 = 6;                             // 0x06 - Player Death
          v310.YPixels = v158;
          v159 = *(_WORD *)(packet + 1);
          v310.ZeroTwo = Password;
          v160 = playerr->MyArena;
          v310.XPixels = v159;
          v310.ZeroOne = v155;
          v161 = 0;
          v310.PowerBallId = GetDeathPrizeGreenId(v160);
          if ( v310.ZeroTwo || abs16(v310.ZeroOne) > 0xA0u )
          {
            ArenaSendPacket(playerr->MyArena, &v309, 10, 1);
          }
          else
          {
            v162 = playerr->MyArena;
            if ( v162->ServersideArenaSettings.MiscTimedGame )
            {
              if ( v162->ArenaPlayerCount > 0 )
              {
                v163 = 16072;
                do
                {
                  v164 = v162->PlayerPointers[v163];
                  v165 = *(_DWORD *)&playerr->PlayerId;
                  v167 = 1;
                  if ( v164->AttachedToPlayerId != v165 )
                  {
                    v166 = *(_DWORD *)&v164->PlayerId;
                    if ( v166 != v165 && v166 != *(__int16 *)(packet + 1) )
                      v167 = 0;
                  }
                  SendPlayerReliablePacket(v164, &v309, 10, v167);
                  v162 = playerr->MyArena;
                  ++v161;
                  ++v163;
                }
                while ( v161 < v162->ArenaPlayerCount );
              }
              goto LABEL_348;
            }
            v168 = v162->ArenaPlayerCount;
            v296 = 0;
            if ( v168 > 0 )
            {
              v169 = 16072;
              while ( 1 )
              {
                v170 = v162->PlayerPointers[v169];
                v171 = v170;
                v172 = v170->ArenaPlayerIndex;
                if ( v172 >= 0 )
                  v171 = ZonePlayerList[v172];
                if ( !v171 )
                  goto LABEL_345;
                v173 = v171->Frequency;
                if ( v173 != playerr->Frequency && v173 != (_DWORD)v295 )
                  break;
                v174 = *(_DWORD *)&playerr->PlayerId;
                if ( v171->AttachedToPlayerId != v174 )
                {
                  v175 = *(_DWORD *)&v171->PlayerId;
                  if ( v175 != v174 && v175 != *(__int16 *)(packet + 1) )
                    goto LABEL_344;
                }
                SendPlayerReliablePacket(v170, &v309, 10, 1);
LABEL_345:
                v162 = playerr->MyArena;
                ++v169;
                v180 = v162->ArenaPlayerCount;
                if ( ++v296 >= v180 )
                  goto LABEL_348;
              }
              v176 = v171->AttachedToPlayerId;
              if ( v176 >= 0 )
                v171 = ZonePlayerList[v176];
              if ( !v171 )
                goto LABEL_345;
              v177 = v162->ServersideArenaSettings.RoutingDeathDistance;
              v178 = v171->YPixels - playerr->YPixels;
              if ( (int)((HIDWORD(v178) ^ v178) - HIDWORD(v178)) > v177 )
                goto LABEL_345;
              v179 = v171->XPixels - playerr->XPixels;
              if ( (int)((HIDWORD(v179) ^ v179) - HIDWORD(v179)) > v177 )
                goto LABEL_345;
LABEL_344:
              SendPlayerReliablePacket(v170, &v309, 10, 0);
              goto LABEL_345;
            }
          }
LABEL_348:
          v181 = playerr->MyArena->ServersideArenaSettings.MiscMaxLossesToPlay;
          if ( v181 > 0 && (unsigned __int16)playerr->CurrentLosses >= v181 )
            SetPlayerShip(playerr, 8);
          if ( AdvertiseSendMode == 3 || AdvertiseSendMode == 2 )
            SendAdvertisement(playerr, 0);
          if ( playerra )
            SendPlayerScoreUpdateAll((PLAYER *)playerra);
          SendPlayerScoreUpdateAll(playerr);
          return;
        }
        playerr->field_297 = 0;
        if ( !v97 )
        {
          printf("%s killed by UNKNOWN\n", playerr->Name);
          CarryFlagsSomething(playerr->MyArena, *(_DWORD *)&playerr->PlayerId, 0);
LABEL_299:
          dword_4D8B14 = *(_DWORD *)&playerr->PlayerId;
          goto LABEL_300;
        }
        v128 = playerr->MyArena;
        if ( (int)v128->ServersideArenaSettings.KillFixedKillReward < 0 )
        {
          v130 = *(__int16 *)v97->gap_EC;
          v131 = (__int16)v128->ArenaSettings.MaxBonus;
          if ( v130 >= 0 )
          {
            v132 = *(__int16 *)(packet + 3) - v130;
            if ( v132 < v131 )
              v131 = *(__int16 *)(packet + 3) - v130;
            v133 = -(__int16)v128->ArenaSettings.MaxPenalty;
            if ( v131 <= v133 || (v133 = (__int16)v128->ArenaSettings.MaxBonus, v132 >= v133) )
              v132 = v133;
            v129 = v132 + *(__int16 *)(packet + 3) + (__int16)v128->ArenaSettings.RewardBase;
          }
          else
          {
            v129 = *(__int16 *)(packet + 3);
          }
        }
        else
        {
          v129 = v128->ServersideArenaSettings.KillFixedKillReward;
        }
        v134 = *(__int16 *)v97->gap_EC * v128->ServersideArenaSettings.KillBountyRewardPercent / 100 + v129;
        LODWORD(v295) = v128->ServersideArenaSettings.KillPointsPerFlag;
        a2 = v134;
        if ( (_DWORD)v295
          && v128->ArenaPlayerCount > v128->ServersideArenaSettings.PeriodicRewardMinimumPlayers
          && *(__int16 *)(packet + 3) > v128->ServersideArenaSettings.KillPointsMinimumBounty )
        {
          v135 = v128->someCounterBefore;
          v136 = 0;
          if ( v135 > 0 )
          {
            v137 = &v128->gap_186A2[8];
            do
            {
              if ( *(_DWORD *)v137 == v97->Frequency )
                ++v136;
              v137 += 16;
              --v135;
            }
            while ( v135 );
          }
          a2 = v295 * v136 + v134;
        }
        v138 = 0;
        v139 = &v97->someStringBuffer[4];
        while ( *(_DWORD *)v139 != playerr->UserId )
        {
          ++v138;
          v139 += 8;
          if ( v138 >= 8 )
          {
            v140 = 0xFFFFFFF;
            goto LABEL_286;
          }
        }
        v290 = (int)(GetTickCount() / 0xA - *(_DWORD *)&v97->someStringBuffer[8 * v138]);
        v140 = (HIDWORD(v290) ^ v290) - HIDWORD(v290);
LABEL_286:
        if ( v140 >= playerr->MyArena->ServersideArenaSettings.KillNoRewardKillDelay )
        {
          v141 = playerr->UserId;
          *(_DWORD *)&v97->someStringBuffer[8 * v97->field_A8] = GetTickCount() / 0xA;
          *(_DWORD *)&v97->someStringBuffer[8 * v97->field_A8 + 4] = v141;
          v97->field_A8 = (v97->field_A8 + 1) % 8;
          if ( v97->Frequency != playerr->Frequency )
          {
            v142 = v97->DebtKills;
            if ( v142 <= 0 )
            {
LABEL_291:
              v143 = a2;
              ++v97->CurrentWins;
              printf("%s(%d) killed by %s\n", playerr->Name, v143, v97->Name);
              FormatMessageArena(playerr->MyArena, "%s(%d) killed by %s\n", playerr->Name, a2, v97->Name);
              v144 = playerr->MyArena;
              if ( v144->ArenaSettings.CarryFlags )
              {
                v145 = 0;
                if ( v144->someCounterBefore > 0 )
                {
                  v146 = 0;
                  do
                  {
                    if ( *(_DWORD *)&v144->gap_186A2[v146 + 4] == *(_DWORD *)&playerr->PlayerId )
                    {
                      *(_DWORD *)&v144->gap_186A2[v146 + 4] = *(_DWORD *)&v97->PlayerId;
                      *(_DWORD *)&playerr->MyArena->gap_186A2[v146 + 8] = v97->Frequency;
                    }
                    v144 = playerr->MyArena;
                    ++v145;
                    v146 += 16;
                  }
                  while ( v145 < v144->someCounterBefore );
                }
              }
              goto LABEL_299;
            }
            v97->DebtKills = v142 - 1;
          }
        }
        a2 = 0;
        goto LABEL_291;
      }
      if ( !playerr->isSuperModerator )
      {
LABEL_358:
        sprintf(a1, "Packet tampering(%d)", (char)*packet);
        SendBillerWarnings(a1, playerr);
        v182 = playerr->MyArena;
        if ( v182 && v182->ServersideArenaSettings.dwordB4 )
          goto LABEL_683;
      }
      return;
    case 6:                                     // 0x06 - Chat message
      if ( playerr->IsSilenced || !playerr->MyArena )
        return;
      v236 = *(_WORD *)(packet + 3);
      if ( v236 > 1024 || v236 < 0 )
        goto LABEL_503;
      if ( strlen((const char *)packet + 5) > 0xFA )
      {
        v5 = v295;
LABEL_503:
        if ( !playerr->isSuperModerator )
        {
          sprintf(a1, "Packet tampering(%d)", v5);
          SendBillerWarnings(a1, playerr);
          v237 = playerr->MyArena;
          if ( v237 )
          {
            if ( v237->ServersideArenaSettings.dwordB4 )
              goto LABEL_683;
          }
        }
      }
      else
      {
        if ( playerr->MyArena->ServersideArenaSettings.MessageBongAllowed || playerr->isModerator )
          v293 = packet[2];
        else
          v293 = 0;
        ChatProcessor(playerr, (char)packet[1], v236, (char *)packet + 5, v293);
      }
      return;
    case 7:                                     // 0x07 - Take Green / Prize
      if ( playerr->MyArena && playerr->Ship != 8 )
      {
        if ( *(__int16 *)(packet + 9) >= 29
          || (v183 = *(_WORD *)(packet + 5), v183 < 0)
          || v183 >= 1024
          || (v184 = *(_WORD *)(packet + 7), v184 < 0)
          || v184 >= 1024 )
        {
          if ( !playerr->isSuperModerator )
          {
            sprintf(a1, "Packet tampering(%d)", v5);
            SendBillerWarnings(a1, playerr);
            v197 = playerr->MyArena;
            if ( v197 )
            {
              if ( v197->ServersideArenaSettings.dwordB4 )
                goto LABEL_683;
            }
          }
        }
        else
        {
          v185 = *(_DWORD *)(packet + 1);
          v186 = playerr->encryptionPointer;
          v187 = ((v186->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v185;
          if ( v187 < 0 || v187 > 30000 )
            v187 = 0;
          v188 = playerr->MyArena;
          if ( v187 <= v188->ServersideArenaSettings.LatencyMaxLatencyForPrizes
            && *(_DWORD *)&playerr->gap_F2[1] != *(_DWORD *)(packet + 1) )
          {
            v309 = 8;                           // 0x08 - Player got a Prize
            *(_DWORD *)playerr->gap_F2 = *(_DWORD *)packet;
            *(_DWORD *)&playerr->gap_F2[4] = *((_DWORD *)packet + 1);
            *(_WORD *)&playerr->gap_F2[8] = *((_WORD *)packet + 4);
            playerr->gap_F2[10] = packet[10];
            v189 = *(_WORD *)(packet + 7);
            *(__int16 *)((char *)&v310.YPixels + 1) = *(_WORD *)(packet + 5);
            v190 = *(_WORD *)(packet + 9);
            *(__int16 *)((char *)&v310.ZeroOne + 1) = v189;
            v191 = *(_DWORD *)(packet + 1);
            *(__int16 *)((char *)&v310.ZeroTwo + 1) = v190;
            v192 = playerr->PlayerId;
            *(_DWORD *)&v310.PowerBallId = v191;
            *(__int16 *)((char *)&v310.PlayerId + 1) = v192;
            v193 = v188->ServersideArenaSettings.PrizeS2CTakePrizeReliable;
            if ( v188 )
            {
              v194 = 0;
              if ( v188->ArenaPlayerCount > 0 )
              {
                v195 = 16072;
                do
                {
                  v196 = v188->PlayerPointers[v195];
                  if ( v196 != playerr && !v196->AlreadySentReliablePacket )
                    SendPlayerReliablePacket(v196, &v309, 13, v193);
                  v188 = playerr->MyArena;
                  ++v194;
                  ++v195;
                }
                while ( v194 < v188->ArenaPlayerCount );
              }
            }
          }
        }
      }
      return;
    case 8:                                     // 0x08 - Spectate request
      if ( playerr->MyArena )
      {
        v220 = *(_WORD *)(packet + 1);
        if ( v220 == -1 || playerr->Ship == 8 )
        {
          if ( v220 > 1024 || v220 < -1 )
          {
            if ( !playerr->isSuperModerator )
            {
              sprintf(a1, "Packet tampering(%d)", v5);
              SendBillerWarnings(a1, playerr);
              v226 = playerr->MyArena;
              if ( v226 )
              {
                if ( v226->ServersideArenaSettings.dwordB4 )
                  goto LABEL_683;
              }
            }
          }
          else
          {
            v221 = playerr->ArenaPlayerIndex;
            playerr->ArenaPlayerIndex = v220;
            if ( v220 >= 0 )
            {
              v222 = ZonePlayerList[v220];
              if ( v222 )
              {
                playerr->XPixels = v222->XPixels;
                playerr->YPixels = v222->YPixels;
                sub_40D870(playerr);
              }
            }
            if ( playerr->isSysop )
            {
              LOBYTE(Password) = 0x1C;          // 0x1C - Put player in spectator mode / change extra info flag
              if ( v221 >= 0 )
              {
                v223 = ZonePlayerList[v221];
                BYTE1(Password) = 0;            // Player ID
                if ( v223 )
                  SendPlayerReliablePacket(v223, (char *)&Password, 2, 1);
              }
              v224 = playerr->ArenaPlayerIndex;
              if ( v224 >= 0 )
              {
                v225 = ZonePlayerList[v224];
                BYTE1(Password) = 1;            // Player ID
                if ( v225 )
                  SendPlayerReliablePacket(v225, (char *)&Password, 2, 1);
              }
            }
          }
        }
        else
        {
          WriteSubGameLog("WARNING: Spectator request from non-spectator ship, ignoring\n");
        }
      }
      return;
    case 9:                                     // 0x09 - Password packet
    case 35:                                    // 0x23 - Password packet
      v267 = *(_DWORD *)(packet + 77);          // Mem Checksums [0x01BC] or [444]
      v296 = 0;
      if ( !v267 )
      {
        playerr->DemoPlayer = 1;
        v296 = 1;
      }
      v268 = (char *)(packet + 2);
      playerra = (char *)(packet + 2);
      strcpy(playerr->TypedName, (const char *)packet + 2);
      config_read_helper_3((int)(packet + 2));
      printf("Connection request from: %s\n", (const char *)packet + 2);
      v269 = 0;
      a2 = 0;
      Password = (int)(packet + 34);
      v270 = strrchr((const char *)packet + 34, '*');// Player Name 32 Bytes Length
      if ( !v270 )
        goto LABEL_605;
      if ( _strcmpi(v270 + 1, SysopPassword) )
      {
        if ( _strcmpi(v270 + 1, SuperModeratorPassword) )
        {
          if ( _strcmpi(v270 + 1, ModeratorPassword) )
          {
            if ( _strcmpi(v270 + 1, VIPPassword) )
              goto LABEL_605;
            v269 = 1;
            a2 = 1;
            WriteSubGameLog("%s>  VIP LOGGED IN\n", v268);
          }
          else
          {
            WriteSubGameLog("%s>  MODERATOR LOGGED IN\n", v268);
            v269 = 1;
            a2 = 1;
            playerr->isModerator = 1;
          }
        }
        else
        {
          WriteSubGameLog("%s>  SUPER MODERATOR LOGGED IN\n", v268);
          v269 = 1;
          a2 = 1;
          playerr->isModerator = 1;
          playerr->isSuperModerator = 1;
        }
      }
      else
      {
        WriteSubGameLog("%s> SYSOP LOGGED IN\n", v268);
        v269 = 1;
        a2 = 1;
        playerr->isSysop = 1;
        playerr->isModerator = 1;
        playerr->isSuperModerator = 1;
      }
      *v270 = 0;
LABEL_605:
      if ( !v296 && BillingConnectionStructPointer && IsBannedMachineId((int)ModeratePointer, (int)v268) >= 0 )
      {
        v269 = 1;
        a2 = 1;
        playerr->isModerator = 1;
      }
      playerr->Name[0] = 0;
      strncpy(playerr->PlayerName, v268, 0x18u);
      playerr->PlayerName[23] = 0;
      playerr->MachineId = *(_DWORD *)(packet + 85);
      playerr->TimeZoneBias = *(__int16 *)(packet + 71);
      v271 = (char)packet[70];
      playerr->ConnectType = v271;
      if ( v271 == 1 )
        playerr->SlowModem = 1;
      if ( !PermissionAllowLowBandwidth && !v269 )
      {
        v311 = 0xA;                             // 0x0A - Password response
        v312 = 8;                               // Byte [1] - 8 - Connection too slow.
        v313 = 134;                             // Byte [2] - Server version 134 - SubSpace 1.34
        SendPlayerReliablePacket(playerr, &v311, 36, 1);
        WriteSubGameLog("Played kicked off for having slow modem: %s\n", playerr->PlayerName);
        playerr->AlreadySentReliablePacket = 1;
        return;
      }
      *(_DWORD *)&playerr->SubspaceVersion = *(__int16 *)(packet + 75);
      playerr->SubspaceEXEChecksumIndex = 0;
      v272 = *packet;
      if ( (char)*packet >= 35 && v272 <= 44 )
        playerr->SubspaceEXEChecksumIndex = v272 - 35;
      if ( !Security[playerr->SubspaceEXEChecksumIndex].SubspaceEXEChecksum )
        goto LABEL_618;
      if ( IsOffensiveName((int *)v268) && !playerr->isModerator )
      {
        v299 = 0xA;                             // 0x0A - Password Packet Response
        v300 = 0xC;                             // 0x0C - Offensive Name
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        v306 = 0;                               // Registration Form Request (Boolean)
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
        WriteSubGameLog("Played kicked off, obscene name: %s\n", v268);
        playerr->AlreadySentReliablePacket = 1;
        return;
      }
      if ( PermissionMode == 1
        && !playerr->isModerator
        && (v296 || IsBannedMachineId((int)PermitPointer, (int)v268) < 0) )
      {
LABEL_618:
        v299 = 0xA;
        v300 = 5;                               // 0x05 - Permission Only Arena
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        v306 = 0;                               // Registration Form Request (Boolean)
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
        playerr->KickOffDelayTimer = GetTickCount() / 0xA;
        return;
      }
      v273 = GetIPAddressString((struct in_addr)playerr->IPAddressDWORD);
      if ( IsBannedIPAddress(playerr->SubspaceEXEChecksumIndex, v273) )
      {
        v299 = 0xA;                             // 0x0A - Password Packet Response
        v300 = 4;                               // 0x04 - Locked Out of Zone
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        v306 = 0;                               // Registration Form Request (Boolean)
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
        WriteSubGameLog("Played kicked off, IP block: %s\n", playerr->PlayerName);
        playerr->AlreadySentReliablePacket = 1;
        return;
      }
      sprintf(&v309, "%d", playerr->MachineId);
      if ( IsBannedMachineId((int)IDBlockPointer, (int)&v309) >= 0 )
      {
        v299 = 0xA;                             // 0x0A - Password Packet Response
        v300 = 4;                               // 0x04 - Locked Out of Zone
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        v306 = 0;                               // Registration Form Request (Boolean)
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
        WriteSubGameLog("Played kicked off, ID block: %s\n", playerr->PlayerName);
        playerr->AlreadySentReliablePacket = 1;
        return;
      }
      v274 = 0;
      if ( MachineIdArrayIndex <= 0 )
        goto LABEL_638;
      v275 = KickedUsers;
      while ( v275->MachineId != playerr->MachineId || playerr->isSysop )
      {
        ++v274;
        ++v275;
        if ( v274 >= MachineIdArrayIndex )
          goto LABEL_638;
      }
      v299 = 0xA;                               // 0x0A - Password Packet Response
      v300 = 5;                                 // 0x05 - Permission Only Arena
      v301 = 134;                               // Server Version 134 = SubSpace 1.34
      v306 = 0;                                 // Registration Form Request (Boolean)
      SendPlayerReliablePacket(playerr, &v299, 36, 1);
      playerr->KickOffDelayTimer = GetTickCount() / 0xA;
LABEL_638:
      if ( !playerr->DemoPlayer )
        goto LABEL_649;
      v276 = ZonePlayerCount;
      v277 = 0;
      if ( ZonePlayerCount > 0 )
      {
        v278 = playerPointerList;
        v279 = ZonePlayerCount;
        do
        {
          if ( (*v278)->DemoPlayer )
            ++v277;
          ++v278;
          --v279;
        }
        while ( v279 );
      }
      if ( MiscMaxSharewarePlayer >= 0 && v277 > MiscMaxSharewarePlayer )
      {
        v299 = 0xA;
        v300 = (MiscMaxSharewarePlayer == 0) + 17;
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        v306 = 0;
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
        WriteSubGameLog("Played kicked off, arena full to demo users: %s\n", playerr->PlayerName);
        playerr->AlreadySentReliablePacket = 1;
        return;
      }
      if ( v296 )
      {
        memset(playerr->Name, 0, 0xACu);        // TODO: Erases way past the Name LOL
        sprintf(playerr->Name, "~Demo%d", *(_DWORD *)&playerr->PlayerId);
        strcpy(playerr->PlayerName, playerr->Name);
        playerr->UserId = -1;
        *(_DWORD *)&playerr->CurrentWins = 0;
        *(_DWORD *)&playerr->GoalCount = 0;
        *(int *)((char *)&playerr->KillPoints + 2) = 0;
        HIWORD(playerr->FlagPoints) = 0;
LABEL_649:
        v276 = ZonePlayerCount;
      }
      if ( v276 > MiscMaxPlayers && !a2 )
      {
        v296 = 0;
        if ( MiscRegisterKickShareware )
        {
          if ( !playerr->DemoPlayer )
          {
            v280 = 0;
            if ( v276 > 0 )
            {
              v281 = playerPointerList;
              while ( !(*v281)->DemoPlayer )
              {
                ++v280;
                ++v281;
                if ( v280 >= v276 )
                  goto LABEL_663;
              }
              v282 = playerPointerList[v280];
              v296 = 1;
              LODWORD(v295) = v282;
              if ( v282->MyArena )
              {
                *(_WORD *)a3 = 7;
                a3[2] = 0;
                *(_WORD *)&a3[3] = -1;
                strcpy(v316, "You have been kicked off to make space for a registered user.");
                v283 = strlen("You have been kicked off to make space for a registered user.") + 1;
                if ( GetRelAckDiff(*(ENCRYPTION **)(v295 + 40), 0) < 128 )
                  SendPlayerReliablePacket((PLAYER *)v295, a3, v283 - 1 + 6, 1);
              }
              playerPointerList[v280]->KickOffDelayTimer = GetTickCount() / 0xA;
            }
          }
        }
LABEL_663:
        if ( !v296 )
        {
          v299 = 0xA;
          v300 = 3;
          v301 = 134;
          v306 = 0;
          SendPlayerReliablePacket(playerr, &v299, 36, 1);
          WriteSubGameLog("Played kicked off, arena full: %s\n", playerr->PlayerName);
          playerr->AlreadySentReliablePacket = 1;
          return;
        }
      }
      v284 = BillingConnectionStructPointer;
      if ( BillingConnectionStructPointer )
      {
        if ( !a2 )
        {
          if ( GetRelAckDiff(encryption, 0) > CommsMaxQueueToLogin )
          {
            v299 = 0xA;                         // 0x0A - Password Packet Response
            v300 = 0xE;                         // 0x0E - Server Busy, try Later
            v301 = 134;                         // Server Version 134 = SubSpace 1.34
            v306 = 0;                           // Registration Form Request (Boolean)
            SendPlayerReliablePacket(playerr, &v299, 36, 1);
            playerr->AlreadySentReliablePacket = 1;
            return;
          }
          v284 = BillingConnectionStructPointer;
        }
        if ( playerr->DemoPlayer && MiscDisableShareware )
          SendBillerUserLoginPacket(
            v284,
            (const char *)&DirectoryCurrentNamePassword,
            (const char *)&DirectoryCurrentNamePassword,
            playerr->IPAddressDWORD,
            playerr->MachineId,
            playerr->TimeZoneBias,
            packet[1],
            playerr->BillerPlayerId,
            0,
            playerr->isSysop);
        else
          SendBillerUserLoginPacket(
            v284,
            playerra,
            (const char *)Password,
            playerr->IPAddressDWORD,
            playerr->MachineId,
            playerr->TimeZoneBias,
            packet[1],
            playerr->BillerPlayerId,
            0,
            playerr->isSysop);
      }
      else if ( IsBannedMachineId((int)ReservedPointer, (int)playerra) < 0 || a2 )
      {
        memset(playerr->Name, 0, 0xACu);        // TODO: Clears past the Name limit of 32 bytes.
        v299 = 0xA;
        v300 = 0xD;                             // 0x0D - No Active Biller
        strcpy(playerr->Name, playerra);
        v301 = 134;                             // Server Version 134 = SubSpace 1.34
        *(_DWORD *)&playerr->CurrentWins = 0;
        *(_DWORD *)&playerr->GoalCount = 0;
        *(int *)((char *)&playerr->KillPoints + 2) = 0;
        HIWORD(playerr->FlagPoints) = 0;
        v285 = playerr->SubspaceEXEChecksumIndex;
        v302 = 0;                               // ? Unknown
        v304 = 0;                               // ? Unknown
        v286 = v285;
        v305 = 0;                               // ? Unknown
        v306 = 0;                               // Registration Form Request (Boolean)
        v287 = Security[v285].SubspaceEXEChecksum;
        v307 = *(_DWORD *)&Security[v286].ScrtyData[4];
        v288 = playerr->isModerator;
        v303 = v287;
        v308 = NewsTxtFileChecksum;
        if ( v288 )
        {
          v303 = -1;                            // Subspace.exe Checksum
          v307 = -1;                            // ? Unknown
        }
        SendPlayerReliablePacket(playerr, &v299, 36, 1);
      }
      else
      {
        v311 = 0xA;                             // 0x0A - Password Packet Response
        v312 = 12;                              // 12 - Offensive name.
        v313 = 134;                             // Server Version 134 = SubSpace 1.34
        v314 = 0;
        SendPlayerReliablePacket(playerr, &v311, 36, 1);
        playerr->KickOffDelayTimer = GetTickCount() / 0xA;
      }
      return;
    case 11:                                    // 0x0B - SSUpdate.EXE Request
      v65 = *(_DWORD *)&playerr->SubspaceVersion;
      if ( v65 == 132 && (v66 = playerr->SubspaceEXEChecksumIndex, (v67 = Security[v66].field_8) != 0) )
      {
        GetMapLvlRequest((int)playerr->encryptionPointer, v67, Security[v66].field_14, 0);
      }
      else if ( v65 == 133 && (v68 = playerr->SubspaceEXEChecksumIndex, (v69 = Security[v68].field_4) != 0) )
      {
        GetMapLvlRequest((int)playerr->encryptionPointer, v69, Security[v68].field_10, 0);
      }
      else
      {
        GetMapLvlRequest(
          (int)playerr->encryptionPointer,
          *(_DWORD *)&Security[playerr->SubspaceEXEChecksumIndex].test,
          Security[playerr->SubspaceEXEChecksumIndex].field_C,
          0);
      }
      return;
    case 12:                                    // 0x0C - Map.lvl Request
      v63 = playerr->MyArena;
      if ( v63 )
        GetMapLvlRequest(
          (int)playerr->encryptionPointer,
          *(_DWORD *)&v63->dwLastConfigReadTime[12],
          *(_DWORD *)&v63->dwLastConfigReadTime[16],
          0);
      return;
    case 13:                                    // 0x0D - News.txt Request
      v64 = emalloc(bytes);
      qmemcpy(v64, ptr, bytes);
      GetNewsRequest((int)playerr->encryptionPointer, (int)v64, bytes, 0);
      return;
    case 14:                                    // 0x0E - Voice Message
      v232 = packet[1];                         // 4*1024 Max Voice Size is 8192 Bytes
      if ( v232 >= 4 || v232 < 0 || *((__int16 *)packet + 1) > 1024 )
      {
        if ( !playerr->isSuperModerator )
          goto LABEL_589;
      }
      else
      {
        if ( !*(_DWORD *)&playerr->field_33D[8 * v232] )
        {
          packett = packet;
          *(_DWORD *)&playerr->field_33D[8 * (char)packet[1]] = emalloc(packetSize - 4);
          *(_DWORD *)&playerr->field_33D[8 * (char)packet[1] + 4] = packetSize - 4;
          qmemcpy(*(void **)&playerr->field_33D[8 * (char)packet[1]], packet + 4, packetSize - 4);
        }
        v233 = *((_WORD *)packett + 1);
        if ( v233 != -1 && v233 != -2 && v233 >= 0 )
        {
          LODWORD(v295) = ZonePlayerList[v233];
          if ( (_DWORD)v295 )
          {
            if ( !sub_41CA10(*(_DWORD *)(v295 + 40)) )
            {
              v234 = *(_DWORD *)&playerr->field_33D[8 * (char)packet[1] + 4] + 3;
              v235 = emalloc(v234);
              *(_BYTE *)v235 = 12;
              *(_WORD *)((char *)v235 + 1) = playerr->PlayerId;
              qmemcpy(
                (char *)v235 + 3,
                *(const void **)&playerr->field_33D[8 * (char)packet[1]],
                *(_DWORD *)&playerr->field_33D[8 * (char)packet[1] + 4]);
              GetNewsRequest(*(_DWORD *)(v295 + 40), (int)v235, v234, 1);
              Wave += v234;
            }
          }
        }
      }
      return;
    case 15:
      if ( playerr->MyArena )                   // 0x0F - Frequency change
        PlayerChangeFrequency(playerr, *(__int16 *)(packet + 1));
      return;
    case 16:
      if ( !playerr->MyArena || playerr->Ship == 8 )
        return;
      v257 = *(_WORD *)(packet + 1);
      if ( v257 > 1024 || v257 < -1 )
      {
        if ( !playerr->isSuperModerator )
        {
LABEL_589:
          sprintf(a1, "Packet tampering(%d)", v5);
          v292 = playerr;
          goto LABEL_590;
        }
      }
      else
      {
        playerr->AttachedToPlayerId = v257;
        if ( v257 >= 0 )
        {
          v258 = ZonePlayerList[v257];
          if ( v258 )
          {
            if ( v258->Frequency != playerr->Frequency )
            {
              playerr->AttachedToPlayerId = -1;
              return;
            }
            if ( v258->AttachedToPlayerId >= 0 )
            {
              playerr->AttachedToPlayerId = -1;
              return;
            }
            playerr->XPixels = v258->XPixels;
            playerr->YPixels = v258->YPixels;
            sub_40D870(playerr);
          }
        }
        v259 = playerr->PlayerId;
        v260 = *(__int16 *)(packet + 1);
        *(_WORD *)((char *)&v295 + 3) = playerr->AttachedToPlayerId;// Turreter Destination Player ID
        v261 = playerr->AttachedToPlayerId;
        LOBYTE(v295) = 0xE;                     // 0x0E - Create Turret Link
        *(_WORD *)((char *)&v295 + 1) = v259;   // Turreter Requester Player ID
        if ( v260 == v261 )
        {
          v262 = playerr->MyArena;
          if ( v262 )
          {
            v263 = 0;
            if ( v262->ArenaPlayerCount > 0 )
            {
              v264 = 16072;
              do
              {
                v265 = v262->PlayerPointers[v264];
                if ( v265 != playerr && !v265->AlreadySentReliablePacket )
                  SendPlayerReliablePacket(v265, (char *)&v295, 5, 1);
                v262 = playerr->MyArena;
                ++v263;
                ++v264;
              }
              while ( v263 < v262->ArenaPlayerCount );
            }
          }
        }
        else
        {
          ArenaSendPacket(playerr->MyArena, &v295, 5, 1);
        }
      }
      return;
    case 19:                                    // 0x13 - Flag request
      if ( playerr->MyArena )
      {
        if ( playerr->Ship != 8 )
        {
          v198 = playerr->MyArena;
          v199 = (int)(GetTickCount() / 0xA - playerr->field_15B);
          if ( (signed int)((HIDWORD(v199) ^ v199) - HIDWORD(v199)) >= v198->ServersideArenaSettings.LatencyNoFlagPenalty )
          {
            v200 = *(_WORD *)(packet + 1);
            v201 = v198->someCounterBefore;
            v202 = v200;
            LODWORD(v295) = v200;
            if ( v200 <= v201 && v200 >= 0 )
            {
              if ( v198->ArenaSettings.CarryFlags != 2 )
                goto LABEL_688;
              v203 = 0;
              if ( v201 > 0 )
              {
                v204 = &v198->gap_186A2[4];
                do
                {
                  if ( *(_DWORD *)v204 == *(_DWORD *)&playerr->PlayerId )
                    ++v203;
                  v204 += 16;
                  --v201;
                }
                while ( v201 );
                v202 = v295;
              }
              if ( v203 <= 0 )
              {
LABEL_688:
                if ( *(_DWORD *)&v198->gap_186A2[16 * v202 + 4] == -1 )
                {
                  *(_WORD *)((char *)&v295 + 1) = *(_WORD *)(packet + 1);// Flag ID
                  v205 = playerr->PlayerId;
                  LOBYTE(v295) = 0x13;          // 0x13 - Flag Claim
                  *(_WORD *)((char *)&v295 + 3) = v205;// Player ID
                  ArenaSendPacket(v198, &v295, 5, 1);
                  *(_DWORD *)&playerr->MyArena->gap_186A2[16 * *(__int16 *)(packet + 1) + 8] = playerr->Frequency;
                  v206 = playerr->MyArena;
                  if ( v206->ArenaSettings.CarryFlags )
                    *(_DWORD *)&v206->gap_186A2[16 * *(__int16 *)(packet + 1) + 4] = *(_DWORD *)&playerr->PlayerId;
                }
              }
            }
          }
        }
      }
      return;
    case 20:                                    // 0x14 - Drop all attached pilots
      v211 = playerr->MyArena;
      if ( v211 )
      {
        v212 = playerr->PlayerId;
        LOBYTE(Password) = 0x15;                // 0x15 - Destroy Turret Link
        *(_WORD *)((char *)&Password + 1) = v212;// Turret Driver Player ID
        v213 = 0;
        if ( v211->ArenaPlayerCount > 0 )
        {
          v214 = 16072;
          do
          {
            v215 = v211->PlayerPointers[v214];
            if ( v215 != playerr && !v215->AlreadySentReliablePacket )
              SendPlayerReliablePacket(v215, (char *)&Password, 3, 1);
            v211 = playerr->MyArena;
            ++v213;
            ++v214;
          }
          while ( v213 < v211->ArenaPlayerCount );
        }
      }
      return;
    case 21:                                    // 0x15 - Drop flags
      v216 = playerr->MyArena;
      if ( v216 && v216->ArenaSettings.CarryFlags )
      {
        v217 = playerr->PlayerId;
        LOBYTE(Password) = 0x16;                //  0x16 - Drop Flag
        *(_WORD *)((char *)&Password + 1) = v217;// Carrier Player ID
        ArenaSendPacket(v216, &Password, 3, 1);
        v218 = playerr->MyArena;
        v219 = v218->ServersideArenaSettings.FlagMode;
        if ( v219 )
        {
          if ( v219 == 1 )
          {
            CarryFlagsSomething(v218, *(_DWORD *)&playerr->PlayerId, 1);
            FlagPositionUpdateSomething(playerr->MyArena, 0);
          }
        }
        else
        {
          CarryFlagsSomething(v218, *(_DWORD *)&playerr->PlayerId, 0);
        }
      }
      return;
    case 22:                                    // 0x16 - File transfer
      v242 = playerr->field_58;
      if ( v242 < 0 )
      {
        v245 = playerr->field_60;
        if ( v245 < 0 )
        {
          v251 = playerr->isSysop != 0;
          v252 = (char *)(packet + 1);
          playerra = (char *)(packet + 1);
          if ( !_strcmpi((const char *)packet + 1, "moderate.txt") )
            v251 = 1;
          if ( !_strcmpi((const char *)packet + 1, "permit.txt") )
            v251 = 1;
          if ( !_strcmpi((const char *)packet + 1, playerr->MyArena->szLevelFile2)
            && playerr->UserId == playerr->MyArena->ServersideArenaSettings.OwnerUserId )
          {
            v251 = 1;
          }
          if ( v251 )
          {
            if ( playerr->isSysop || packetSize <= 0x80000 )// 512 KB Max
            {
              v253 = fopen((const char *)packet + 1, "wb");
              v254 = v253;
              if ( v253 )
              {
                fwrite(packet + 17, packetSize - 17, 1u, v253);
                fclose(v254);
              }
              sprintf(a1, "File received: %s", v252);
              if ( playerr->MyArena )
              {
                *(_WORD *)a3 = 7;
                a3[2] = 0;
                *(_WORD *)&a3[3] = -1;
                strcpy(v316, a1);
                v255 = strlen(a1) + 1;
                if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                  SendPlayerReliablePacket(playerr, a3, v255 - 1 + 6, 1);
                v252 = playerra;
              }
              if ( !_strcmpi(v252, playerr->MyArena->szLevelFile2) )
              {
                if ( playerr->MyArena )
                {
                  *(_WORD *)a3 = 7;
                  a3[2] = 0;
                  *(_WORD *)&a3[3] = -1;
                  strcpy(v316, "Arena is recycling so the change can take effect.");
                  v256 = strlen("Arena is recycling so the change can take effect.") + 1;
                  if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                    SendPlayerReliablePacket(playerr, a3, v256 - 1 + 6, 1);
                }
                v252 = playerra;
                playerr->MyArena->field_10026 = 1;
              }
              if ( !_strcmpi(v252, MiscDefaultLevelFile) )
                RecycleServer = 1;
            }
            else if ( playerr->MyArena )
            {
              *(_WORD *)a3 = 7;                 // 0x07 - Chat
              a3[2] = 0;
              *(_WORD *)&a3[3] = -1;
              strcpy(v316, "File has arrived, but is too big (size limit of 512k)");
              v40 = strlen("File has arrived, but is too big (size limit of 512k)") + 6;
              if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                goto LABEL_553;
            }
          }
        }
        else
        {
          v246 = ZonePlayerList[v245];
          v296 = (int)v246;
          if ( v246 && v246->UserId == playerr->field_5C )
          {
            playerra = (char *)(packet + 1);
            sprintf(a1, "File arrived at server, forwarding to %s: %s", v246->Name, (const char *)packet + 1);
            if ( playerr->MyArena )
            {
              *(_WORD *)a3 = 7;
              a3[2] = 0;
              *(_WORD *)&a3[3] = -1;
              strcpy(v316, a1);
              v247 = strlen(a1) + 1;
              if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                SendPlayerReliablePacket(playerr, a3, v247 - 1 + 6, 1);
            }
            v248 = emalloc(packetSize);
            qmemcpy(v248 + 17, packet + 17, packetSize - 17);
            v249 = playerra;
            *v248 = 16;
            LODWORD(v295) = v248 + 1;
            strcpy(v248 + 1, v249);
            GetNewsRequest(*(_DWORD *)(v296 + 40), (int)v248, packetSize, 0);
            playerr->field_60 = -1;
            playerr->field_5C = -1;
          }
          else
          {
            sprintf(a1, "File arrived at server, could not forward: %s", (const char *)packet + 1);
            if ( playerr->MyArena )
            {
              *(_WORD *)a3 = 7;
              a3[2] = 0;
              *(_WORD *)&a3[3] = -1;
              strcpy(v316, a1);
              v250 = strlen(a1) + 1;
              if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                SendPlayerReliablePacket(playerr, a3, v250 - 1 + 6, 1);
            }
            playerr->field_60 = -1;
            playerr->field_5C = -1;
          }
        }
      }
      else
      {
        LODWORD(v295) = ZonePlayerList[v242];
        if ( (_DWORD)v295 && *(_DWORD *)(v295 + 631) )
        {
          sprintf(a1, "File arrived, forwarding: %s", (const char *)packet + 1);
          if ( *(_DWORD *)(v295 + 28) )
          {
            *(_WORD *)a3 = 7;
            a3[2] = 0;
            *(_WORD *)&a3[3] = -1;
            strcpy(v316, a1);
            v243 = strlen(a1) + 1;
            if ( GetRelAckDiff(*(ENCRYPTION **)(v295 + 40), 0) < 128 )
              SendPlayerReliablePacket((PLAYER *)v295, a3, v243 - 1 + 6, 1);
          }
          v244 = emalloc(packetSize);
          qmemcpy(v244 + 17, packet + 17, packetSize - 17);
          *v244 = 16;
          v296 = (int)(v244 + 1);
          strcpy(v244 + 1, "pulled.dat");
          GetNewsRequest(*(_DWORD *)(v295 + 40), (int)v244, packetSize, 0);
        }
        playerr->field_58 = -1;
      }
      return;
    case 23:                                    // 0x17 - Registration Form Response
      if ( packetSize == 766 && BillingConnectionStructPointer )
        SendBillerUserDemographicsPacket(BillingConnectionStructPointer, playerr->BillerPlayerId, (int)(packet + 1));
      return;
    case 24:                                    // 0x18 - Set ship type
      v207 = playerr->MyArena;
      if ( !v207 )
        return;
      v208 = v207->ServersideArenaSettings.MiscMaxLossesToPlay;
      if ( v208 > 0 && (unsigned __int16)playerr->CurrentLosses >= v208 )
        return;
      if ( playerr->IsSpeced )
        return;
      v209 = packet[1];
      if ( (char)v209 == playerr->Ship )
        return;
      if ( (_BYTE)v209 == 8 )
        goto LABEL_424;
      if ( !v207->ArenaLocked || playerr->isSuperModerator )
      {
        if ( playerr->DemoPlayer && ((_BYTE)v209 == 5 || (_BYTE)v209 == 6 || (_BYTE)v209 == 4 || (_BYTE)v209 == 7) )
        {
          *(_WORD *)a3 = 7;                     // 0x07 - Chat
          a3[2] = 0;
          *(_WORD *)&a3[3] = -1;
          strcpy(v316, "Demo version of SubSpace does not allow the use of that ship type.");
          v40 = strlen("Demo version of SubSpace does not allow the use of that ship type.") + 6;
          if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
            goto LABEL_553;
        }
        else
        {
          sub_41CB70(
            (int)playerr->encryptionPointer,
            (int)&playerr->S2CPacketLossPercentage,
            (int)&playerr->C2SPacketLossPercentage);
          v207 = playerr->MyArena;
          if ( playerr->S2CPacketLossPercentage >= v207->ServersideArenaSettings.PacketLossS2CKickOutPercent
            && playerr->C2SPacketLossPercentage >= v207->ServersideArenaSettings.PacketLossC2SKickOutPercent
            || playerr->isSysop )
          {
LABEL_424:
            playerr->DebtKills = v207->ServersideArenaSettings.KillDebtKills;
            v210 = packet[1];
            if ( v210 > 8 || v210 < 0 )
            {
              if ( !playerr->isSuperModerator )
              {
                sprintf(a1, "Packet tampering(%d)", (char)*packet);
                v292 = playerr;
LABEL_590:
                SendBillerWarnings(a1, v292);
                v266 = playerr->MyArena;
                if ( v266 )
                {
                  if ( v266->ServersideArenaSettings.dwordB4 )
                    goto LABEL_683;
                }
              }
            }
            else
            {
              SetPlayerShip(playerr, v210);
            }
          }
          else if ( v207 )
          {
            *(_WORD *)a3 = 7;                   // 0x07 - Chat
            a3[2] = 0;
            *(_WORD *)&a3[3] = -1;
            strcpy(v316, "Packet loss too high for you to enter the game.");
            v40 = strlen("Packet loss too high for you to enter the game.") + 6;
            if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
              goto LABEL_553;
          }
        }
      }
      return;
    case 25:                                    // 0x19 - Set personal banner
      qmemcpy(playerr->BannerData, packet + 1, sizeof(playerr->BannerData));
      if ( BillingConnectionStructPointer )
        SendBillerUserBannerPacket(BillingConnectionStructPointer, playerr->BillerPlayerId, packet + 1);
      LOWORD(Password) = 0x1E;                  // 0x1E - Personal Banner Changed
                                                // Boolean ?Unknown? (0x00)
      SendPlayerReliablePacket(playerr, (char *)&Password, 2, 1);
      v230 = playerr->MyArena;
      if ( v230
        && (playerr->FlagPoints + playerr->KillPoints >= v230->ServersideArenaSettings.MiscBannerPoints
         || playerr->dword30) )
      {
        v231 = playerr->PlayerId;
        v318 = 0x1F;                            // 0x1F - Player Banner Changed
        v319 = v231;                            // PlayerId
        qmemcpy(v320, playerr->BannerData, sizeof(v320));// Banner Pixels
        ArenaSendPacket(v230, &v318, 99, 1);
      }
      return;
    case 26:                                    // 0x1A - Security checksum
      if ( playerr->field_B4 )
      {
        v47 = GetTickCount();
        v51 = playerr->field_B4;
        playerr->field_B4 = 0;
        LODWORD(v295) = v47 / 0xA - v51;
        playerr->SecurityWeaponCountTotal = playerr->field_11F;
        playerr->SecurityWeaponCount = *(_DWORD *)(packet + 1);// Weapon Count
        qmemcpy(playerr->gap_12B, packet, 0x28u);
        LOBYTE(v47) = packet[39];               // Slow Frame Detected (Boolean)
        if ( (_BYTE)v47 )
          goto LABEL_76;
        v52 = playerr->MyArena;
        if ( v52 && !playerr->isSuperModerator && v52->field_FF38 )
        {
          v53 = *(_DWORD *)(packet + 9);        // Subspace.EXE Checksum
          v54 = playerr->SubspaceEXEChecksumIndex;
          if ( *(_DWORD *)&Security[0].ScrtyData[8 * v52->field_FF34 + 4 + v54 * 4036] != v53 )
          {
            v55 = 0;
            v56 = &Security[v54].ScrtyData[4];
            v57 = 500;
            do
            {
              if ( *(_DWORD *)v56 == v53 )
                v55 = 1;
              v56 += 8;
              --v57;
            }
            while ( v57 );
            if ( v55 )
              v291 = "WARNING: Code checksum mismatch - [%d] old match";
            else
              v291 = "WARNING: Code checksum mismatch - [%d] no possible match";
            sprintf(a1, v291, *(_DWORD *)(packet + 9));// Subspace.EXE Checksum
            SendBillerWarnings(a1, playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;    // 0x03 - Arena is Full
              playerr->AlreadySentReliablePacket = 1;
            }
          }
          if ( playerr->MyArena->field_FF38 != *(_DWORD *)(packet + 5) )// Settings Checksum
          {
            sprintf(a1, "WARNING: Parameter checksum mismatch: TimeSinceRequest:%d0 ms", (_DWORD)v295);
            SendBillerWarnings(a1, playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;    // 0x03 - Arena is Full
              playerr->AlreadySentReliablePacket = 1;
            }
          }
          v58 = *(_DWORD *)(packet + 13);       // Map.LVL Checksum
          if ( v58 != -12345678 && playerr->MyArena->MapLVLChecksum != v58 )
          {
            SendBillerWarnings("WARNING: Level checksum mismatch", playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;    // 0x03 - Arena is Full
              playerr->AlreadySentReliablePacket = 1;
            }
          }
          v59 = *(__int16 *)(packet + 25);
          v60 = *(__int16 *)(packet + 27) + v59;
          v61 = playerr->MyArena;
          if ( v60 > (__int16)v61->ArenaSettings.ClientSlowPacketSampleSize
            && playerr->Ship != 8
            && 1000 * v59 / v60 > v61->ServersideArenaSettings.LatencyClientSlowPacketKickoutPercent )
          {
            if ( v61 )
            {
              *(_WORD *)a3 = 7;                 // 0x07 - Chat
              a3[2] = 0;
              *(_WORD *)&a3[3] = -1;
              strcpy(v316, "You have been put in spectator mode due to high latency (S2C)");
              v62 = strlen("You have been put in spectator mode due to high latency (S2C)") + 1;
              if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
                SendPlayerReliablePacket(playerr, a3, v62 - 1 + 6, 1);
            }
            SetPlayerShip(playerr, 8);
          }
        }
      }
      return;
    case 27:                                    // 0x1B - Security violation
      GenerateWarning(playerr, (char)packet[1]);
      return;
    case 28:                                    // 0x1C - Drop Brick
      if ( playerr->Ship != 8 )
      {
        v44 = *(_WORD *)(packet + 1);
        if ( v44 < 0 || v44 >= 1024 || (v45 = *(_WORD *)(packet + 3), v45 < 0) || v45 >= 1024 )
        {
          if ( !playerr->isSuperModerator )
          {
            sprintf(a1, "Packet tampering(%d)", v5);
            SendBillerWarnings(a1, playerr);
            v46 = playerr->MyArena;
            if ( v46 )
            {
              if ( v46->ServersideArenaSettings.dwordB4 )
                goto LABEL_683;
            }
          }
        }
        else
        {
          DropBrick(playerr->MyArena, v44, v45, playerr->Frequency);
        }
      }
      return;
    case 29:                                    // 0x1D - Change Certain Arena Settings
      if ( !playerr->isSysop )
      {
        v38 = playerr->MyArena;
        v39 = v38->ServersideArenaSettings.OwnerUserId;
        if ( playerr->UserId != v39 || v39 < 0 )
        {
          if ( !v38 )
            return;
          *(_WORD *)a3 = 7;                     // 0x07 - Chat
          a3[2] = 0;
          *(_WORD *)&a3[3] = -1;
          strcpy(v316, "Only the owner of this arena can change the settings.");
          v40 = strlen("Only the owner of this arena can change the settings.") + 6;
          if ( GetRelAckDiff(playerr->encryptionPointer, 0) >= 128 )
            return;
LABEL_553:
          SendPlayerReliablePacket(playerr, a3, v40, 1);
          return;
        }
      }
      v41 = (const CHAR *)(packet + 1);
      if ( packet[1] )
      {
        do
        {
          if ( v41 - (const CHAR *)packet >= packetSize )
            break;
          ChangeSettings(playerr->MyArena, playerr, v41);
          v42 = strlen(v41) + 1;
          v43 = v41[v42];
          v41 += v42;
        }
        while ( v43 );
      }
      if ( playerr->MyArena )
      {
        *(_WORD *)a3 = 7;                       // 0x07 - Chat
        a3[2] = 0;
        *(_WORD *)&a3[3] = -1;
        strcpy(v316, "Settings have been successfully changed.");
        v40 = strlen("Settings have been successfully changed.") + 6;
        if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
          goto LABEL_553;
      }
      return;
    case 30:                                    // 0x1E - End Personal KoTH Timer
      v92 = playerr->KotHDeathCount;
      if ( v92 > 0 )
      {
        playerr->KotHDeathCount = v92 - 1;
        playerr->KingCrownKills = 0;
        if ( playerr->KotHDeathCount )
        {
          v95 = playerr->MyArena;
          LOBYTE(v295) = 0x2B;                  // 0x2B - Set Personal KotH Timer
          *(_DWORD *)((char *)&v295 + 1) = v95->ServersideArenaSettings.KingExpireTime;
          SendPlayerReliablePacket(playerr, (char *)&v295, 5, 1);
        }
        else
        {
          v93 = playerr->PlayerId;
          *(_DWORD *)((char *)&v295 + 2) = 0;   // Timer Value
          v94 = playerr->MyArena;
          LOWORD(v295) = 0x2C;                  // 0x2C - KotH Game Reset
          HIWORD(v295) = v93;                   // Player ID
          ArenaSendPacket(v94, &v295, 8, 1);
        }
      }
      return;
    case 31:                                    // 0x1F - Fire a Ball
      v6 = playerr->MyArena;
      if ( v6 )
      {
        v7 = packet + 1;
        v8 = (int)v6 + 12 * (char)packet[1] + 3 * (char)packet[1];
        if ( *(__int16 *)(v8 + 65403) == *(_DWORD *)&playerr->PlayerId && !*(_DWORD *)(v8 + 65405) )
        {
          v9 = v8 + 65394;
          *(_DWORD *)v9 = *(_DWORD *)v7;
          *(_DWORD *)(v9 + 4) = *(_DWORD *)(packet + 5);
          *(_DWORD *)(v9 + 8) = *(_DWORD *)(packet + 9);
          *(_WORD *)(v9 + 12) = *(_WORD *)(packet + 13);
          *(_BYTE *)(v9 + 14) = packet[15];
          playerr->MyArena->SoccerBallTimers[(char)*v7] = GetTickCount() / 0xA;
          v10 = playerr->MyArena;
          v11 = (char)*v7;
          v309 = 0x2E;                          // 0x2E  Power-Ball Position Update
          v310 = *(SOCCER_BALL *)((char *)v10->SoccerBalls + 12 * v11 + 3 * v11);
          ArenaSendPacket(v10, &v309, 16, 0);
        }
      }
      return;
    case 32:                                    // 0x20 - Ball request
      v32 = playerr->MyArena;
      if ( !v32 || playerr->Ship == 8 )
        return;
      v33 = v32->TotalSoccerBalls;              // It's a mess right now struct is wrong
      v34 = 0;
      if ( v33 <= 0 )
        goto LABEL_46;
      v35 = (SOCCER_BALL *)&v32->SoccerBalls[0].PlayerId;// Start address The first SoccerBall
      while ( *(_DWORD *)((char *)&v35->XPixels + 1) || *(__int16 *)&v35->PowerBallId != *(_DWORD *)&playerr->PlayerId )
      {
        ++v34;
        ++v35;
        if ( v34 >= v33 )
        {
LABEL_46:
          if ( *(int *)((char *)&v32->SoccerBalls[0].StartTimerDelay + 12 * (char)packet[1] + 3 * (char)packet[1]) == *(_DWORD *)(packet + 2) )
          {
            if ( v32->ArenaPlayerCount > v32->ServersideArenaSettings.SoccerCatchMinimum )
              playerr->MySoccerReward += v32->ServersideArenaSettings.SoccerCatchPoints;
            playerr->MyArena->SoccerBalls[(char)packet[1]].StartTimerDelay = 0;
            playerr->MyArena->SoccerBalls[(char)packet[1]].PlayerId = playerr->PlayerId;
            playerr->MyArena->SoccerBalls[(char)packet[1]].XPixels = playerr->XPixels;
            playerr->MyArena->SoccerBalls[(char)packet[1]].YPixels = playerr->YPixels;
            playerr->MyArena->SoccerBallTimers[(char)packet[1]] = GetTickCount() / 0xA;
            v36 = playerr->MyArena;
            v37 = (char)packet[1];
            v309 = 0x2E;                        // 0x2E - Power-Ball Position Update
            v310 = *(SOCCER_BALL *)((char *)v36->SoccerBalls + 12 * v37 + 3 * v37);
            ArenaSendPacket(v36, &v309, 16, 0);
          }
          return;
        }
      }
      return;
    case 33:                                    // 0x21 - Soccer goal scored
      v12 = playerr->MyArena;
      if ( v12 )
      {
        v13 = (int)v12 + 12 * (char)packet[1] + 3 * (char)packet[1];
        if ( *(__int16 *)(v13 + 65403) == *(_DWORD *)&playerr->PlayerId )
        {
          if ( *(_DWORD *)(v13 + 65405) )
          {
            v14 = v12->ArenaPlayerCount;
            v15 = 0;
            if ( v14 > 0 )
            {
              v16 = v12->playerPointersForSomething;
              do
              {
                if ( (*v16)->Ship != 8 )
                  ++v15;
                ++v16;
                --v14;
              }
              while ( v14 );
            }
            v17 = v12->ServersideArenaSettings.SoccerReward;
            if ( v17 >= 0 )
              v18 = v17 * v15 * v15 / 1000;
            else
              v18 = -v17;
            v296 = v18;
            if ( v18 )
            {
              sprintf(Dest, "Team Goal! by %s  Reward:%d", playerr->Name, v18);
              sprintf(a1, "Enemy Goal! by %s  Reward:%d", playerr->Name, v18);
            }
            else
            {
              sprintf(Dest, "Team Goal! by %s", playerr->Name);
              sprintf(a1, "Enemy Goal! by %s", playerr->Name);
            }
            v19 = playerr->MyArena;
            playerra = 0;
            if ( v19->ArenaPlayerCount > 0 )
            {
              v20 = 64288;
              a2 = 64288;
              while ( 1 )
              {
                v21 = *(PLAYER **)((char *)v19->PlayerPointers + v20);
                if ( v21->Frequency != playerr->Frequency || v21->Ship == 8 )
                {
                  if ( v21->MyArena )
                  {
                    *(_WORD *)a3 = 7;           // 0x07 - Chat
                    a3[2] = 104;
                    *(_WORD *)&a3[3] = -1;
                    strcpy(v316, a1);
                    v24 = strlen(a1) + 1;
                    if ( GetRelAckDiff(v21->encryptionPointer, 0) < 128 )
                      SendPlayerReliablePacket(v21, a3, v24 - 1 + 6, 1);
                  }
                }
                else
                {
                  v21->FlagPoints += v18;
                  ++(*(PLAYER **)((char *)playerr->MyArena->PlayerPointers + v20))->GoalCount;
                  v22 = *(PLAYER **)((char *)playerr->MyArena->PlayerPointers + v20);
                  if ( v22->MyArena )
                  {
                    buf[0] = 7;                 // 0x07 - Chat
                    buf[1] = 0;
                    buf[2] = 104;
                    v323 = -1;
                    strcpy(v324, Dest);
                    v23 = strlen(Dest) + 1;
                    if ( GetRelAckDiff(v22->encryptionPointer, 0) < 128 )
                      SendPlayerReliablePacket(v22, buf, v23 - 1 + 6, 1);
                  }
                }
                v19 = playerr->MyArena;
                v20 = a2 + 4;
                v25 = (int)++playerra < v19->ArenaPlayerCount;
                a2 += 4;
                if ( !v25 )
                  break;
                v18 = v296;
              }
              packett = packet;
              v18 = v296;
            }
            v26 = playerr->MyArena;
            if ( v26->ServersideArenaSettings.SoccerCapturePoints )
              SoccerGame2(v26, playerr->Frequency, *((__int16 *)packett + 1), *((__int16 *)packett + 2));
            if ( v18 )
            {
              v27 = playerr->Frequency;
              v28 = playerr->MyArena;
              LOBYTE(v295) = 0xB;               // 0x0B - Soccer Goal Made
              *(_WORD *)((char *)&v295 + 1) = v27;
              *(_DWORD *)((char *)&v295 + 3) = v18;
              ArenaSendPacket(v28, &v295, 7, 1);
            }
            v29 = playerr->MyArena;
            if ( v29->TotalSoccerBalls > 0 )
            {
              CreateSoccerBall(v29, (char)packett[1]);
              playerr->MyArena->SoccerBallTimers[(char)packett[1]] = GetTickCount() / 0xA;
              v30 = playerr->MyArena;
              v31 = (char)packett[1];
              v309 = 0x2E;                      // 0x2E - Power-Ball Position Update
              v310 = *(SOCCER_BALL *)((char *)v30->SoccerBalls + 12 * v31 + 3 * v31);
              ArenaSendPacket(v30, &v309, 16, 0);
            }
          }
        }
      }
      return;
    case 34:                                    // 0x22 - Security Violation Unknown
      if ( playerr->MyArena && !playerr->isSuperModerator )
      {
        v47 = packet[17];
        if ( (_BYTE)v47 )
        {
LABEL_76:
          GenerateWarning(playerr, (char)v47);
        }
        else
        {
          if ( *(_DWORD *)&Security[playerr->SubspaceEXEChecksumIndex].ScrtyData[4] != *(_DWORD *)(packet + 9) )
          {
            SendBillerWarnings("WARNING: Code checksum mismatch (unsolicited)", playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;    // 0x03 - Arena is Full
              playerr->AlreadySentReliablePacket = 1;
            }
          }
          v48 = 0;
          v49 = &playerr->MyArena->ArenaSettings;
          v50 = 357;
          do
          {
            v48 += v49->VersionAndManyBitFields;
            v49 = (ARENA_SETTINGS *)((char *)v49 + 4);
            --v50;
          }
          while ( v50 );
          if ( v48 != *(_DWORD *)(packet + 5) )
          {
            SendBillerWarnings("WARNING: Parameter checksum mismatch (unsolicited)", playerr);
            if ( playerr->MyArena->ServersideArenaSettings.dwordB4 )
            {
              playerr->DisconnectReason = 3;
              playerr->AlreadySentReliablePacket = 1;
            }
          }
        }
      }
      return;
    default:
      if ( !playerr->isSuperModerator )
      {
        sprintf(a1, "Packet tampering(%d)", v5);
        SendBillerWarnings(a1, playerr);
        v289 = playerr->MyArena;
        if ( v289 )
        {
          if ( v289->ServersideArenaSettings.dwordB4 )
          {
LABEL_683:
            playerr->DisconnectReason = 0x10;   // 0x10 - Restricted Zone, Compare against local Subspace.exe to determine if an Update is needed.
            playerr->AlreadySentReliablePacket = 1;
          }
        }
      }
      return;
  }
}
/* Orphan comments:
Weapon Info
0x0A - Password Packet Response
0x0A - Password Packet Response
0x05 - Permission Only Arena
Server Version 134 = SubSpace 1.34
Registration Form Request (Boolean)
*/
// 40AAF0: conditional instruction was optimized away because of 'esi.4!=0'
// 4314B0: using guessed type int AdvertiseSendMode;
// 432004: using guessed type int RecycleServer;
// 437CA0: using guessed type int CommsMaxQueueToLogin;
// 438138: using guessed type int MiscMaxSharewarePlayer;
// 4386D4: using guessed type int MachineIdArrayIndex;
// 438B1C: using guessed type int PermissionMode;
// 438B74: using guessed type int MiscMaxPlayers;
// 4AC448: using guessed type KICK KickedUsers[1000];
// 4AF32C: using guessed type int AutoPermissionPoints;
// 4D5900: using guessed type int PermissionAllowLowBandwidth;
// 4D590C: using guessed type int MiscJackpotBroadcastPoints;
// 4D5910: using guessed type int MiscRegisterKickShareware;
// 4D5914: using guessed type int NewsTxtFileChecksum;
// 4D5918: using guessed type int MiscDisableShareware;
// 4D89C8: using guessed type int Wave;
// 4D8B14: using guessed type int dword_4D8B14;
// 408E80: using guessed type char var_65F[507];

//----- (0040CB80) --------------------------------------------------------
// Player.GenerateWarning()
const char *__thiscall GenerateWarning(PLAYER *playerr, DWORD dwWarningId)
{
  const char *result; // eax
  int v4; // edx
  ARENA *v5; // ecx
  char a1[256]; // [esp+8h] [ebp-100h] BYREF

  result = (const char *)playerr->isSuperModerator;
  if ( !result )
  {
    v4 = 1;
    result = "Unknown integrity violation";
    switch ( dwWarningId )
    {
      case 0u:
        result = "Normal integrity";
        goto LABEL_33;
      case 1u:
        result = "Slow frame detected";
        goto LABEL_33;
      case 2u:
        result = "Current energy higher than top energy";
        goto LABEL_33;
      case 3u:
        result = "Top energy higher than max energy";
        goto LABEL_33;
      case 4u:
        result = "Max energy without getting prizes";
        goto LABEL_33;
      case 5u:
        result = "Recharge rate higher than max recharge rate";
        goto LABEL_33;
      case 6u:
        result = "Max recharge rate without getting prizes";
        goto LABEL_33;
      case 7u:
        result = "Too many burst used";
        goto LABEL_33;
      case 8u:
        result = "Too many repel used";
        goto LABEL_33;
      case 9u:
        result = "Too many decoy used";
        goto LABEL_33;
      case 0xAu:
        result = "Too many thor used";
        goto LABEL_33;
      case 0xBu:
        result = "Too many wall blocks used";
        goto LABEL_33;
      case 0xCu:
        result = "Stealth on but never collected";
        goto LABEL_33;
      case 0xDu:
        result = "Cloak on but never collected";
        goto LABEL_33;
      case 0xEu:
        result = "XRadar on but never collected";
        goto LABEL_33;
      case 0xFu:
        result = "AntiWarp on but never collected";
        goto LABEL_33;
      case 0x10u:
        result = "Proximity bombs but never collected";
        goto LABEL_33;
      case 0x11u:
        result = "Bouncing bullets but never collected";
        goto LABEL_33;
      case 0x12u:
        result = "Max guns without getting prizes";
        goto LABEL_33;
      case 0x13u:
        result = "Max bombs without getting prizes";
        goto LABEL_33;
      case 0x14u:
        result = "Shields or Super on longer than possible";
        goto LABEL_33;
      case 0x15u:
        v4 = 0;
        result = "Saved ship weapon limits too high (burst/repel/etc)";
        goto LABEL_33;
      case 0x16u:
        v4 = 0;
        result = "Saved ship weapon level too high (guns/bombs)";
        goto LABEL_33;
      case 0x17u:
        v4 = 0;
        result = "Login checksum mismatch (program exited)";
        goto LABEL_33;
      case 0x18u:
        v5 = playerr->MyArena;
        result = (const char *)(playerr->field_157 + 1);
        playerr->field_157 = (int)result;
        if ( (int)result < v5->ServersideArenaSettings.SecurityPacketModificationMax )
          return result;
        result = "S2C position packet modified";
LABEL_33:
        if ( !playerr->field_309 || !v4 )
        {
          sprintf(a1, "WARNING: %s", result);
          SendBillerWarnings(a1, playerr);
          result = (const char *)playerr->MyArena;
          if ( result )
          {
            if ( *(_DWORD *)(result + 109802) )
            {
              playerr->DisconnectReason = 3;
              playerr->AlreadySentReliablePacket = 1;
            }
          }
        }
        break;
      case 0x19u:
        v4 = 0;
        result = "Saved ship checksum mismatch";
        goto LABEL_33;
      case 0x1Au:
        result = "Softice Debugger Running";
        goto LABEL_33;
      case 0x1Bu:
        result = "Data checksum mismatch detected";
        goto LABEL_33;
      case 0x1Cu:
        result = "Parameter mismatch detected";
        goto LABEL_33;
      default:
        goto LABEL_33;
    }
  }
  return result;
}

//----- (0040CDB0) --------------------------------------------------------
void __thiscall UpdatePowerBallPositionsSomething(PLAYER *playerr)
{
  ARENA *arena; // ecx
  int XPixels; // eax
  int powerBallId; // ebx
  int v5; // edi
  ARENA *v6; // ecx
  int v7; // [esp+8h] [ebp-18h]
  int YPixels; // [esp+Ch] [ebp-14h]
  char buf; // [esp+10h] [ebp-10h] BYREF
  int v10; // [esp+11h] [ebp-Fh]
  int v11; // [esp+15h] [ebp-Bh]
  int v12; // [esp+19h] [ebp-7h]
  __int16 v13; // [esp+1Dh] [ebp-3h]
  char v14; // [esp+1Fh] [ebp-1h]

  arena = playerr->MyArena;
  if ( arena )
  {
    XPixels = playerr->XPixels;
    YPixels = playerr->YPixels;
    powerBallId = 0;
    v7 = XPixels;
    if ( arena->TotalSoccerBalls > 0 )
    {
      v5 = 0;
      while ( 1 )
      {
        if ( !arena->SoccerBalls[v5].StartTimerDelay && arena->SoccerBalls[v5].PlayerId == *(_DWORD *)&playerr->PlayerId )
        {
          if ( XPixels <= 0 || YPixels <= 0 )
          {
            CreateSoccerBall(arena, powerBallId);
          }
          else
          {
            arena->SoccerBalls[v5].PowerBallId = powerBallId;
            playerr->MyArena->SoccerBalls[v5].XPixels = XPixels;
            *(_DWORD *)&playerr->MyArena->SoccerBalls[v5].YPixels = (unsigned __int16)YPixels;
            playerr->MyArena->SoccerBalls[v5].ZeroTwo = 0;
            playerr->MyArena->SoccerBalls[v5].PlayerId = playerr->PlayerId;
            playerr->MyArena->SoccerBalls[v5].StartTimerDelay = GetTickCount() / 0xA;
            playerr->MyArena->SoccerBallTimers[powerBallId] = GetTickCount() / 0xA;
            v6 = playerr->MyArena;
            buf = 46;
            v10 = *(_DWORD *)&v6->SoccerBalls[v5].PowerBallId;
            v11 = *(_DWORD *)((char *)&v6->SoccerBalls[v5].YPixels + 1);
            v12 = *(_DWORD *)((char *)&v6->SoccerBalls[v5].ZeroTwo + 1);
            v13 = *(_WORD *)((char *)&v6->SoccerBalls[v5].StartTimerDelay + 1);
            v14 = HIBYTE(v6->SoccerBalls[v5].StartTimerDelay);
            ArenaSendPacket(v6, &buf, 16, 0);
          }
        }
        arena = playerr->MyArena;
        ++powerBallId;
        ++v5;
        if ( powerBallId >= arena->TotalSoccerBalls )
          break;
        XPixels = v7;
      }
    }
  }
}

//----- (0040CF10) --------------------------------------------------------
signed int __thiscall sub_40CF10(PLAYER *playerr)
{
  signed int result; // eax
  DWORD (__stdcall *v3)(); // ebx
  __int64 v4; // rax
  __int64 v5; // rax
  DWORD v6; // eax
  unsigned int v7; // kr08_4
  FILE *v8; // ebx
  unsigned int v9; // kr10_4
  signed int v10; // esi
  __int64 v11; // rax
  ARENA *v12; // esi
  unsigned int v13; // kr28_4
  int *v14; // ebx
  int *v15; // esi
  int v16; // edi
  ARENA *v17; // eax
  unsigned int v18; // kr30_4
  int v19; // eax
  int v20; // esi
  int v21; // eax
  int v22; // ecx
  int v23; // edi
  ARENA *v24; // eax
  int v25; // esi
  int v26; // [esp-8h] [ebp-524h]
  const char *v27; // [esp-8h] [ebp-524h]
  char *v28; // [esp-4h] [ebp-520h]
  char v29; // [esp+13h] [ebp-509h] BYREF
  int i; // [esp+14h] [ebp-508h]
  DWORD ExitCode; // [esp+18h] [ebp-504h] BYREF
  char buf; // [esp+1Ch] [ebp-500h] BYREF
  char v33; // [esp+1Dh] [ebp-4FFh]
  char v34; // [esp+1Eh] [ebp-4FEh]
  __int16 v35; // [esp+1Fh] [ebp-4FDh]
  char v36[507]; // [esp+21h] [ebp-4FBh] BYREF
  char Dest[256]; // [esp+21Ch] [ebp-300h] BYREF
  char Buf[3]; // [esp+31Ch] [ebp-200h] BYREF
  __int16 v39; // [esp+31Fh] [ebp-1FDh]
  char v40[507]; // [esp+321h] [ebp-1FBh] BYREF

  if ( playerr->field_287 > 0 )
    HighestPlayerCountMaybeSomething = 1;
  if ( playerr->AlreadySentReliablePacket )
    return 1;
  v3 = GetTickCount;
  if ( playerr->KickOffDelayTimer )
  {
    v4 = (int)(GetTickCount() / 0xA - playerr->KickOffDelayTimer);
    if ( (int)((HIDWORD(v4) ^ v4) - HIDWORD(v4)) > 1000 )
    {
      printf("KickOffTime expired: %s\n", playerr->PlayerName);
      return 1;
    }
  }
  if ( !playerr->PlayerName[0] )
  {
    v5 = (int)(GetTickCount() / 0xA - playerr->NoPasswordPacketDelayTimer);
    if ( (int)((HIDWORD(v5) ^ v5) - HIDWORD(v5)) > 300 )
    {
      printf("No password packet delay exceeded\n");
      playerr->DisconnectReason = 17;
      return 1;
    }
  }
  if ( !playerr->MyArena )
  {
    if ( (int)abs32(GetTickCount() / 0xA - playerr->encryptionPointer->MenuKickOutDelayTimer) > MiscMenuKickOutDelay )
    {
      v28 = playerr->PlayerName;
      v27 = "Menu kickout delay exceeded: %s\n";
      goto LABEL_74;
    }
LABEL_72:
    if ( CheckIfBillingServerIsConnected((int)playerr->encryptionPointer) != 4 )
      return 0;
    v28 = playerr->PlayerName;
    v27 = "Connection status read as terminated: %s\n";
LABEL_74:
    printf(v27, v28);
    result = 1;
    playerr->DisconnectReason = 1;
    return result;
  }
  if ( playerr->unknownIthoughtItWasPlayerPointerDupe
    && GetExitCodeProcess((HANDLE)playerr->unknownIthoughtItWasPlayerPointerDupe, &ExitCode)
    && ExitCode != 259 )
  {
    TerminateProcess((HANDLE)playerr->unknownIthoughtItWasPlayerPointerDupe, 0);
    CloseHandle((HANDLE)playerr->unknownIthoughtItWasPlayerPointerDupe);
    v6 = ExitCode;
    playerr->unknownIthoughtItWasPlayerPointerDupe = 0;
    playerr->dword4 = 0;
    playerr->dword8 = 0;
    playerr->dwordC = 0;
    sprintf(Dest, "SPAWN TERMINATED: %d", v6);
    if ( playerr->MyArena )
    {
      Buf[0] = 7;
      Buf[1] = 0;
      Buf[2] = 0;
      v39 = -1;
      strcpy(v40, Dest);
      v7 = strlen(Dest) + 1;
      if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
        SendPlayerReliablePacket(playerr, Buf, v7 - 1 + 6, 1);
    }
    v8 = fopen("spawn.log", "rt");
    if ( v8 )
    {
      for ( i = 0; i < 40; ++i )
      {
        Buf[0] = 0;
        fgets(Buf, 256, v8);
        if ( playerr->MyArena )
        {
          buf = 7;                              // 0x07 - Chat
          v33 = 0;
          v34 = 0;
          v35 = -1;
          strcpy(v36, Buf);
          v9 = strlen(Buf) + 1;
          if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
            SendPlayerReliablePacket(playerr, &buf, v9 - 1 + 6, 1);
        }
        if ( (v8->_flag & 0x10) != 0 )
          break;
      }
      fclose(v8);
    }
    v3 = GetTickCount;
  }
  v10 = abs32(v3() / 0xA - playerr->encryptionPointer->MenuKickOutDelayTimer);
  if ( v10 > playerr->MyArena->ServersideArenaSettings.LatencyNoFlagDelay )
    playerr->field_15B = v3() / 0xA;
  if ( v10 <= playerr->MyArena->ServersideArenaSettings.LatencyKickOutDelay
    || playerr->isSysop && (int)abs32(v3() / 0xA - playerr->encryptionPointer->MenuKickOutDelayTimer) <= 6000 )
  {
    if ( playerr->DemoPlayer )
    {
      v11 = (int)(v3() / 0xA - playerr->NoPasswordPacketDelayTimer);
      if ( (int)((HIDWORD(v11) ^ v11) - HIDWORD(v11)) > MiscMaxSharkwareTime )
      {
        WriteSubGameLog("Shareware Timer Expired: %s\n", playerr->PlayerName);
        v35 = playerr->PlayerId;
        playerr->DisconnectReason = 22;
        buf = 7;
        v33 = 0;
        v34 = 0;
        strcpy(
          v36,
          "DISCONNECTED: Your time for this session has expired. There is no time limit when you play the full version.");
        v26 = strlen(
                "DISCONNECTED: Your time for this session has expired. There is no time limit when you play the full version.")
            + 6;
        goto LABEL_82;
      }
    }
    if ( (int)abs32(v3() / 0xA - playerr->encryptionPointer->KeepAliveDelayTimer) > MiscKeepAliveDelay )
    {
      v29 = 39;
      SendPlayerReliablePacket(playerr, &v29, 1, 0);
    }
    if ( playerr->Ship != 8 )
    {
      if ( playerr->LatencyKickOutDelayTimer )
      {
        v12 = playerr->MyArena;
        if ( (signed int)(v3() / 0xA - playerr->LatencyKickOutDelayTimer) > v12->ServersideArenaSettings.LatencyKickOutTime
          && !playerr->isSysop )
        {
          if ( v12 )
          {
            buf = 7;                            // 0x07 - Chat
            v33 = 0;
            v34 = 0;
            v35 = -1;
            strcpy(v36, "You have been put in spectator mode due to high latency (spike)");
            v13 = strlen("You have been put in spectator mode due to high latency (spike)") + 1;
            if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
              SendPlayerReliablePacket(playerr, &buf, v13 - 1 + 6, 1);
          }
          SetPlayerShip(playerr, 8);
        }
      }
    }
    v14 = &playerr->C2SPacketLossPercentage;
    v15 = &playerr->S2CPacketLossPercentage;
    sub_41CB70(
      (int)playerr->encryptionPointer,
      (int)&playerr->S2CPacketLossPercentage,
      (int)&playerr->C2SPacketLossPercentage);
    v16 = 0;
    if ( playerr->Ship == 8 )
      v16 = playerr->MyArena->ServersideArenaSettings.PacketLossSpectatorPercentAdjust;
    v17 = playerr->MyArena;
    if ( (*v15 < v17->ServersideArenaSettings.PacketLossS2CKickOutPercent - v16
       || *v14 < v17->ServersideArenaSettings.PacketLossC2SKickOutPercent - v16
       || *v14 > v17->ServersideArenaSettings.PacketLossC2SNegativeKickOutPercent + v16 + 1000)
      && !playerr->isSysop )
    {
      if ( playerr->Ship == 8 )
      {
        WriteSubGameLog(
          "Packet loss too high S2C:%d%%, C2S:%d%%, kicking out player: %s\n",
          (1000 - *v15) / 10,
          (1000 - *v14) / 10,
          playerr->PlayerName);
        v24 = playerr->MyArena;
        v25 = *v15;
        if ( v25 >= v24->ServersideArenaSettings.PacketLossS2CKickOutPercent - v16 )
        {
          if ( *v14 <= v24->ServersideArenaSettings.PacketLossC2SNegativeKickOutPercent + v16 + 1000 )
            playerr->DisconnectReason = 7;
          else
            playerr->DisconnectReason = 23;
        }
        else
        {
          playerr->DisconnectReason = 6;
        }
        sprintf(
          Dest,
          "WARNING: Disconnected because of high packet loss (ServerToYou:%d%%, YouToServer:%d%%)",
          (1000 - v25) / 10,
          (1000 - *v14) / 10);
        v35 = playerr->PlayerId;
        buf = 7;                                // 0x07 - Chat
        v33 = 0;
        v34 = 0;
        strcpy(v36, Dest);
        v26 = strlen(Dest) + 6;
        goto LABEL_82;
      }
      if ( v17 )
      {
        buf = 7;                                // 0x07 - Chat
        v33 = 0;
        v34 = 0;
        v35 = -1;
        strcpy(v36, "You have been put in spectator mode due to high packet loss");
        v18 = strlen("You have been put in spectator mode due to high packet loss") + 1;
        if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
          SendPlayerReliablePacket(playerr, &buf, v18 - 1 + 6, 1);
      }
      SetPlayerShip(playerr, 8);
    }
    v19 = *v14;
    if ( *v14 >= 1000 )
      v19 = 1000;
    v20 = playerr->S2CPacketLossPercentage;
    v21 = v19 - v20;
    playerr->field_153 = v21;
    if ( v20 > 900 || playerr->isSysop || v21 < 0 )
      playerr->field_153 = 0;
    if ( v20 < 1000 )
    {
      v22 = playerr->SecurityWeaponCountTotal;
      if ( v22 > 400 && playerr->Ship != 8 )
      {
        v23 = 1000 * playerr->SecurityWeaponCount / v22;
        if ( v20 - v23 > 100
          && v23 < playerr->MyArena->ServersideArenaSettings.SecurityS2CKickOutPercentWeapons
          && !playerr->isSysop )
        {
          sprintf(Dest, "S2C weapon packet loss too high(S2CW=%d%%)(S2C=%d%%)", (1000 - v23) / 10, (1000 - v20) / 10);
          SendBillerWarnings(Dest, playerr);
          playerr->DisconnectReason = 3;
          return 1;
        }
      }
    }
    goto LABEL_72;
  }
  WriteSubGameLog("Kickout delay exceeded: %s\n", playerr->PlayerName);
  playerr->DisconnectReason = 9;
  v35 = playerr->PlayerId;
  buf = 7;                                      // 0x07 - Chat
  v33 = 0;
  v34 = 0;
  strcpy(v36, "WARNING: You have been disconnected because server has not been receiving data from you.");
  v26 = strlen("WARNING: You have been disconnected because server has not been receiving data from you.") + 6;
LABEL_82:
  SendPlayerReliablePacket(playerr, &buf, v26, 0);
  sub_41CB20((int)playerr->encryptionPointer);
  return 1;
}
/* Orphan comments:
(1000 - v38) / 10)
(1000 - v40) / 10)
*/
// 4AF328: using guessed type int MiscKeepAliveDelay;
// 4D55D4: using guessed type int MiscMaxSharkwareTime;
// 4D55D8: using guessed type int MiscMenuKickOutDelay;
// 4D8AF8: using guessed type int HighestPlayerCountMaybeSomething;
// 40CF10: using guessed type char var_4FB[507];

//----- (0040D870) --------------------------------------------------------
PLAYER *__thiscall sub_40D870(PLAYER *playerr)
{
  ARENA *arena; // ecx
  int v3; // eax
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // edi
  PLAYER *result; // eax
  int v9; // ebx
  __int64 v10; // rax
  int v11; // edi
  int v12; // edi
  int v13; // ebx
  ARENA *v14; // ecx

  arena = playerr->MyArena;
  v3 = playerr->XPixels - *(_DWORD *)&arena->dwLastConfigReadTime[8];
  playerr->LooksLikeX1BigOfSomething = v3;
  if ( v3 < 0 )
    playerr->LooksLikeX1BigOfSomething = 0;
  v4 = 2 * (0x2000 - *(_DWORD *)&arena->dwLastConfigReadTime[8]);
  if ( playerr->LooksLikeX1BigOfSomething > v4 )
    playerr->LooksLikeX1BigOfSomething = v4;
  v5 = playerr->YPixels - *(_DWORD *)&arena->dwLastConfigReadTime[8];
  playerr->LooksLikeYBigOfSomething = v5;
  if ( v5 < 0 )
    playerr->LooksLikeYBigOfSomething = 0;
  v6 = 2 * (0x2000 - *(_DWORD *)&arena->dwLastConfigReadTime[8]);
  if ( playerr->LooksLikeYBigOfSomething > v6 )
    playerr->LooksLikeYBigOfSomething = v6;
  v7 = playerr->LooksLikeYBigOfSomething;
  playerr->LooksLikeXSmallOfSomething = playerr->LooksLikeX1BigOfSomething
                                      + 2 * *(_DWORD *)&arena->dwLastConfigReadTime[8];
  result = *(PLAYER **)&arena->dwLastConfigReadTime[8];
  v9 = v7 + 2 * (_DWORD)result;
  playerr->LooksLikeYSmallOfSomething = v9;
  if ( arena )
  {
    v10 = playerr->LooksLikeX1BigOfSomething + playerr->LooksLikeXSmallOfSomething;
    v11 = (WORD2(v10) & 0xFFF) + v10;
    result = (PLAYER *)playerr->field_50;
    v12 = v11 >> 12;
    v13 = (v9 + playerr->LooksLikeYBigOfSomething) / 4096;
    if ( (PLAYER *)v12 != result || v13 != playerr->field_54 )
    {
      sub_404980(arena, (int)playerr, *(_QWORD *)&playerr->field_50);
      v14 = playerr->MyArena;
      playerr->field_50 = v12;
      playerr->field_54 = v13;
      result = AddPlayerToArenaSomething(v14, playerr, v12, v13);
    }
  }
  return result;
}

//----- (0040D980) --------------------------------------------------------
void __thiscall PlayerChangeFrequency(PLAYER *playerr, signed int NewFrequencyy)
{
  int NewFrequency; // edi
  ARENA *arena; // esi
  PLAYER **v5; // ecx
  int v6; // edx
  int v7; // eax
  int v8; // ecx
  signed int v9; // eax
  unsigned int v10; // kr08_4
  int v11; // ecx
  int v12; // edx
  PLAYER **v13; // eax
  int v14; // ecx
  __int16 v15; // ax
  ARENA *v16; // ecx
  __int16 v17; // dx
  char buf; // [esp+10h] [ebp-20Ch] BYREF
  __int16 v19; // [esp+11h] [ebp-20Bh]
  __int16 v20; // [esp+13h] [ebp-209h]
  char v21; // [esp+15h] [ebp-207h]
  char v22; // [esp+18h] [ebp-204h] BYREF
  __int16 v23; // [esp+19h] [ebp-203h]
  _DWORD NumPlayersPerFreqArray[128]; // [esp+1Ch] [ebp-200h] BYREF

  NewFrequency = NewFrequencyy;
  arena = playerr->MyArena;
  if ( NewFrequencyy >= arena->ArenaSettings.MaxFrequency )
    return;
  if ( (int)arena->ServersideArenaSettings.TeamForceEvenTeams > 0 && !playerr->isSuperModerator )
  {
    memset(NumPlayersPerFreqArray, 0, 0x100u);
    if ( arena->ArenaPlayerCount > 0 )
    {
      v5 = arena->playerPointersForSomething;
      v6 = arena->ArenaPlayerCount;
      do
      {
        v7 = (*v5)->Frequency;
        if ( v7 < 64 )
          ++NumPlayersPerFreqArray[v7];
        ++v5;
        --v6;
      }
      while ( v6 );
    }
    v8 = playerr->Frequency;
    v9 = arena->ServersideArenaSettings.TeamDesiredTeams;
    if ( v8 < v9
      && NewFrequencyy < v9
      && v9 < 64
      && NumPlayersPerFreqArray[v8] + arena->ServersideArenaSettings.TeamForceEvenTeams - 1 <= NumPlayersPerFreqArray[NewFrequencyy] )
    {
      if ( arena )
      {
        strcpy((char *)NumPlayersPerFreqArray, "\a");// 0x07 - Chat
        BYTE2(NumPlayersPerFreqArray[0]) = 0;
        *(_WORD *)((char *)NumPlayersPerFreqArray + 3) = -1;
        strcpy((char *)&NumPlayersPerFreqArray[1] + 1, "Changing frequencies would make the teams too uneven.");
        v10 = strlen("Changing frequencies would make the teams too uneven.") + 1;
        if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
          SendPlayerReliablePacket(playerr, (char *)NumPlayersPerFreqArray, v10 - 1 + 6, 1);
      }
      return;
    }
    NewFrequency = NewFrequencyy;
  }
  playerr->DebtKills = arena->ServersideArenaSettings.KillDebtKills;
  v11 = arena->ArenaPlayerCount;
  v12 = 0;
  if ( v11 > 0 )
  {
    v13 = arena->playerPointersForSomething;
    do
    {
      if ( (*v13)->Frequency == NewFrequency )
        ++v12;
      ++v13;
      --v11;
    }
    while ( v11 );
  }
  v14 = (unsigned __int8)arena->ArenaSettings.MaxPerTeam;
  if ( arena->ArenaSettings.MaxPerPrivateTeam )
    v14 = (unsigned __int8)arena->ArenaSettings.MaxPerPrivateTeam;
  if ( v12 < v14 || playerr->isSysop )
  {
    v15 = playerr->PlayerId;
    playerr->Frequency = NewFrequency;
    buf = 0xD;                                  // 0x0D - Player Changed Frequency
    v19 = v15;                                  // Player ID
    v20 = NewFrequency;                         // Frequency
    v21 = -1;                                   // Ship
    if ( arena->ServersideArenaSettings.MiscFrequencyShipTypes && playerr->Ship != 8 )
    {
      playerr->Ship = NewFrequency % 8;
      v21 = playerr->Ship;                      // Ship
    }
    ArenaSendPacket(arena, &buf, 6, 1);
    CarryFlagsSomething(playerr->MyArena, *(_DWORD *)&playerr->PlayerId, 0);
    UpdatePowerBallPositionsSomething(playerr);
    v16 = playerr->MyArena;
    if ( v16->ServersideArenaSettings.MiscResetScoreOnFrequencyChange )
    {
      v17 = playerr->PlayerId;
      playerr->CurrentLosses = 0;
      playerr->CurrentWins = 0;
      playerr->KillPoints = 0;
      playerr->FlagPoints = 0;
      playerr->GoalCount = 0;
      playerr->field_30D = 1;
      v22 = 0x1A;                               // Player ID
      v23 = v17;
      if ( v16 )
        ArenaSendPacket(v16, &v22, 3, 1);
    }
  }
}

//----- (0040DC00) --------------------------------------------------------
void __thiscall SetPlayerShip(PLAYER *playerr, signed int Ship)
{
  __int16 v3; // ax
  ARENA *v4; // ecx
  __int16 v5; // ax
  __int16 v6; // dx
  ARENA *v7; // ecx
  __int16 v8; // si
  ARENA *v9; // esi
  unsigned int v10; // kr08_4
  __int16 v11; // ax
  ARENA *v12; // ecx
  int v13; // esi
  char v14; // [esp+10h] [ebp-210h] BYREF
  char v15; // [esp+11h] [ebp-20Fh]
  __int16 v16; // [esp+12h] [ebp-20Eh]
  __int16 v17; // [esp+14h] [ebp-20Ch]
  char v18; // [esp+18h] [ebp-208h] BYREF
  __int16 v19; // [esp+19h] [ebp-207h]
  __int16 v20; // [esp+1Bh] [ebp-205h]
  char buf; // [esp+20h] [ebp-200h] BYREF
  char v22; // [esp+21h] [ebp-1FFh]
  char v23; // [esp+22h] [ebp-1FEh]
  __int16 v24; // [esp+23h] [ebp-1FDh]
  char v25[507]; // [esp+25h] [ebp-1FBh] BYREF

  if ( playerr->AttachedToPlayerId >= 0 )
  {
    v3 = playerr->PlayerId;
    v4 = playerr->MyArena;
    v18 = 0xE;                                  // 0x0E - Create Turret Link
    v20 = -1;
    v19 = v3;
    playerr->AttachedToPlayerId = -1;
    ArenaSendPacket(v4, &v18, 5, 1);
  }
  LOBYTE(v5) = Ship;
  v6 = playerr->PlayerId;
  v14 = 0x1D;                                   // 0x1D - Player Team and Ship Changed
  v16 = v6;
  v15 = Ship;
  if ( (_BYTE)Ship == 8 )                       // Spec Ship
  {
    v7 = playerr->MyArena;
    v8 = v7->ServersideArenaSettings.TeamSpectatorFrequency;
    v17 = v8;
LABEL_18:
    playerr->Ship = (char)v5;
    playerr->AttachedToPlayerId = -1;
    playerr->ArenaPlayerIndex = -1;
    playerr->Frequency = v8;
    ArenaSendPacket(v7, &v14, 6, 1);
    CarryFlagsSomething(playerr->MyArena, *(_DWORD *)&playerr->PlayerId, 0);
    UpdatePowerBallPositionsSomething(playerr);
    v12 = playerr->MyArena;
    v13 = playerr->TotalShipChanges + 1;
    playerr->TotalShipChanges = v13;
    if ( v13 > v12->ServersideArenaSettings.SecurityMaxShipTypeSwitchCount )
    {
      WriteSubGameLog("Played kicked off for too many ship type changes: %s\n", playerr->PlayerName);
      v24 = playerr->PlayerId;
      playerr->DisconnectReason = 15;
      playerr->AlreadySentReliablePacket = 1;
      buf = 7;                                  // 0x07 - Chat
      v22 = 0;
      v23 = 0;
      strcpy(v25, "WARNING: You have been disconnected for too many ship type changes.");
      SendPlayerReliablePacket(
        playerr,
        &buf,
        strlen("WARNING: You have been disconnected for too many ship type changes.") + 6,
        0);
      sub_41CB20((int)playerr->encryptionPointer);
    }
    return;
  }
  if ( playerr->Ship != 8 )                     // Any Ship other then Spec
  {
    v7 = playerr->MyArena;
    if ( v7->ServersideArenaSettings.MiscFrequencyShipTypes )
    {
      PlayerChangeFrequency(playerr, Ship);
      return;
    }
    v8 = playerr->Frequency;
    v17 = v8;
    goto LABEL_18;
  }
  if ( playerr->isModerator
    || (int)playerr->MyArena->ServersideArenaSettings.MiscMaxPlaying <= 0
    || (v9 = playerr->MyArena, GetTotalPlayingPlayers(v9) <= v9->ServersideArenaSettings.MiscMaxPlaying) )
  {
    v11 = GetNextFrequencyToJoin(playerr->MyArena);
    v7 = playerr->MyArena;
    v8 = v11;                                   // 0x07 - Chat
    v17 = v11;
    if ( v7->ServersideArenaSettings.MiscFrequencyShipTypes )
    {
      v5 = v11 % 8;
      v15 = v5;
    }
    else
    {
      LOBYTE(v5) = v15;
    }
    goto LABEL_18;
  }
  if ( v9 )
  {
    v24 = -1;
    buf = 7;
    v22 = 0;
    v23 = 0;
    strcpy(v25, "There are too many people playing the game right now, try again later.");
    v10 = strlen("There are too many people playing the game right now, try again later.") + 1;
    if ( GetRelAckDiff(playerr->encryptionPointer, 0) < 128 )
      SendPlayerReliablePacket(playerr, &buf, v10 - 1 + 6, 1);
  }
}

//----- (0040DEA0) --------------------------------------------------------
ARENA *__thiscall sub_40DEA0(PLAYER *playerr, char *buf, int len, int a4)
{
  ARENA *result; // eax

  result = (ARENA *)playerr->field_309;
  if ( !result )
  {
    result = playerr->MyArena;
    if ( result )
    {
      if ( a4 == 21 && (buf[19] & 0x1F) != 0 )
      {
        ++playerr->field_11F;
        if ( playerr->S2CPacketLossPercentage < result->ServersideArenaSettings.RoutingDoubleSendPercent )
        {
          SendPlayerReliablePacket(playerr, buf, len, 0);
          ++playerr->field_11F;
          ++dword_4C8F38;
          sub_41CB20((int)playerr->encryptionPointer);
        }
      }
      result = SendPlayerReliablePacket(playerr, buf, len, 0);
    }
  }
  return result;
}
// 4C8F38: using guessed type int dword_4C8F38;

//----- (0040DF30) --------------------------------------------------------
ARENA *__thiscall SendPlayerReliablePacket(PLAYER *playerr, char *buf, int len, int a4)
{
  ARENA *result; // eax
  int v6; // eax

  if ( a4
    || (result = (ARENA *)playerr->field_309) == 0
    && ((result = playerr->MyArena) == 0
     || playerr->encryptionPointer->field_A82 <= result->ServersideArenaSettings.LatencyCutbackWatermark
     || *buf == 5) )
  {
    if ( !WriteData(playerr->encryptionPointer, buf, len, a4) && a4 )
    {
      WriteSubGameLog(
        "Reliable packet lost(%d) to: %s (pending=%d current=%d diff=%d)\n",
        (unsigned __int8)*buf,
        playerr->Name,
        playerr->encryptionPointer->field_262,
        playerr->encryptionPointer->field_25E,
        playerr->encryptionPointer->field_25E - playerr->encryptionPointer->field_262);
      v6 = playerr->isSysop;
      playerr->DisconnectReason = 8;
      playerr->AlreadySentReliablePacket = 1;
      if ( v6 )
        LogReliablePackets((char *)playerr->encryptionPointer, "reliable.txt");
    }
    ++SomeArrayOf256_1[*buf];
    result = (ARENA *)*buf;
    SomeArrayOf256_2[(_DWORD)result] += len;
  }
  return result;
}

//----- (0040E000) --------------------------------------------------------
void __thiscall SendToSpectators(PLAYER *player, char *buf, int len, int a4, int a5, int a6)
{
  if ( (!a5 || !player->AllowAudioByte2) && (!a6 || player->Ship == 8) )
    SendPlayerReliablePacket(player, buf, len, a4);
}

//----- (0040E040) --------------------------------------------------------
void __thiscall SendEverybodyButYourself(PLAYER *playerr, const void *buf, unsigned int len, int a4)
{
  ARENA *arena; // eax
  int v6; // ebx
  int v7; // edi
  PLAYER *v8; // eax

  arena = playerr->MyArena;
  if ( arena )
  {
    v6 = 0;
    if ( arena->ArenaPlayerCount > 0 )
    {
      v7 = 16072;
      do
      {
        v8 = arena->PlayerPointers[v7];
        if ( v8 != playerr && !v8->AlreadySentReliablePacket )
          SendPlayerReliablePacket(v8, (char *)buf, len, a4);
        arena = playerr->MyArena;
        ++v6;
        ++v7;
      }
      while ( v6 < arena->ArenaPlayerCount );
    }
  }
}

//----- (0040E0A0) --------------------------------------------------------
ARENA *__thiscall SendReliablePacketToMyFrequency(PLAYER *playerr, char *buf, int len, int a4)
{
  ARENA *result; // eax
  int v6; // ebx
  int v7; // edi
  PLAYER *v8; // eax

  result = playerr->MyArena;
  if ( result )
  {
    v6 = 0;
    if ( result->ArenaPlayerCount > 0 )
    {
      v7 = 16072;
      do
      {
        v8 = result->PlayerPointers[v7];
        if ( v8 != playerr && v8->Frequency == playerr->Frequency )
          SendPlayerReliablePacket(v8, buf, len, a4);
        result = playerr->MyArena;
        ++v6;
        ++v7;
      }
      while ( v6 < result->ArenaPlayerCount );
    }
  }
  return result;
}

//----- (0040E110) --------------------------------------------------------
ARENA *__thiscall SomethingWithAttachedPlayer(PLAYER *playerr, char *buf, int len, int a4, int a5, int a6)
{
  ARENA *result; // eax
  int v8; // ebp
  PLAYER *v9; // ecx
  PLAYER *v10; // esi
  int v11; // edx
  int v12; // edx
  signed int v13; // edi
  __int64 v14; // rax
  __int64 v15; // rax
  int v16; // [esp+0h] [ebp-4h]

  result = playerr->MyArena;
  if ( result )
  {
    v16 = 0;
    if ( result->ArenaPlayerCount > 0 )
    {
      v8 = 16072;
      do
      {
        v9 = result->PlayerPointers[v8];
        v10 = v9;
        if ( v9 != playerr )
        {
          v11 = v9->ArenaPlayerIndex;
          if ( v11 >= 0 )
            v10 = ZonePlayerList[v11];
          if ( v10 )
          {
            v12 = v10->AttachedToPlayerId;
            if ( v12 >= 0 )
              v10 = ZonePlayerList[v12];
            if ( v10 )
            {
              if ( v9->isSysop
                || (v13 = result->ServersideArenaSettings.MessageDistance,
                    v14 = v10->YPixels - playerr->YPixels,
                    (int)((HIDWORD(v14) ^ v14) - HIDWORD(v14)) <= v13)
                && (v15 = v10->XPixels - playerr->XPixels, (int)((HIDWORD(v15) ^ v15) - HIDWORD(v15)) <= v13) )
              {
                if ( (!a5 || !v9->AllowAudioByte2) && (!a6 || v9->Ship == 8) )
                  SendPlayerReliablePacket(v9, buf, len, a4);
              }
            }
          }
        }
        result = playerr->MyArena;
        ++v8;
        ++v16;
      }
      while ( v16 < result->ArenaPlayerCount );
    }
  }
  return result;
}

//----- (0040E220) --------------------------------------------------------
ARENA *__thiscall sub_40E220(PLAYER *playerr, char *buf, int len, int a4, int a5, int a6)
{
  ARENA *arena; // eax
  int v8; // ebx
  int v9; // edi
  PLAYER *v10; // ecx

  arena = playerr->MyArena;
  if ( arena )
  {
    v8 = 0;
    if ( arena->ArenaPlayerCount > 0 )
    {
      v9 = 16072;
      do
      {
        v10 = arena->PlayerPointers[v9];
        if ( v10 != playerr
          && v10->Frequency == playerr->Frequency
          && (!a5 || !v10->AllowAudioByte2)
          && (!a6 || v10->Ship == 8) )
        {
          SendPlayerReliablePacket(v10, buf, len, a4);
        }
        arena = playerr->MyArena;
        ++v8;
        ++v9;
      }
      while ( v8 < arena->ArenaPlayerCount );
    }
  }
  return arena;
}

//----- (0040E2B0) --------------------------------------------------------
ARENA *__stdcall SomethingWithAudioByteAndShip8(ARENA *arenaa, char *buf, int len, int a4, int a5, ARENA *a6)
{
  ARENA *arena; // eax
  PLAYER *v7; // ecx

  arena = arenaa;
  v7 = ZonePlayerList[(_DWORD)arenaa];
  if ( v7 )
  {
    if ( !a5 || (arena = (ARENA *)v7->AllowAudioByte2) == 0 )
    {
      arena = a6;
      if ( !a6 || v7->Ship == 8 )
        arena = SendPlayerReliablePacket(v7, buf, len, a4);
    }
  }
  return arena;
}

//----- (0040E300) --------------------------------------------------------
ARENA *__thiscall sub_40E300(void *this, int a2, char *buf, int len, int a4, int a6, int a7)
{
  ARENA *result; // eax
  PLAYER *v8; // ebx
  int v9; // edi
  int v10; // esi
  PLAYER *v11; // ecx

  result = (ARENA *)a2;
  v8 = ZonePlayerList[a2];
  if ( v8 )
  {
    result = v8->MyArena;
    if ( result )
    {
      v9 = 0;
      if ( result->ArenaPlayerCount > 0 )
      {
        v10 = 16072;
        do
        {
          v11 = result->PlayerPointers[v10];
          if ( v11 != this
            && v11->Frequency == v8->Frequency
            && (!a6 || !v11->AllowAudioByte2)
            && (!a7 || v11->Ship == 8) )
          {
            SendPlayerReliablePacket(v11, buf, len, a4);
          }
          result = v8->MyArena;
          ++v9;
          ++v10;
        }
        while ( v9 < result->ArenaPlayerCount );
      }
    }
  }
  return result;
}

//----- (0040E3A0) --------------------------------------------------------
// Player.SendMessage()
ARENA *__thiscall SendMessage(PLAYER *this, char *msg, int SoundByte)
{
  ARENA *arena; // eax
  unsigned int v5; // kr08_4
  char buf[3]; // [esp+10h] [ebp-200h] BYREF
  __int16 v7; // [esp+13h] [ebp-1FDh]
  char v8[507]; // [esp+15h] [ebp-1FBh] BYREF

  arena = this->MyArena;
  if ( arena )
  {
    buf[2] = SoundByte;                         // Sound Byte
    buf[0] = 7;                                 // 0x07 - Chat
    buf[1] = 0;                                 // Chat Type - 0x00 - Message in green text [*arena, *zone, ...]
    v7 = -1;                                    // Originator ID
    strcpy(v8, msg);
    v5 = strlen(msg) + 1;
    arena = (ARENA *)GetRelAckDiff(this->encryptionPointer, 0);
    if ( (int)arena < 128 )
      arena = SendPlayerReliablePacket(this, buf, v5 - 1 + 6, 1);
  }
  return arena;
}
/* Orphan comments:
Chat Message
*/

//----- (0040E440) --------------------------------------------------------
ARENA *__thiscall SendChannelMessage(PLAYER *playerr, const char *a2)
{
  ARENA *arena; // eax
  char buf[3]; // [esp+4h] [ebp-200h] BYREF
  __int16 v4; // [esp+7h] [ebp-1FDh]
  char v5[507]; // [esp+9h] [ebp-1FBh] BYREF

  arena = playerr->MyArena;
  if ( arena )
  {
    buf[0] = 7;                                 // 0x07 - Chat
    buf[1] = 9;                                 // Chat Type - 0x09 - Channel message
    buf[2] = 0;                                 // Sound Byte
    v4 = -1;                                    // Originator ID
    strcpy(v5, a2);
    arena = SendPlayerReliablePacket(playerr, buf, strlen(a2) + 6, 1);
  }
  return arena;
}
/* Orphan comments:
Chat Message
*/

//----- (0040E4C0) --------------------------------------------------------
void __thiscall SendArenaMessagePlayer(PLAYER *playerr, const char *a2, char SoundByte)
{
  __int16 v4; // cx
  char buf[3]; // [esp+10h] [ebp-5h] BYREF
  __int16 v6; // [esp+13h] [ebp-2h]
  char v7[507]; // [esp+15h] [ebp+0h] BYREF

  v4 = playerr->PlayerId;
  buf[2] = SoundByte;                           // Sound Byte
  v6 = v4;                                      // Originator ID
  buf[0] = 7;                                   // 0x07 - Chat
  buf[1] = 0;                                   // Chat Type - 0x00 - Message in green text [*arena, *zone, ...]
  strcpy(v7, a2);
  SendPlayerReliablePacket(playerr, buf, strlen(a2) + 6, 0);
  sub_41CB20((int)playerr->encryptionPointer);
}
/* Orphan comments:
Chat Message
*/

//----- (0040E550) --------------------------------------------------------
// Player.SendFile()
ARENA *__thiscall SendFile(PLAYER *this, char *filename)
{
  PLAYER *player; // esi
  FILE *v3; // eax
  FILE *v4; // edi
  int v5; // eax
  size_t v6; // ebp
  _BYTE *v7; // esi
  ARENA *result; // eax
  char buf; // [esp+10h] [ebp-14h] BYREF
  char Dest[19]; // [esp+11h] [ebp-13h] BYREF

  player = this;
  v3 = fopen(filename, "rb");
  v4 = v3;
  if ( v3 )
  {
    v5 = _fileno(v3);
    v6 = _filelength(v5);
    v7 = emalloc(v6 + 17);
    fread(v7 + 17, 1u, v6, v4);
    fclose(v4);
    *v7 = 16;
    strncpy(v7 + 1, filename, 0x10u);
    v7[16] = 0;
    result = (ARENA *)GetNewsRequest((int)this->encryptionPointer, (int)v7, v6 + 17, 0);
  }
  else
  {
    buf = 0x10;                                 // 0x10 - File Transfer
    strncpy(Dest, filename, 0x10u);
    Dest[15] = 0;                               // File Data... is 0 (No idea what this means)
    result = SendPlayerReliablePacket(player, &buf, 17, 1);
  }
  return result;
}
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);

//----- (0040E620) --------------------------------------------------------
ARENA *__thiscall ArenaHandler(PLAYER *this, int ArenaIndex, const char *ArenaName)
{
  int v3; // ebx
  PLAYER *v4; // edx
  int v5; // ecx
  ARENA *result; // eax
  char *v7; // ebp
  ARENA **v8; // ebx
  ARENA *v9; // eax
  int v10; // edx
  int v11; // edi
  int v12; // esi
  int v13; // eax
  ARENA *v14; // esi
  ARENA **v15; // edx
  int v16; // edi
  int v17; // esi
  ARENA *v18; // eax
  int v19; // edi
  ARENA **v20; // esi
  ARENA *v21; // eax
  ARENA *v22; // eax
  int v23; // esi
  int i; // eax
  ARENA *v25; // edx
  ARENA **j; // esi
  ARENA *v27; // eax
  int v28; // ecx
  int ArenaIndexa; // [esp+24h] [ebp+4h]

  v3 = 0;
  v4 = this;
  if ( ArenaIndex < 0 )
  {
    if ( ArenaIndex == -1 && (v7 = this->Squad, this->Squad[0]) )
    {
      v5 = ArenaArrayLength;
      ArenaIndexa = 0;
      if ( ArenaArrayLength > 0 )
      {
        v8 = Arenas;
        while ( 1 )
        {
          v9 = *v8;
          if ( !(*v8)->ArenaName[0] )
          {
            v10 = v9->ArenaPlayerCount;
            if ( v10 < ArenaMaxPlayers )
            {
              v11 = 0;
              if ( v10 > 0 )
                break;
            }
          }
LABEL_18:
          ++v8;
          if ( ++ArenaIndexa >= v5 )
            goto LABEL_54;
        }
        v12 = 16072;
        while ( _strcmpi(v9->PlayerPointers[v12]->Squad, v7) )
        {
          v9 = *v8;
          ++v11;
          ++v12;
          if ( v11 >= (*v8)->ArenaPlayerCount )
          {
            v5 = ArenaArrayLength;
            goto LABEL_18;
          }
        }
        return Arenas[ArenaIndexa];
      }
    }
    else if ( ArenaIndex == -2 )
    {
      v5 = ArenaArrayLength;
      v13 = 0;
      if ( ArenaArrayLength > 0 )
      {
        v14 = (ARENA *)v4->field_20;
        v15 = Arenas;
        while ( *v15 != v14 )
        {
          ++v13;
          ++v15;
          if ( v13 >= ArenaArrayLength )
            goto LABEL_28;
        }
        v3 = v13;
      }
LABEL_28:
      v16 = 0;
      if ( ArenaArrayLength > 0 )
      {
        v17 = v3 + 1;
        do
        {
          v18 = Arenas[v17 % ArenaArrayLength];
          if ( !v18->ArenaName[0] && (this->isModerator || v18->ArenaPlayerCount < ArenaMaxPlayers) )
            return Arenas[v17 % ArenaArrayLength];
          ++v16;
          ++v17;
        }
        while ( v16 < ArenaArrayLength );
      }
    }
    else if ( ArenaIndex == -3 )
    {
      v5 = ArenaArrayLength;
      v19 = 0;
      if ( ArenaArrayLength > 0 )
      {
        v20 = Arenas;
        while ( 1 )
        {
          v3 += GetArenaMemoryTotal(*v20);
          if ( !_strcmpi((*v20)->ArenaName, ArenaName) )
            break;
          v5 = ArenaArrayLength;
          ++v19;
          ++v20;
          if ( v19 >= ArenaArrayLength )
            goto LABEL_46;
        }
        if ( this->isModerator )
          goto LABEL_68;
        if ( Arenas[v19]->ArenaPlayerCount < ArenaMaxPlayers )
          return Arenas[v19];
        v5 = ArenaArrayLength;
LABEL_46:
        v4 = this;
      }
      if ( v19 == v5 && (v4->isSuperModerator || v5 < MaxArenas && v3 < MaxArenasMemory) )
      {
        v21 = (ARENA *)operator new(0x1D40Eu);
        if ( v21 )
        {
          v22 = ServerEntryPoint(v21, ArenaName);
LABEL_72:
          v28 = ArenaArrayLength;
          Arenas[ArenaArrayLength] = v22;
          result = Arenas[v28];
          ArenaArrayLength = v28 + 1;
          return result;
        }
LABEL_71:
        v22 = 0;
        goto LABEL_72;
      }
    }
    else
    {
      v5 = ArenaArrayLength;
    }
  }
  else
  {
    v5 = ArenaArrayLength;
    if ( ArenaIndex < ArenaArrayLength
      && (v4->isModerator || !Arenas[ArenaIndex]->ArenaName[0] && Arenas[ArenaIndex]->ArenaPlayerCount < ArenaMaxPlayers) )
    {
      return Arenas[ArenaIndex];
    }
  }
LABEL_54:
  v23 = -1;
  for ( i = 0; i < v5; ++i )
  {
    v25 = Arenas[i];
    if ( !v25->ArenaName[0] && (v23 == -1 || v25->ArenaPlayerCount < Arenas[v23]->ArenaPlayerCount) )
      v23 = i;
  }
  if ( v23 == -1 || (result = Arenas[v23], result->ArenaPlayerCount >= ArenaMaxPlayers) )
  {
    v27 = (ARENA *)operator new(0x1D40Eu);
    if ( v27 )
    {
      v22 = ServerEntryPoint(v27, (const char *)&DirectoryCurrentNamePassword);
      goto LABEL_72;
    }
    goto LABEL_71;
  }
  v19 = 0;
  if ( v5 > 0 )
  {
    for ( j = Arenas; (*j)->ArenaName[0] || (*j)->ArenaPlayerCount >= ArenaDesiredPlayers; ++j )
    {
      if ( ++v19 >= v5 )
        return result;
    }
LABEL_68:
    result = Arenas[v19];
  }
  return result;
}
// 40E677: conditional instruction was optimized away because of 'edx.4==0'
// 431FF4: using guessed type int ArenaArrayLength;
// 4380B0: using guessed type int ArenaMaxPlayers;
// 438B18: using guessed type int MaxArenasMemory;
// 4D5908: using guessed type int MaxArenas;
// 4D5928: using guessed type int ArenaDesiredPlayers;

//----- (0040E990) --------------------------------------------------------
int __thiscall SendWeaponPacket(PLAYER *playerr)
{
  int v2; // eax
  __int16 v3; // cx
  __int16 v4; // dx
  ENCRYPTION *v5; // edi
  __int16 v6; // ax
  DWORD v7; // eax
  int v8; // ebp
  int v9; // edi
  DWORD v10; // edx
  ENCRYPTION *v11; // ebp
  int v12; // edx
  int v13; // edi
  ENCRYPTION *v14; // ebp
  int v15; // edx
  __int16 v16; // cx
  __int16 v17; // ax
  char v18; // al
  char *v19; // ecx
  int v20; // edx
  ARENA *v21; // eax
  int v22; // ecx
  __int16 v23; // dx
  __int16 v24; // ax
  ENCRYPTION *v25; // edi
  __int16 v26; // cx
  DWORD v27; // eax
  int v28; // ebp
  int v29; // edi
  DWORD v30; // edx
  ENCRYPTION *v31; // ebp
  int v32; // edx
  int v33; // edx
  int v34; // edi
  ENCRYPTION *v35; // ebp
  char v36; // al
  char v37; // cl
  __int16 v38; // ax
  __int16 v39; // cx
  ENCRYPTION *v40; // edi
  __int16 v41; // dx
  DWORD v42; // eax
  int v43; // ebp
  int v44; // edi
  DWORD v45; // edx
  ENCRYPTION *v46; // ebp
  int v47; // edx
  char v48; // al
  int v49; // edi
  ENCRYPTION *v50; // ebp
  int v51; // edx
  __int16 v52; // dx
  char v53; // al
  __int16 v54; // cx
  __int16 v55; // ax
  int v56; // edx
  __int16 v57; // cx
  char v58; // al
  int *v59; // ecx
  int v60; // eax
  char *v61; // ecx
  __int16 v62; // dx
  int v63; // edx
  int v64; // edi
  __int16 v65; // ax
  bool v66; // cc
  bool v67; // cc
  ARENA *v68; // eax
  int v69; // ebp
  PLAYER *v70; // esi
  int v71; // edx
  int v72; // ecx
  int v73; // edi
  ARENA *v74; // eax
  int v75; // esi
  int v76; // ecx
  int v77; // ebp
  int v78; // edx
  int v79; // eax
  int v80; // eax
  int v81; // edi
  int v82; // eax
  int v83; // ecx
  int *v84; // eax
  PLAYER *v85; // ebp
  int v86; // eax
  int v87; // eax
  PLAYER *v88; // ecx
  int v89; // eax
  __int64 v90; // rax
  int v91; // esi
  ARENA *v92; // eax
  int v93; // ecx
  int v94; // eax
  bool v95; // zf
  int result; // eax
  int len; // [esp+10h] [ebp-DCh]
  int v98; // [esp+14h] [ebp-D8h]
  int v99; // [esp+14h] [ebp-D8h]
  int v100; // [esp+18h] [ebp-D4h]
  int v101; // [esp+18h] [ebp-D4h]
  int v102; // [esp+1Ch] [ebp-D0h]
  int v103; // [esp+1Ch] [ebp-D0h]
  int v104; // [esp+20h] [ebp-CCh]
  int v105; // [esp+20h] [ebp-CCh]
  char buf[2]; // [esp+24h] [ebp-C8h] BYREF
  __int16 v107; // [esp+26h] [ebp-C6h]
  __int16 v108; // [esp+28h] [ebp-C4h]
  __int16 v109; // [esp+2Ah] [ebp-C2h]
  __int16 v110; // [esp+2Ch] [ebp-C0h]
  __int16 v111; // [esp+2Eh] [ebp-BEh]
  char v112; // [esp+30h] [ebp-BCh]
  char v113; // [esp+31h] [ebp-BBh]
  char v114; // [esp+32h] [ebp-BAh]
  __int16 v115; // [esp+33h] [ebp-B9h]
  __int16 v116; // [esp+35h] [ebp-B7h]
  int v117; // [esp+37h] [ebp-B5h]
  int v118; // [esp+3Ch] [ebp-B0h]
  int v119; // [esp+40h] [ebp-ACh]
  int v120; // [esp+44h] [ebp-A8h]
  int v121; // [esp+48h] [ebp-A4h]
  int v122; // [esp+4Ch] [ebp-A0h]
  int *v123; // [esp+50h] [ebp-9Ch]
  int v124; // [esp+54h] [ebp-98h]
  int v125; // [esp+58h] [ebp-94h]
  int *v126; // [esp+5Ch] [ebp-90h]
  int v127; // [esp+60h] [ebp-8Ch]
  int v128; // [esp+64h] [ebp-88h]
  int v129; // [esp+68h] [ebp-84h]
  int v130; // [esp+6Ch] [ebp-80h] BYREF
  __int16 v131; // [esp+70h] [ebp-7Ch]
  __int16 v132; // [esp+72h] [ebp-7Ah]
  __int16 v133; // [esp+74h] [ebp-78h]
  __int16 v134; // [esp+76h] [ebp-76h]
  __int16 v135; // [esp+78h] [ebp-74h]
  char v136[3]; // [esp+7Ah] [ebp-72h]
  __int16 v137; // [esp+7Dh] [ebp-6Fh]
  int v138; // [esp+7Fh] [ebp-6Dh]

  v2 = playerr->field_28B;
  playerr->field_FD = 0;
  if ( v2 )
  {
    v3 = playerr->YPixels;
    v4 = playerr->XVelocity;
    v5 = playerr->encryptionPointer;
    v108 = playerr->XPixels;                    // X Pixels (0-16384)
    v6 = playerr->YVelocity;
    v115 = v3;
    LOBYTE(v3) = playerr->ShipDirection;
    buf[0] = 5;                                 // 0x05 - Large Position Packet (Weapons Packet)
    v111 = v4;                                  // X Velocity
    v109 = v6;                                  // Y Velocity
    buf[1] = v3;                                // Direction (0-360)
    v7 = GetTickCount();
    v8 = v5->dwordE;
    v9 = playerr->Ping;
    v10 = v8 + v7 / 0xA;
    v11 = playerr->encryptionPointer;
    v107 = v10;
    v12 = ((v11->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v9;
    if ( v12 < 0 || v12 > 30000 )
      v12 = 0;
    if ( v12 <= 255 )
    {
      v13 = playerr->Ping;
      v14 = playerr->encryptionPointer;
      v15 = ((v14->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v13;
      if ( v15 < 0 || v15 > 30000 )
        LOBYTE(v15) = 0;
      v114 = v15;                               // Ping
    }
    else
    {
      v114 = -1;                                // Ping
    }
    v16 = playerr->field_F0;
    v110 = 1014;                                // Special PlayerId?
    v17 = v16 & 0x1F;
    v113 = 0;
    v116 = 0;
    if ( v17 == 3 || v17 == 4 || v17 == 1 || v17 == 2 )
      LOWORD(v117) = v16 ^ (v16 ^ v16 & 0x80 ^ (v16 & 0x1F ^ v117 & 0xFF80) & 0xFC7F) & 0x3FF;
    else
      LOWORD(v117) = 0;
    v18 = 0;
    v19 = buf;
    v112 = 0;                                   // Checksum
    v20 = 21;
    do
    {
      v18 ^= *v19++;
      --v20;
    }
    while ( v20 );
    v112 = v18;                                 // Computed Checksum
    if ( !playerr->field_309 )
    {
      v21 = playerr->MyArena;
      if ( v21 )
      {
        if ( (v117 & 0x1F) != 0 )
        {
          v22 = playerr->S2CPacketLossPercentage;
          ++playerr->field_11F;
          if ( v22 < v21->ServersideArenaSettings.RoutingDoubleSendPercent )
          {
            SendPlayerReliablePacket(playerr, buf, 21, 0);
            ++playerr->field_11F;
            ++dword_4C8F38;
            sub_41CB20((int)playerr->encryptionPointer);
          }
        }
        SendPlayerReliablePacket(playerr, buf, 21, 0);
      }
    }
  }
  if ( playerr->Ship < 8 && playerr->MyArena )
  {
    if ( *(int *)&playerr->PlayerId > 255 || *(__int16 *)playerr->gap_EC > 255 || (playerr->field_F0 & 0x1F) != 0 )
    {
      v38 = playerr->YPixels;
      v39 = playerr->XVelocity;
      v40 = playerr->encryptionPointer;
      v131 = playerr->XPixels;
      v41 = playerr->YVelocity;
      *(_WORD *)&v136[1] = v38;
      LOBYTE(v38) = playerr->ShipDirection;
      len = 21;
      LOBYTE(v130) = 5;                         // 0x05 - Large Position Packet (Weapons Packet)
      v134 = v39;
      v132 = v41;
      BYTE1(v130) = v38;
      v42 = GetTickCount();
      v43 = v40->dwordE;
      v44 = playerr->Ping;
      v45 = v43 + v42 / 0xA;
      v46 = playerr->encryptionPointer;
      HIWORD(v130) = v45;
      v47 = ((v46->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v44;
      if ( v47 < 0 || v47 > 30000 )
        v47 = 0;
      if ( v47 <= 255 )
      {
        v49 = playerr->Ping;
        v50 = playerr->encryptionPointer;
        v51 = ((v50->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v49;
        if ( v51 < 0 || v51 > 30000 )
          LOBYTE(v51) = 0;
        v48 = v51;
      }
      else
      {
        v48 = -1;
      }
      v52 = playerr->PlayerId;
      v136[0] = v48;
      v53 = playerr->ShipTogglables;
      v54 = *(_WORD *)playerr->gap_EC;
      v133 = v52;
      HIBYTE(v135) = v53;
      v55 = playerr->field_F0;
      v137 = v54;
      LOWORD(v138) = ((unsigned __int8)v55 ^ (unsigned __int8)v138) & 0x1F ^ v138;// BitFlags
      LOWORD(v138) = ((unsigned __int8)v55 ^ (unsigned __int8)v138) & 0x60 ^ v138;
      LOWORD(v138) = ((unsigned __int8)v55 ^ (unsigned __int8)v138) & 0x80 ^ v138;
      LOWORD(v138) = (v55 ^ v138) & 0x300 ^ v138;
      LOWORD(v138) = (v55 ^ v138) & 0x7C00 ^ v138;
      v56 = 21;
      v57 = v55 ^ (v55 ^ v138) & 0x7FFF;
      v58 = 0;
      LOWORD(v138) = v57;
      LOBYTE(v135) = 0;
      v59 = &v130;
      do
      {
        v58 ^= *(_BYTE *)v59;
        v59 = (int *)((char *)v59 + 1);
        --v56;
      }
      while ( v56 );
      LOBYTE(v135) = v58;
    }
    else
    {
      v23 = playerr->YPixels;
      v24 = playerr->XVelocity;
      v25 = playerr->encryptionPointer;
      v131 = playerr->XPixels;
      v26 = playerr->YVelocity;
      v135 = v23;
      LOBYTE(v23) = playerr->ShipDirection;
      len = 16;
      LOBYTE(v130) = 0x28;                      // 0x28 - Small Position Packet
      *(_WORD *)v136 = v24;
      v134 = v26;
      BYTE1(v130) = v23;
      v27 = GetTickCount();
      v28 = v25->dwordE;
      v29 = playerr->Ping;
      v30 = v28 + v27 / 0xA;
      v31 = playerr->encryptionPointer;
      HIWORD(v130) = v30;
      v32 = ((v31->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v29;
      if ( v32 < 0 || v32 > 30000 )
        v32 = 0;
      if ( v32 <= 255 )
      {
        v34 = playerr->Ping;
        v35 = playerr->encryptionPointer;
        v33 = ((v35->dwordE + GetTickCount() / 0xA) & 0x7FFFFFFF) - v34;
        if ( v33 < 0 || v33 > 30000 )
          LOBYTE(v33) = 0;
      }
      else
      {
        LOBYTE(v33) = -1;
      }
      v36 = playerr->ShipTogglables;
      v37 = playerr->gap_EC[0];
      LOBYTE(v132) = v33;
      LOBYTE(v133) = playerr->PlayerId;
      HIBYTE(v133) = v36;
      HIBYTE(v132) = v37;
    }
    if ( playerr->field_10B )
    {
      v60 = len;
      v61 = (char *)&v130 + len;
      *(_DWORD *)v61 = playerr->EnergyOptional;
      v62 = playerr->SharpnelMinesBombsBulletsMultifireInformationOptional;
      *((_DWORD *)v61 + 1) = playerr->TimerOptional;
      *((_WORD *)v61 + 4) = v62;
      v118 = len + 10;
    }
    else
    {
      *(_WORD *)((char *)&v130 + len) = *(_WORD *)&playerr->gap_EC[2];
      v118 = len + 2;
      v60 = len;
    }
    v63 = 0;
    v64 = 0;
    v104 = 0;
    v98 = 0;
    v100 = 0;
    if ( v60 != 21 )
      goto LABEL_79;
    v65 = v138 & 0x1F;
    if ( v65 == 6 || v65 == 3 && (v138 & 0x8000) != 0 || v65 == 4 && (v138 & 0x8000) != 0 || v65 == 5 || v65 == 8 )
    {
      playerr->field_10F = 1;
    }
    else if ( v65 == 4 || v65 == 3 )
    {
      if ( SBYTE1(v130) < 5 || SBYTE1(v130) > 35 )
        v98 = playerr->MyArena->ServersideArenaSettings.RoutingCloseEnoughBombAdjust;
      if ( SBYTE1(v130) > 5 )
      {
        v66 = SBYTE1(v130) <= 15;
        if ( SBYTE1(v130) >= 15 )
          goto LABEL_71;
        v64 = playerr->MyArena->ServersideArenaSettings.RoutingCloseEnoughBombAdjust;
      }
      v66 = SBYTE1(v130) <= 15;
LABEL_71:
      if ( !v66 )
      {
        v67 = SBYTE1(v130) <= 25;
        if ( SBYTE1(v130) >= 25 )
        {
LABEL_75:
          if ( !v67 && SBYTE1(v130) < 35 )
          {
            v63 = playerr->MyArena->ServersideArenaSettings.RoutingCloseEnoughBombAdjust;
            v104 = v63;
          }
          goto LABEL_79;
        }
        v100 = playerr->MyArena->ServersideArenaSettings.RoutingCloseEnoughBombAdjust;
      }
      v67 = SBYTE1(v130) <= 25;
      goto LABEL_75;
    }
LABEL_79:
    if ( playerr->field_10F )
    {
      v68 = playerr->MyArena;
      v102 = 0;
      if ( v68->ArenaPlayerCount > 0 )
      {
        v69 = 16072;
        do
        {
          v70 = v68->PlayerPointers[v69];
          if ( v70 != playerr )
          {
            v71 = v70->isSysop;
            if ( v71 || !playerr->field_3C || (v72 = playerr->field_4C, v72 < 0) || v72 == *(_DWORD *)&v70->PlayerId )
            {
              v73 = len;
              if ( v70->isEnergyShowing
                || v70->ArenaPlayerIndex == *(_DWORD *)&playerr->PlayerId
                && (v68->ArenaSettings.ExtraPositionData || v71) )
              {
                v73 = v118;
              }
              if ( !v70->field_309 )
              {
                v74 = v70->MyArena;
                if ( v74 )
                {
                  if ( len == 21 && (v138 & 0x1F) != 0 )
                  {
                    ++v70->field_11F;
                    if ( v70->S2CPacketLossPercentage < v74->ServersideArenaSettings.RoutingDoubleSendPercent )
                    {
                      SendPlayerReliablePacket(v70, (char *)&v130, v73, 0);
                      ++v70->field_11F;
                      ++dword_4C8F38;
                      sub_41CB20((int)v70->encryptionPointer);
                    }
                  }
                  SendPlayerReliablePacket(v70, (char *)&v130, v73, 0);
                }
              }
            }
          }
          v68 = playerr->MyArena;
          ++v69;
          ++v102;
        }
        while ( v102 < v68->ArenaPlayerCount );
      }
    }
    else
    {
      v75 = (playerr->LooksLikeX1BigOfSomething - v63) / 2048;
      if ( v75 < 0 )
        v75 = 0;
      v76 = (v64 + playerr->LooksLikeXSmallOfSomething) / 2048;
      if ( v76 >= 8 )
        v76 = 7;
      v77 = (playerr->LooksLikeYBigOfSomething - v98) / 2048;
      v103 = v77;
      if ( v77 < 0 )
      {
        v103 = 0;
        v77 = 0;
      }
      v121 = (v100 + playerr->LooksLikeYSmallOfSomething) / 2048;
      v78 = v121;
      if ( v121 >= 8 )
      {
        v78 = 7;
        v121 = 7;
      }
      v79 = playerr->XPixels;
      v128 = v79 + v64;
      v125 = v79 - v104;
      v80 = playerr->YPixels;
      v127 = v80 + v100;
      v129 = v80 - v98;
      v105 = 128;
      v101 = 128;
      if ( len == 21 && (v138 & 0x1F) != 0 )
      {
        v105 = playerr->MyArena->ServersideArenaSettings.RoutingCloseEnoughBulletAdjust + 128;
        v101 = v105;
      }
      if ( v75 <= v76 )
      {
        v81 = 1004 * (v77 + 8 * v75);
        v120 = v81;
        v122 = v76 - v75 + 1;
        do
        {
          if ( v77 <= v78 )
          {
            v82 = v81;
            v124 = v81;
            v83 = v78 - v77 + 1;
            v119 = v83;
            do
            {
              v99 = 0;
              v84 = (int *)((char *)playerr->MyArena + v82);
              v126 = v84;
              if ( v84[250] > 0 )
              {
                v123 = v84;
                do
                {
                  v85 = (PLAYER *)*v84;
                  if ( (PLAYER *)*v84 != playerr )
                  {
                    if ( v85->isSysop
                      || !playerr->field_3C
                      || (v86 = playerr->field_4C, v86 < 0)
                      || v86 == *(_DWORD *)&v85->PlayerId )
                    {
                      v87 = v85->ArenaPlayerIndex;
                      v88 = v85;
                      if ( v87 < 0 || (v88 = ZonePlayerList[v87]) != 0 )
                      {
                        v89 = v88->AttachedToPlayerId;
                        if ( v89 < 0 || (v88 = ZonePlayerList[v89]) != 0 )
                        {
                          if ( (int)abs32(v88->YPixels - playerr->YPixels) > v101 + v85->YResolution / 2
                            || (v90 = v88->XPixels - playerr->XPixels,
                                (int)((HIDWORD(v90) ^ v90) - HIDWORD(v90)) > v105 + v85->XResolution / 2) )
                          {
                            if ( v128 >= v88->LooksLikeX1BigOfSomething
                              && v125 <= v88->LooksLikeXSmallOfSomething
                              && v127 >= v88->LooksLikeYBigOfSomething
                              && v129 <= v88->LooksLikeYSmallOfSomething
                              && (len == 21 && (v138 & 0x1Fu) > 2
                               || v99 % playerr->MyArena->ServersideArenaSettings.RoutingRadarFavor == *(_DWORD *)playerr->gap_11B) )
                            {
                              if ( IncreasesRadarValueSomeHow >= 4000 )
                                IncreaseRadarValueShowHomeOverFourThousand();
                              v94 = 26 * IncreasesRadarValueSomeHow;
                              qmemcpy((char *)dword_4AF8FC + 26 * IncreasesRadarValueSomeHow, &v130, len);
                              byte_4AF911[v94] = len;
                              *(int *)((char *)&dword_4AF8F8 + v94) = *(_DWORD *)&v85->PlayerId;
                              ++IncreasesRadarValueSomeHow;
                            }
                          }
                          else
                          {
                            v91 = len;
                            if ( v85->isEnergyShowing
                              || v85->ArenaPlayerIndex == *(_DWORD *)&playerr->PlayerId
                              && (playerr->MyArena->ArenaSettings.ExtraPositionData || v85->isSysop) )
                            {
                              v91 = v118;
                            }
                            if ( !v85->field_309 )
                            {
                              v92 = v85->MyArena;
                              if ( v92 )
                              {
                                if ( len == 21 && (v138 & 0x1F) != 0 )
                                {
                                  v93 = v85->S2CPacketLossPercentage;
                                  ++v85->field_11F;
                                  if ( v93 < v92->ServersideArenaSettings.RoutingDoubleSendPercent )
                                  {
                                    SendPlayerReliablePacket(v85, (char *)&v130, v91, 0);
                                    ++v85->field_11F;
                                    ++dword_4C8F38;
                                    sub_41CB20((int)v85->encryptionPointer);
                                  }
                                }
                                SendPlayerReliablePacket(v85, (char *)&v130, v91, 0);
                              }
                            }
                            ++dword_4D55D0;
                          }
                        }
                      }
                    }
                  }
                  v84 = v123 + 1;
                  v66 = ++v99 < v126[250];
                  ++v123;
                }
                while ( v66 );
                v77 = v103;
                v78 = v121;
                v81 = v120;
                v83 = v119;
              }
              v82 = v124 + 1004;
              --v83;
              v124 += 1004;
              v119 = v83;
            }
            while ( v83 );
          }
          v81 += 8032;
          v95 = v122 == 1;
          v120 = v81;
          --v122;
        }
        while ( !v95 );
      }
      *(_DWORD *)playerr->gap_11B = (*(_DWORD *)playerr->gap_11B + 1)
                                  % playerr->MyArena->ServersideArenaSettings.RoutingRadarFavor;
    }
  }
  result = 0;
  playerr->field_10F = 0;
  playerr->field_10B = 0;
  return result;
}
/* Orphan comments:
 Large Position Packet (Weapons Packet) Without Optionals
*/
// 4AF8F8: using guessed type int dword_4AF8F8;
// 4AF8FC: using guessed type int dword_4AF8FC[5];
// 4C8F38: using guessed type int dword_4C8F38;
// 4CA814: using guessed type int IncreasesRadarValueSomeHow;
// 4D55D0: using guessed type int dword_4D55D0;

//----- (0040F4A0) --------------------------------------------------------
int __thiscall SendResetScoresPacket(PLAYER *player)
{
  __int16 v1; // dx
  int result; // eax
  ARENA *arena; // ecx
  PLAYER *buf; // [esp+0h] [ebp-4h] BYREF

  buf = player;
  v1 = player->PlayerId;
  result = 0;
  player->CurrentLosses = 0;
  player->CurrentWins = 0;
  player->KillPoints = 0;
  player->FlagPoints = 0;
  player->GoalCount = 0;
  player->field_30D = 1;
  arena = player->MyArena;
  LOBYTE(buf) = 0x1A;                           // 0x1A - Reset Score(s)
  *(_WORD *)((char *)&buf + 1) = v1;
  if ( arena )
    result = ArenaSendPacket(arena, &buf, 3, 1);
  return result;
}

//----- (0040F500) --------------------------------------------------------
ARENA *__thiscall SendPlayerScoreUpdate(PLAYER *player)
{
  __int16 v1; // ax
  __int16 v2; // dx
  int v3; // eax
  char buf; // [esp+0h] [ebp-10h] BYREF
  __int16 v6; // [esp+1h] [ebp-Fh]
  int v7; // [esp+3h] [ebp-Dh]
  int v8; // [esp+7h] [ebp-9h]
  __int16 v9; // [esp+Bh] [ebp-5h]
  __int16 v10; // [esp+Dh] [ebp-3h]

  v1 = player->PlayerId;
  v7 = player->KillPoints;                      // Kill Points
  v2 = player->CurrentWins;
  v6 = v1;                                      // Player ID
  v3 = player->FlagPoints;
  v9 = v2;                                      // Wins
  v8 = v3;                                      // Flag Points
  LOWORD(v3) = player->CurrentLosses;
  buf = 9;                                      // 0x09 - Player Score Update
  v10 = v3;                                     // Losses
  return SendPlayerReliablePacket(player, &buf, 15, 1);
}

//----- (0040F550) --------------------------------------------------------
signed int __thiscall SendPlayerScoreUpdateAll(PLAYER *playerr)
{
  int v2; // edx
  int v3; // edi
  int v4; // ebp
  int v5; // ecx
  ARENA *v6; // eax
  __int16 v7; // dx
  int v8; // ebp
  __int16 v9; // cx
  int v10; // ebp
  int v11; // ebp
  int v12; // edi
  int v13; // ebx
  PLAYER *v14; // eax
  ARENA *v15; // eax
  char buf; // [esp+10h] [ebp-10h] BYREF
  __int16 v18; // [esp+11h] [ebp-Fh]
  int v19; // [esp+13h] [ebp-Dh]
  int v20; // [esp+17h] [ebp-9h]
  __int16 v21; // [esp+1Bh] [ebp-5h]
  __int16 v22; // [esp+1Dh] [ebp-3h]

  v2 = playerr->KillPoints;
  v3 = *(_DWORD *)&playerr->field_245;
  v4 = *(_DWORD *)&playerr->field_249;
  v5 = playerr->FlagPoints;
  if ( v5 + v2 - v3 - v4 <= MiscPointUpdateDiff )
    return 0;
  if ( !dword_4C8F3C )
    return 0;
  v6 = playerr->MyArena;
  if ( !v6 )
    return 0;
  v19 = v2;                                     // Kill Points
  v7 = playerr->CurrentLosses;
  v8 = *(_DWORD *)&playerr->CurrentWins;
  v20 = v5;                                     // Flag Points
  playerr->dword23F = v8;
  v9 = playerr->CurrentWins;
  v10 = *(_DWORD *)&playerr->GoalCount;
  buf = 9;                                      // 0x09 - Player Score Update
  *(_DWORD *)&playerr->dword243 = v10;
  v21 = v9;                                     // Wins
  v11 = *(int *)((char *)&playerr->KillPoints + 2);
  v22 = v7;                                     // Losses
  *(_DWORD *)&playerr->dword247 = v11;
  LOWORD(playerr->word24B) = HIWORD(playerr->FlagPoints);
  v18 = playerr->PlayerId;                      // Player ID
  v12 = 0;
  if ( v6->ArenaPlayerCount > 0 )
  {
    v13 = 16072;
    do
    {
      v14 = v6->PlayerPointers[v13];
      if ( v14 != playerr && !v14->AlreadySentReliablePacket )
        SendPlayerReliablePacket(v14, &buf, 15, 0);
      v6 = playerr->MyArena;
      ++v12;
      ++v13;
    }
    while ( v12 < v6->ArenaPlayerCount );
  }
  SendPlayerReliablePacket(playerr, &buf, 15, 1);
  if ( BillingConnectionStructPointer )
  {
    v15 = playerr->MyArena;
    if ( !v15->ServersideArenaSettings.MiscTimedGame )
    {
      if ( v15->RecordPointsToLog )
      {
        if ( (MiscDisableSharewareScores || MiscDisableShareware) && playerr->DemoPlayer )
          return 1;
        SendBillerUserScorePacket(
          (ENCRYPTION **)BillingConnectionStructPointer,
          playerr->BillerPlayerId,
          &playerr->CurrentWins,
          0xEu);
      }
    }
  }
  return 1;
}
// 4C8F3C: using guessed type int dword_4C8F3C;
// 4CA60C: using guessed type int MiscPointUpdateDiff;
// 4D5918: using guessed type int MiscDisableShareware;
// 4D8AE0: using guessed type int MiscDisableSharewareScores;

//----- (0040F6B0) --------------------------------------------------------
ARENA *__thiscall SendAdvertisement(PLAYER *playerr, int a2)
{
  __int64 v3; // rax
  ARENA *result; // eax
  DWORD v5; // kr00_4
  int v6; // eax
  int v7; // edx
  int v8; // edx
  int v9; // edx

  if ( a2
    || (v3 = (int)(GetTickCount() / 0xA - *(_DWORD *)playerr->gap_24),
        result = (ARENA *)((HIDWORD(v3) ^ v3) - HIDWORD(v3)),
        (int)result >= 3000) )
  {
    v5 = GetTickCount();
    v6 = playerr->DemoPlayer;
    *(_DWORD *)playerr->gap_24 = v5 / 0xA;
    if ( v6 )
    {
      if ( dword_4D8B04 > 0 || (result = (ARENA *)dword_4D8AFC, dword_4D8AFC > 0) )
      {
        v7 = rand() % (dword_4D8B04 + dword_4D8AFC);
        if ( v7 >= dword_4D8B04 )
        {
          v8 = v7 - dword_4D8B04;
          if ( a2 )
            result = SendPlayerReliablePacket(playerr, (&buf)[2 * v8], *(&len + 2 * v8), 1);
          else
            result = (ARENA *)GetMapLvlRequest(
                                (int)playerr->encryptionPointer,
                                (int)(&buf)[2 * v8],
                                *(&len + 2 * v8),
                                0);
          return result;
        }
        if ( a2 )
          return SendPlayerReliablePacket(playerr, (&dword_437CB0)[2 * v7], *(&dword_437CB4 + 2 * v7), 1);
        return (ARENA *)GetMapLvlRequest(
                          (int)playerr->encryptionPointer,
                          (int)(&dword_437CB0)[2 * v7],
                          *(&dword_437CB4 + 2 * v7),
                          0);
      }
    }
    else if ( dword_4D8B04 > 0 || (result = (ARENA *)dword_4D8B00, dword_4D8B00 > 0) )
    {
      v7 = rand() % (dword_4D8B04 + dword_4D8B00);
      if ( v7 < dword_4D8B04 )
      {
        if ( a2 )
          return SendPlayerReliablePacket(playerr, (&dword_437CB0)[2 * v7], *(&dword_437CB4 + 2 * v7), 1);
        return (ARENA *)GetMapLvlRequest(
                          (int)playerr->encryptionPointer,
                          (int)(&dword_437CB0)[2 * v7],
                          *(&dword_437CB4 + 2 * v7),
                          0);
      }
      v9 = v7 - dword_4D8B04;
      if ( a2 )
        result = SendPlayerReliablePacket(playerr, (&dword_4317B8)[2 * v9], *(&dword_4317BC + 2 * v9), 1);
      else
        result = (ARENA *)GetMapLvlRequest(
                            (int)playerr->encryptionPointer,
                            (int)(&dword_4317B8)[2 * v9],
                            *(&dword_4317BC + 2 * v9),
                            0);
    }
  }
  return result;
}
// 4D8AFC: using guessed type int dword_4D8AFC;
// 4D8B00: using guessed type int dword_4D8B00;
// 4D8B04: using guessed type int dword_4D8B04;

//----- (0040F840) --------------------------------------------------------
struc_2 *__cdecl LoadZoneCFGSettings(ARENA_SETTINGS *arenaSettings, SERVERSIDE_ARENA_SETTINGS *serverArenaSettings, const char *a3)
{
  struc_2 *result; // eax
  char *v4; // ebp
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // eax
  int v14; // eax
  int v15; // eax
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // eax
  int v20; // eax
  int v21; // eax
  int v22; // eax
  int v23; // eax
  int v24; // eax
  int v25; // eax
  int v26; // eax
  int v27; // eax
  int v28; // eax
  int v29; // eax
  int v30; // eax
  int v31; // eax
  int v32; // eax
  char *v33; // edi
  SHIP_SETTINGS *v34; // esi
  int v35; // eax
  int v36; // ecx
  int v37; // eax
  int v38; // ecx
  int v39; // eax
  char v40; // al
  int v41; // edx
  char v42; // al
  int v43; // ecx
  char v44; // al
  int v45; // edx
  int v46; // eax
  char *v47; // esi
  int v48; // edi
  int v49; // [esp-4h] [ebp-44h]
  char *Str2[8]; // [esp+14h] [ebp-2Ch]
  int v51; // [esp+3Ch] [ebp-4h]
  int i; // [esp+4Ch] [ebp+Ch]

  result = (struc_2 *)operator new(0x2B74Cu);
  v51 = 0;
  if ( result )
  {
    result = ReadSettingsSomething(result, a3);
    v4 = (char *)result;
  }
  else
  {
    v4 = 0;
  }
  v51 = -1;
  if ( arenaSettings )
  {
    memset(arenaSettings, 0, sizeof(ARENA_SETTINGS));
    LOBYTE(arenaSettings->VersionAndManyBitFields) = 15;
    arenaSettings->SomeUnknownStuff = 0;
    v5 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"QuickCharge", 80);
    if ( v5 > 255 )
      LOBYTE(v5) = -1;
    arenaSettings->PrizeWeightQuickCharge = v5;
    v6 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Energy", 70);
    if ( v6 > 255 )
      LOBYTE(v6) = -1;
    arenaSettings->PrizeWeightEnergy = v6;
    v7 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Rotation", 60);
    if ( v7 > 255 )
      LOBYTE(v7) = -1;
    arenaSettings->PrizeWeightRotation = v7;
    v8 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Stealth", 30);
    if ( v8 > 255 )
      LOBYTE(v8) = -1;
    arenaSettings->PrizeWeightStealth = v8;
    v9 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Cloak", 20);
    if ( v9 > 255 )
      LOBYTE(v9) = -1;
    arenaSettings->PrizeWeightCloak = v9;
    v10 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"AntiWarp", 20);
    if ( v10 > 255 )
      LOBYTE(v10) = -1;
    arenaSettings->PrizeWeightAntiWarp = v10;
    v11 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"XRadar", 20);
    if ( v11 > 255 )
      LOBYTE(v11) = -1;
    arenaSettings->PrizeWeightXRadar = v11;
    v12 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Warp", 40);
    if ( v12 > 255 )
      LOBYTE(v12) = -1;
    arenaSettings->PrizeWeightWarp = v12;
    v13 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Gun", 60);
    if ( v13 > 255 )
      LOBYTE(v13) = -1;
    arenaSettings->PrizeWeightGun = v13;
    v14 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Bomb", 50);
    if ( v14 > 255 )
      LOBYTE(v14) = -1;
    arenaSettings->PrizeWeightBomb = v14;
    v15 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"BouncingBullets", 30);
    if ( v15 > 255 )
      LOBYTE(v15) = -1;
    arenaSettings->PrizeWeightBouncingBullets = v15;
    v16 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Thruster", 70);
    if ( v16 > 255 )
      LOBYTE(v16) = -1;
    arenaSettings->PrizeWeightThruster = v16;
    v17 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"TopSpeed", 70);
    if ( v17 > 255 )
      LOBYTE(v17) = -1;
    arenaSettings->PrizeWeightTopSpeed = v17;
    v18 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Recharge", 60);
    if ( v18 > 255 )
      LOBYTE(v18) = -1;
    arenaSettings->PrizeWeightRecharge = v18;
    v19 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"MultiFire", 30);
    if ( v19 > 255 )
      LOBYTE(v19) = -1;
    arenaSettings->PrizeWeightMultiFire = v19;
    v20 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Proximity", 30);
    if ( v20 > 255 )
      LOBYTE(v20) = -1;
    arenaSettings->PrizeWeightProximity = v20;
    v21 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Glue", 20);
    if ( v21 > 255 )
      LOBYTE(v21) = -1;
    arenaSettings->PrizeWeightGlue = v21;
    v22 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"AllWeapons", 10);
    if ( v22 > 255 )
      LOBYTE(v22) = -1;
    arenaSettings->PrizeWeightAllWeapons = v22;
    v23 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Shields", 10);
    if ( v23 > 255 )
      LOBYTE(v23) = -1;
    arenaSettings->PrizeWeightShields = v23;
    v24 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Shrapnel", 40);
    if ( v24 > 255 )
      LOBYTE(v24) = -1;
    arenaSettings->PrizeWeightShrapnel = v24;
    v25 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Repel", 40);
    if ( v25 > 255 )
      LOBYTE(v25) = -1;
    arenaSettings->PrizeWeightRepel = v25;
    v26 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Burst", 30);
    if ( v26 > 255 )
      LOBYTE(v26) = -1;
    arenaSettings->PrizeWeightBurst = v26;
    v27 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Decoy", 20);
    if ( v27 > 255 )
      LOBYTE(v27) = -1;
    arenaSettings->PrizeWeightDecoy = v27;
    v28 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Thor", 30);
    if ( v28 > 255 )
      LOBYTE(v28) = -1;
    arenaSettings->PrizeWeightThor = v28;
    v29 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Portal", 30);
    if ( v29 > 255 )
      LOBYTE(v29) = -1;
    arenaSettings->PrizeWeightPortal = v29;
    v30 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Brick", 10);
    if ( v30 > 255 )
      LOBYTE(v30) = -1;
    arenaSettings->PrizeWeightBrick = v30;
    v31 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"Rocket", 10);
    if ( v31 > 255 )
      LOBYTE(v31) = -1;
    arenaSettings->PrizeWeightRocket = v31;
    v32 = GetCFGSettingInteger(v4, "PrizeWeight", (int)"MultiPrize", 20);
    if ( v32 > 255 )
      LOBYTE(v32) = -1;
    arenaSettings->PrizeWeightMultiPrize = v32;
    Str2[0] = "Warbird";
    Str2[1] = "Javelin";
    Str2[2] = "Spider";
    Str2[3] = "Leviathan";
    Str2[4] = "Terrier";
    Str2[5] = "Weasel";
    Str2[6] = "Lancaster";
    Str2[7] = "Shark";
    for ( i = 0; i < 8; ++i )
    {
      v33 = Str2[i];
      v34 = &arenaSettings->ShipSettings[i];
      *(_DWORD *)&v34->SuperTime = GetCFGSettingInteger(v4, v33, (int)"SuperTime", 6000);
      *(_DWORD *)&v34->ShieldsTime = GetCFGSettingInteger(v4, v33, (int)"ShieldsTime", 4000);
      v34->Gravity = GetCFGSettingInteger(v4, v33, (int)"Gravity", 1500);
      v34->GravityTopSpeed = GetCFGSettingInteger(v4, v33, (int)"GravityTopSpeed", 100);
      v34->BulletFireEnergy = GetCFGSettingInteger(v4, v33, (int)"BulletFireEnergy", 20);
      v34->MultiFireEnergy = GetCFGSettingInteger(v4, v33, (int)"MultiFireEnergy", 30);
      v34->BombFireEnergy = GetCFGSettingInteger(v4, v33, (int)"BombFireEnergy", 300);
      v34->BombFireEnergyUpgrade = GetCFGSettingInteger(v4, v33, (int)"BombFireEnergyUpgrade", 50);
      v34->MineFireEnergy = GetCFGSettingInteger(v4, v33, (int)"LandmineFireEnergy", 300);
      v34->MineFireEnergyUpgrade = GetCFGSettingInteger(v4, v33, (int)"LandmineFireEnergyUpgrade", 150);
      v34->BulletSpeed = GetCFGSettingInteger(v4, v33, (int)"BulletSpeed", 2000);
      v34->BombSpeed = GetCFGSettingInteger(v4, v33, (int)"BombSpeed", 2000);
      v35 = -(i != 4);
      LOBYTE(v35) = v35 & 0xFB;
      v34->BulletFireDelay = GetCFGSettingInteger(v4, v33, (int)"BulletFireDelay", v35 + 30);
      v34->MultiFireDelay = GetCFGSettingInteger(v4, v33, (int)"MultiFireDelay", 50);
      v34->BombFireDelay = GetCFGSettingInteger(v4, v33, (int)"BombFireDelay", 150);
      v34->LandmineFireDelay = GetCFGSettingInteger(v4, v33, (int)"LandmineFireDelay", 125);
      v34->MultiFireAngleBits2 = GetCFGSettingInteger(v4, v33, (int)"MultiFireAngle", 500);
      v36 = -(i != 7);
      LOBYTE(v36) = v36 & 0x38;
      v34->CloakEnergy = GetCFGSettingInteger(v4, v33, (int)"CloakEnergy", v36 + 300);
      v34->StealthEnergy = GetCFGSettingInteger(v4, v33, (int)"StealthEnergy", i != 7 ? 333 : 300);
      v34->AntiWarpEnergy = GetCFGSettingInteger(v4, v33, (int)"AntiWarpEnergy", 100);
      v34->XRadarEnergy = GetCFGSettingInteger(v4, v33, (int)"XRadarEnergy", 250);
      if ( i )
      {
        if ( i == 7 )
          v49 = 280;
        else
          v49 = 230;
      }
      else
      {
        v49 = 300;
      }
      arenaSettings->ShipSettings[i].MaximumRotation = GetCFGSettingInteger(v4, v33, (int)"MaximumRotation", v49);
      if ( i == 7 || (v37 = 17, !i) )
        v37 = 19;
      arenaSettings->ShipSettings[i].MaximumThrust = GetCFGSettingInteger(v4, v33, (int)"MaximumThrust", v37);
      arenaSettings->ShipSettings[i].MaxmimumSpeed = GetCFGSettingInteger(
                                                       v4,
                                                       v33,
                                                       (int)"MaximumSpeed",
                                                       i != 1 ? 3250 : 3750);
      arenaSettings->ShipSettings[i].MaximumRecharge = GetCFGSettingInteger(v4, v33, (int)"MaximumRecharge", 1150);
      arenaSettings->ShipSettings[i].MaximumEnergy = GetCFGSettingInteger(
                                                       v4,
                                                       v33,
                                                       (int)"MaximumEnergy",
                                                       i != 7 ? 1700 : 1750);
      arenaSettings->ShipSettings[i].InitalRotation = GetCFGSettingInteger(
                                                        v4,
                                                        v33,
                                                        (int)"InitialRotation",
                                                        i != 0 ? 200 : 210);
      arenaSettings->ShipSettings[i].InitalThrust = GetCFGSettingInteger(v4, v33, (int)"InitialThrust", 16 - (i != 0));
      v38 = -(i != 1);
      LOBYTE(v38) = v38 & 0x42;
      arenaSettings->ShipSettings[i].InitalSpeed = GetCFGSettingInteger(v4, v33, (int)"InitialSpeed", v38 + 2200);
      arenaSettings->ShipSettings[i].InitialRecharge = GetCFGSettingInteger(
                                                         v4,
                                                         v33,
                                                         (int)"InitialRecharge",
                                                         i != 2 ? 400 : 500);
      arenaSettings->ShipSettings[i].InitialEnergy = GetCFGSettingInteger(v4, v33, (int)"InitialEnergy", 1000);
      arenaSettings->ShipSettings[i].UpgradeRotation = GetCFGSettingInteger(v4, v33, (int)"UpgradeRotation", 40);
      arenaSettings->ShipSettings[i].UpgradeThrust = GetCFGSettingInteger(v4, v33, (int)"UpgradeThrust", 2);
      arenaSettings->ShipSettings[i].UpgradeSpeed = GetCFGSettingInteger(v4, v33, (int)"UpgradeSpeed", 250);
      arenaSettings->ShipSettings[i].UpgradeRecharge = GetCFGSettingInteger(v4, v33, (int)"UpgradeRecharge", 166);
      arenaSettings->ShipSettings[i].UpgradeEnergy = GetCFGSettingInteger(v4, v33, (int)"UpgradeEnergy", 100);
      arenaSettings->ShipSettings[i].AfterburnerEnergy = GetCFGSettingInteger(v4, v33, (int)"AfterburnerEnergy", 1200);
      arenaSettings->ShipSettings[i].BombThrust = GetCFGSettingInteger(v4, v33, (int)"BombThrust", 400);
      arenaSettings->ShipSettings[i].BurstSpeed = GetCFGSettingInteger(v4, v33, (int)"BurstSpeed", 3000);
      arenaSettings->ShipSettings[i].BurstShrapnel = GetCFGSettingInteger(v4, v33, (int)"BurstShrapnel", 24);
      arenaSettings->ShipSettings[i].TurretThrustPenalty = GetCFGSettingInteger(v4, v33, (int)"TurretThrustPenalty", 1);
      arenaSettings->ShipSettings[i].TurretSpeedPenalty = GetCFGSettingInteger(v4, v33, (int)"TurretSpeedPenalty", 125);
      arenaSettings->ShipSettings[i].TurretLimit = GetCFGSettingInteger(v4, v33, (int)"TurretLimit", 5);
      arenaSettings->ShipSettings[i].RocketTime = GetCFGSettingInteger(v4, v33, (int)"RocketTime", 1000);
      arenaSettings->ShipSettings[i].InitialBounty = GetCFGSettingInteger(v4, v33, (int)"InitialBounty", 0);
      arenaSettings->ShipSettings[i].MaxMines = GetCFGSettingInteger(v4, v33, (int)"MaxMines", 5);
      arenaSettings->ShipSettings[i].RepelMax = GetCFGSettingInteger(v4, v33, (int)"RepelMax", 3);
      arenaSettings->ShipSettings[i].BurstMax = GetCFGSettingInteger(v4, v33, (int)"BurstMax", 3);
      arenaSettings->ShipSettings[i].DecoyMax = GetCFGSettingInteger(v4, v33, (int)"DecoyMax", 3);
      arenaSettings->ShipSettings[i].ThorMax = GetCFGSettingInteger(v4, v33, (int)"ThorMax", 3);
      arenaSettings->ShipSettings[i].BrickMax = GetCFGSettingInteger(v4, v33, (int)"BrickMax", 3);
      arenaSettings->ShipSettings[i].RocketMax = GetCFGSettingInteger(v4, v33, (int)"RocketMax", 3);
      arenaSettings->ShipSettings[i].PortalMax = GetCFGSettingInteger(v4, v33, (int)"PortalMax", 3);
      arenaSettings->ShipSettings[i].InitialRepel = GetCFGSettingInteger(v4, v33, (int)"InitialRepel", 0);
      arenaSettings->ShipSettings[i].InitialBurst = GetCFGSettingInteger(v4, v33, (int)"InitialBurst", 0);
      arenaSettings->ShipSettings[i].InitialBrick = GetCFGSettingInteger(v4, v33, (int)"InitialBrick", 0);
      arenaSettings->ShipSettings[i].InitialRocket = GetCFGSettingInteger(v4, v33, (int)"InitialRocket", 0);
      arenaSettings->ShipSettings[i].InitialThor = GetCFGSettingInteger(v4, v33, (int)"InitialThor", 0);
      arenaSettings->ShipSettings[i].InitialDecoy = GetCFGSettingInteger(v4, v33, (int)"InitialDecoy", i == 2);
      arenaSettings->ShipSettings[i].InitialPortal = GetCFGSettingInteger(v4, v33, (int)"InitialPortal", 0);
      arenaSettings->ShipSettings[i].BombBounceCount = GetCFGSettingInteger(v4, v33, (int)"BombBounceCount", i == 6);
      v39 = i == 2 || i == 7;
      v40 = GetCFGSettingInteger(v4, v33, (int)"CloakStatus", v39);
      v41 = arenaSettings->ShipSettings[i].LotsOfBitFields;
      BYTE1(v41) &= 0xF3u;
      arenaSettings->ShipSettings[i].LotsOfBitFields = v41 | ((v40 & 3) << 10);
      v42 = GetCFGSettingInteger(v4, v33, (int)"StealthStatus", (i == 2) + 1);
      v43 = arenaSettings->ShipSettings[i].LotsOfBitFields;
      BYTE1(v43) &= 0xCFu;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((v42 & 3) << 12) | v43;
      v44 = GetCFGSettingInteger(v4, v33, (int)"XRadarStatus", 1);
      v45 = arenaSettings->ShipSettings[i].LotsOfBitFields;
      BYTE1(v45) &= 0x3Fu;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((v44 & 3) << 14) | v45;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"AntiWarpStatus", 1) & 3) << 16) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFFFCFFFF;
      arenaSettings->ShipSettings[i].DamageFactor = GetCFGSettingInteger(v4, v33, (int)"DamageFactor", 30);
      arenaSettings->ShipSettings[i].PrizeShareLimit = GetCFGSettingInteger(v4, v33, (int)"PrizeShareLimit", 100);
      arenaSettings->ShipSettings[i].AttachBounty = GetCFGSettingInteger(v4, v33, (int)"AttachBounty", 12);
      arenaSettings->ShipSettings[i].LotsOfBitFields ^= ((unsigned __int8)GetCFGSettingInteger(
                                                                            v4,
                                                                            v33,
                                                                            (int)"ShrapnelMax",
                                                                            i != 5 ? 8 : 0) ^ (unsigned __int8)arenaSettings->ShipSettings[i].LotsOfBitFields) & 0x1F;
      arenaSettings->ShipSettings[i].LotsOfBitFields = (32
                                                      * (GetCFGSettingInteger(v4, v33, (int)"ShrapnelRate", 2) & 0x1F)) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFFFFFC1F;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"MaxGuns", 3) & 3) << 20) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFFCFFFFF;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"MaxBombs", (i == 3) + 2) & 3) << 24) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFCFFFFFF;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"InitialGuns", (i == 4) + 1) & 3) << 18) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFFF3FFFF;
      v46 = i == 3 || i == 5;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"InitialBombs", v46) & 3) << 22) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFF3FFFFF;
      arenaSettings->ShipSettings[i].LotsOfBitFields = arenaSettings->ShipSettings[i].LotsOfBitFields & 0xF7FFFFFF | ((GetCFGSettingInteger(v4, v33, (int)"EmpBomb", i == 5) & 1) << 27);
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"SeeMines", i == 5) & 1) << 28) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xEFFFFFFF;
      arenaSettings->ShipSettings[i].LotsOfBitFields = ((GetCFGSettingInteger(v4, v33, (int)"DoubleBarrel", i == 4) & 1) << 26) | arenaSettings->ShipSettings[i].LotsOfBitFields & 0xFBFFFFFF;
      arenaSettings->ShipSettings[i].SoccerBallFriction = GetCFGSettingInteger(v4, v33, (int)"SoccerBallFriction", 12);
      arenaSettings->ShipSettings[i].SoccerBallProximity = GetCFGSettingInteger(v4, v33, (int)"SoccerBallProximity", 64);
      arenaSettings->ShipSettings[i].SoccerThrowTime = GetCFGSettingInteger(v4, v33, (int)"SoccerThrowTime", 1200);
      arenaSettings->ShipSettings[i].SoccerBallSpeed = GetCFGSettingInteger(v4, v33, (int)"SoccerBallSpeed", 2500);
    }
    arenaSettings->BulletDamageLevel = 1000 * GetCFGSettingInteger(v4, "Bullet", (int)"BulletDamageLevel", 200);
    arenaSettings->BulletDamageUpgrade = 1000 * GetCFGSettingInteger(v4, "Bullet", (int)"BulletDamageUpgrade", 100);
    arenaSettings->BulletAliveTime = GetCFGSettingInteger(v4, "Bullet", (int)"BulletAliveTime", 550);
    arenaSettings->BombDamageLevel = 1000 * GetCFGSettingInteger(v4, "Bomb", (int)"BombDamageLevel", 750);
    arenaSettings->BombAliveTime = GetCFGSettingInteger(v4, "Bomb", (int)"BombAliveTime", 6000);
    arenaSettings->BombExplodeDelay = GetCFGSettingInteger(v4, "Bomb", (int)"BombExplodeDelay", 150);
    arenaSettings->BombExplodePixels = GetCFGSettingInteger(v4, "Bomb", (int)"BombExplodePixels", 80);
    arenaSettings->ProximityDistance = GetCFGSettingInteger(v4, "Bomb", (int)"ProximityDistance", 3);
    arenaSettings->JitterTime = GetCFGSettingInteger(v4, "Bomb", (int)"JitterTime", 72);
    arenaSettings->BombSafety = GetCFGSettingInteger(v4, "Bomb", (int)"BombSafety", 1);
    arenaSettings->EBombShutdownTime = GetCFGSettingInteger(v4, "Bomb", (int)"EBombShutdownTime", 400);
    arenaSettings->EBombDamagePercent = GetCFGSettingInteger(v4, "Bomb", (int)"EBombDamagePercent", 1000);
    arenaSettings->BBombDamagePercent = GetCFGSettingInteger(v4, "Bomb", (int)"BBombDamagePercent", 1000);
    arenaSettings->MineAliveTime = GetCFGSettingInteger(v4, "Mine", (int)"MineAliveTime", 12000);
    arenaSettings->TeamMaxMines = GetCFGSettingInteger(v4, "Mine", (int)"TeamMaxMines", 12);
    arenaSettings->ShrapnelSpeed = GetCFGSettingInteger(v4, "Shrapnel", (int)"ShrapnelSpeed", 3000);
    arenaSettings->InactiveShrapnelDamage = 1000 * GetCFGSettingInteger(v4, "Shrapnel", (int)"InactiveShrapDamage", 3);
    arenaSettings->ShrapnelDamagePercent = GetCFGSettingInteger(v4, "Shrapnel", (int)"ShrapnelDamagePercent", 1000);
    arenaSettings->RandomShrapnel = GetCFGSettingInteger(v4, "Shrapnel", (int)"Random", 1);
    arenaSettings->BurstDamageLevel = 1000 * GetCFGSettingInteger(v4, "Burst", (int)"BurstDamageLevel", 515);
    arenaSettings->AntiwarpPixels = GetCFGSettingInteger(v4, "Toggle", (int)"AntiWarpPixels", 1500);
    arenaSettings->MultiPrizeCount = GetCFGSettingInteger(v4, "Prize", (int)"MultiPrizeCount", 10);
    arenaSettings->PrizeFactor = GetCFGSettingInteger(v4, "Prize", (int)"PrizeFactor", 1000);
    arenaSettings->PrizeDelay = GetCFGSettingInteger(v4, "Prize", (int)"PrizeDelay", 300);
    arenaSettings->PrizeHideCount = GetCFGSettingInteger(v4, "Prize", (int)"PrizeHideCount", 30);
    arenaSettings->PrizeMinimumVirtual = GetCFGSettingInteger(v4, "Prize", (int)"MinimumVirtual", 256);
    arenaSettings->PrizeUpgradeVirtual = GetCFGSettingInteger(v4, "Prize", (int)"UpgradeVirtual", 6);
    arenaSettings->PrizeMaxExist = GetCFGSettingInteger(v4, "Prize", (int)"PrizeMaxExist", 8000);
    arenaSettings->PrizeMinExist = GetCFGSettingInteger(v4, "Prize", (int)"PrizeMinExist", 4000);
    arenaSettings->PrizeNegativeFactor = GetCFGSettingInteger(v4, "Prize", (int)"PrizeNegativeFactor", 300);
    arenaSettings->DeathPrizeTime = GetCFGSettingInteger(v4, "Prize", (int)"DeathPrizeTime", 800);
    arenaSettings->EngineShutdownTime = GetCFGSettingInteger(v4, "Prize", (int)"EngineShutdownTime", 700);
    arenaSettings->TakePrizeReliable = GetCFGSettingInteger(v4, "Prize", (int)"TakePrizeReliable", 0);
    arenaSettings->FlaggerOnRadar = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerOnRadar", 1);
    arenaSettings->FlaggerKillMultiplier = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerKillMultiplier", 2);
    arenaSettings->FlaggerGunUpgrade = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerGunUpgrade", 0);
    arenaSettings->FlaggerBombUpgrade = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerBombUpgrade", 0);
    arenaSettings->FlaggerFireCostPercent = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerFireCostPercent", 1000);
    arenaSettings->FlaggerDamagePercent = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerDamagePercent", 1000);
    arenaSettings->FlaggerBombFireDelay = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerBombFireDelay", 0);
    arenaSettings->FlaggerSpeedAdjustment = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerSpeedAdjustment", 0);
    arenaSettings->FlaggerThrustAdjustment = GetCFGSettingInteger(v4, "Flag", (int)"FlaggerThrustAdjustment", 0);
    arenaSettings->CarryFlags = GetCFGSettingInteger(v4, "Flag", (int)"CarryFlags", 1);
    arenaSettings->FlagDropDelay = GetCFGSettingInteger(v4, "Flag", (int)"FlagDropDelay", 0);
    arenaSettings->FlagDropResetReward = GetCFGSettingInteger(v4, "Flag", (int)"FlagDropResetReward", 0);
    arenaSettings->EnterGameFlaggingDelay = GetCFGSettingInteger(v4, "Flag", (int)"EnterGameFlaggingDelay", 12000);
    arenaSettings->FlagBlankDelay = GetCFGSettingInteger(v4, "Flag", (int)"FlagBlankDelay", 200);
    arenaSettings->NoDataFlagDropDelay = GetCFGSettingInteger(v4, "Flag", (int)"NoDataFlagDropDelay", 500);
    arenaSettings->SoccerBallBounce = GetCFGSettingInteger(v4, "Soccer", (int)"BallBounce", 1);
    arenaSettings->SoccerAllowBombs = GetCFGSettingInteger(v4, "Soccer", (int)"AllowBombs", 1);
    arenaSettings->SoccerAllowGuns = GetCFGSettingInteger(v4, "Soccer", (int)"AllowGuns", 1);
    arenaSettings->SoccerPassDelay = GetCFGSettingInteger(v4, "Soccer", (int)"PassDelay", 20);
    arenaSettings->SoccerMode = GetCFGSettingInteger(v4, "Soccer", (int)"Mode", 1);
    arenaSettings->SoccerBallBlankDelay = GetCFGSettingInteger(v4, "Soccer", (int)"BallBlankDelay", 200);
    arenaSettings->SoccerUseFlagger = GetCFGSettingInteger(v4, "Soccer", (int)"UseFlagger", 0);
    arenaSettings->SoccerBallLocation = GetCFGSettingInteger(v4, "Soccer", (int)"BallLocation", 0);
    arenaSettings->RadarMode = GetCFGSettingInteger(v4, "Radar", (int)"RadarMode", 0);
    arenaSettings->RadarNeutralSize = GetCFGSettingInteger(v4, "Radar", (int)"RadarNeutralSize", 128);
    arenaSettings->MapZoomFactor = GetCFGSettingInteger(v4, "Radar", (int)"MapZoomFactor", 10);
    arenaSettings->MaxFrequency = GetCFGSettingInteger(v4, "Team", (int)"MaxFrequency", 9999);
    arenaSettings->MaxPerTeam = GetCFGSettingInteger(v4, "Team", (int)"MaxPerTeam", 6);
    arenaSettings->MaxPerPrivateTeam = GetCFGSettingInteger(v4, "Team", (int)"MaxPerPrivateTeam", 0);
    arenaSettings->MaxBonus = GetCFGSettingInteger(v4, "Kill", (int)"MaxBonus", 0);
    arenaSettings->MaxPenalty = GetCFGSettingInteger(v4, "Kill", (int)"MaxPenalty", 0);
    arenaSettings->RewardBase = GetCFGSettingInteger(v4, "Kill", (int)"RewardBase", 0);
    arenaSettings->BountyIncreaseForKill = GetCFGSettingInteger(v4, "Kill", (int)"BountyIncreaseForKill", 6);
    arenaSettings->EnterDelay = GetCFGSettingInteger(v4, "Kill", (int)"EnterDelay", 200);
    arenaSettings->RepelSpeed = GetCFGSettingInteger(v4, "Repel", (int)"RepelSpeed", 5000);
    arenaSettings->RepelTime = GetCFGSettingInteger(v4, "Repel", (int)"RepelTime", 225);
    arenaSettings->RepelDistance = GetCFGSettingInteger(v4, "Repel", (int)"RepelDistance", 512);
    arenaSettings->MessageReliable = GetCFGSettingInteger(v4, "Message", (int)"MessageReliable", 0);
    arenaSettings->AllowAudioMessages = GetCFGSettingInteger(v4, "Message", (int)"AllowAudioMessages", 1);
    arenaSettings->WormholeGravityBombs = GetCFGSettingInteger(v4, "Wormhole", (int)"GravityBombs", 1);
    arenaSettings->WormholeSwitchTime = GetCFGSettingInteger(v4, "Wormhole", (int)"SwitchTime", 0);
    arenaSettings->SendRoutePercent = GetCFGSettingInteger(v4, "Latency", (int)"SendRoutePercent", 500);
    arenaSettings->ClientSlowPacketSampleSize = GetCFGSettingInteger(
                                                  v4,
                                                  "Latency",
                                                  (int)"ClientSlowPacketSampleSize",
                                                  100);
    arenaSettings->BrickTime = GetCFGSettingInteger(v4, "Brick", (int)"BrickTime", 12000);
    arenaSettings->RocketThrust = GetCFGSettingInteger(v4, "Rocket", (int)"RocketThrust", 25);
    arenaSettings->RocketSpeed = GetCFGSettingInteger(v4, "Rocket", (int)"RocketSpeed", 5500);
    arenaSettings->DoorDelay = GetCFGSettingInteger(v4, "Door", (int)"DoorDelay", 400);
    arenaSettings->DoorMode = GetCFGSettingInteger(v4, "Door", (int)"DoorMode", -1);
    arenaSettings->WarpPointDelay = GetCFGSettingInteger(v4, "Misc", (int)"WarpPointDelay", 6000);
    arenaSettings->DecoyAliveTime = GetCFGSettingInteger(v4, "Misc", (int)"DecoyAliveTime", 3000);
    arenaSettings->BounceFactor = GetCFGSettingInteger(v4, "Misc", (int)"BounceFactor", 22);
    arenaSettings->SendPositionDelay = GetCFGSettingInteger(v4, "Misc", (int)"SendPositionDelay", 10);
    arenaSettings->SlowFrameCheck = GetCFGSettingInteger(v4, "Misc", (int)"SlowFrameCheck", 0);
    arenaSettings->AllowSavedShip = GetCFGSettingInteger(v4, "Misc", (int)"AllowSavedShips", 1);
    arenaSettings->SafetyLimit = GetCFGSettingInteger(v4, "Misc", (int)"SafetyLimit", 90000);
    arenaSettings->FrequencyShift = GetCFGSettingInteger(v4, "Misc", (int)"FrequencyShift", 900);
    arenaSettings->HelpTickerDelay = GetCFGSettingInteger(v4, "Misc", (int)"TickerDelay", 1000);
    arenaSettings->ExtraPositionData = GetCFGSettingInteger(v4, "Misc", (int)"ExtraPositionData", 0);
    arenaSettings->WarpRadiusLimit = GetCFGSettingInteger(v4, "Misc", (int)"WarpRadiusLimit", 1024);
    arenaSettings->ActivateAppShutdownTime = GetCFGSettingInteger(v4, "Misc", (int)"ActivateAppShutdownTime", 1500);
    arenaSettings->NearDeathLevel = GetCFGSettingInteger(v4, "Misc", (int)"NearDeathLevel", 0);
    arenaSettings->VictoryMusic = GetCFGSettingInteger(v4, "Misc", (int)"VictoryMusic", 1);
    arenaSettings->ClientSlowPacketTime = GetCFGSettingInteger(v4, "Latency", (int)"ClientSlowPacketTime", 40);
    result = (struc_2 *)GetCFGSettingInteger(v4, "Latency", (int)"S2CNoDataKickoutDelay", 500);
    arenaSettings->S2CNoDataKickoutDelay = (_WORD)result;
  }
  if ( serverArenaSettings )
  {
    serverArenaSettings->CustomSaveStatsTime = GetCFGSettingInteger(v4, "Custom", (int)"SaveStatsTime", 720000);
    serverArenaSettings->TerritoryRewardDelay = GetCFGSettingInteger(v4, "Territory", (int)"RewardDelay", 60000);
    serverArenaSettings->TerritoryRewardBaseFlags = GetCFGSettingInteger(v4, "Territory", (int)"RewardBaseFlags", 8);
    serverArenaSettings->TerritoryRewardMinimumPlayers = GetCFGSettingInteger(
                                                           v4,
                                                           "Territory",
                                                           (int)"RewardMinimumPlayers",
                                                           5);
    serverArenaSettings->TerritoryRewardPoints = GetCFGSettingInteger(v4, "Territory", (int)"RewardPoints", 30);
    serverArenaSettings->PeriodicRewardDelay = GetCFGSettingInteger(v4, "Periodic", (int)"RewardDelay", 0);
    serverArenaSettings->PeriodicRewardMinimumPlayers = GetCFGSettingInteger(
                                                          v4,
                                                          "Periodic",
                                                          (int)"RewardMinimumPlayers",
                                                          16);
    serverArenaSettings->PeriodicRewardPoints = GetCFGSettingInteger(v4, "Periodic", (int)"RewardPoints", 50);
    serverArenaSettings->FlagMode = GetCFGSettingInteger(v4, "Flag", (int)"FlagMode", 0);
    serverArenaSettings->FlagResetDelay = GetCFGSettingInteger(v4, "Flag", (int)"FlagResetDelay", 1440000);
    serverArenaSettings->MaxFlags = GetCFGSettingInteger(v4, "Flag", (int)"MaxFlags", 16);
    serverArenaSettings->RandomFlags = GetCFGSettingInteger(v4, "Flag", (int)"RandomFlags", 0);
    serverArenaSettings->FlagReward = GetCFGSettingInteger(v4, "Flag", (int)"FlagReward", 1000);
    serverArenaSettings->FlagRewardMode = GetCFGSettingInteger(v4, "Flag", (int)"FlagRewardMode", 0);
    serverArenaSettings->FlagTerritoryRadius = GetCFGSettingInteger(v4, "Flag", (int)"FlagTerritoryRadius", 8);
    serverArenaSettings->FlagTerritoryRadiusCentroid = GetCFGSettingInteger(
                                                         v4,
                                                         "Flag",
                                                         (int)"FlagTerritoryRadiusCentroid",
                                                         0);
    serverArenaSettings->FlagFriendlyTransfer = GetCFGSettingInteger(v4, "Flag", (int)"FriendlyTransfer", 1);
    serverArenaSettings->KillPointsPerFlag = GetCFGSettingInteger(v4, "Kill", (int)"KillPointsPerFlag", 0);
    serverArenaSettings->KillPointsMinimumBounty = GetCFGSettingInteger(v4, "Kill", (int)"KillPointsMinimumBounty", 50);
    serverArenaSettings->KillDebtKills = GetCFGSettingInteger(v4, "Kill", (int)"DebtKills", 0);
    serverArenaSettings->KillNoRewardKillDelay = GetCFGSettingInteger(v4, "Kill", (int)"NoRewardKillDelay", 0);
    serverArenaSettings->KillBountyRewardPercent = GetCFGSettingInteger(v4, "Kill", (int)"BountyRewardPercent", 0);
    serverArenaSettings->KillFixedKillReward = GetCFGSettingInteger(v4, "Kill", (int)"FixedKillReward", -1);
    serverArenaSettings->KillJackpotBountyPercent = GetCFGSettingInteger(v4, "Kill", (int)"JackpotBountyPercent", 0);
    serverArenaSettings->TeamForceEvenTeams = GetCFGSettingInteger(v4, "Team", (int)"ForceEvenTeams", 0);
    serverArenaSettings->TeamDesiredTeams = GetCFGSettingInteger(v4, "Team", (int)"DesiredTeams", 2);
    serverArenaSettings->TeamSpectatorFrequency = GetCFGSettingInteger(v4, "Team", (int)"SpectatorFrequency", 8025);
    serverArenaSettings->BrickSpan = GetCFGSettingInteger(v4, "Brick", (int)"BrickSpan", 7);
    serverArenaSettings->MiscFrequencyShipTypes = GetCFGSettingInteger(v4, "Misc", (int)"FrequencyShipTypes", 0);
    serverArenaSettings->MiscBannerPoints = GetCFGSettingInteger(v4, "Misc", (int)"BannerPoints", 5000);
    serverArenaSettings->MiscMaxLossesToPlay = GetCFGSettingInteger(v4, "Misc", (int)"MaxLossesToPlay", 0);
    serverArenaSettings->MiscSpectatorQuiet = GetCFGSettingInteger(v4, "Misc", (int)"SpectatorQuiet", 0);
    serverArenaSettings->MiscTimedGame = GetCFGSettingInteger(v4, "Misc", (int)"TimedGame", 0);
    GetCFGSettingString(
      v4,
      "Misc",
      (int)"SheepMessage",
      "Sheep successfully cloned -- hello Dolly",
      serverArenaSettings->MiscSheepMessage,
      0x100u);
    serverArenaSettings->MiscResetScoreOnFrequencyChange = GetCFGSettingInteger(
                                                             v4,
                                                             "Misc",
                                                             (int)"ResetScoreOnFrequencyChange",
                                                             0);
    serverArenaSettings->MiscMaxPlaying = GetCFGSettingInteger(v4, "Misc", (int)"MaxPlaying", 0);
    serverArenaSettings->MessageBongAllowed = GetCFGSettingInteger(v4, "Message", (int)"BongAllowed", 0);
    serverArenaSettings->MessageQuickMessageLimit = GetCFGSettingInteger(v4, "Message", (int)"QuickMessageLimit", 8);
    serverArenaSettings->MessageReliable = GetCFGSettingInteger(v4, "Message", (int)"MessageReliable", 0);
    serverArenaSettings->MessageTeamReliable = GetCFGSettingInteger(v4, "Message", (int)"MessageTeamReliable", 1);
    serverArenaSettings->MessageDistance = GetCFGSettingInteger(v4, "Message", (int)"MessageDistance", 17000);
    serverArenaSettings->dwordB4 = 1;
    serverArenaSettings->SecurityS2CKickOutPercentWeapons = GetCFGSettingInteger(
                                                              v4,
                                                              "Security",
                                                              (int)"S2CKickOutPercentWeapons",
                                                              700);
    serverArenaSettings->SecuritySuicideLimit = GetCFGSettingInteger(v4, "Security", (int)"SuicideLimit", 10);
    serverArenaSettings->SecurityMaxShipTypeSwitchCount = GetCFGSettingInteger(
                                                            v4,
                                                            "Security",
                                                            (int)"MaxShipTypeSwitchCount",
                                                            40);
    serverArenaSettings->SecurityPacketModificationMax = GetCFGSettingInteger(
                                                           v4,
                                                           "Security",
                                                           (int)"PacketModificationMax",
                                                           3);
    serverArenaSettings->SecurityMaxDeathWithoutFiring = GetCFGSettingInteger(
                                                           v4,
                                                           "Security",
                                                           (int)"MaxDeathWithoutFiring",
                                                           5);
    serverArenaSettings->PacketLossC2SKickOutPercent = GetCFGSettingInteger(
                                                         v4,
                                                         "PacketLoss",
                                                         (int)"C2SKickOutPercent",
                                                         800);
    serverArenaSettings->PacketLossC2SNegativeKickOutPercent = GetCFGSettingInteger(
                                                                 v4,
                                                                 "PacketLoss",
                                                                 (int)"C2SNegativeKickOutPercent",
                                                                 50);
    serverArenaSettings->PacketLossS2CKickOutPercent = GetCFGSettingInteger(
                                                         v4,
                                                         "PacketLoss",
                                                         (int)"S2CKickOutPercent",
                                                         800);
    serverArenaSettings->PacketLossSpectatorPercentAdjust = GetCFGSettingInteger(
                                                              v4,
                                                              "PacketLoss",
                                                              (int)"SpectatorPercentAdjust",
                                                              100);
    serverArenaSettings->PacketLossDisableWeapons = GetCFGSettingInteger(
                                                      v4,
                                                      "PacketLoss",
                                                      (int)"PacketLossDisableWeapons",
                                                      1);
    serverArenaSettings->LatencyKickOutDelay = GetCFGSettingInteger(v4, "Latency", (int)"KickOutDelay", 1000);
    serverArenaSettings->LatencyNoFlagDelay = GetCFGSettingInteger(v4, "Latency", (int)"NoFlagDelay", 300);
    serverArenaSettings->LatencyNoFlagPenalty = GetCFGSettingInteger(v4, "Latency", (int)"NoFlagPenalty", 1000);
    serverArenaSettings->LatencySlowPacketKickoutPercent = GetCFGSettingInteger(
                                                             v4,
                                                             "Latency",
                                                             (int)"SlowPacketKickoutPercent",
                                                             200);
    serverArenaSettings->LatencyClientSlowPacketKickoutPercent = GetCFGSettingInteger(
                                                                   v4,
                                                                   "Latency",
                                                                   (int)"ClientSlowPacketKickoutPercent",
                                                                   200);
    serverArenaSettings->LatencySlowPacketTime = GetCFGSettingInteger(v4, "Latency", (int)"SlowPacketTime", 50);
    serverArenaSettings->LatencySlowPacketSampleSize = GetCFGSettingInteger(
                                                         v4,
                                                         "Latency",
                                                         (int)"SlowPacketSampleSize",
                                                         300);
    serverArenaSettings->LatencyMaxLatencyForWeapons = GetCFGSettingInteger(
                                                         v4,
                                                         "Latency",
                                                         (int)"MaxLatencyForWeapons",
                                                         45);
    serverArenaSettings->LatencyMaxLatencyForPrizes = GetCFGSettingInteger(
                                                        v4,
                                                        "Latency",
                                                        (int)"MaxLatencyForPrizes",
                                                        80);
    serverArenaSettings->LatencyMaxLatencyForKickOut = GetCFGSettingInteger(
                                                         v4,
                                                         "Latency",
                                                         (int)"MaxLatencyForKickOut",
                                                         120);
    serverArenaSettings->LatencyKickOutTime = GetCFGSettingInteger(v4, "Latency", (int)"LatencyKickOutTime", 2200);
    serverArenaSettings->LatencyCutbackWatermark = GetCFGSettingInteger(v4, "Latency", (int)"CutbackWatermark", 2400);
    serverArenaSettings->PrizeS2CTakePrizeReliable = GetCFGSettingInteger(v4, "Prize", (int)"S2CTakePrizeReliable", 0);
    serverArenaSettings->RoutingRadarFavor = GetCFGSettingInteger(v4, "Routing", (int)"RadarFavor", 3);
    serverArenaSettings->RoutingCloseEnoughBulletAdjust = GetCFGSettingInteger(
                                                            v4,
                                                            "Routing",
                                                            (int)"CloseEnoughBulletAdjust",
                                                            512);
    serverArenaSettings->RoutingCloseEnoughBombAdjust = GetCFGSettingInteger(
                                                          v4,
                                                          "Routing",
                                                          (int)"CloseEnoughBombAdjust",
                                                          2048);
    serverArenaSettings->RoutingDeathDistance = GetCFGSettingInteger(v4, "Routing", (int)"DeathDistance", 2800);
    serverArenaSettings->RoutingDoubleSendPercent = GetCFGSettingInteger(v4, "Routing", (int)"DoubleSendPercent", 880);
    serverArenaSettings->RoutingWallResendCount = GetCFGSettingInteger(v4, "Routing", (int)"WallResendCount", 2);
    serverArenaSettings->SoccerBallCount = GetCFGSettingInteger(v4, "Soccer", (int)"BallCount", 0);
    serverArenaSettings->SoccerSendTime = GetCFGSettingInteger(v4, "Soccer", (int)"SendTime", 200);
    serverArenaSettings->SoccerReward = GetCFGSettingInteger(v4, "Soccer", (int)"Reward", 1000);
    serverArenaSettings->SoccerCapturePoints = GetCFGSettingInteger(v4, "Soccer", (int)"CapturePoints", 0);
    serverArenaSettings->SoccerCatchMinimum = GetCFGSettingInteger(v4, "Soccer", (int)"CatchMinimum", 12);
    serverArenaSettings->SoccerCatchPoints = GetCFGSettingInteger(v4, "Soccer", (int)"CatchPoints", 0);
    serverArenaSettings->SoccerWinBy = GetCFGSettingInteger(v4, "Soccer", (int)"WinBy", 0);
    serverArenaSettings->KingDeathCount = GetCFGSettingInteger(v4, "King", (int)"DeathCount", 0);
    serverArenaSettings->KingExpireTime = GetCFGSettingInteger(v4, "King", (int)"ExpireTime", 30000);
    serverArenaSettings->KingRewardFactor = GetCFGSettingInteger(v4, "King", (int)"RewardFactor", 1000);
    serverArenaSettings->KingNonCrownAdjustTime = GetCFGSettingInteger(v4, "King", (int)"NonCrownAdjustTime", 3000);
    serverArenaSettings->KingNonCrownMinimumBounty = GetCFGSettingInteger(v4, "King", (int)"NonCrownMinimumBounty", 100);
    serverArenaSettings->KingCrownRecoverKills = GetCFGSettingInteger(v4, "King", (int)"CrownRecoverKills", 3);
    memset(serverArenaSettings->char158, 0, 0x240u);
    strcpy(serverArenaSettings->char158, "Recharge");
    serverArenaSettings->dword16C = 1;
    strcpy(serverArenaSettings->char170, "Energy");
    serverArenaSettings->dword184 = 2;
    strcpy(serverArenaSettings->char188, "Rotation");
    serverArenaSettings->dword19C = 3;
    strcpy(serverArenaSettings->char1A0, "Stealth");
    serverArenaSettings->dword1B4 = 4;
    strcpy(serverArenaSettings->char1B8, "Cloak");
    serverArenaSettings->dword1CC = 5;
    strcpy(serverArenaSettings->char1D0, "XRadar");
    serverArenaSettings->dword1E4 = 6;
    strcpy(serverArenaSettings->char1E8, "Gun");
    serverArenaSettings->dword1FC = 8;
    strcpy(serverArenaSettings->char200, "Bomb");
    serverArenaSettings->dword214 = 9;
    strcpy(serverArenaSettings->char218, "Bounce");
    serverArenaSettings->dword22C = 10;
    strcpy(serverArenaSettings->char230, "Thrust");
    serverArenaSettings->dword244 = 11;
    strcpy(serverArenaSettings->char248, "Speed");
    serverArenaSettings->dword25C = 12;
    strcpy(serverArenaSettings->char260, "MultiFire");
    serverArenaSettings->dword274 = 15;
    strcpy(serverArenaSettings->char278, "Prox");
    serverArenaSettings->dword28C = 16;
    strcpy(serverArenaSettings->char290, "Super");
    serverArenaSettings->dword2A4 = 17;
    strcpy(serverArenaSettings->char2A8, "Shield");
    serverArenaSettings->dword2BC = 18;
    strcpy(serverArenaSettings->char2C0, "Shrap");
    serverArenaSettings->dword2D4 = 19;
    strcpy(serverArenaSettings->char2D8, "AntiWarp");
    serverArenaSettings->dword2EC = 20;
    strcpy(serverArenaSettings->char2F0, "Repel");
    serverArenaSettings->dword304 = 21;
    strcpy(serverArenaSettings->char308, "Burst");
    serverArenaSettings->dword31C = 22;
    strcpy(serverArenaSettings->char320, "Decoy");
    serverArenaSettings->dword334 = 23;
    strcpy(serverArenaSettings->char338, "Thor");
    serverArenaSettings->dword34C = 24;
    strcpy(serverArenaSettings->char350, "Brick");
    serverArenaSettings->dword364 = 26;
    strcpy(serverArenaSettings->char368, "Rocket");
    serverArenaSettings->dword37C = 27;
    strcpy(serverArenaSettings->char380, "Portal");
    serverArenaSettings->dword394 = 28;
    v47 = &serverArenaSettings->char158[16];
    v48 = 24;
    do
    {
      *(_DWORD *)v47 = GetCFGSettingInteger(v4, "Cost", (int)(v47 - 16), 0);
      v47 += 24;
      --v48;
    }
    while ( v48 );
    serverArenaSettings->CostPurchaseAnytime = GetCFGSettingInteger(v4, "Cost", (int)"PurchaseAnytime", 0);
    serverArenaSettings->OwnerUserId = GetCFGSettingInteger(v4, "Owner", (int)"UserId", -1);
    result = (struc_2 *)GetCFGSettingString(v4, "Owner", (int)"Name", "None", serverArenaSettings->OwnerName, 0x20u);
  }
  if ( v4 )
  {
    WriteCfgFile((int)v4);
    result = (struc_2 *)operator delete(v4);
  }
  return result;
}

//----- (00411D70) --------------------------------------------------------
int __cdecl SoccerRelatedMath(int SoccerMode, int a2, signed int a3)
{
  int result; // eax

  switch ( SoccerMode )
  {
    case 1:
      result = a2 >= 512;
      break;
    case 2:
      result = a3 >= 512;
      break;
    case 3:
    case 4:
      if ( a2 >= 512 )
        result = a3 >= 512 ? 3 : 1;
      else
        result = a3 >= 512 ? 2 : 0;
      break;
    case 5:
    case 6:
      if ( a2 >= a3 )
        result = (a2 >= 1024 - a3) + 2;
      else
        result = a2 >= 1024 - a3;
      break;
    default:
      result = 0;
      break;
  }
  return result;
}

//----- (00411E30) --------------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  const char *v3; // eax
  char *v4; // eax
  char *v6; // eax
  unsigned int v7; // ecx
  char v8; // al
  char *v9; // edi
  char *v10; // edx
  char *v11; // eax
  unsigned int v12; // kr04_4
  char *v13; // edi
  char *v14; // esi
  char v15; // cl
  char *v16; // edx
  unsigned int v17; // eax
  int v18; // edi
  const char **v19; // esi
  int v20; // [esp+0h] [ebp-70h] BYREF
  struct _STARTUPINFOA StartupInfo; // [esp+Ch] [ebp-64h] BYREF
  struct _PROCESS_INFORMATION ProcessInformation; // [esp+50h] [ebp-20h] BYREF
  int *v23; // [esp+60h] [ebp-10h]
  int v24; // [esp+6Ch] [ebp-4h]

  v23 = &v20;
  v3 = GetCommandLineA();
  v4 = strstr(v3, "/SPAWN");
  if ( v4 )
    return RunCommandPrompt(v4 + 7);
  GetModuleFileNameA(0, FileName, 0x100u);
  v6 = strrchr(FileName, 92);
  if ( v6 )
  {
    v10 = v6 + 1;
    v7 = strlen("server.ini") + 1;
    v8 = v7;
    v9 = v10;
  }
  else
  {
    v7 = strlen("server.ini") + 1;
    v8 = v7;
    v9 = FileName;
  }
  qmemcpy(v9, "server.ini", 4 * (v7 >> 2) + (v8 & 3));
  GetModuleFileNameA(0, Filename2, 0x100u);
  v11 = strrchr(Filename2, 92);
  if ( v11 )
  {
    v16 = v11 + 1;
    v17 = strlen("server.cfg") + 1;
    qmemcpy(v16, "server.cfg", 4 * (v17 >> 2));
    v14 = &MEMORY[0x42A098][4 * (v17 >> 2)];
    v13 = &v16[4 * (v17 >> 2)];
    v15 = v17;
  }
  else
  {
    v12 = strlen("server.cfg") + 1;
    qmemcpy(Filename2, "server.cfg", 4 * (v12 >> 2));
    v14 = &MEMORY[0x42A098][4 * (v12 >> 2)];
    v13 = &Filename2[4 * (v12 >> 2)];
    v15 = v12;
  }
  qmemcpy(v13, v14, v15 & 3);
  if ( argc > 1 )
  {
    v18 = argc - 1;
    v19 = argv + 1;
    do
    {
      if ( !_strcmpi(*v19, "/nb") )
        dword_42C840 = 0;
      ++v19;
      --v18;
    }
    while ( v18 );
  }
  ShutdownArguments = 0;
  nullsub_1();
  IsServerRunning = 0;
  while ( !IsServerRunning )
  {
    ServerInitialize();
    v24 = 0;
    ServerMainLoop();
    v24 = -1;
    ServerUninitialize();
  }
  nullsub_1();
  if ( ShutdownArguments )
  {
    memset(&StartupInfo, 0, sizeof(StartupInfo));
    StartupInfo.cb = 68;
    StartupInfo.lpTitle = "Spawned Command";
    CreateProcessA(0, &ShutdownArguments, 0, 0, 0, 0x210u, 0, 0, &StartupInfo, &ProcessInformation);
  }
  return 0;
}
// 408300: using guessed type int nullsub_1(void);
// 42C840: using guessed type int dword_42C840;
// 437CA8: using guessed type int IsServerRunning;

//----- (00412060) --------------------------------------------------------
int __cdecl ServerInitialize()
{
  int v0; // eax
  int v1; // edi
  ARENA **v2; // esi
  SERVER_BIG_ARRAY *v3; // eax
  FILE *v4; // eax
  FILE *v5; // esi
  int v6; // eax
  struct TEXT_FILE_STRUCT *v7; // eax
  int v8; // eax
  struct TEXT_FILE_STRUCT *v9; // eax
  int v10; // eax
  DWORD v11; // esi
  int v12; // ebx
  void *v13; // eax
  void *v14; // eax
  DWORD v15; // esi
  int v16; // eax
  void *v17; // ebx
  void *v18; // eax
  void *v19; // eax
  int v20; // eax
  void *v21; // eax
  void *v22; // eax
  void *v23; // esi
  SOCKET *v24; // eax
  void *v25; // eax
  char *v26; // esi
  SOCKET *v27; // eax
  int v28; // eax
  struct TEXT_FILE_STRUCT *v29; // eax
  const CHAR *v30; // eax
  struct TEXT_FILE_STRUCT *v31; // eax
  const CHAR *v32; // eax
  struct TEXT_FILE_STRUCT *v33; // eax
  const CHAR *v34; // eax
  struct TEXT_FILE_STRUCT *v35; // eax
  const CHAR *v36; // eax
  struct TEXT_FILE_STRUCT *v37; // eax
  const CHAR *v38; // eax
  PINGSOCKET *v39; // eax
  PINGSOCKET *v40; // eax
  void *v41; // eax
  void *v42; // eax
  int v44; // [esp+14h] [ebp-428h]
  int v45; // [esp+18h] [ebp-424h] BYREF
  int v46[4]; // [esp+1Ch] [ebp-420h] BYREF
  char v47; // [esp+2Ch] [ebp-410h]
  CHAR cp[512]; // [esp+30h] [ebp-40Ch] BYREF
  int Src[128]; // [esp+230h] [ebp-20Ch] BYREF
  int v50; // [esp+438h] [ebp-4h]

  ShutdownArguments = 0;
  RecycleServer = 0;
  fileHandle = fopen("subgame.log", "wt");
  WriteSubGameLog("SubSpace Game Server f%d.%02d%c\n", 1, 34, 98);
  if ( fileHandle )
  {
    fclose(fileHandle);
    fileHandle = 0;
  }
  v0 = clock();
  setRNGSeed(v0);
  memset(LogArray, 0, sizeof(LogArray));
  memset(ZonePlayerList, 0, sizeof(ZonePlayerList));
  memset(ChatRelatedArray, 0, sizeof(ChatRelatedArray));
  MachineIdArrayIndex = 0;
  CurrentLogLine = 0;
  ZonePlayerCount = 0;
  IncreasesRadarValueSomeHow = 0;
  dword_4D55D0 = 0;
  dword_4C8F38 = 0;
  PointsFileHandle = 0;
  dword_4D8AFC = 0;
  dword_4D8B00 = 0;
  dword_4D8B04 = 0;
  ChatCounter64Max = 0;
  LoadWinsock();
  IsFileLastWrittenTime(FileName, (int)&LastTimeServerINIWasEdited);
  ReadServerINI();
  IsFileLastWrittenTime(Filename2, (int)&LastTimeMasterCFGWasEdited);
  LoadZoneCFGSettings(&ArenaSettings, &ServersideArenaSettings, Filename2);
  v1 = 0;
  if ( ArenaArrayLength > 0 )
  {
    v2 = Arenas;
    do
    {
      if ( !_strcmpi((*v2)->szConfigFile, Filename2) )
        (*v2)->playerPointersForSomething[250] = (PLAYER *)1;
      ++v1;
      ++v2;
    }
    while ( v1 < ArenaArrayLength );
  }
  LoadTemplateSSS();
  LoadMapSomething();
  LoadAdvertisements();
  v46[0] = 16;
  v46[1] = 0;
  v46[2] = 0;
  v46[3] = 0;
  v44 = 0;
  v47 = 0;
  memset(Security, 0, sizeof(Security));
  do
  {
    if ( v44 )
    {
      sprintf((char *)Src, "version%d\\", v44);
    }
    else if ( _access("version0", 0) == -1 )
    {
      LOBYTE(Src[0]) = 0;
    }
    else
    {
      sprintf((char *)Src, "version%d\\", 0);
    }
    v3 = &Security[v44];
    *(_DWORD *)&v3->test = 0;
    v3->field_4 = 0;
    v3->field_8 = 0;
    strcpy(cp, (const char *)Src);
    strcat(cp, "Update.exe");
    if ( _access(cp, 0) != -1 )
      *(_DWORD *)&Security[v44].test = CompressFile(cp, &Security[v44].field_C, &v45, v46, 0x11u, 0, 0);
    strcpy(cp, (const char *)Src);
    strcat(cp, "Update1.exe");
    if ( _access(cp, 0) != -1 )
      Security[v44].field_4 = (int)CompressFile(cp, &Security[v44].field_10, &v45, v46, 0x11u, 0, 0);
    strcpy(cp, (const char *)Src);
    strcat(cp, "Update2.exe");
    if ( _access(cp, 0) != -1 )
      Security[v44].field_8 = (int)CompressFile(cp, &Security[v44].field_14, &v45, v46, 0x11u, 0, 0);
    strcpy(cp, (const char *)Src);
    strcat(cp, "subspace.exe");
    if ( _access(cp, 0) != -1 )
    {
      Security[v44].SubspaceEXEChecksum = (int)GetSubspaceEXEChecksum(cp);
      _spawnlp(0, cp, (int)cp);
      v4 = fopen("scrty", "rb");
      v5 = v4;
      if ( v4 )
      {
        v6 = _fileno(v4);
        if ( _filelength(v6) != 4000 )
        {
          printf("Security file invalid size\n");
          exit(1);
        }
        fread(Security[v44].ScrtyData, 1u, 0xFA0u, v5);
        fclose(v5);
      }
      strcpy(cp, (const char *)Src);
      strcat(cp, "ipblock.txt");
      v7 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
      v50 = 0;
      if ( v7 )
        InitializeTextFile(v7, cp, 1, 1);
      else
        v8 = 0;
      Security[v44].field_FBC = v8;
      strcpy(cp, (const char *)Src);
      v50 = -1;
      strcat(cp, "ipallow.txt");
      v9 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
      v50 = 1;
      if ( v9 )
        InitializeTextFile(v9, cp, 1, 1);
      else
        v10 = 0;
      v50 = -1;
      *(_DWORD *)&Security[v44].field_FC0 = v10;
    }
    ++v44;
  }
  while ( v44 < 10 );
  ptr = CompressFile("news.txt", &bytes, &NewsTxtFileChecksum, v46, 0x11u, 1, 0);
  SetConsoleTitleA(BillingServerName);
  dword_4C8F3C = 1;
  memset(SomeArrayOf256_1, 0, sizeof(SomeArrayOf256_1));
  memset(SomeArrayOf256_2, 0, sizeof(SomeArrayOf256_2));
  memset(&byte_431BBC[4], 0, 0x20u);
  RadarValue = 0;
  ScreenValue = 0;
  ServerIterations = 0;
  DoubleValue = 0;
  Wave = 0;
  SmallServerStruct = 0;
  ServerStruct = 0;
  BillingConnectionStructPointer = 0;
  if ( dword_42C840 )
  {
    v11 = GetTickCount() / 0xA;
    v12 = GetTickCount() / 0xA;
    v45 = v12;
    v13 = operator new(0x8C5Cu);
    v50 = 2;
    if ( v13 )
      v14 = (void *)StartServerListener((int)v13, 0, 0, 16, 0, 0x2000, 0x2000, 1);
    else
      v14 = 0;
    v50 = -1;
    ServerStruct = v14;
    encryption = 0;
    while ( (int)abs32(GetTickCount() / 0xA - v12) < BillingAttemptTime )
    {
      if ( !encryption )
      {
        WriteSubGameLog("Attempting to establish link to billing server...\n");
        v15 = GetTickCount() / 0xA;
        v16 = rand();
        encryption = SomethingBillerServer(
                       ServerStruct,
                       BillingIP,
                       BillingPort,
                       ((int)(v15 + v16) >> 31) - (((int)(v15 + v16) >> 31) ^ (v15 + v16)),
                       0);
        v11 = GetTickCount() / 0xA;
      }
      PlayerDoNetworkOps((PLAYER *)ServerStruct);
      if ( CheckIfBillingServerIsConnected((int)encryption) == 2 )
        break;
      if ( (int)abs32(GetTickCount() / 0xA - v11) > 2000 )
      {
        sub_41B7A0((int)encryption);
        v17 = ServerStruct;
        encryption = 0;
        if ( ServerStruct )
        {
          CleanUpPacketAttachment((struct PACKET_ATTACHMENT *)ServerStruct);
          operator delete(v17);
        }
        v18 = operator new(0x8C5Cu);
        v50 = 3;
        if ( v18 )
          v19 = (void *)StartServerListener((int)v18, 0, 0, 16, 0, 0x2000, 0x2000, 1);
        else
          v19 = 0;
        v12 = v45;
        v50 = -1;
        ServerStruct = v19;
      }
      if ( console_input_wrapper() )
      {
        v20 = getch();
        if ( (!v20 || v20 == 224) && getch() == 136 )
        {
          printf("Shutting down server...\n");
          exit(1);
        }
      }
    }
    if ( CheckIfBillingServerIsConnected((int)encryption) == 2 )
    {
      WriteSubGameLog("Billing server connected.\n");
      v21 = operator new(0x18u);
      v50 = 4;
      if ( v21 )
      {
        v22 = (void *)SendBillerServerConnectPacket(
                        (int)v21,
                        (int)HandleBillerPacket,
                        BillingServerName,
                        BillingServerId,
                        BillingGroupId,
                        BillingScoreId,
                        BillingPassword,
                        (int)ServerStruct,
                        (int)encryption);
        v50 = -1;
        BillingConnectionStructPointer = v22;
      }
      else
      {
        v50 = -1;
        BillingConnectionStructPointer = 0;
      }
    }
    else
    {
      WriteSubGameLog("ERROR: Could not connect to billing server.\n");
      v23 = ServerStruct;
      BillingConnectionStructPointer = 0;
      if ( ServerStruct )
      {
        CleanUpPacketAttachment((struct PACKET_ATTACHMENT *)ServerStruct);
        operator delete(v23);
      }
      ServerStruct = 0;
      WriteSubGameLog("Starting server in stand-alone mode.\n");
      v24 = (SOCKET *)operator new(0xCu);
      v50 = 5;
      if ( v24 )
        ConnectSocket(v24, BillingIP, BillingPort + 1, 0);
      else
        v25 = 0;
      v50 = -1;
      SmallServerStruct = v25;
    }
  }
  if ( strlen(DirectoryIPAddresses) > 4 )
  {
    strcpy((char *)Src, DirectoryIPAddresses);
    v26 = &byte_431BBC[4];
    do
    {
      if ( !GetSplitNextDirectoryIP(cp, (char *)Src) )
        break;
      v27 = (SOCKET *)operator new(0xCu);
      v50 = 6;
      if ( v27 )
        ConnectSocket(v27, cp, DirectoryPort, 0);
      else
        v28 = 0;
      *(_DWORD *)v26 = v28;
      v26 += 4;
      v50 = -1;
    }
    while ( (int)v26 < (int)&MiscDisableSharewareShips );
  }
  v29 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
  v50 = 7;
  if ( v29 )
    InitializeTextFile(v29, "obscene.txt", 1, 1);
  else
    v30 = 0;
  v50 = -1;
  ObscenePointer = v30;
  v31 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
  v50 = 8;
  if ( v31 )
    InitializeTextFile(v31, "idblock.txt", 0, 1);
  else
    v32 = 0;
  v50 = -1;
  IDBlockPointer = v32;
  v33 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
  v50 = 9;
  if ( v33 )
    InitializeTextFile(v33, "permit.txt", 0, 1);
  else
    v34 = 0;
  v50 = -1;
  PermitPointer = v34;
  v35 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
  v50 = 10;
  if ( v35 )
    InitializeTextFile(v35, "moderate.txt", 0, 1);
  else
    v36 = 0;
  v50 = -1;
  ModeratePointer = v36;
  v37 = (struct TEXT_FILE_STRUCT *)operator new(0x114u);
  v50 = 11;
  if ( v37 )
    InitializeTextFile(v37, "reserved.txt", 0, 1);
  else
    v38 = 0;
  v50 = -1;
  ReservedPointer = v38;
  ServerListenPort = GetPrivateProfileIntWrapper("Misc", "Port", 382, FileName);
  v39 = (PINGSOCKET *)operator new(8u);
  v50 = 12;
  if ( v39 )
    v40 = ListenOnPort(v39, ServerListenPort + 1, nullsub_1);
  else
    v40 = 0;
  v50 = -1;
  dword_4D89C0 = v40;
  ArenaArrayLength = 0;
  v41 = operator new(0x8C5Cu);
  v50 = 13;
  if ( v41 )
    v42 = (void *)StartServerListener(
                    (int)v41,
                    (int)NewConnectionRequest,
                    (int)PlayerHandleGamePacketWrapperSomething,
                    1024,
                    ServerListenPort,
                    CommsOutgoingBufferSize,
                    CommsIncomingBufferSize,
                    CommsPacketHistoryMax);
  else
    v42 = 0;
  v50 = -1;
  dword_437B08 = v42;
  sub_41A910((int)v42, CommsEncryptMode);
  return sub_41B430(dword_437B08, CommsTransportBufferSize);
}
// 4125C8: variable 'v8' is possibly undefined
// 412663: variable 'v10' is possibly undefined
// 412A5B: variable 'v25' is possibly undefined
// 412AF4: variable 'v28' is possibly undefined
// 412B48: variable 'v30' is possibly undefined
// 412B87: variable 'v32' is possibly undefined
// 412BC6: variable 'v34' is possibly undefined
// 412C05: variable 'v36' is possibly undefined
// 412C53: variable 'v38' is possibly undefined
// 408300: using guessed type int nullsub_1();
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);
// 42C840: using guessed type int dword_42C840;
// 431BB8: using guessed type int LastTimeServerINIWasEdited;
// 431BE0: using guessed type int MiscDisableSharewareShips;
// 431BE8: using guessed type int RadarValue;
// 431FF4: using guessed type int ArenaArrayLength;
// 431FF8: using guessed type int ServerIterations;
// 432000: using guessed type int LastTimeMasterCFGWasEdited;
// 432004: using guessed type int RecycleServer;
// 437C18: using guessed type int DoubleValue;
// 437C1C: using guessed type int BillingAttemptTime;
// 437CA4: using guessed type int CurrentLogLine;
// 4386D4: using guessed type int MachineIdArrayIndex;
// 438B10: using guessed type int ScreenValue;
// 438B20: using guessed type int CommsEncryptMode;
// 4C8F38: using guessed type int dword_4C8F38;
// 4C8F3C: using guessed type int dword_4C8F3C;
// 4CA814: using guessed type int IncreasesRadarValueSomeHow;
// 4D55D0: using guessed type int dword_4D55D0;
// 4D5914: using guessed type int NewsTxtFileChecksum;
// 4D89C8: using guessed type int Wave;
// 4D8AFC: using guessed type int dword_4D8AFC;
// 4D8B00: using guessed type int dword_4D8B00;
// 4D8B04: using guessed type int dword_4D8B04;
// 4D8B18: using guessed type int ChatCounter64Max;

//----- (00412D50) --------------------------------------------------------
signed int __cdecl NewConnectionRequest(int IPAddress, __int16 Port, ENCRYPTION *encryption)
{
  int v3; // ebp
  int v4; // edi
  PLAYER **v5; // esi
  PLAYER **v6; // ebx
  PLAYER *v7; // eax
  PLAYER *v8; // eax
  int v9; // ecx
  PLAYER *Memory; // [esp+10h] [ebp-10h]

  v3 = 0;
  if ( ZonePlayerCount > 0 )
  {
    v4 = 0;
    v5 = playerPointerList;
    v6 = &playerPointerList[1];
    do
    {
      if ( (*v5)->IPAddressDWORD == IPAddress && (*v5)->Port == Port )
      {
        printf("Connection broken because same ip/port requested another connection\n");
        sub_41CBD0((int)(*v5)->encryptionPointer);
        Memory = *v5;
        if ( *v5 )
        {
          DisconnectUser((HANDLE *)*v5);
          operator delete(Memory);
        }
        --ZonePlayerCount;
        memcpy(v5, v6, 4 * (v4 + ZonePlayerCount));
        --v3;
        v4 -= 0x3FFFFFFF;
        --v6;
        --v5;
      }
      ++v3;
      v4 += 0x3FFFFFFF;
      ++v6;
      ++v5;
    }
    while ( v3 < ZonePlayerCount );
  }
  v7 = (PLAYER *)operator new(0x35Du);
  if ( v7 )
    v8 = CreateNewPlayer(v7, (struct in_addr)IPAddress, Port, (NetData *)encryption);
  else
    v8 = 0;
  v9 = ZonePlayerCount;
  playerPointerList[ZonePlayerCount] = v8;
  ZonePlayerCount = v9 + 1;
  return 1;
}

//----- (00412E80) --------------------------------------------------------
void __cdecl PlayerHandleGamePacketWrapperSomething(int packet, int packetSize, int a3)
{
  struct PLAYER *v3; // ecx

  v3 = ZonePlayerList[*(_DWORD *)(a3 + 46)];
  if ( v3 )
    PlayerHandleGamePacket(v3, (unsigned __int8 *)packet, packetSize);
}

//----- (00412EB0) --------------------------------------------------------
void __cdecl ServerMainLoop()
{
  int (*GetTickCountt)(void); // ebp
  int i; // ebx
  int v2; // eax
  int v3; // edi
  int v4; // edi
  PLAYER **v5; // esi
  unsigned int v6; // esi
  int v7; // edi
  PLAYER **v8; // esi
  int v9; // eax
  int v10; // edi
  char *v11; // esi
  PLAYER *v12; // ecx
  unsigned int v13; // eax
  int v14; // edi
  PLAYER **v15; // esi
  PLAYER **v16; // ebp
  int v17; // edi
  ARENA **v18; // esi
  ARENA **v19; // ebp
  int v20; // eax
  DWORD (__stdcall *v21)(); // ebp
  int v22; // ebx
  int v23; // esi
  KICK *v24; // ebp
  KICK *v25; // edi
  __int64 v26; // rax
  DWORD v27; // eax
  void **v28; // esi
  int v29; // edi
  ARENA **v30; // esi
  char *v31; // esi
  struct TEXT_FILE_STRUCT *v32; // ecx
  int v33; // edi
  PLAYER **v34; // esi
  DWORD v35; // eax
  int v36; // esi
  HANDLE *buf; // [esp+10h] [ebp-1F4h]
  struct ARENA *bufa; // [esp+10h] [ebp-1F4h]
  DWORD bufb; // [esp+10h] [ebp-1F4h]
  DWORD GetTickCountDivideddBy10; // [esp+14h] [ebp-1F0h]
  unsigned int v41; // [esp+18h] [ebp-1ECh]
  DWORD GetTickCountDividedBy10; // [esp+1Ch] [ebp-1E8h]
  unsigned int v43; // [esp+20h] [ebp-1E4h]
  int v44[4]; // [esp+24h] [ebp-1E0h] BYREF
  char v45; // [esp+34h] [ebp-1D0h]
  int v46; // [esp+38h] [ebp-1CCh] BYREF
  int v47; // [esp+3Ch] [ebp-1C8h] BYREF
  __int16 v48[226]; // [esp+40h] [ebp-1C4h] BYREF

  GetTickCount();
  GetTickCount();
  GetTickCountDivideddBy10 = GetTickCount() / 0xA;
  GetTickCount();
  GetTickCount();
  GetTickCountDividedBy10 = GetTickCount() / 0xA;
  GetTickCount();
  v41 = 0;
  dword_4D5920 = 0;
  if ( !IsServerRunning )
  {
    GetTickCountt = (int (*)(void))GetTickCount;
    for ( i = 0; ; i = 0 )
    {
      if ( RecycleServer )
        return;
      v43 = GetTickCountt() / 0xAu;
      if ( console_input_wrapper() )
      {
        v2 = getch();
        if ( (!v2 || v2 == 224) && getch() == 136 )
        {
          printf("Shutting down server...\n");
          IsServerRunning = 1;
          return;
        }
      }
      if ( BillingConnectionStructPointer )
      {
        if ( IsBillingServerDisconnected((int)BillingConnectionStructPointer) )
        {
          WriteSubGameLog("Connection to billing server broken\n");
          RecycleServer = 1;
        }
        v3 = GetBillerLastReconnectTime(BillingConnectionStructPointer);
        if ( (int)(GetTickCountt() / 0xAu - v3) > BillingReconnectTime )
        {
          WriteSubGameLog("Connection to billing server timed out\n");
          RecycleServer = 1;
        }
        if ( RecycleServer )
        {
          v4 = 0;
          if ( ZonePlayerCount > 0 )
          {
            v5 = playerPointerList;
            do
            {
              if ( (*v5)->MyArena )
                SendMessage(*v5, "NOTICE: Server recycling, please log back in shortly.", 1);
              ++v4;
              ++v5;
            }
            while ( v4 < ZonePlayerCount );
          }
          SendPacketsToEverybody((struct PACKET_ATTACHMENT *)dword_437B08);
        }
      }
      ProcessZonePings(dword_4D89C0, ZonePlayerCount);
      v6 = GetTickCountt() / 0xAu;
      if ( PlayerDoNetworkOps((PLAYER *)dword_437B08) )
      {
        while ( (int)(GetTickCountt() / 0xAu - v6) < CPUProcessMaxTime && PlayerDoNetworkOps((PLAYER *)dword_437B08) )
          ;
      }
      v7 = 0;
      if ( ZonePlayerCount > 0 )
      {
        v8 = playerPointerList;
        do
        {
          if ( (*v8)->field_FD )
            SendWeaponPacket(*v8);
          ++v7;
          ++v8;
        }
        while ( v7 < ZonePlayerCount );
      }
      SendPacketsToEverybody((struct PACKET_ATTACHMENT *)dword_437B08);
      v9 = IncreasesRadarValueSomeHow;
      ScreenValue += dword_4D55D0;
      v10 = 0;
      DoubleValue += dword_4C8F38;
      dword_4D55D0 = 0;
      dword_4C8F38 = 0;
      RadarValue += IncreasesRadarValueSomeHow;
      if ( IncreasesRadarValueSomeHow > 0 )
      {
        v11 = byte_4AF911;
        do
        {
          v12 = ZonePlayerList[*(_DWORD *)(v11 - 25)];
          if ( v12 )
          {
            sub_40DEA0(v12, v11 - 21, *v11, *v11);
            v9 = IncreasesRadarValueSomeHow;
          }
          ++v10;
          v11 += 26;
        }
        while ( v10 < v9 );
      }
      IncreasesRadarValueSomeHow = 0;
      if ( (int)abs32(GetTickCountt() / 0xAu - GetTickCountDivideddBy10) > 30 )
      {
        v13 = GetTickCountt();
        HighestPlayerCountMaybeSomething = 0;
        GetTickCountDivideddBy10 = v13 / 0xA;
        if ( ZonePlayerCount > 0 )
        {
          v14 = 0;
          v15 = playerPointerList;
          v16 = &playerPointerList[1];
          do
          {
            if ( sub_40CF10(*v15) )
            {
              buf = (HANDLE *)*v15;
              --ZonePlayerCount;
              memcpy(v15, v16, 4 * (v14 + ZonePlayerCount));
              if ( buf )
              {
                DisconnectUser(buf);
                operator delete(buf);
              }
              --i;
              v14 -= 0x3FFFFFFF;
              --v16;
              --v15;
            }
            ++i;
            v14 += 0x3FFFFFFF;
            ++v16;
            ++v15;
          }
          while ( i < ZonePlayerCount );
          i = 0;
        }
        if ( ArenaArrayLength > 0 )
        {
          v17 = 0;
          v18 = Arenas;
          v19 = &Arenas[1];
          do
          {
            LOBYTE(v20) = ProcessArena(*v18);
            if ( v20 )
            {
              if ( (*v18)->ArenaName[0] )
                WriteSubGameLog("Private arena dropped: %s\n", (*v18)->ArenaName);
              else
                WriteSubGameLog("Arena dropped\n");
              bufa = *v18;
              if ( *v18 )
              {
                ShutdownArena(*v18);
                operator delete(bufa);
              }
              --ArenaArrayLength;
              memcpy(v18, v19, 4 * (v17 + ArenaArrayLength));
              --i;
              v17 -= 0x3FFFFFFF;
              --v19;
              --v18;
            }
            ++i;
            v17 += 0x3FFFFFFF;
            ++v19;
            ++v18;
          }
          while ( i < ArenaArrayLength );
        }
      }
      SendPacketsToEverybody((struct PACKET_ATTACHMENT *)dword_437B08);
      ++ServerIterations;
      if ( (int)(GetTickCount() / 0xA - oldTickCountValue) > 6000 )
      {
        v21 = GetTickCount;
        memset(SomeArrayOf256_1, 0, sizeof(SomeArrayOf256_1));
        v22 = 0;
        memset(SomeArrayOf256_2, 0, sizeof(SomeArrayOf256_2));
        RadarValue = 0;
        ScreenValue = 0;
        ServerIterations = 0;
        DoubleValue = 0;
        Wave = 0;
        oldTickCountValue = GetTickCount() / 0xA;
        sub_41B3D0(dword_437B08);
        if ( MachineIdArrayIndex <= 0 )
          goto SKIP_KICKED_USERS;
        v23 = 0;
        v24 = KickedUsers;
        v25 = &KickedUsers[1];
        do
        {
          v26 = (int)(GetTickCount() / 0xA - KickedUsers[v23].KickStartTime);
          if ( (signed int)((HIDWORD(v26) ^ v26) - HIDWORD(v26)) > KickedUsers[v23].KickDelayMilliseconds )
          {
            --MachineIdArrayIndex;
            memcpy(v24, v25, 12 * MachineIdArrayIndex - v23 * 12);
            --v22;
            --v23;
            --v25;
            --v24;
          }
          ++v22;
          ++v23;
          ++v25;
          ++v24;
        }
        while ( v22 < MachineIdArrayIndex );
      }
      v21 = GetTickCount;
SKIP_KICKED_USERS:
      if ( (int)abs32(v21() / 0xA - v41) > 6000 )
      {
        v27 = v21();
        memset(v48, 0, 0x1C0u);
        v41 = v27 / 0xA;
        v48[224] = 0;
        v48[1] = ZonePlayerCount;
        v48[2] = BillingConnectionStructPointer != 0;
        *(_DWORD *)&v48[3] = 134;
        v48[0] = ServerListenPort;
        strncpy((char *)&v48[5], BillingServerName, 0x20u);
        HIBYTE(v48[20]) = 0;
        strncpy((char *)&v48[21], DirectoryNamePassword, 0x10u);
        HIBYTE(v48[28]) = 0;
        strncpy((char *)&v48[45], DirectoryDescription, 0xFAu);
        HIBYTE(v48[169]) = 0;
        v28 = (void **)&byte_431BBC[4];
        do
        {
          if ( *v28 )
          {
            SendDirectoryServerZoneUpdatePacket(*v28, v48, strlen((const char *)&v48[45]) + 91);
            GetSocketRecvLag((SOCKET)*v28, &v47);
          }
          ++v28;
        }
        while ( (int)v28 < (int)&MiscDisableSharewareShips );
      }
      if ( (int)abs32(v21() / 0xA - GetTickCountDividedBy10) > 18000 || dword_4D5920 )
      {
        bufb = v21() / 0xA;
        if ( SmallServerStruct && !BillingConnectionStructPointer )
          SendDirectoryServerZoneUpdatePacket(SmallServerStruct, 0, 0);
        dword_4C8F3C = 1;
        dword_4D5920 = 0;
        GetTickCountDividedBy10 = v21() / 0xA;
        if ( IsFileLastWrittenTime(FileName, (int)&LastTimeServerINIWasEdited) )
        {
          printf("INI settings different, re-reading\n");
          ReadServerINI();
          sub_41A910((int)dword_437B08, CommsEncryptMode);
          sub_41B430(dword_437B08, CommsTransportBufferSize);
        }
        if ( IsFileLastWrittenTime(Filename2, (int)&LastTimeMasterCFGWasEdited) )
        {
          printf("Master CFG settings different, re-reading\n");
          LoadZoneCFGSettings(&ArenaSettings, &ServersideArenaSettings, Filename2);
          v29 = 0;
          if ( ArenaArrayLength > 0 )
          {
            v30 = Arenas;
            do
            {
              if ( !_strcmpi((*v30)->szConfigFile, Filename2) )
                (*v30)->playerPointersForSomething[250] = (PLAYER *)1;
              ++v29;
              ++v30;
            }
            while ( v29 < ArenaArrayLength );
          }
        }
        v31 = &Security[0].field_FC0;
        do
        {
          v32 = (struct TEXT_FILE_STRUCT *)*((_DWORD *)v31 - 1);
          if ( v32 )
            LoadTextFile(v32, 0);
          if ( *(_DWORD *)v31 )
            LoadTextFile(*(struct TEXT_FILE_STRUCT **)v31, 0);
          v31 += 4036;
        }
        while ( (int)v31 < (int)&ZonePlayerList[1006] );
        LoadTextFile((struct TEXT_FILE_STRUCT *)IDBlockPointer, 0);
        LoadTextFile((struct TEXT_FILE_STRUCT *)ObscenePointer, 0);
        LoadTextFile((struct TEXT_FILE_STRUCT *)PermitPointer, 0);
        LoadTextFile((struct TEXT_FILE_STRUCT *)ModeratePointer, 0);
        LoadTextFile((struct TEXT_FILE_STRUCT *)ReservedPointer, 0);
        v44[0] = 16;
        v44[1] = 0;
        v44[2] = 0;
        v44[3] = 0;
        v45 = 0;
        if ( IsFileLastWrittenTime("news.txt", (int)&LastTimeNewsTxtWasEdited) )
        {
          if ( ptr )
            efree(ptr);
          ptr = CompressFile("news.txt", &bytes, &NewsTxtFileChecksum, v44, 0x11u, 1, 0);
        }
        if ( SmallServerStruct
          && !BillingConnectionStructPointer
          && GetSocketRecvLag((SOCKET)SmallServerStruct, &v46) >= 0 )
        {
          v33 = 0;
          if ( ZonePlayerCount > 0 )
          {
            v34 = playerPointerList;
            do
            {
              if ( (*v34)->MyArena )
                SendMessage(*v34, "NOTICE: Server recycling in order to restore scores, please log back in.", 1);
              ++v33;
              ++v34;
            }
            while ( v33 < ZonePlayerCount );
          }
          SendPacketsToEverybody((struct PACKET_ATTACHMENT *)dword_437B08);
          RecycleServer = 1;
        }
        v35 = v21();
        printf("Re-read Settings: %d ms\n", 10 * (v35 / 0xA - bufb));
        fflush(&stru_42E498);
      }
      sub_41B570(100);
      v36 = v21() / 0xA - v43;
      if ( v36 <= 2 || CPUSleepPerIteration )
        Sleep(CPUSleepTime);
      if ( v36 > CPUSlowIterationWarningLevel )
        WriteSubGameLog("Slow iteration warning: %d ms\n", 10 * v36);
      if ( IsServerRunning )
        return;
      GetTickCountt = (int (*)(void))GetTickCount;
    }
  }
}
// 4131FA: variable 'v20' is possibly undefined
// 431BB8: using guessed type int LastTimeServerINIWasEdited;
// 431BE0: using guessed type int MiscDisableSharewareShips;
// 431BE8: using guessed type int RadarValue;
// 431FF4: using guessed type int ArenaArrayLength;
// 431FF8: using guessed type int ServerIterations;
// 432000: using guessed type int LastTimeMasterCFGWasEdited;
// 432004: using guessed type int RecycleServer;
// 437C18: using guessed type int DoubleValue;
// 437CA8: using guessed type int IsServerRunning;
// 4386D4: using guessed type int MachineIdArrayIndex;
// 438B10: using guessed type int ScreenValue;
// 438B14: using guessed type int CPUSlowIterationWarningLevel;
// 438B20: using guessed type int CommsEncryptMode;
// 438B78: using guessed type int BillingReconnectTime;
// 4AC448: using guessed type KICK KickedUsers[1000];
// 4C8F38: using guessed type int dword_4C8F38;
// 4C8F3C: using guessed type int dword_4C8F3C;
// 4C9F44: using guessed type int CPUSleepPerIteration;
// 4CA814: using guessed type int IncreasesRadarValueSomeHow;
// 4D55D0: using guessed type int dword_4D55D0;
// 4D5904: using guessed type int CPUProcessMaxTime;
// 4D5914: using guessed type int NewsTxtFileChecksum;
// 4D5920: using guessed type int dword_4D5920;
// 4D5924: using guessed type int LastTimeNewsTxtWasEdited;
// 4D89C8: using guessed type int Wave;
// 4D8AF4: using guessed type int oldTickCountValue;
// 4D8AF8: using guessed type int HighestPlayerCountMaybeSomething;

//----- (004137F0) --------------------------------------------------------
int __cdecl IncreaseRadarValueShowHomeOverFourThousand()
{
  int result; // eax
  int v1; // edi
  char *v2; // esi
  PLAYER *v3; // ecx

  result = IncreasesRadarValueSomeHow;
  v1 = 0;
  RadarValue += IncreasesRadarValueSomeHow;
  if ( IncreasesRadarValueSomeHow > 0 )
  {
    v2 = byte_4AF911;
    do
    {
      v3 = ZonePlayerList[*(_DWORD *)(v2 - 25)];
      if ( v3 )
      {
        sub_40DEA0(v3, v2 - 21, *v2, *v2);
        result = IncreasesRadarValueSomeHow;
      }
      ++v1;
      v2 += 26;
    }
    while ( v1 < result );
  }
  IncreasesRadarValueSomeHow = 0;
  return result;
}
// 431BE8: using guessed type int RadarValue;
// 4CA814: using guessed type int IncreasesRadarValueSomeHow;

//----- (00413850) --------------------------------------------------------
FILE *__cdecl ServerUninitialize()
{
  int v0; // eax
  bool v1; // cc
  HANDLE **v2; // edi
  int v3; // ebx
  HANDLE *v4; // esi
  int v5; // ebx
  ARENA **v6; // edi
  ARENA *v7; // esi
  void *v8; // esi
  void *v9; // esi
  void *v10; // esi
  void *v11; // esi
  void *v12; // esi
  SOCKET **v13; // edi
  SOCKET *v14; // esi
  CHAR *v15; // esi
  CHAR *v16; // esi
  CHAR *v17; // esi
  CHAR *v18; // esi
  CHAR *v19; // esi
  TEXT_FILE_STRUCT **v20; // ebx
  void *v21; // esi
  TEXT_FILE_STRUCT *v22; // esi
  LPVOID *v23; // esi
  int v24; // edi
  void *v25; // esi
  FILE *result; // eax

  v0 = ZonePlayerCount;
  v1 = ZonePlayerCount <= 0;
  ZonePlayerCount = 0;
  if ( !v1 )
  {
    v2 = (HANDLE **)playerPointerList;
    v3 = v0;
    do
    {
      v4 = *v2;
      if ( *v2 )
      {
        DisconnectUser(*v2);
        operator delete(v4);
      }
      ++v2;
      --v3;
    }
    while ( v3 );
  }
  v5 = 0;
  if ( ArenaArrayLength > 0 )
  {
    v6 = Arenas;
    do
    {
      v7 = *v6;
      if ( *v6 )
      {
        ShutdownArena(*v6);
        operator delete(v7);
      }
      ++v5;
      ++v6;
    }
    while ( v5 < ArenaArrayLength );
  }
  ArenaArrayLength = 0;
  if ( PointsFileHandle )
  {
    fclose(PointsFileHandle);
    PointsFileHandle = 0;
  }
  v8 = dword_437B08;
  if ( dword_437B08 )
  {
    CleanUpPacketAttachment((struct PACKET_ATTACHMENT *)dword_437B08);
    operator delete(v8);
  }
  v9 = dword_4D89C0;
  if ( dword_4D89C0 )
  {
    sub_408740((SOCKET *)dword_4D89C0);
    operator delete(v9);
  }
  v10 = SmallServerStruct;
  if ( SmallServerStruct )
  {
    sub_408740((SOCKET *)SmallServerStruct);
    operator delete(v10);
  }
  v11 = BillingConnectionStructPointer;
  if ( BillingConnectionStructPointer )
  {
    CleanUpBilling(BillingConnectionStructPointer);
    operator delete(v11);
  }
  v12 = ServerStruct;
  if ( ServerStruct )
  {
    CleanUpPacketAttachment((struct PACKET_ATTACHMENT *)ServerStruct);
    operator delete(v12);
  }
  v13 = (SOCKET **)&byte_431BBC[4];
  do
  {
    v14 = *v13;
    if ( *v13 )
    {
      sub_408740(*v13);
      operator delete(v14);
    }
    ++v13;
  }
  while ( (int)v13 < (int)&MiscDisableSharewareShips );
  v15 = (CHAR *)ObscenePointer;
  if ( ObscenePointer )
  {
    CleanTextFileMemory((TEXT_FILE_STRUCT *)ObscenePointer);
    operator delete(v15);
  }
  v16 = (CHAR *)PermitPointer;
  if ( PermitPointer )
  {
    CleanTextFileMemory((TEXT_FILE_STRUCT *)PermitPointer);
    operator delete(v16);
  }
  v17 = (CHAR *)ModeratePointer;
  if ( ModeratePointer )
  {
    CleanTextFileMemory((TEXT_FILE_STRUCT *)ModeratePointer);
    operator delete(v17);
  }
  v18 = (CHAR *)ReservedPointer;
  if ( ReservedPointer )
  {
    CleanTextFileMemory((TEXT_FILE_STRUCT *)ReservedPointer);
    operator delete(v18);
  }
  v19 = (CHAR *)IDBlockPointer;
  if ( IDBlockPointer )
  {
    CleanTextFileMemory((TEXT_FILE_STRUCT *)IDBlockPointer);
    operator delete(v19);
  }
  if ( ptr )
  {
    efree(ptr);
    ptr = 0;
  }
  v20 = (TEXT_FILE_STRUCT **)&Security[0].field_FC0;
  do
  {
    v21 = *(v20 - 1);
    if ( v21 )
    {
      CleanTextFileMemory(*(v20 - 1));
      operator delete(v21);
    }
    v22 = *v20;
    if ( *v20 )
    {
      CleanTextFileMemory(*v20);
      operator delete(v22);
    }
    v23 = (LPVOID *)(v20 - 1008);
    v24 = 3;
    do
    {
      if ( *v23 )
      {
        efree(*v23);
        *v23 = 0;
      }
      ++v23;
      --v24;
    }
    while ( v24 );
    v20 += 1009;
  }
  while ( (int)v20 < (int)&ZonePlayerList[1006] );
  v25 = dword_438B70;
  if ( dword_438B70 )
  {
    sub_406B30((char *)dword_438B70);
    operator delete(v25);
  }
  efree(dword_437B0C);
  efree(MapAllocatedMemory);
  CleanUpMemory();
  j_WSACleanup();
  result = fileHandle;
  if ( fileHandle )
    result = (FILE *)fclose(fileHandle);
  fileHandle = 0;
  return result;
}
// 431BE0: using guessed type int MiscDisableSharewareShips;
// 431FF4: using guessed type int ArenaArrayLength;

//----- (00413AE0) --------------------------------------------------------
void __cdecl HandleBillerPacket(char *buffer, int a2)
{
  int v2; // eax
  PLAYER **v3; // esi
  int v4; // edx
  PLAYER **k; // eax
  int v6; // ecx
  PLAYER **j; // eax
  PLAYER *v8; // esi
  int v9; // ecx
  PLAYER **i; // eax
  PLAYER *v11; // ebp
  char v12; // al
  __int16 v13; // ax
  __int16 *v14; // ebx
  char *v15; // eax
  PLAYER **v16; // esi
  ARENA *v17; // eax
  __int16 *v18; // eax
  int v19; // ecx
  PLAYER *v20; // edi
  bool v21; // cc
  int v22; // ecx
  int v23; // eax
  int v24; // ecx
  int v25; // edx
  int v26; // eax
  char v27; // [esp+13h] [ebp-835h] BYREF
  int v28; // [esp+14h] [ebp-834h]
  char *v29; // [esp+18h] [ebp-830h]
  void *Src; // [esp+1Ch] [ebp-82Ch]
  int v31; // [esp+20h] [ebp-828h]
  char buf[2]; // [esp+24h] [ebp-824h] BYREF
  int v33; // [esp+26h] [ebp-822h]
  int v34; // [esp+2Ah] [ebp-81Eh]
  int v35; // [esp+2Eh] [ebp-81Ah]
  int v36; // [esp+32h] [ebp-816h]
  char v37; // [esp+36h] [ebp-812h]
  char v38; // [esp+37h] [ebp-811h]
  int v39; // [esp+38h] [ebp-810h]
  int v40; // [esp+3Ch] [ebp-80Ch]
  char a2a[2048]; // [esp+48h] [ebp-800h] BYREF

  switch ( *buffer )
  {
    case 1:
      v9 = 0;
      v28 = a2 - 178;
      v29 = buffer + 178;
      if ( ZonePlayerCount > 0 )
      {
        for ( i = playerPointerList; ; ++i )
        {
          v11 = *i;
          if ( (*i)->BillerPlayerId == *(_DWORD *)(buffer + 2) )
            break;
          if ( ++v9 >= ZonePlayerCount )
            return;
        }
        v12 = buffer[1];
        v27 = 0xA;                              // 0x0A - Server is Full
        v31 = 0;
        switch ( v12 )
        {
          case 0:
          case 6:
            v27 = 0;                            // 0x00 - Login OK
            if ( v12 == 6 )
              v31 = 1;
            v14 = &v11->CurrentWins;
            qmemcpy(v11->Name, buffer + 6, 0xACu);
            if ( v28 == 14 )
            {
              v15 = v29;
              *(_DWORD *)v14 = *(_DWORD *)v29;
              *(_DWORD *)&v11->GoalCount = *((_DWORD *)v15 + 1);
              *(int *)((char *)&v11->KillPoints + 2) = *((_DWORD *)v15 + 2);
              HIWORD(v11->FlagPoints) = *((_WORD *)v15 + 6);
            }
            else
            {
              *(_DWORD *)v14 = 0;
              *(_DWORD *)&v11->GoalCount = 0;
              *(int *)((char *)&v11->KillPoints + 2) = 0;
              HIWORD(v11->FlagPoints) = 0;
            }
            if ( v11->DemoPlayer )
            {
              *(_DWORD *)v14 = 0;
              *(_DWORD *)&v11->GoalCount = 0;
              *(int *)((char *)&v11->KillPoints + 2) = 0;
              HIWORD(v11->FlagPoints) = 0;
            }
            *(_DWORD *)&v11->PersonalBestWins = *(_DWORD *)v14;
            *(_DWORD *)&v11->field_235 = *(_DWORD *)&v11->GoalCount;
            *(_DWORD *)&v11->Points = *(int *)((char *)&v11->KillPoints + 2);
            v11->FlagPointsHiWord = HIWORD(v11->FlagPoints);
            if ( !v11->isModerator )
            {
              if ( PermissionMaxPoints && v11->FlagPoints + v11->KillPoints > PermissionMaxPoints )
                v27 = 7;                        // 0x07 - Too many points to Play here
              if ( v11->UsageTotalSeconds < PermissionMinimumSecondsToLogin )
                v27 = 0xF;                      // 0x0F - Not enough usage to play here.
            }
            v29 = 0;
            if ( ZonePlayerCount > 0 )
            {
              v28 = 0;
              v16 = playerPointerList;
              Src = &playerPointerList[1];
              do
              {
                if ( *v16 != v11 && !_strcmpi((*v16)->Name, v11->Name) )
                {
                  WriteSubGameLog("Player %s already on, kicking them off (lost connection probably)\n", v11->Name);
                  v17 = v11->MyArena;
                  if ( v17 )
                  {
                    if ( !v17->ServersideArenaSettings.MiscTimedGame )
                    {
                      v18 = &(*v16)->CurrentWins;
                      if ( (unsigned __int16)*v18
                         + (*v16)->KillPoints
                         + (*v16)->FlagPoints
                         + (unsigned __int16)(*v16)->CurrentLosses > (unsigned __int16)*v14
                                                                   + v11->FlagPoints
                                                                   + v11->KillPoints
                                                                   + (unsigned __int16)v11->CurrentLosses )
                      {
                        *(_DWORD *)v14 = *(_DWORD *)v18;
                        *(_DWORD *)&v11->GoalCount = *((_DWORD *)v18 + 1);
                        *(int *)((char *)&v11->KillPoints + 2) = *((_DWORD *)v18 + 2);
                        HIWORD(v11->FlagPoints) = v18[6];
                        v19 = (int)&(*v16)->PersonalBestWins;
                        *(_DWORD *)&v11->PersonalBestWins = *(_DWORD *)v19;
                        *(_DWORD *)&v11->field_235 = *(_DWORD *)(v19 + 4);
                        *(_DWORD *)&v11->Points = *(_DWORD *)(v19 + 8);
                        v11->FlagPointsHiWord = *(_WORD *)(v19 + 12);
                      }
                    }
                  }
                  v20 = *v16;
                  if ( *v16 )
                  {
                    DisconnectUser((HANDLE *)*v16);
                    operator delete(v20);
                  }
                  --ZonePlayerCount;
                  memcpy(v16, Src, 4 * (v28 + ZonePlayerCount));
                  --v29;
                  v28 -= 0x3FFFFFFF;
                  Src = (char *)Src - 4;
                  --v16;
                }
                v28 += 0x3FFFFFFF;
                ++v16;
                v21 = (int)++v29 < ZonePlayerCount;
                Src = (char *)Src + 4;
              }
              while ( v21 );
            }
            if ( PermissionMode == 2
              && !v11->isModerator
              && IsBannedMachineId((int)PermitPointer, (int)v11->PlayerName) < 0 )
            {
              goto LABEL_71;
            }
            break;
          case 1:
            v27 = 1;                            // 0x01 - Unregistered Player
            break;
          case 2:
            v27 = 2;                            // 0x02 - Bad Password
            v11->DisconnectReason = 18;
            v11->KickOffDelayTimer = GetTickCount() / 0xA;
            break;
          case 3:
            v27 = 4;                            // 0x04 - Locked Out of Zone
            WriteSubGameLog("Player kicked off for IP block: %s\n", v11->PlayerName);
            v11->DisconnectReason = 11;
            v11->AlreadySentReliablePacket = 1;
            break;
          case 4:
            v27 = 0xA;                          // 0x0A - Server is Full
            break;
          case 5:
            v27 = 0xB;                          // 0x0B - Invalid Name
            break;
          case 7:
            v27 = 0xE;                          // 0x0E - Server Busy, try Later
            break;
          case 8:
            v27 = 0x10;                         // 0x10 - Restricted Zone
            *(_DWORD *)&v11->CurrentWins = 0;
            *(_DWORD *)&v11->GoalCount = 0;
            *(int *)((char *)&v11->KillPoints + 2) = 0;
            HIWORD(v11->FlagPoints) = 0;
            *(_DWORD *)&v11->PersonalBestWins = *(_DWORD *)&v11->CurrentWins;
            *(_DWORD *)&v11->field_235 = *(_DWORD *)&v11->GoalCount;
            v13 = HIWORD(v11->FlagPoints);
            *(_DWORD *)&v11->Points = *(int *)((char *)&v11->KillPoints + 2);
            v11->FlagPointsHiWord = v13;
            qmemcpy(v11->Name, buffer + 6, 0xACu);
            strcpy(v11->Name, v11->PlayerName);
            v11->BillerPlayerId = -1;
            if ( PermissionMode == 2 && !v11->isModerator )
            {
LABEL_71:
              v27 = 6;                          // 0x06 - Permission to Spectate Only
              v11->IsSpeced = 1;
            }
            break;
          default:
            break;
        }
        buf[1] = v27;                           // Login Response
        v22 = v11->SubspaceEXEChecksumIndex;
        v40 = NewsTxtFileChecksum;              // News.txt Checksum
        v38 = v31;                              // Registration Form Request (Boolean)
        buf[0] = 0xA;                           // 0x0A - Password Packet Response
        v23 = v22;
        v33 = 134;                              // Server Version
        v34 = 0;                                // ? Unknown
        v24 = Security[v22].SubspaceEXEChecksum;// Subspace.exe Checksum
        v25 = *(_DWORD *)&Security[v23].ScrtyData[4];
        v26 = v11->isModerator;
        v36 = 0;                                // ? Unknown
        v37 = 0;                                // ? Unknown
        v35 = v24;
        v39 = v25;
        if ( v26 )
        {
          v35 = -1;
          v39 = -1;
        }
        SendPlayerReliablePacket(v11, buf, 36, 1);
        if ( !v11->DemoPlayer )
        {
          v27 = 0x31;                           // 0x31 - Post Login Sequence
          SendPlayerReliablePacket(v11, &v27, 1, 1);
        }
      }
      break;
    case 2:
      WriteSubGameLog("Shutdown packet received, shutting down server...\n");
      IsServerRunning = 1;
      break;
    case 3:
      if ( buffer[5] == 1 )
      {
        if ( IsBannedMachineId((int)PermitPointer, (int)(buffer + 6)) < 0 )
        {
          AddLineTextFile((struct TEXT_FILE_STRUCT *)PermitPointer, buffer + 6);
          WriteTextFileToFile((struct TEXT_FILE_STRUCT *)PermitPointer);
        }
      }
      else if ( buffer[5] == 2 )
      {
        if ( buffer[7] == 58 )
          ChatProcessor(0, 7, 0, buffer + 7, buffer[6]);
        else
          ChatProcessor(0, 0, 0, buffer + 7, buffer[6]);
      }
      break;
    case 4:
      RecycleServer = 1;
      break;
    case 8:
      v6 = 0;
      if ( ZonePlayerCount > 0 )
      {
        for ( j = playerPointerList; ; ++j )
        {
          v8 = *j;
          if ( (*j)->BillerPlayerId == *(_DWORD *)(buffer + 1) )
            break;
          if ( ++v6 >= ZonePlayerCount )
            return;
        }
        WriteSubGameLog("Player kicked off by billing server, reason #%d\n", *(_DWORD *)(buffer + 5));
        v8->DisconnectReason = 21;
        v8->AlreadySentReliablePacket = 1;
      }
      break;
    case 9:
      v4 = 0;
      if ( ZonePlayerCount > 0 )
      {
        for ( k = playerPointerList; (*k)->BillerPlayerId != *(_DWORD *)(buffer + 1); ++k )
        {
          if ( ++v4 >= ZonePlayerCount )
            return;
        }
        SendMessage(*k, buffer + 5, 0);
      }
      break;
    case 10:
      v2 = 0;
      v3 = playerPointerList;
      if ( ZonePlayerCount > 0 )
      {
        while ( (*v3)->BillerPlayerId != *(_DWORD *)(buffer + 1) )
        {
          ++v2;
          ++v3;
          if ( v2 >= ZonePlayerCount )
            return;
        }
        sprintf(a2a, "%d:%s", buffer[5], buffer + 6);
        SendChannelMessage(*v3, a2a);
      }
      break;
    default:
      return;
  }
}
// 413F2A: conditional instruction was optimized away because of 'eax.4==0'
// 432004: using guessed type int RecycleServer;
// 437CA8: using guessed type int IsServerRunning;
// 438B1C: using guessed type int PermissionMode;
// 438B7C: using guessed type int PermissionMinimumSecondsToLogin;
// 4AC438: using guessed type int PermissionMaxPoints;
// 4D5914: using guessed type int NewsTxtFileChecksum;

//----- (004141F0) --------------------------------------------------------
int FormatMessageArena(ARENA *arena, const char *Format, ...)
{
  struct tm *v2; // eax
  char *v3; // eax
  int v4; // edi
  int result; // eax
  PLAYER **v6; // esi
  FILE *v7; // eax
  char Str[132]; // [esp+Ch] [ebp-484h] BYREF
  char v9[512]; // [esp+90h] [ebp-400h] BYREF
  char Dest[512]; // [esp+290h] [ebp-200h] BYREF
  va_list Args; // [esp+49Ch] [ebp+Ch] BYREF

  va_start(Args, Format);
  time(Str);
  v2 = localtime((const time_t *)Str);
  strcpy(&Str[4], asctime(v2));
  v3 = strstr(&Str[4], " 199");
  if ( v3 || (v3 = strstr(&Str[4], " 200")) != 0 )
    *v3 = 0;
  vsprintf(v9, Format, Args);
  sprintf(Dest, "%s:  %s", &Str[4], v9);
  v4 = 0;
  result = arena->ArenaPlayerCount;
  if ( result > 0 )
  {
    v6 = arena->playerPointersForSomething;
    do
    {
      v7 = (*v6)->pfile329;
      if ( v7 )
        fprintf(v7, "%s", Dest);
      result = arena->ArenaPlayerCount;
      ++v4;
      ++v6;
    }
    while ( v4 < result );
  }
  return result;
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);

//----- (00414310) --------------------------------------------------------
int WriteSubGameLog(char *Format, ...)
{
  FILE *v1; // eax
  struct tm *v2; // eax
  char *v3; // eax
  char *v4; // edx
  char *v5; // eax
  char v6; // cl
  int result; // eax
  char Str[132]; // [esp+8h] [ebp-484h] BYREF
  char Dest[512]; // [esp+8Ch] [ebp-400h] BYREF
  char v10[512]; // [esp+28Ch] [ebp-200h] BYREF
  va_list va; // [esp+494h] [ebp+8h] BYREF

  va_start(va, Format);
  v1 = fileHandle;
  if ( fileHandle )
    goto LABEL_5;
  if ( MiscServerLog )
  {
    v1 = fopen("subgame.log", "at");
    fileHandle = v1;
  }
  if ( v1 )
  {
LABEL_5:
    if ( !MiscServerLog )
    {
      fclose(v1);
      fileHandle = 0;
    }
  }
  time(Str);
  v2 = localtime((const time_t *)Str);
  strcpy(&Str[4], asctime(v2));
  v3 = strstr(&Str[4], " 199");
  if ( v3 || (v3 = strstr(&Str[4], " 200")) != 0 )
    *v3 = 0;
  vsprintf(v10, Format, va);
  sprintf(Dest, "%s:  %s", &Str[4], v10);
  if ( fileHandle )
    fprintf(fileHandle, "%s", Dest);
  printf("%s", Dest);
  v4 = &LogArray[256 * CurrentLogLine];
  strcpy(v4, Dest);
  v5 = v4;
  if ( *v4 >= 32 )
  {
    do
      v6 = *++v5;
    while ( v6 >= 32 );
  }
  *v5 = 0;
  result = (CurrentLogLine + 1) / 48;
  CurrentLogLine = (CurrentLogLine + 1) % 48;
  return result;
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 437CA4: using guessed type int CurrentLogLine;
// 4D55CC: using guessed type int MiscServerLog;

//----- (004144C0) --------------------------------------------------------
char *__cdecl IsOffensiveName(int *a1)
{
  int *v1; // esi
  char *v2; // edi
  char v3; // al
  LPCSTR v4; // ecx
  int v5; // edi
  int v6; // esi
  const char *v7; // eax
  char *result; // eax
  char Str[400]; // [esp+8h] [ebp-190h] BYREF

  v1 = a1;
  v2 = Str;
  if ( *(_BYTE *)a1 )
  {
    do
    {
      if ( isalpha(*(char *)v1) )
        *v2++ = toupper(*(char *)v1);
      v3 = *((_BYTE *)v1 + 1);
      v1 = (int *)((char *)v1 + 1);
    }
    while ( v3 );
  }
  v4 = ObscenePointer;
  *v2 = 0;
  v5 = ListMachine((int)v4);
  v6 = 0;
  if ( v5 <= 0 )
    return 0;
  while ( 1 )
  {
    v7 = (const char *)ListMachineByIndex((int)ObscenePointer, v6);
    result = strstr(Str, v7);
    if ( result )
      break;
    if ( ++v6 >= v5 )
      return result;
  }
  return (char *)1;
}

//----- (00414560) --------------------------------------------------------
signed int __cdecl IsBannedIPAddress(int a1, const char *a2)
{
  int v2; // ebp
  int v3; // ebx
  int v4; // edx
  unsigned int v5; // kr04_4
  signed int v6; // esi
  int v7; // eax
  const char *v8; // edx
  unsigned int v9; // ecx
  int v11; // edx
  unsigned int v12; // kr10_4
  signed int v13; // esi
  int v14; // ebp
  const char *v15; // edx
  unsigned int v16; // ecx
  int v17; // [esp+14h] [ebp-4h]
  int v18; // [esp+14h] [ebp-4h]
  int v19; // [esp+1Ch] [ebp+4h]

  v2 = 0;
  v3 = a1;
  v4 = *(_DWORD *)&Security[a1].field_FC0;
  if ( !v4 )
    goto LABEL_17;
  v19 = 1;
  v5 = strlen(a2) + 1;
  v6 = v5 - 1;
  if ( v5 == 1 )
  {
    v19 = 0;
  }
  else
  {
    v7 = ListMachine(v4);
    v17 = v7;
    if ( v7 )
    {
      if ( v7 > 0 )
      {
        while ( 1 )
        {
          v8 = (const char *)ListMachineByIndex(Security[v3].field_FBC, v2);
          if ( v6 >= (int)strlen(v8) )
            v9 = strlen(v8);
          else
            v9 = v6;
          if ( !memcmp(a2, v8, v9) )
            v19 = 0;
          if ( ++v2 >= v17 )
            break;
          v6 = v5 - 1;
        }
      }
    }
    else
    {
      v19 = 0;
    }
  }
  if ( v19 )
    return 1;
LABEL_17:
  v11 = Security[v3].field_FBC;
  if ( !v11 )
    return 0;
  v12 = strlen(a2) + 1;
  v13 = v12 - 1;
  if ( v12 == 1 )
    return 0;
  v14 = 0;
  v18 = ListMachine(v11);
  if ( v18 <= 0 )
    return 0;
  while ( 1 )
  {
    v15 = (const char *)ListMachineByIndex(Security[v3].field_FBC, v14);
    v16 = v13 >= (int)strlen(v15) ? strlen(v15) : v13;
    if ( !memcmp(a2, v15, v16) )
      break;
    if ( ++v14 >= v18 )
      return 0;
    v13 = v12 - 1;
  }
  return 1;
}

//----- (004146D0) --------------------------------------------------------
void __cdecl SendBillerWarnings(const char *a1, PLAYER *player)
{
  int v2; // eax
  char *v3; // eax
  int v4; // esi
  PLAYER **v5; // ebx
  PLAYER *v6; // edx
  int v7; // [esp-4h] [ebp-414h]
  int v8; // [esp-4h] [ebp-414h]
  char Args[512]; // [esp+10h] [ebp-400h] BYREF
  char buf[3]; // [esp+210h] [ebp-200h] BYREF
  __int16 v11; // [esp+213h] [ebp-1FDh]
  char v12[507]; // [esp+215h] [ebp-1FBh] BYREF

  strcpy(Args, a1);
  if ( player )
  {
    v7 = player->TotalUsageSeconds2;
    v2 = time(0);
    v8 = (__int64)difftime(v2, v7);
    v3 = GetIPAddressString((struct in_addr)player->IPAddressDWORD);
    sprintf(Args, "%s (%s)(%d)(%s)(sec=%d)", a1, player->PlayerName, player->MachineId, v3, v8);
  }
  WriteSubGameLog("%s\n", Args);
  v11 = -1;                                     // Originator ID
  buf[0] = 7;                                   // 0x07 - Chat
  buf[1] = 8;                                   // Chat Type - 0x08 - Red server errors, without a name tag (S2C only)
  buf[2] = 0;                                   // Sound Byte
  strcpy(v12, Args);                            // Chat Message
  v4 = 0;
  if ( ZonePlayerCount > 0 )
  {
    v5 = playerPointerList;
    do
    {
      v6 = *v5;
      if ( (*v5)->MyArena && v6->isSysop )
        SendPlayerReliablePacket(v6, buf, strlen(Args) + 6, 1);
      ++v4;
      ++v5;
    }
    while ( v4 < ZonePlayerCount );
  }
  if ( BillingConnectionStructPointer )
  {
    if ( player )
      SendBillerWarningPacket(
        (struct BILLING_SERVER_STRUCT *)BillingConnectionStructPointer,
        player->BillerPlayerId,
        Args);
    else
      SendBillerWarningPacket((struct BILLING_SERVER_STRUCT *)BillingConnectionStructPointer, 0, Args);
  }
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 4146D0: using guessed type char var_1FB[507];

//----- (00414850) --------------------------------------------------------
void __cdecl ChatProcessor(PLAYER *player, int zonePlayerIndex, signed int zonePlayerIndex_4, char *ChatText, char SoundByte)
{
  struct _EXCEPTION_REGISTRATION_RECORD *v7; // eax
  void *v8; // esp
  char *v9; // ebx
  PLAYER *v10; // ebp
  signed int v11; // edi
  PLAYER *v12; // edx
  int v13; // ecx
  int v14; // esi
  int v15; // eax
  char v16; // al
  const char *v17; // ebx
  ENCRYPTION **v18; // edx
  PLAYER *v19; // eax
  int v20; // esi
  char *v21; // ecx
  int v22; // edx
  signed int v23; // ebx
  ARENA *v24; // eax
  int v25; // esi
  int v26; // edi
  int v27; // eax
  float v28; // ecx
  int v29; // esi
  int v30; // edi
  int v31; // esi
  int v32; // ecx
  int v33; // eax
  char v34; // al
  char *v35; // ebx
  char v36; // al
  char v37; // al
  char *v38; // ebx
  char v39; // al
  char v40; // al
  char *v41; // ebx
  char v42; // al
  int v43; // ebx
  const char *v44; // edx
  char *v45; // edi
  int v46; // edi
  int n; // esi
  char *v48; // eax
  int ii; // esi
  char *v50; // edx
  char *v51; // ebx
  PLAYER *v52; // eax
  int v53; // edx
  BOOL v54; // ecx
  PLAYER *v55; // eax
  int v56; // edx
  BOOL v57; // ecx
  char v58; // cl
  char *v59; // eax
  char *jj; // edx
  char v61; // cl
  char v62; // cl
  char *v63; // eax
  char *kk; // edx
  char v65; // cl
  char v66; // cl
  _BYTE *v67; // eax
  char *ll; // edx
  char *v69; // eax
  char v70; // al
  char *v71; // esi
  char *mm; // ecx
  char v73; // al
  char v74; // al
  _BYTE *v75; // esi
  char *nn; // ecx
  char v77; // al
  _BYTE *v78; // esi
  char *i1; // ecx
  char *v80; // ebx
  ENCRYPTION **v81; // edx
  char v82; // al
  char *v83; // ebx
  char v84; // al
  ARENA *v85; // eax
  unsigned int v86; // kr44_4
  int v87; // edi
  PLAYER **v88; // ebx
  PLAYER *v89; // ecx
  PLAYER *v90; // esi
  char *v91; // eax
  ARENA *v92; // eax
  int v93; // ecx
  int v94; // eax
  ENCRYPTION *v95; // ecx
  int v96; // edi
  int v97; // edx
  int v98; // edi
  double v99; // st7
  int v100; // eax
  int v101; // ecx
  int v102; // eax
  double v103; // st7
  int v104; // ecx
  int v105; // edx
  int v106; // edi
  int v107; // eax
  int v108; // edi
  int v109; // ecx
  int v110; // ecx
  PLAYER *v111; // eax
  int v112; // edx
  char v113; // al
  char *v114; // edi
  char v115; // al
  char v116; // al
  bool v117; // zf
  __int16 v118; // ax
  PLAYER *v119; // edi
  ARENA *v120; // eax
  int v121; // ecx
  int v122; // edx
  PLAYER *v123; // eax
  ARENA *v124; // eax
  int v125; // ecx
  int v126; // edx
  PLAYER *v127; // eax
  PLAYER *v128; // eax
  char *v129; // eax
  char v130; // al
  char *v131; // edi
  char v132; // al
  ARENA *v133; // eax
  unsigned int v134; // kr58_4
  char v135; // al
  char *v136; // edi
  char v137; // al
  char v138; // al
  char *v139; // edi
  char v140; // al
  int v141; // eax
  __int16 v142; // ax
  PLAYER *v143; // esi
  int v144; // edx
  char v145; // al
  char *v146; // edi
  char v147; // al
  PLAYER *v148; // esi
  int v149; // edx
  PLAYER *v150; // esi
  int v151; // edi
  int v152; // eax
  int v153; // esi
  int v154; // eax
  ARENA *v155; // ecx
  int v156; // edi
  ARENA **v157; // esi
  PLAYER *v158; // ecx
  int v159; // edi
  PLAYER **v160; // esi
  PLAYER *v161; // ecx
  ARENA *v162; // ecx
  FILE *v163; // eax
  const char *v164; // edi
  int v165; // ebx
  int v166; // eax
  FILE *v167; // eax
  ARENA *v168; // eax
  int v169; // esi
  int v170; // edi
  const char *v171; // esi
  int v172; // edx
  int v173; // eax
  int v174; // esi
  char *i; // ebx
  int j; // ebx
  char *v177; // eax
  int v178; // ecx
  const char *v179; // edi
  int v180; // ebx
  int v181; // esi
  ARENA *v182; // edx
  int v183; // eax
  int v184; // esi
  int v185; // edi
  int *v186; // edx
  int v187; // ecx
  __int64 v188; // rax
  ARENA *v189; // eax
  int v190; // edx
  int v191; // ecx
  __int16 v192; // ax
  int v193; // eax
  int v194; // ecx
  int v195; // eax
  int v196; // eax
  ARENA *v197; // ecx
  char *v198; // eax
  char *v199; // edx
  char *v200; // ebx
  struc_2 *v201; // eax
  float v202; // esi
  char *v203; // esi
  const char **v204; // ebp
  int v205; // eax
  int v206; // eax
  int v207; // eax
  char *v208; // edx
  ARENA *v209; // ecx
  int v210; // ebx
  PLAYER *v211; // ecx
  int v212; // esi
  __int64 v213; // rax
  __int64 v214; // rax
  const char *v215; // edi
  int v216; // edx
  int v217; // ecx
  char *v218; // edx
  char *v219; // ebx
  char *v220; // ebx
  int v221; // eax
  signed int v222; // ecx
  signed int v223; // ecx
  unsigned __int64 v224; // rax
  int v225; // ecx
  int v226; // eax
  char v227; // al
  char *v228; // edi
  char *k; // ecx
  char v230; // al
  char v231; // al
  char *v232; // edi
  char *l; // ecx
  char v234; // al
  char *v235; // edi
  char *v236; // esi
  LPCSTR v238; // ecx
  int v239; // edi
  int v240; // esi
  const char *v241; // eax
  ARENA *v242; // ecx
  int v243; // eax
  int v244; // eax
  __int64 v245; // rax
  __int64 v246; // rax
  __int64 v247; // rax
  const char *v248; // ebx
  char *v249; // edi
  char *v250; // esi
  ARENA *v251; // eax
  ARENA *v252; // eax
  char *v253; // eax
  int v254; // edx
  struct PLAYER *v255; // esi
  bool v256; // cc
  ARENA **v257; // edi
  ARENA *v258; // eax
  int v259; // ebx
  int v260; // esi
  unsigned int v261; // krA0_4
  ARENA **v262; // esi
  int v263; // ebp
  int v264; // edi
  ARENA *v265; // edx
  int v266; // esi
  int v267; // ecx
  char *v268; // ecx
  char v269; // al
  char *m; // edx
  char v271; // al
  char v272; // al
  const char *v273; // ecx
  int v274; // eax
  int v275; // eax
  unsigned int v276; // krB0_4
  int v277; // edi
  PLAYER **v278; // ebp
  unsigned __int64 v279; // [esp+0h] [ebp-16090h]
  int v280; // [esp+8h] [ebp-16088h]
  const char *v281; // [esp+8h] [ebp-16088h]
  int v282; // [esp+Ch] [ebp-16084h]
  int v283; // [esp+Ch] [ebp-16084h]
  const char *v284; // [esp+10h] [ebp-16080h]
  unsigned __int64 v285; // [esp+10h] [ebp-16080h]
  const char *v286; // [esp+10h] [ebp-16080h]
  __int64 v287; // [esp+10h] [ebp-16080h]
  const char *v288; // [esp+10h] [ebp-16080h]
  const char *v289; // [esp+10h] [ebp-16080h]
  unsigned __int64 v290; // [esp+10h] [ebp-16080h]
  unsigned __int64 v291; // [esp+10h] [ebp-16080h]
  BOOL v292; // [esp+14h] [ebp-1607Ch]
  int v293; // [esp+14h] [ebp-1607Ch]
  int v294; // [esp+14h] [ebp-1607Ch]
  int v295; // [esp+14h] [ebp-1607Ch]
  float a5; // [esp+28h] [ebp-16068h] BYREF
  int a6; // [esp+2Ch] [ebp-16064h] BYREF
  const char *v298; // [esp+30h] [ebp-16060h] BYREF
  int v299; // [esp+34h] [ebp-1605Ch] BYREF
  char ExitCode[5]; // [esp+38h] [ebp-16058h] BYREF
  char v301; // [esp+3Fh] [ebp-16051h] BYREF
  size_t Size; // [esp+40h] [ebp-16050h] BYREF
  int v303; // [esp+44h] [ebp-1604Ch]
  int v304; // [esp+48h] [ebp-16048h] BYREF
  int a2a; // [esp+4Ch] [ebp-16044h] BYREF
  char v306; // [esp+50h] [ebp-16040h] BYREF
  __int16 v307; // [esp+51h] [ebp-1603Fh]
  _DWORD v308[2]; // [esp+53h] [ebp-1603Dh]
  __int16 v309; // [esp+5Bh] [ebp-16035h]
  __int16 v310; // [esp+5Dh] [ebp-16033h]
  int v311; // [esp+60h] [ebp-16030h] BYREF
  char KeyName[32]; // [esp+64h] [ebp-1602Ch] BYREF
  char CommandLine[256]; // [esp+84h] [ebp-1600Ch] BYREF
  char Dest[256]; // [esp+184h] [ebp-15F0Ch] BYREF
  char Str1[64]; // [esp+284h] [ebp-15E0Ch] BYREF
  char AppName[64]; // [esp+2C4h] [ebp-15DCCh] BYREF
  char buf[256]; // [esp+304h] [ebp-15D8Ch] BYREF
  char v318[256]; // [esp+404h] [ebp-15C8Ch] BYREF
  char StartupInfo[256]; // [esp+504h] [ebp-15B8Ch] BYREF
  char v320[256]; // [esp+604h] [ebp-15A8Ch] BYREF
  char v321[8192]; // [esp+804h] [ebp-1588Ch] BYREF
  char Str[256]; // [esp+2804h] [ebp-1388Ch] BYREF
  struct _EXCEPTION_REGISTRATION_RECORD *v323; // [esp+16084h] [ebp-Ch]
  void *v324; // [esp+16088h] [ebp-8h]
  int v325; // [esp+1608Ch] [ebp-4h]
  char *Buf1a; // [esp+160A0h] [ebp+10h]

  v325 = -1;
  v7 = NtCurrentTeb()->NtTib.ExceptionList;
  v324 = &loc_4288DE;
  v323 = v7;
  v8 = alloca(0x1605C);
  v9 = ChatText;
  v10 = player;
  if ( player && player->isModerator && *ChatText == '8' || strlen(ChatText) > 0xFA )
    return;
  v11 = zonePlayerIndex_4;
  SomethingWithSendingChatTypes(player, zonePlayerIndex, zonePlayerIndex_4, ChatText, SoundByte);
  if ( player )
  {
    v12 = 0;
    if ( zonePlayerIndex_4 >= 0 && zonePlayerIndex_4 < 1024 )
      v12 = ZonePlayerList[zonePlayerIndex_4];
    v13 = BillingLogMessages;
    if ( BillingLogMessages <= player->Extra2 )
      v13 = player->Extra2;
    if ( v12 && v12->Extra2 )
    {
      if ( v13 )
      {
LABEL_16:
        v14 = -1;
        switch ( zonePlayerIndex )
        {
          case 3:
            v14 = -2;
            break;
          case 4:
            v14 = -3;
            break;
          case 5:
            if ( v12 )
              v14 = v12->UserId;
            break;
          case 9:
            v14 = -4;
            break;
          default:
            break;
        }
        if ( v13 == 3
          || v13 == 2
          && (zonePlayerIndex == 3
           || zonePlayerIndex == 4
           || zonePlayerIndex == 5
           || zonePlayerIndex == 9
           || *ChatText == '*')
          || v13 == 1 && (zonePlayerIndex == 5 || *ChatText == '*') )
        {
          v15 = player->UserId;
          if ( v15 >= 0 )
          {
            if ( BillingConnectionStructPointer )
              SendBillerUnknownPacket((ENCRYPTION **)BillingConnectionStructPointer, v15, v14, ChatText);
          }
        }
        goto LABEL_35;
      }
      v13 = *ChatText != '*';
    }
    if ( !v13 )
      goto LABEL_35;
    goto LABEL_16;
  }
LABEL_35:
  v16 = *ChatText;
  if ( *ChatText != '*' )
  {
    if ( player )
    {
      a6 = (int)player->MyArena;
      if ( a6 )
      {
        if ( v16 == 63 )
        {
          if ( !strcmp(ChatText, "?usage") )
          {
            v294 = player->TotalUsageSeconds2;
            v173 = time(0);
            v174 = (__int64)difftime(v173, v294);
            sprintf(CommandLine, "Session Usage: %5d hours %d minutes", v174 / 3600, v174 / 60 % 60);
            SendMessage(player, CommandLine, 0);
            sprintf(
              CommandLine,
              "  Total Usage: %5d hours %d minutes",
              (player->UsageTotalSeconds + v174) / 3600,
              (player->UsageTotalSeconds + v174) / 60 % 60);
            SendMessage(player, CommandLine, 0);
            v279 = __PAIR64__(
                     (unsigned __int16)player->AccountCreationDay,
                     (unsigned __int16)player->AccountCreationMonth);
            sprintf(
              CommandLine,
              " First played: %d-%d-%d %d:%d:%d",
              (_DWORD)v279,
              HIDWORD(v279),
              player->AccountCreationYear,
              (unsigned __int16)player->AccountCreationHour,
              (unsigned __int16)player->AccountCreationMinute,
              (unsigned __int16)player->AccountCreationSecond);
            SendMessage(player, CommandLine, 0);
            return;
          }
          if ( !strcmp(ChatText, "?sheep") )
          {
            SendMessage(player, (char *)(a6 + 110542), 24);
            return;
          }
          if ( !memcmp(ChatText, "?buy", 4u) )
          {
            for ( i = ChatText + 4; *i == 32 || *i == 61; ++i )
              ;
            Buf1a = i;
            if ( *i )
            {
              if ( player->Ship == 8 )
              {
                SendMessage(player, "Spectators cannot purchase items.", 0);
              }
              else if ( *(_DWORD *)(a6 + 109770) || (player->ShipTogglables & 0x20) != 0 )
              {
                v180 = 0;
                v181 = 0;
                while ( _strcmpi(&player->MyArena->ServersideArenaSettings.char158[v181], Buf1a) )
                {
                  v181 += 24;
                  ++v180;
                  if ( v181 >= 576 )
                    goto LABEL_495;
                }
                v182 = player->MyArena;
                v183 = player->FlagPoints;
                v184 = 24 * v180;
                v185 = *(_DWORD *)&v182->ServersideArenaSettings.char158[24 * v180 + 16];
                v186 = (int *)&v182->ServersideArenaSettings.char158[24 * v180 + 16];
                if ( v185 )
                {
                  if ( v185 <= v183 + player->KillPoints )
                  {
                    v187 = *v186;
                    if ( *v186 <= v183 )
                    {
                      HIDWORD(v287) = -v187;
                      LODWORD(v287) = 0;
                    }
                    else
                    {
                      HIDWORD(v188) = -v183;
                      LODWORD(v188) = v183 - v187;
                      v287 = v188;
                    }
                    UpdatePoints(player, v287, HIDWORD(v287));
                    v189 = player->MyArena;
                    ExitCode[0] = 32;
                    *(_WORD *)&ExitCode[3] = *(_WORD *)&v189->ServersideArenaSettings.char158[v184 + 20];
                    *(_WORD *)&ExitCode[1] = 1;
                    SendPlayerReliablePacket(player, ExitCode, 5, 1);
                    v190 = player->FlagPoints;
                    v191 = player->KillPoints;
                    v307 = player->PlayerId;
                    v192 = player->CurrentWins;
                    v308[1] = v190;
                    v308[0] = v191;
                    LOWORD(v191) = player->CurrentLosses;
                    v309 = v192;
                    v193 = *(_DWORD *)&player->CurrentWins;
                    v310 = v191;
                    v194 = *(_DWORD *)&player->GoalCount;
                    player->dword23F = v193;
                    v195 = *(int *)((char *)&player->KillPoints + 2);
                    v306 = 9;
                    *(_DWORD *)&player->dword243 = v194;
                    LOWORD(v194) = HIWORD(player->FlagPoints);
                    *(_DWORD *)&player->dword247 = v195;
                    LOWORD(player->word24B) = v194;
                    SendPlayerReliablePacket(player, &v306, 15, 1);
                    if ( *(int *)&player->MyArena->ServersideArenaSettings.char158[v184 + 16] > 500 )
                      SendEverybodyButYourself(player, &v306, 0xFu, 0);
                  }
                  else
                  {
                    SendMessage(player, "You do not have enough points to purchase that item.", 0);
                  }
                }
                else
                {
                  SendMessage(player, "That item is not available for purchase.", 0);
                }
LABEL_495:
                if ( v180 == 24 )
                  SendMessage(player, "Invalid item specified for purchase.", 0);
              }
              else
              {
                SendMessage(player, "You must be in safe zone to purchase items.", 0);
              }
              return;
            }
            CommandLine[0] = 0;
            for ( j = 0; j < 576; j += 24 )
            {
              v177 = (char *)player->MyArena + j;
              v178 = *(_DWORD *)(v177 + 109982);
              if ( v178 > 0 )
              {
                sprintf(Dest, "%s=%d", v177 + 109966, v178);
                if ( strlen(Dest) + strlen(CommandLine) > 0x4B )
                {
                  SendMessage(player, CommandLine, 0);
                  CommandLine[0] = 0;
                }
                v179 = " ";
                if ( !CommandLine[0] )
                  v179 = "PRICE: ";
                strcat(CommandLine, v179);
                strcat(CommandLine, Dest);
              }
            }
            if ( !CommandLine[0] )
              return;
LABEL_477:
            SendMessage(player, CommandLine, 0);
            return;
          }
          if ( !strcmp(ChatText, "?zone") )
          {
            SendMessage(player, BillingServerName, 0);
            return;
          }
          if ( !strcmp(ChatText, "?userid") )
          {
            sprintf(Dest, "UserId:%d", player->UserId);
            SendMessage(player, Dest, 0);
            return;
          }
          if ( !strcmp(ChatText, "?owner") )
          {
            sprintf(Dest, "Arena Owner:%s", (const char *)(a6 + 110798));
            SendMessage(player, Dest, 0);
            return;
          }
          if ( !strcmp(ChatText, "?getsettings") )
          {
            if ( player->isSysop || (v196 = *(_DWORD *)(a6 + 109622), player->UserId == v196) && v196 >= 0 )
            {
              SendMessage(player, "File being sent, please wait.", 0);
              v197 = player->MyArena;
              Str[0] = 16;
              v198 = strrchr(v197->szConfigFile, 92);
              if ( v198 )
              {
                strcpy(&Str[1], v198 + 1);
                v199 = strrchr(&Str[1], 46);
                if ( v199 )
                  strcpy(v199, ".set");
                v200 = &Str[17];
                v201 = (struc_2 *)operator new(0x2B74Cu);
                *(_DWORD *)ExitCode = v201;
                v325 = 0;
                if ( v201 )
                {
                  v202 = COERCE_FLOAT(ReadSettingsSomething(v201, player->MyArena->szConfigFile));
                  a5 = v202;
                }
                else
                {
                  a5 = 0.0;
                  v202 = 0.0;
                }
                v325 = -1;
                v298 = 0;
                if ( TotalTemplateSSSEntries > 0 )
                {
                  v203 = TotalTemplateSSSList[0].SomeString256;
                  do
                  {
                    if ( !v203[256] || v10->isSysop )
                    {
                      if ( _strcmpi(v203 - 80, "All") )
                      {
                        sub_4066B0(
                          SLODWORD(a5),
                          v203 - 80,
                          v203 - 48,
                          (const char *)&DirectoryCurrentNamePassword,
                          Dest,
                          0x100u);
                        v206 = *((_DWORD *)v203 - 2);
                        if ( v206 == -999 )
                          sprintf(v200, "%s:%s:%s:::%s\r\n", v203 - 80, v203 - 48, Dest, v203);
                        else
                          sprintf(
                            v200,
                            "%s:%s:%s:%d:%d:%s\r\n",
                            v203 - 80,
                            v203 - 48,
                            Dest,
                            v206,
                            *((_DWORD *)v203 - 1),
                            v203);
                        v200 += strlen(v200);
                      }
                      else
                      {
                        v204 = (const char **)off_42C848;
                        do
                        {
                          sub_4066B0(
                            SLODWORD(a5),
                            *v204,
                            v203 - 48,
                            (const char *)&DirectoryCurrentNamePassword,
                            CommandLine,
                            0x100u);
                          if ( (int)v204 <= (int)off_42C848 )
                          {
                            v205 = *((_DWORD *)v203 - 2);
                            if ( v205 == -999 )
                              sprintf(v200, "%s:%s:%s:::%s\r\n", *v204, v203 - 48, CommandLine, v203);
                            else
                              sprintf(
                                v200,
                                "%s:%s:%s:%d:%d:%s\r\n",
                                *v204,
                                v203 - 48,
                                CommandLine,
                                v205,
                                *((_DWORD *)v203 - 1),
                                v203);
                          }
                          else
                          {
                            sprintf(v200, "%s:%s:%s:*\r\n", *v204, v203 - 48, CommandLine);
                          }
                          ++v204;
                          v200 += strlen(v200);
                        }
                        while ( (int)v204 < (int)"Spawned Command" );
                      }
                    }
                    v10 = player;
                    v203 += 338;
                    ++v298;
                  }
                  while ( (int)v298 < TotalTemplateSSSEntries );
                  v202 = a5;
                }
                SendPlayerReliablePacket(v10, Str, v200 - Str, 1);
                if ( v202 != 0.0 )
                {
                  WriteCfgFile(SLODWORD(v202));
                  operator delete((void *)LODWORD(v202));
                }
              }
            }
            else
            {
              SendMessage(player, "Only the owner of this arena can view the settings.", 0);
            }
            return;
          }
          if ( !memcmp(ChatText, "?setlevel ", 0xAu) )
          {
            if ( player->isSysop || (v207 = *(_DWORD *)(a6 + 109622), player->UserId == v207) && v207 >= 0 )
            {
              buf[0] = 25;
              strncpy(&buf[1], ChatText + 10, 0x100u);
              v208 = player->MyArena->szLevelFile2;
              v318[0] = 0;
              strncpy(&v318[1], v208, 0x10u);
              v318[16] = 0;
              SendPlayerReliablePacket(player, buf, 273, 1);
            }
            else
            {
              SendMessage(player, "Only the owner of this arena can change the level.", 0);
            }
            return;
          }
          if ( !strcmp(ChatText, "?recycle") )
          {
            if ( player->isSysop || player->UserId == *(_DWORD *)(a6 + 109622) )
              *(_DWORD *)(a6 + 65574) = 1;
            else
              SendMessage(player, "Only the owner of this arena can recycle it.", 0);
            return;
          }
          if ( !strcmp(ChatText, "?spec") )
          {
            v209 = (ARENA *)a6;
            CommandLine[0] = 0;
            v298 = 0;
            if ( *(int *)(a6 + 65292) > 0 )
            {
              v210 = 16072;
              do
              {
                v211 = v209->PlayerPointers[v210];
                v212 = 0;
                if ( player->isSuperModerator )
                {
                  if ( v211->Ship == 8 && v211->ArenaPlayerIndex < 0 )
                  {
                    v213 = v211->XPixels - player->XPixels;
                    if ( (int)((HIDWORD(v213) ^ v213) - HIDWORD(v213)) < 1280 )
                    {
                      v214 = v211->YPixels - player->YPixels;
                      if ( (int)((HIDWORD(v214) ^ v214) - HIDWORD(v214)) < 1024 )
                        v212 = 1;
                    }
                  }
                }
                if ( (v211->ArenaPlayerIndex == *(_DWORD *)&player->PlayerId || v212)
                  && (player->isSysop || !v211->isModerator) )
                {
                  if ( v212 )
                    v288 = "*%s";
                  else
                    v288 = "%s";
                  sprintf(Dest, v288, v211->Name);
                  if ( strlen(Dest) + strlen(CommandLine) > 0x4B )
                  {
                    SendMessage(player, CommandLine, 0);
                    CommandLine[0] = 0;
                  }
                  v215 = ",";
                  if ( !CommandLine[0] )
                    v215 = "SPEC: ";
                  strcat(CommandLine, v215);
                  strcat(CommandLine, Dest);
                }
                v209 = player->MyArena;
                ++v210;
                v216 = v209->ArenaPlayerCount;
                ++v298;
              }
              while ( (int)v298 < v216 );
            }
            if ( !CommandLine[0] )
              return;
            goto LABEL_477;
          }
          if ( !strcmp(ChatText, "?packetloss") )
          {
            sub_41CB70((int)player->encryptionPointer, (int)&a5, (int)&v299);
            v217 = 1000 - v299;
            v117 = LODWORD(a5) == 1000;
            LODWORD(a5) = 1000 - LODWORD(a5);
            v299 = 1000 - v299;
            if ( !v117 || v217 )
              sprintf(
                CommandLine,
                "PACKET LOSS ServerToYou:%.1f%%  YouToServer:%.1f%%",
                (double)SLODWORD(a5) * 0.1,
                (double)v299 * 0.1);
            else
              sprintf(CommandLine, "PACKET LOSS Unknown, check again in a few minutes.");
            SendMessage(player, CommandLine, 0);
            return;
          }
          if ( !strcmp(ChatText, "?jackpot") )
          {
            sprintf(Dest, "Current Jackpot: %d", *(_DWORD *)(a6 + 65382));
            SendMessage(player, Dest, 0);
            return;
          }
          if ( !strcmp(ChatText, "?crown") )
          {
            if ( *(int *)(a6 + 109910) <= 0 || *(int *)(a6 + 109930) <= 0 )
            {
              SendMessage(player, "This is not a king of the hill style game or crowns cannot be recovered.", 0);
            }
            else if ( (int)player->KotHDeathCount <= 0 )
            {
              sprintf(Dest, "Kills needed for crown: %d", *(_DWORD *)(a6 + 109930) - player->KingCrownKills);
              SendMessage(player, Dest, 0);
            }
            else
            {
              SendMessage(player, "You already have a crown.", 0);
            }
            return;
          }
          if ( !strcmp(ChatText, "?score") )
          {
            GetScore((ARENA *)a6, (int)player);
            return;
          }
          if ( !strcmp(ChatText, "?arena") )
          {
            v218 = 0;
            v321[0] = 47;
            v219 = &v321[1];
            v298 = 0;
            if ( ArenaArrayLength > 0 )
            {
              a5 = COERCE_FLOAT(Arenas);
              do
              {
                if ( *(_BYTE *)(*(_DWORD *)LODWORD(a5) + 64256) != 35
                  || player->isModerator
                  || player->MyArena == *(ARENA **)LODWORD(a5) )
                {
                  if ( *(_BYTE *)(*(_DWORD *)LODWORD(a5) + 64256) )
                  {
                    v295 = *(_DWORD *)LODWORD(a5) + 64256;
                    v289 = "%s";
                  }
                  else
                  {
                    v295 = (int)v218;
                    v289 = "%d";
                  }
                  sprintf(CommandLine, v289, v295);
                  strcpy(v219, CommandLine);
                  v220 = &v219[strlen(CommandLine) + 1];
                  v221 = *(_DWORD *)LODWORD(a5);
                  if ( *(ARENA **)LODWORD(a5) == player->MyArena )
                    *(_WORD *)v220 = -*(_WORD *)(v221 + 65292);
                  else
                    *(_WORD *)v220 = *(_WORD *)(v221 + 65292);
                  v218 = (char *)v298;
                  v219 = v220 + 2;
                }
                v298 = ++v218;
                LODWORD(a5) += 4;
              }
              while ( (int)v218 < ArenaArrayLength );
            }
            SendPlayerReliablePacket(player, v321, v219 - v321, 1);
            return;
          }
          if ( !strcmp(ChatText, "?time") )
          {
            if ( *(int *)(a6 + 109754) <= 0 )
            {
              if ( !*(_DWORD *)(a6 + 65362) )
              {
                if ( player->isModerator )
                {
                  v223 = player->MyArena->ServersideArenaSettings.TerritoryRewardDelay
                       - abs32(GetTickCount() / 0xA - player->MyArena->TerritoryRewardTimePassed);
                  if ( v223 < 0 )
                    v223 = 0;
                  sprintf(CommandLine, "Time left to reward: %d minutes %d seconds", v223 / 6000, v223 % 6000 / 100);
                  SendMessage(player, CommandLine, 0);
                }
                else
                {
                  SendMessage(player, "This zone does not have a game time limit", 0);
                }
                return;
              }
              v222 = player->MyArena->GameTimeStart - abs32(GetTickCount() / 0xA - player->MyArena->GameTimePassed);
              if ( v222 < 0 )
                v222 = 0;
            }
            else
            {
              v222 = player->MyArena->ServersideArenaSettings.MiscTimedGame
                   - abs32(GetTickCount() / 0xA - player->MyArena->GameTimePassedTwo);
              if ( v222 < 0 )
                v222 = 0;
            }
            sprintf(CommandLine, "Time left: %d minutes %d seconds", v222 / 6000, v222 % 6000 / 100);
            SendMessage(player, CommandLine, 0);
            return;
          }
          if ( !strcmp(ChatText, "?best") )
          {
            if ( *(int *)(a6 + 109754) <= 0 )
            {
              HIDWORD(v224) = (unsigned __int16)player->CurrentLosses;
              LODWORD(v224) = (unsigned __int16)player->CurrentWins;
              v290 = v224;
              v283 = player->KillPoints + player->FlagPoints;
              v281 = "CURRENT SCORE  Points:%d  Win:%d  Lose:%d";
            }
            else
            {
              v290 = __PAIR64__(
                       (unsigned __int16)player->PersonalBestLosses,
                       (unsigned __int16)player->PersonalBestWins);
              v283 = *(_DWORD *)&player->PersonalBestPoints1of2 + *(_DWORD *)&player->PersonalBestGoalCount;
              v281 = "PERSONAL BEST  Points:%d  Win:%d  Lose:%d";
            }
            sprintf(Dest, v281, v283, v290);
            SendMessage(player, Dest, 0);
            return;
          }
          if ( !memcmp(ChatText, "?set ", 5u) || !memcmp(ChatText, "?get ", 5u) )
          {
            v225 = 0;
            if ( player->isSysop
              || (v226 = player->UserId, v226 >= 0) && *(_DWORD *)(a6 + 65570) && *(_DWORD *)(a6 + 109622) == v226 )
            {
              v225 = 1;
            }
            if ( v225 )
            {
              v227 = ChatText[5];
              v228 = ChatText + 5;
              for ( k = AppName; v227; ++v228 )
              {
                if ( v227 == ':' )
                  break;
                *k = v227;
                v227 = v228[1];
                ++k;
              }
              v230 = *v228;
              *k = 0;
              if ( v230 )
              {
                v231 = v228[1];
                v232 = v228 + 1;
                for ( l = Str1; v231; ++v232 )
                {
                  if ( v231 == '=' )
                    break;
                  if ( v231 == ':' )
                    break;
                  *l = v231;
                  v231 = v232[1];
                  ++l;
                }
                v234 = *v232;
                *l = 0;
                if ( v234 )
                  ++v232;
                strcpy(Dest, v232);
                if ( _memicmp(ChatText, "?set ", 5u)
                  || (sprintf(StartupInfo, "%s:%s:%s", AppName, Str1, Dest),
                      !ChangeSettings(player->MyArena, player, StartupInfo)) )
                {
                  if ( !_strcmpi(AppName, "All") )
                    strcpy(AppName, "Warbird");
                  GetPrivateProfileStringA(
                    AppName,
                    Str1,
                    "InvalidTag",
                    CommandLine,
                    0x80u,
                    player->MyArena->szConfigFile);
                  sprintf(buf, "%s:%s=%s", AppName, Str1, CommandLine);
                  SendMessage(player, buf, 0);
                }
              }
            }
            else
            {
              SendMessage(player, "You do not have permission to set parameters in this arena.", 0);
            }
            return;
          }
          if ( isalpha(ChatText[1]) )
          {
            if ( BillingConnectionStructPointer )
              biller_user_command((ENCRYPTION **)BillingConnectionStructPointer, player->BillerPlayerId, ChatText);
            return;
          }
        }
      }
    }
    v235 = buf;
    v236 = ChatText;
    if ( *ChatText )
    {
      do
      {
        if ( isalpha(*v236) )
          *v235++ = toupper(*v236);
      }
      while ( *++v236 );
    }
    v238 = ObscenePointer;
    *v235 = 0;
    v239 = ListMachine((int)v238);
    v240 = 0;
    if ( v239 <= 0 )
    {
LABEL_656:
      a5 = 0.0;
    }
    else
    {
      while ( 1 )
      {
        v241 = (const char *)ListMachineByIndex((int)ObscenePointer, v240);
        if ( strstr(buf, v241) )
          break;
        if ( ++v240 >= v239 )
          goto LABEL_656;
      }
      LODWORD(a5) = 1;
    }
    a6 = 0;
    if ( player )
    {
      if ( player->Ship == 8 && player->MyArena->ServersideArenaSettings.MiscSpectatorQuiet && !player->isModerator )
        a6 = 1;
      if ( (int)(GetTickCount() / 0xA - player->GetTickCountValueDividedByTen2) >= 100 )
      {
        player->dword293 = 0;
      }
      else
      {
        v242 = player->MyArena;
        v243 = player->dword293 + 1;
        player->dword293 = v243;
        if ( v243 > v242->ServersideArenaSettings.MessageQuickMessageLimit && !player->isSysop )
        {
          WriteSubGameLog("Played kicked off for message flooding: %s\n", player->PlayerName);
          player->DisconnectReason = 12;
          player->AlreadySentReliablePacket = 1;
          SendArenaMessagePlayer(player, "WARNING: You have been disconnected for message flooding.", 0);
          return;
        }
      }
      player->GetTickCountValueDividedByTen2 = GetTickCount() / 0xA;
    }
    v244 = zonePlayerIndex;
    if ( zonePlayerIndex == 1 || zonePlayerIndex == 2 )
    {
      if ( player )
      {
        if ( player->MyArena )
        {
          v245 = (int)(GetTickCount() / 0xA - player->MyArena->GameTimePassedTwo);
          if ( (int)((HIDWORD(v245) ^ v245) - HIDWORD(v245)) < 600 )
            return;
          v246 = (int)(GetTickCount() / 0xA - player->MyArena->GetTickCountValue8);
          if ( (int)((HIDWORD(v246) ^ v246) - HIDWORD(v246)) < 500 )
            return;
          v247 = (int)(GetTickCount() / 0xA - player->MyArena->TerritoryRewardTimePassed);
          if ( (int)((HIDWORD(v247) ^ v247) - HIDWORD(v247)) < 500 )
            return;
        }
      }
      v248 = (const char *)&DirectoryCurrentNamePassword;
      v298 = (const char *)&DirectoryCurrentNamePassword;
      if ( player )
      {
        v248 = player->Name;
        v298 = player->Name;
      }
      if ( *v248 && ChatCounter64Max > 0 )
      {
        if ( !strcmp((const char *)&dword_431FC8[91 * ChatCounter64Max], v248)
          && !strcmp((const char *)&dword_431E9C[91 * ChatCounter64Max], ChatText) )
        {
          return;
        }
        v248 = v298;
      }
      v249 = (char *)(364 * ChatCounter64Max + 4399112);
      ChatCounter64Max = (ChatCounter64Max + 1) % 64;
      strncpy(v249, ChatText, 0x12Cu);
      v250 = v249 + 300;
      v249[299] = 0;
      strncpy(v249 + 300, v248, 0x20u);
      v249 += 332;
      v250[31] = 0;
      strncpy(v249, "(Everyone)", 0x20u);
      v249[31] = 0;
      if ( player )
      {
        v251 = player->MyArena;
        if ( v251 )
          FormatMessageArena(v251, "%16.16s>%s\n", v250, ChatText);
      }
      v244 = zonePlayerIndex;
    }
    v320[0] = 7;
    v320[1] = v244;
    v320[2] = SoundByte;
    if ( v244 == 7 )
    {
      if ( !player
        || (v252 = player->MyArena) == 0
        || player->isModerator
        || v252->SpecMessageLock && player->Ship != 8
        || !v252->PrivateMessagesLocked )
      {
        *(_WORD *)&v320[3] = 0;
        v253 = strchr(ChatText + 1, ':');
        *(_DWORD *)ExitCode = v253;
        if ( v253 )
        {
          v254 = v253 - ChatText - 1;
          Size = v254;
          qmemcpy(CommandLine, ChatText + 1, v254);
          v255 = 0;
          v256 = ArenaArrayLength <= 0;
          CommandLine[v254] = 0;
          v299 = 0;
          v298 = 0;
          if ( !v256 )
          {
            v257 = Arenas;
            do
            {
              v258 = *v257;
              v259 = 0;
              if ( (*v257)->ArenaPlayerCount > 0 )
              {
                v260 = 16072;
                while ( _strcmpi(CommandLine, v258->PlayerPointers[v260]->Name) )
                {
                  if ( !v299 && player && !_memicmp(CommandLine, (*v257)->PlayerPointers[v260]->Name, Size) )
                    v299 = (int)(*v257)->PlayerPointers[v260];
                  v258 = *v257;
                  ++v259;
                  ++v260;
                  if ( v259 >= (*v257)->ArenaPlayerCount )
                    goto LABEL_706;
                }
                v299 = (int)(*v257)->playerPointersForSomething[v259];
              }
LABEL_706:
              ++v257;
              ++v298;
            }
            while ( (int)v298 < ArenaArrayLength );
            v254 = Size;
            v253 = *(char **)ExitCode;
            v255 = (struct PLAYER *)v299;
          }
          if ( v255 )
          {
            if ( player )
              sprintf(&v320[5], "(%s)>%s", player->Name, v253 + 1);
            else
              sprintf(&v320[5], "%s", v253 + 1);
            SendToSpectators(v255, v320, strlen(&v320[5]) + 6, 1, SLODWORD(a5), a6);
          }
          else if ( player )
          {
            buf[0] = 2;
            buf[1] = SoundByte;
            sprintf(&buf[2], ":%s:(%s)>%s", CommandLine, player->Name, v253 + 1);
            if ( BillingConnectionStructPointer )
              SendBillerUserPrivateChatPacket(
                (ENCRYPTION **)BillingConnectionStructPointer,
                -1,
                BillingGroupId,
                buf,
                strlen(&buf[2]) + 3);
          }
          else if ( CommandLine[0] == 35 && v254 > 2 && CommandLine[1] != 32 )
          {
            sprintf(&v320[5], "%s", v253 + 1);
            v261 = strlen(&v320[5]) + 1;
            v298 = 0;
            if ( ArenaArrayLength > 0 )
            {
              v262 = Arenas;
              do
              {
                v263 = 0;
                if ( (*v262)->ArenaPlayerCount > 0 )
                {
                  v264 = 16072;
                  do
                  {
                    v291 = __PAIR64__((unsigned int)(*v262)->PlayerPointers[v264]->Squad, &CommandLine[1]);
                    if ( !_strcmpi((const char *)v291, (const char *)HIDWORD(v291)) )
                      SendToSpectators((*v262)->PlayerPointers[v264], v320, v261 - 1 + 6, 1, SLODWORD(a5), a6);
                    ++v263;
                    ++v264;
                  }
                  while ( v263 < (*v262)->ArenaPlayerCount );
                }
                ++v262;
                ++v298;
              }
              while ( (int)v298 < ArenaArrayLength );
            }
          }
        }
      }
    }
    else if ( player && (v265 = player->MyArena) != 0 )
    {
      *(_WORD *)&v320[3] = player->PlayerId;
      *(_DWORD *)ExitCode = strcpy(&v320[5], ChatText);
      v266 = v265->ServersideArenaSettings.MessageReliable;
      v267 = strlen(ChatText) + 6;
      if ( v265->ArenaPlayerCount < 20 )
        v266 = 1;
      switch ( zonePlayerIndex )
      {
        case 1:
        case 2:
          if ( player->isModerator || v265->SpecMessageLock && player->Ship != 8 || !v265->AllMessagesLocked )
            SomethingWithAttachedPlayer(player, v320, v267, v266, SLODWORD(a5), a6);
          break;
        case 3:
          if ( player->isModerator
            || v265->SpecMessageLock && player->Ship != 8
            || !v265->AllMessagesLockedAgainSomething )
          {
            v274 = v265->ServersideArenaSettings.MessageTeamReliable || v266;
            sub_40E220(player, v320, v267, v274, SLODWORD(a5), a6);
          }
          break;
        case 4:
          if ( player->isModerator
            || v265->SpecMessageLock && player->Ship != 8
            || !v265->AllMessagesLockedAgainSomething )
          {
            v275 = v265->ServersideArenaSettings.MessageTeamReliable || v266;
            sub_40E300(player, zonePlayerIndex_4, v320, v267, v275, SLODWORD(a5), a6);
          }
          break;
        case 5:
          if ( player->isModerator || v265->SpecMessageLock && player->Ship != 8 || !v265->PrivateMessagesLocked )
            SomethingWithAudioByteAndShip8((ARENA *)zonePlayerIndex_4, v320, v267, 1, SLODWORD(a5), (ARENA *)a6);
          break;
        case 9:
          if ( player->isModerator || v265->SpecMessageLock && player->Ship != 8 || !v265->PrivateMessagesLocked )
          {
            if ( BillingConnectionStructPointer )
            {
              if ( *ChatText == ';' || isdigit(*ChatText) && ChatText[1] == ';' )
              {
                v268 = ChatText;
                if ( *ChatText == ';' )
                  v268 = ChatText + 1;
                v269 = *v268;
                for ( m = Str1; v269; ++v268 )
                {
                  if ( v269 == ';' )
                    break;
                  if ( v269 == ':' )
                    break;
                  *m = v269;
                  v269 = v268[1];
                  ++m;
                }
                v271 = *v268;
                *m = 0;
                if ( v271 )
                {
                  v272 = v268[1];
                  v273 = v268 + 1;
                  if ( v272 )
                  {
                    if ( Str1[0] )
                      SendBillerUserChannelChatPacket(
                        (ENCRYPTION **)BillingConnectionStructPointer,
                        player->BillerPlayerId,
                        Str1,
                        v273);
                  }
                }
              }
              else
              {
                SendBillerUserChannelChatPacket(
                  (ENCRYPTION **)BillingConnectionStructPointer,
                  player->BillerPlayerId,
                  (const char *)&DirectoryCurrentNamePassword,
                  ChatText);
              }
            }
            else
            {
              SendMessage(player, "Chat channels not available at this time.", 0);
            }
          }
          break;
        default:
          return;
      }
    }
    else
    {
      buf[2] = SoundByte;
      buf[0] = 7;
      buf[1] = 0;
      *(_WORD *)&buf[3] = 0;
      strcpy(&buf[5], ChatText);
      v276 = strlen(ChatText) + 1;
      v277 = 0;
      if ( ZonePlayerCount > 0 )
      {
        v278 = playerPointerList;
        do
        {
          if ( (*v278)->MyArena )
            SendPlayerReliablePacket(*v278, buf, v276 - 1 + 6, 1);
          ++v277;
          ++v278;
        }
        while ( v277 < ZonePlayerCount );
      }
    }
    return;
  }
  if ( !player )
    goto LABEL_41;
  if ( !player->isModerator )
    goto LABEL_443;
  v9 = ChatText;
  v11 = zonePlayerIndex_4;
  if ( !player->isSuperModerator )
    goto LABEL_294;
  if ( player->isSysop )
  {
LABEL_41:
    if ( !_memicmp(v9, "**", 2u) && player )
    {
      v17 = v9 + 2;
      buf[1] = SoundByte;
      buf[0] = 2;
      v18 = (ENCRYPTION **)BillingConnectionStructPointer;
      strcpy(&buf[2], v17);
      if ( v18 )
        SendBillerUserPrivateChatPacket(v18, player->BillerPlayerId, BillingGroupId, buf, strlen(v17) + 3);
      return;
    }
    if ( _memicmp(v9, "*energy", 7u) || !player )
    {
      if ( !_memicmp(v9, "*stat", 5u) && player )
      {
        v23 = GetTickCount() / 0xA - oldTickCountValue;
        v299 = v23;
        if ( v23 <= 0 )
        {
          v23 = 1;
          v299 = 1;
        }
        v24 = player->MyArena;
        a5 = 0.0;
        if ( v24->ArenaPlayerCount > 0 )
        {
          v25 = 0;
          v26 = 16072;
          do
          {
            v27 = GetRelAckDiff(v24->PlayerPointers[v26++]->encryptionPointer, 0);
            LODWORD(v28) = v27 + LODWORD(a5);
            v24 = player->MyArena;
            a5 = v28;
            ++v25;
          }
          while ( v25 < v24->ArenaPlayerCount );
          LODWORD(a5) = 10 * LODWORD(a5) / player->MyArena->ArenaPlayerCount;
        }
        GetPacketStatistics((struct PACKET_ATTACHMENT *)dword_437B08, &a2a, &a6, &v304, (int *)&Size, (int *)&v298);
        sprintf(
          Dest,
          "Send:%d(%d)  Recv:%d(%d)  RelOut:%.1f  Multi:%.1f\n",
          100 * a2a / v23,
          100 * a6 / v23,
          100 * v304 / v23,
          (int)(100 * Size) / v23,
          (double)SLODWORD(a5) * 0.1,           // 0.1
          (double)(int)v298 * 100.0 / (double)v299);// 100.0
        SendMessage(player, Dest, 0);
        v29 = 0;
        if ( encryption )
          v29 = GetRelAckDiff(encryption, 0);
        sprintf(
          Dest,
          "Iterations:%d  Players:%d  BillingRelOut:%d  Wave:%d\n",
          100 * ServerIterations / v23,
          ZonePlayerCount,
          v29,
          100 * Wave / v23);
        SendMessage(player, Dest, 0);
        sprintf(
          Dest,
          "Screen:%d  Radar:%d  Double:%d  Timer:%d\n",
          100 * ScreenValue / v23,
          100 * RadarValue / v23,
          100 * DoubleValue / v23,
          v23 / 100);
        SendMessage(player, Dest, 0);
        v30 = 0;
        v31 = 0;
        if ( ArenaArrayLength > 0 )
        {
          v299 = (int)Arenas;
          do
          {
            v30 += GetArenaMemoryTotal(*(ARENA **)v299);
            ++v31;
            v299 += 4;
          }
          while ( v31 < ArenaArrayLength );
        }
        sprintf(Dest, "MemoryUsage:%dk\n", v30);
        SendMessage(player, Dest, 0);
        v32 = 0;
        Dest[0] = 0;
        v299 = 0;
        do
        {
          v33 = SomeArrayOf256_1[v32];
          if ( v33 )
          {
            sprintf(AppName, "%d:%d(%d)  ", v32, 100 * SomeArrayOf256_2[v32] / v23, 100 * v33 / v23);
            if ( strlen(AppName) + strlen(Dest) > 0x4B )
            {
              SendMessage(player, Dest, 0);
              Dest[0] = 0;
            }
            strcat(Dest, AppName);
            v32 = v299;
          }
          v299 = ++v32;
        }
        while ( v32 < 256 );
        if ( Dest[0] )
          SendMessage(player, Dest, 0);
        goto LABEL_172;
      }
      if ( !_memicmp(v9, "*addword", 8u) )
      {
        v34 = v9[8];
        v35 = v9 + 8;
        ChatText = v35;
        if ( v34 == 32 )
        {
          do
            v36 = *++v35;
          while ( v36 == 32 );
          ChatText = v35;
        }
        if ( *v35 )
        {
          AddLineTextFile((struct TEXT_FILE_STRUCT *)ObscenePointer, v35);
          WriteTextFileToFile((struct TEXT_FILE_STRUCT *)ObscenePointer);
          if ( player )
          {
            sprintf(CommandLine, "Obscene Word Added: %s", v35);
            SendMessage(player, CommandLine, 0);
          }
        }
        goto LABEL_172;
      }
      if ( _memicmp(v9, "*addmachine", 0xBu) )
      {
        if ( !_memicmp(v9, "*removemachine", 0xEu) )
        {
          v40 = v9[14];
          v41 = v9 + 14;
          ChatText = v41;
          if ( v40 == 32 )
          {
            do
              v42 = *++v41;
            while ( v42 == 32 );
            ChatText = v41;
          }
          if ( *v41 )
          {
            v43 = 0;
            v299 = ListMachine((int)IDBlockPointer);
            if ( v299 > 0 )
            {
              do
              {
                v44 = (const char *)ListMachineByIndex((int)IDBlockPointer, v43);
                v45 = ChatText;
                if ( strlen(ChatText) >= strlen(v44) )
                  v45 = (char *)v44;
                if ( !memcmp(ChatText, v44, strlen(v45)) )
                {
                  ListMachineSomething((int)IDBlockPointer, v43);
                  --v299;
                }
                else
                {
                  ++v43;
                }
              }
              while ( v43 < v299 );
            }
            WriteTextFileToFile((struct TEXT_FILE_STRUCT *)IDBlockPointer);
            if ( player )
              SendMessage(player, "MachineId Block Removed", 0);
          }
          goto LABEL_172;
        }
        if ( !_memicmp(v9, "*listmachine", 0xCu) && player )
        {
          v46 = ListMachine((int)IDBlockPointer);
          for ( n = 0; n < v46; ++n )
          {
            v48 = (char *)ListMachineByIndex((int)IDBlockPointer, n);
            SendMessage(player, v48, 0);
          }
          goto LABEL_172;
        }
        if ( !_memicmp(v9, "*log", 4u) && player )
        {
          for ( ii = 0; ii < 48; ++ii )
          {
            v50 = &LogArray[256 * ((ii + CurrentLogLine) % 48)];
            if ( *v50 )
              SendMessage(player, v50, 0);
          }
          goto LABEL_172;
        }
        if ( !_memicmp(v9, "*shutdown", 9u) )
        {
          if ( player )
            SendMessage(player, "Shutting down server...", 0);
          printf("Shutting down server...\n");
          v51 = v9 + 9;
          RecycleServer = 1;
          IsServerRunning = 1;
          ShutdownArguments = 0;
          ChatText = v51;
          if ( *v51 == 32 )
            ChatText = ++v51;
          if ( *v51 )
            strcpy(&ShutdownArguments, v51);
          goto LABEL_172;
        }
        if ( !_memicmp(v9, "*sysop", 6u) )
        {
          if ( zonePlayerIndex == 5 )
          {
            v52 = ZonePlayerList[v11];
            if ( v52 )
            {
              v53 = v52->isSysop;
              v54 = v53 == 0;
              v52->isSysop = v54;
              v52->isSuperModerator = v54;
              v52->isModerator = v54;
              if ( v53 )
                SendMessage(player, "Player Sysop Mode OFF", 0);
              else
                SendMessage(player, "Player Sysop Mode ON", 0);
            }
          }
          goto LABEL_172;
        }
        if ( !_memicmp(v9, "*smoderator", 0xBu) )
        {
          if ( zonePlayerIndex == 5 )
          {
            v55 = ZonePlayerList[v11];
            if ( v55 )
            {
              v56 = v55->isSuperModerator;
              v57 = v56 == 0;
              v55->isSuperModerator = v57;
              v55->isModerator = v57;
              if ( v56 )
                SendMessage(player, "Player Super Moderator Mode OFF", 0);
              else
                SendMessage(player, "Player Super Moderator Mode ON", 0);
            }
          }
          goto LABEL_172;
        }
        if ( _memicmp(v9, "*s*", 3u) && _memicmp(v9, "*g*", 3u) )
        {
          if ( !_memicmp(v9, "*set ", 5u) )
          {
            v58 = v9[5];
            v59 = v9 + 5;
            for ( jj = Str1; v58; ++v59 )
            {
              if ( v58 == 58 )
                break;
              *jj = v58;
              v58 = v59[1];
              ++jj;
            }
            v61 = *v59;
            *jj = 0;
            if ( !v61 )
              return;
            v62 = v59[1];
            v63 = v59 + 1;
            for ( kk = KeyName; v62; ++v63 )
            {
              if ( v62 == 58 )
                break;
              *kk = v62;
              v62 = v63[1];
              ++kk;
            }
            v65 = *v63;
            *kk = 0;
            if ( !v65 )
              return;
            v66 = v63[1];
            v67 = v63 + 1;
            for ( ll = Dest; v66; ++v67 )
            {
              *ll = v66;
              v66 = v67[1];
              ++ll;
            }
            *ll = 0;
            GetModuleFileNameA(0, StartupInfo, 0x100u);
            v69 = strrchr(StartupInfo, 92);
            if ( v69 )
              *v69 = 0;
            else
              StartupInfo[0] = 0;
            sprintf(CommandLine, "%s\\server.cfg", StartupInfo);
            if ( _strcmpi(Str1, "All") )
            {
              WritePrivateProfileStringA(Str1, KeyName, Dest, CommandLine);
            }
            else
            {
              WritePrivateProfileStringA("Warbird", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Javelin", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Spider", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Leviathan", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Weasel", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Terrier", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Lancaster", KeyName, Dest, CommandLine);
              WritePrivateProfileStringA("Shark", KeyName, Dest, CommandLine);
            }
            if ( player )
              SendMessage(player, "Change complete", 0);
          }
          goto LABEL_172;
        }
        v70 = v9[3];
        v71 = v9 + 3;
        for ( mm = Str1; v70; ++v71 )
        {
          if ( v70 == 58 )
            break;
          *mm = v70;
          v70 = v71[1];
          ++mm;
        }
        v73 = *v71;
        *mm = 0;
        if ( !v73 )
          return;
        v74 = v71[1];
        v75 = v71 + 1;
        for ( nn = KeyName; v74; ++v75 )
        {
          if ( v74 == 58 )
            break;
          *nn = v74;
          v74 = v75[1];
          ++nn;
        }
        *nn = 0;
        if ( !_memicmp(v9, "*s*", 3u) )
        {
          if ( !*v75 )
            return;
          v77 = v75[1];
          v78 = v75 + 1;
          for ( i1 = AppName; v77; ++v78 )
          {
            *i1 = v77;
            v77 = v78[1];
            ++i1;
          }
          *i1 = 0;
          WritePrivateProfileStringA(Str1, KeyName, AppName, FileName);
          dword_4D5920 = 1;
        }
        if ( !player )
          goto LABEL_172;
        GetPrivateProfileStringA(Str1, KeyName, "InvalidTag", StartupInfo, 0x40u, FileName);
        sprintf(Dest, "%s:%s:%s", Str1, KeyName, StartupInfo);
        v21 = Dest;
      }
      else
      {
        v37 = v9[11];
        v38 = v9 + 11;
        ChatText = v38;
        if ( v37 == 32 )
        {
          do
            v39 = *++v38;
          while ( v39 == 32 );
          ChatText = v38;
        }
        if ( !*v38 )
          goto LABEL_172;
        AddLineTextFile((struct TEXT_FILE_STRUCT *)IDBlockPointer, v38);
        WriteTextFileToFile((struct TEXT_FILE_STRUCT *)IDBlockPointer);
        if ( !player )
          goto LABEL_172;
        sprintf(CommandLine, "MachineId Block Added: %s", v38);
        v21 = CommandLine;
      }
      goto LABEL_171;
    }
    if ( zonePlayerIndex != 5 )
    {
      if ( player->MyArena )
      {
        v22 = player->isEnergyShowing;
        player->isEnergyShowing = v22 == 0;
        if ( v22 )
          SendMessage(player, "Showing Energy OFF", 0);
        else
          SendMessage(player, "Showing Energy ON", 0);
      }
      goto LABEL_172;
    }
    v19 = ZonePlayerList[v11];
    if ( v19 )
    {
      v20 = v19->isEnergyShowing;
      v19->isEnergyShowing = v20 == 0;
      if ( v20 )
        v284 = "Showing Energy OFF for %s";
      else
        v284 = "Showing Energy ON for %s";
      sprintf(CommandLine, v284, v19->Name);
      v21 = CommandLine;
LABEL_171:
      SendMessage(player, v21, 0);
      goto LABEL_172;
    }
  }
LABEL_172:
  if ( !_memicmp(ChatText, "*szone", 6u) && player )
  {
    v80 = ChatText + 6;
    if ( ChatText[6] == ' ' )
      v80 = ChatText + 7;
    if ( *v80 == '_' )
      *v80 = ' ';
    if ( player->isSysop || *v80 != '*' || !_memicmp(v80, "*permit", 7u) || !_memicmp(v80, "*revoke", 7u) )
    {
      buf[1] = SoundByte;
      buf[0] = 2;
      v81 = (ENCRYPTION **)BillingConnectionStructPointer;
      strcpy(&buf[2], v80);
      if ( v81 )
        SendBillerZoneRevokePermitPacket(v81, player->BillerPlayerId, BillingScoreId, (int)buf, strlen(v80) + 3);
    }
    return;
  }
  if ( _memicmp(ChatText, "*zone", 5u) )
  {
    if ( _memicmp(ChatText, "*where", 6u) || !player )
    {
      if ( _memicmp(ChatText, "*info", 5u) || !player )
      {
        if ( _memicmp(ChatText, "*getlist", 8u) || !player )
        {
          if ( _memicmp(ChatText, "*putlist", 8u) || !player )
          {
            if ( _memicmp(ChatText, "*getmodlist", 0xBu) || !player )
            {
              if ( _memicmp(ChatText, "*putmodlist", 0xBu) || !player )
              {
                if ( _memicmp(ChatText, "*recycle", 8u) )
                {
                  if ( _memicmp(ChatText, "*moderator", 0xAu) )
                  {
                    if ( _memicmp(ChatText, "*restart", 8u) || !player )
                    {
                      if ( _memicmp(ChatText, "*prize", 6u) )
                      {
                        if ( !_memicmp(ChatText, "*trace", 6u) && player )
                        {
                          if ( player->unknownIthoughtItWasPlayerPointerDupe
                            && GetExitCodeProcess(
                                 (HANDLE)player->unknownIthoughtItWasPlayerPointerDupe,
                                 (LPDWORD)ExitCode) )
                          {
                            if ( *(_DWORD *)ExitCode == 259 )
                              TerminateProcess((HANDLE)player->unknownIthoughtItWasPlayerPointerDupe, 0);
                            CloseHandle((HANDLE)player->unknownIthoughtItWasPlayerPointerDupe);
                            player->unknownIthoughtItWasPlayerPointerDupe = 0;
                            player->dword4 = 0;
                            player->dword8 = 0;
                            player->dwordC = 0;
                          }
                          if ( zonePlayerIndex == 5 )
                          {
                            v128 = ZonePlayerList[zonePlayerIndex_4];
                            if ( v128 )
                            {
                              v129 = GetIPAddressString((struct in_addr)v128->IPAddressDWORD);
                              sprintf(CommandLine, "SUBGAME /SPAWN tracert %s > spawn.log", v129);
                              memset(StartupInfo, 0, 0x44u);
                              *(_DWORD *)StartupInfo = 68;
                              *(_DWORD *)&StartupInfo[12] = "Spawned TRACERT";
                              CreateProcessA(
                                0,
                                CommandLine,
                                0,
                                0,
                                0,
                                0x20u,
                                0,
                                0,
                                (LPSTARTUPINFOA)StartupInfo,
                                (LPPROCESS_INFORMATION)player);
                              SendMessage(player, "SPAWN STARTED", 0);
                            }
                          }
                        }
                      }
                      else
                      {
                        v113 = ChatText[6];
                        v114 = ChatText + 6;
                        ChatText += 6;
                        if ( v113 == 32 )
                        {
                          do
                            v115 = *++v114;
                          while ( v115 == 32 );
                          ChatText = v114;
                        }
                        v116 = *v114;
                        v117 = *v114 == 35;
                        ExitCode[0] = 32;
                        *(_DWORD *)&ExitCode[1] = 1;
                        if ( v117 )
                        {
                          *(_WORD *)&ExitCode[3] = atoi(v114 + 1);
                        }
                        else if ( isdigit(v116) )
                        {
                          *(_WORD *)&ExitCode[1] = atoi(v114);
                        }
                        if ( !player->isSysop )
                        {
                          v118 = *(_WORD *)&ExitCode[1];
                          strcpy(&ExitCode[1], "d");
                          if ( v118 <= 100 )
                            *(_WORD *)&ExitCode[1] = v118;
                        }
                        if ( player )
                          SendMessage(player, "Granting prize(s)", 0);
                        if ( zonePlayerIndex == 5 )
                        {
                          v119 = ZonePlayerList[zonePlayerIndex_4];
                          if ( v119 )
                          {
                            SendPlayerReliablePacket(v119, ExitCode, 5, 1);
                            v119->field_305 = 1;
                          }
                        }
                        else if ( zonePlayerIndex == 3 )
                        {
                          SendReliablePacketToMyFrequency(player, ExitCode, 5, 1);
                          SendPlayerReliablePacket(player, ExitCode, 5, 1);
                          v120 = player->MyArena;
                          v121 = 0;
                          if ( v120->ArenaPlayerCount > 0 )
                          {
                            v122 = 16072;
                            do
                            {
                              v123 = v120->PlayerPointers[v122];
                              ++v121;
                              ++v122;
                              v123->field_305 = 1;
                              v120 = player->MyArena;
                            }
                            while ( v121 < v120->ArenaPlayerCount );
                          }
                        }
                        else
                        {
                          ArenaSendPacket(player->MyArena, ExitCode, 5, 1);
                          v124 = player->MyArena;
                          v125 = 0;
                          if ( v124->ArenaPlayerCount > 0 )
                          {
                            v126 = 16072;
                            do
                            {
                              v127 = v124->PlayerPointers[v126];
                              ++v125;
                              ++v126;
                              v127->field_305 = 1;
                              v124 = player->MyArena;
                            }
                            while ( v125 < v124->ArenaPlayerCount );
                          }
                        }
                      }
                    }
                    else
                    {
                      player->MyArena->GameTimePassedTwo = 0;
                    }
                  }
                  else if ( zonePlayerIndex == 5 )
                  {
                    v111 = ZonePlayerList[zonePlayerIndex_4];
                    if ( v111 )
                    {
                      v112 = v111->isModerator;
                      v111->isModerator = v112 == 0;
                      if ( v112 )
                        SendMessage(player, "Player Moderator Mode OFF", 0);
                      else
                        SendMessage(player, "Player Moderator Mode ON", 0);
                    }
                  }
                }
                else
                {
                  if ( player )
                    SendMessage(player, "Recycling Server", 0);
                  RecycleServer = 1;
                }
              }
              else
              {
                buf[0] = 25;
                strncpy(&v318[1], "moderate.txt", 0x10u);
                v318[16] = 0;
                strncpy(&buf[1], "moderate.txt", 0x100u);
                v318[0] = 0;
                SendPlayerReliablePacket(player, buf, 273, 1);
              }
            }
            else
            {
              SendMessage(player, "File sent: moderate.txt (please wait...)", 0);
              SendFile(player, "moderate.txt");
            }
          }
          else
          {
            buf[0] = 25;
            strncpy(&buf[1], "permit.txt", 0x100u);
            v318[0] = 0;
            strncpy(&v318[1], "permit.txt", 0x10u);
            v318[16] = 0;
            SendPlayerReliablePacket(player, buf, 273, 1);
          }
        }
        else
        {
          SendMessage(player, "File sent: permit.txt (please wait...)", 0);
          SendFile(player, "permit.txt");
        }
      }
      else if ( zonePlayerIndex == 5 )
      {
        v90 = ZonePlayerList[zonePlayerIndex_4];
        if ( v90 )
        {
          v292 = v90->DemoPlayer != 0;
          v282 = v90->Frequency;
          v280 = v90->TimeZoneBias;
          v91 = GetIPAddressString((struct in_addr)v90->IPAddressDWORD);
          sprintf(
            CommandLine,
            "IP:%s  TimeZoneBias:%d  Freq:%d  TypedName:%s  Demo:%d",
            v91,
            v280,
            v282,
            v90->TypedName,
            v292);
          if ( player->isSysop )
            sprintf(&CommandLine[strlen(CommandLine)], "  MachineId:%d", v90->MachineId);
          SendMessage(player, CommandLine, 0);
          v92 = player->MyArena;
          if ( (int)v92->ServersideArenaSettings.KingDeathCount > 0 )
          {
            v285 = __PAIR64__(
                     v92->ServersideArenaSettings.KingCrownRecoverKills - v90->KingCrownKills,
                     v90->KotHDeathCount);
            sprintf(CommandLine, "DeathsLeft:%d  KillsNeeded:%d", (_DWORD)v285, HIDWORD(v285));
            SendMessage(player, CommandLine, 0);
          }
          sprintf(
            CommandLine,
            "Ping:%dms  LowPing:%dms  HighPing:%dms  AvePing:%dms",
            10 * v90->CurrentPing,
            10 * v90->LowPing,
            10 * v90->HighPing,
            10 * v90->AveragePing);
          SendMessage(player, CommandLine, 0);
          sprintf(
            CommandLine,
            "S2CAveLatency:%dms  C2SAveLatency:%dms",
            v90->S2CAverageLatency,
            10 * v90->C2SAverageLatencyFirst / (v90->C2SAverageLatencySecond + 1));
          v93 = v90->SecurityWeaponCountTotal;
          v94 = 1000;
          if ( v93 > 200 )
            v94 = 1000 * v90->SecurityWeaponCount / v93;
          v298 = (const char *)(1000 - v94);
          sub_41CB70((int)v90->encryptionPointer, (int)&a6, (int)&v299);
          a6 = 1000 - a6;
          v95 = v90->encryptionPointer;
          v299 = 1000 - v299;
          v96 = GetRelAckDiff(v95, (DWORD *)&a2a);
          sprintf(CommandLine, "LOSS: S2C:%.1f%%  C2S:%.1f%%", (double)a6 * 0.1, (double)v299 * 0.1);
          if ( player->isSysop )
            sprintf(
              &CommandLine[strlen(CommandLine)],
              "  S2CWeapons:%.1f%%  S2C_RelOut:%d(%d)",
              (double)(int)v298 * 0.1,
              v96,
              a2a);
          SendMessage(player, CommandLine, 0);
          if ( player->isSuperModerator )
          {
            GetPacketCountInfoSomething(
              (struct CONNECTION *)v90->encryptionPointer,
              (int)&v311,
              (int)&v298,
              (int)&Size,
              (int)&v304);
            sprintf(CommandLine, "S2C:%d-->%d  C2S:%d-->%d", v311, v304, Size, v298);
            SendMessage(player, CommandLine, 0);
            v97 = v90->C2SCurrentFast;
            v98 = v90->C2SCurrentSlow;
            v99 = 0.0;
            a5 = 0.0;
            v303 = v98;
            *(_DWORD *)ExitCode = v98 + v97;
            if ( v98 + v97 > 0 )
              a5 = (double)v303 * 100.0 / (double)*(int *)ExitCode;
            v100 = v90->C2SCurrentTotalSlow;
            v101 = v90->C2SCurrentTotalFast;
            *(_DWORD *)ExitCode = v100;
            v303 = v101 + v100;
            if ( v101 + v100 > 0 )
              v99 = (double)*(int *)ExitCode * 100.0 / (double)v303;
            sprintf(
              CommandLine,
              "C2S CURRENT: Slow:%d Fast:%d %.1f%%   TOTAL: Slow:%d Fast:%d %.1f%%",
              v98,
              v97,
              a5,
              v100,
              v101,
              v99);
            SendMessage(player, CommandLine, 0);
            v102 = *(__int16 *)&v90->gap_12B[25];
            v103 = 0.0;
            v104 = *(__int16 *)&v90->gap_12B[27];
            a5 = 0.0;
            *(_DWORD *)ExitCode = v102;
            v303 = v104 + v102;
            if ( v104 + v102 > 0 )
              a5 = (double)*(int *)ExitCode * 100.0 / (double)v303;
            v105 = *(_DWORD *)&v90->gap_12B[21];
            v106 = *(_DWORD *)&v90->gap_12B[17];
            *(_DWORD *)ExitCode = v106;
            v303 = v106 + v105;
            if ( v106 + v105 > 0 )
              v103 = (double)*(int *)ExitCode * 100.0 / (double)v303;
            sprintf(
              CommandLine,
              "S2C CURRENT: Slow:%d Fast:%d %.1f%%   TOTAL: Slow:%d Fast:%d %.1f%%",
              v102,
              v104,
              a5,
              v106,
              v105,
              v103);
            SendMessage(player, CommandLine, 0);
          }
          v293 = v90->TotalUsageSeconds2;
          v107 = time(0);
          v108 = (__int64)difftime(v107, v293);
          sprintf(Dest, "TIME: Session:%5d:%02d:00", v108 / 3600, v108 / 60 % 60);
          if ( player->isSysop )
          {
            v109 = v108 + v90->UsageTotalSeconds;
            sprintf(
              &Dest[strlen(Dest)],
              "  Total:%5d:%02d:00  Created: %d-%d-%d %02d:%02d:%02d",
              v109 / 3600,
              v109 / 60 % 60,
              (unsigned __int16)v90->AccountCreationMonth,
              (unsigned __int16)v90->AccountCreationDay,
              v90->AccountCreationYear,
              (unsigned __int16)v90->AccountCreationHour,
              (unsigned __int16)v90->AccountCreationMinute,
              (unsigned __int16)v90->AccountCreationSecond);
          }
          SendMessage(player, Dest, 0);
          if ( player->isSysop )
          {
            if ( (int)player->MyArena->ServersideArenaSettings.MiscTimedGame > 0 )
            {
              sprintf(
                CommandLine,
                "BEST SCORE Points:%d  Win:%d  Lose:%d",
                *(_DWORD *)&v90->PersonalBestPoints1of2 + *(_DWORD *)&v90->PersonalBestGoalCount,
                (unsigned __int16)v90->PersonalBestWins,
                (unsigned __int16)v90->PersonalBestLosses);
              SendMessage(player, CommandLine, 0);
            }
            v110 = (int)v90->encryptionPointer;
            a5 = 0.0;
            v298 = 0;
            v304 = 0;
            Size = 0;
            sub_41C9B0(v110, (int)&a5, (int)&v298);
            GetASyncS2CInfoSomething((struct CONNECTION *)v90->encryptionPointer, (int)&v304, (int)&Size);
            if ( SLODWORD(a5) > 0 || v304 > 0 )
            {
              sprintf(CommandLine, "Async C2S:%d of %d  S2C:%d of %d", v298, a5, Size, v304);
              SendMessage(player, CommandLine, 0);
            }
          }
        }
      }
    }
    else if ( zonePlayerIndex == 5 )
    {
      v89 = ZonePlayerList[zonePlayerIndex_4];
      if ( v89 )
      {
        sprintf(
          AppName,
          "%s: %c%d",
          v89->PlayerName,
          10 * (v89->XPixels / 16) / 512 + 65,
          10 * (v89->YPixels / 16) / 512 + 1);
        SendMessage(player, AppName, 0);
      }
    }
  }
  else
  {
    v82 = ChatText[5];
    v83 = ChatText + 5;
    ChatText += 5;
    if ( v82 == ' ' )
    {
      do
        v84 = *++v83;
      while ( v84 == ' ' );
      ChatText = v83;
    }
    if ( player )
    {
      v85 = player->MyArena;
      if ( v85 )
        FormatMessageArena(v85, "%s\n", v83);
    }
    if ( *v83 == '_' )
      *v83 = ' ';
    buf[2] = SoundByte;
    buf[0] = 7;
    buf[1] = 0;
    *(_WORD *)&buf[3] = -1;
    strcpy(&buf[5], v83);
    v86 = strlen(v83) + 1;
    v87 = 0;
    if ( ZonePlayerCount > 0 )
    {
      v88 = playerPointerList;
      do
      {
        if ( (*v88)->MyArena )
          SendPlayerReliablePacket(*v88, buf, v86 - 1 + 6, 1);
        ++v87;
        ++v88;
      }
      while ( v87 < ZonePlayerCount );
    }
  }
LABEL_294:
  if ( _memicmp(ChatText, "*arena", 6u) )
  {
    if ( !_memicmp(ChatText, "*permit", 7u) )
    {
      v135 = ChatText[7];
      v136 = ChatText + 7;
      ChatText += 7;
      if ( v135 == 32 )
      {
        do
          v137 = *++v136;
        while ( v137 == 32 );
        ChatText = v136;
      }
      if ( *v136 )
      {
        AddLineTextFile((struct TEXT_FILE_STRUCT *)PermitPointer, v136);
        WriteTextFileToFile((struct TEXT_FILE_STRUCT *)PermitPointer);
        if ( !player )
          return;
        sprintf(CommandLine, "Permission Added: %s", v136);
        SendMessage(player, CommandLine, 0);
      }
      goto LABEL_443;
    }
    if ( _memicmp(ChatText, "*revoke", 7u) )
    {
      if ( _memicmp(ChatText, "*banner", 7u) || !player )
      {
        if ( _memicmp(ChatText, "*shutup", 7u) || !player )
        {
          if ( _memicmp(ChatText, "*lock", 5u) || !player )
          {
            if ( _memicmp(ChatText, "*timer", 6u) || !player )
            {
              if ( _memicmp(ChatText, "*spec", 5u) || !player )
              {
                if ( _memicmp(ChatText, "*kill", 5u) || !player )
                {
                  if ( _memicmp(ChatText, "*flagreset", 0xAu) )
                  {
                    if ( _memicmp(ChatText, "*shipreset", 0xAu) )
                    {
                      if ( _memicmp(ChatText, "*scorereset", 0xBu) )
                      {
                        if ( _memicmp(ChatText, "*timereset", 0xAu) )
                        {
                          if ( _memicmp(ChatText, "*beginlog", 9u) || !player )
                          {
                            if ( !_memicmp(ChatText, "*endlog", 7u) )
                            {
                              if ( !player )
                                return;
                              v167 = player->pfile329;
                              if ( v167 )
                              {
                                fprintf(v167, "Name               Win  Lose  Points\n");
                                fprintf(player->pfile329, "---------------- ----- ----- -------\n");
                                v168 = player->MyArena;
                                if ( v168 )
                                {
                                  v169 = 0;
                                  if ( v168->ArenaPlayerCount > 0 )
                                  {
                                    v170 = 16072;
                                    do
                                    {
                                      fprintf(
                                        player->pfile329,
                                        "%-16.16s %5d %5d %7d\n",
                                        v168->PlayerPointers[v170]->Name,
                                        (unsigned __int16)v168->PlayerPointers[v170]->CurrentWins,
                                        (unsigned __int16)v168->PlayerPointers[v170]->CurrentLosses,
                                        v168->PlayerPointers[v170]->FlagPoints + v168->PlayerPointers[v170]->KillPoints);
                                      v168 = player->MyArena;
                                      ++v169;
                                      ++v170;
                                    }
                                    while ( v169 < v168->ArenaPlayerCount );
                                  }
                                }
                                fprintf(player->pfile329, "\nLOG FINISHED\n");
                                fclose(player->pfile329);
                                player->pfile329 = 0;
                                sprintf(Dest, "Logging session closed, sending file: %s", &player->char32d);
                                SendMessage(player, Dest, 0);
                                SendFile(player, &player->char32d);
                              }
                            }
                          }
                          else
                          {
                            v163 = player->pfile329;
                            v164 = ChatText + 9;
                            ChatText += 9;
                            if ( v163 )
                              fclose(v163);
                            v165 = rand();
                            v166 = rand();
                            sprintf(&player->char32d, "SS%d.log", v166 + v165);
                            player->pfile329 = fopen(&player->char32d, "wt");
                            sprintf(Dest, "Logging session to: %s", &player->char32d);
                            SendMessage(player, Dest, 0);
                            fprintf(player->pfile329, "LOG STARTED:%s\n", v164);
                          }
                        }
                        else
                        {
                          if ( !player )
                            return;
                          v162 = player->MyArena;
                          if ( v162 )
                          {
                            if ( (int)v162->ServersideArenaSettings.MiscTimedGame <= 0 )
                              SendMessage(player, "Invalid command, this is not a timed game", 0);
                            else
                              sub_405360(v162, 1);
                          }
                        }
                      }
                      else if ( zonePlayerIndex == 5 )
                      {
                        if ( player )
                          SendMessage(player, "Player score reset", 0);
                        v161 = ZonePlayerList[zonePlayerIndex_4];
                        if ( v161 )
                          SendResetScoresPacket(v161);
                      }
                      else
                      {
                        if ( !player )
                          return;
                        ArenaScoreReset(player->MyArena, 1);
                      }
                    }
                    else
                    {
                      v301 = 27;
                      if ( zonePlayerIndex == 5 )
                      {
                        if ( player )
                          SendMessage(player, "Player ship reset", 0);
                        v158 = ZonePlayerList[zonePlayerIndex_4];
                        if ( v158 )
                          SendPlayerReliablePacket(v158, &v301, 1, 1);
                      }
                      else if ( player )
                      {
                        SendMessage(player, "All ships reset", 0);
                        ArenaSendPacket(player->MyArena, &v301, 1, 1);
                      }
                      else
                      {
                        v159 = 0;
                        if ( ZonePlayerCount > 0 )
                        {
                          v160 = playerPointerList;
                          do
                          {
                            if ( (*v160)->MyArena )
                              SendPlayerReliablePacket(*v160, &v301, 1, 1);
                            ++v159;
                            ++v160;
                          }
                          while ( v159 < ZonePlayerCount );
                        }
                      }
                    }
                  }
                  else if ( player )
                  {
                    SendMessage(player, "Flag game being reset", 0);
                    v155 = player->MyArena;
                    if ( v155 )
                      ResetFlagGame(v155);
                  }
                  else
                  {
                    v156 = 0;
                    if ( ArenaArrayLength > 0 )
                    {
                      v157 = Arenas;
                      do
                      {
                        ResetFlagGame(*v157);
                        ++v156;
                        ++v157;
                      }
                      while ( v156 < ArenaArrayLength );
                    }
                  }
                }
                else if ( zonePlayerIndex == 5 )
                {
                  v150 = ZonePlayerList[zonePlayerIndex_4];
                  if ( v150 )
                  {
                    if ( player->isSysop || !v150->isSuperModerator )
                    {
                      v150->DisconnectReason = 4;
                      v150->AlreadySentReliablePacket = 1;
                      WriteSubGameLog("Player kicked off by moderator: %s\n", v150->Name);
                      SendMessage(player, "Player kicked off", 0);
                      if ( ChatText[5] == 32 )
                      {
                        v151 = atoi(ChatText + 6);
                        if ( v151 > 0 )
                        {
                          v152 = MachineIdArrayIndex;
                          if ( MachineIdArrayIndex < 1000 )
                          {
                            KickedUsers[MachineIdArrayIndex].MachineId = v150->MachineId;
                            v153 = v152;
                            KickedUsers[v153].KickStartTime = GetTickCount() / 0xA;
                            v154 = MachineIdArrayIndex + 1;
                            KickedUsers[v153].KickDelayMilliseconds = 6000 * v151;
                            MachineIdArrayIndex = v154;
                          }
                        }
                      }
                    }
                    else
                    {
                      SendMessage(v150, "Moderator attempted to kick you off", 0);
                    }
                  }
                }
              }
              else if ( zonePlayerIndex == 5 )
              {
                v148 = ZonePlayerList[zonePlayerIndex_4];
                if ( v148 )
                {
                  if ( player->isSysop || !v148->isSuperModerator )
                  {
                    if ( v148->Ship != 8 )
                      SetPlayerShip(v148, 8);
                    v149 = v148->IsSpeced;
                    v148->IsSpeced = v149 == 0;
                    if ( v149 )
                      SendMessage(player, "Player free to enter arena", 0);
                    else
                      SendMessage(player, "Player locked in spectator mode", 0);
                  }
                }
              }
            }
            else
            {
              v145 = ChatText[6];
              v146 = ChatText + 6;
              ChatText += 6;
              if ( v145 == 32 )
              {
                do
                  v147 = *++v146;
                while ( v147 == 32 );
                ChatText = v146;
              }
              if ( *v146 )
              {
                player->MyArena->GameTimeStart = 6000 * atoi(v146);
                player->MyArena->GameTimePassed = GetTickCount() / 0xA;
                player->MyArena->field_FF56 = 0;
              }
            }
          }
          else if ( player->MyArena )
          {
            if ( _memicmp(ChatText, "*lockpublic", 0xBu) )
            {
              if ( _memicmp(ChatText, "*lockteam", 9u) )
              {
                if ( _memicmp(ChatText, "*lockprivate", 0xCu) )
                {
                  if ( _memicmp(ChatText, "*lockall", 8u) )
                  {
                    if ( _memicmp(ChatText, "*lockspec", 9u) )
                    {
                      if ( !ChatText[5] )
                      {
                        player->MyArena->ArenaLocked = player->MyArena->ArenaLocked == 0;
                        if ( player->MyArena->ArenaLocked )
                          SendMessage(player, "Arena LOCKED", 0);
                        else
                          SendMessage(player, "Arena UNLOCKED", 0);
                      }
                    }
                    else
                    {
                      player->MyArena->SpecMessageLock = player->MyArena->SpecMessageLock == 0;
                      if ( player->MyArena->SpecMessageLock )
                        SendMessage(player, "Message lock applies to spectators only.", 0);
                      else
                        SendMessage(player, "Message lock applies to everybody.", 0);
                    }
                  }
                  else
                  {
                    player->MyArena->AllMessagesLocked = player->MyArena->AllMessagesLocked == 0;
                    player->MyArena->AllMessagesLockedAgainSomething = player->MyArena->AllMessagesLocked;
                    if ( player->MyArena->AllMessagesLocked )
                      SendMessage(player, "All Messages LOCKED", 0);
                    else
                      SendMessage(player, "All Messages UNLOCKED", 0);
                  }
                }
                else
                {
                  player->MyArena->PrivateMessagesLocked = player->MyArena->PrivateMessagesLocked == 0;
                  if ( player->MyArena->PrivateMessagesLocked )
                    SendMessage(player, "Private Messages LOCKED", 0);
                  else
                    SendMessage(player, "Private Messages UNLOCKED", 0);
                }
              }
              else
              {
                player->MyArena->AllMessagesLocked = player->MyArena->AllMessagesLocked == 0;
                if ( player->MyArena->AllMessagesLocked )
                  SendMessage(player, "Team Messages LOCKED", 0);
                else
                  SendMessage(player, "Team Messages UNLOCKED", 0);
              }
            }
            else
            {
              player->MyArena->AllMessagesLocked = player->MyArena->AllMessagesLocked == 0;
              if ( player->MyArena->AllMessagesLocked )
                SendMessage(player, "Public Messages LOCKED", 0);
              else
                SendMessage(player, "Public Messages UNLOCKED", 0);
            }
          }
        }
        else if ( zonePlayerIndex == 5 )
        {
          v143 = ZonePlayerList[zonePlayerIndex_4];
          if ( v143 )
          {
            if ( v143->isSysop || v143->isSuperModerator && !player->isSysop )
            {
              sprintf(Dest, "%s tried to shut you up", player->Name);
              SendMessage(v143, Dest, 0);
            }
            else
            {
              v144 = v143->IsSilenced;
              v143->IsSilenced = v144 == 0;
              if ( v144 )
                v286 = "%s can now speak";
              else
                v286 = "%s has been silenced";
              sprintf(Dest, v286, v143->Name);
              SendMessage(player, Dest, 0);
            }
          }
        }
      }
      else
      {
        player->dword30 = 1;
        v142 = player->PlayerId;
        Dest[0] = 31;
        *(_WORD *)&Dest[1] = v142;
        qmemcpy(&Dest[3], player->BannerData, 0x60u);
        ArenaSendPacket(player->MyArena, Dest, 99, 1);
      }
      goto LABEL_443;
    }
    v138 = ChatText[7];
    v139 = ChatText + 7;
    ChatText += 7;
    if ( v138 == 32 )
    {
      do
        v140 = *++v139;
      while ( v140 == 32 );
      ChatText = v139;
    }
    if ( *v139 )
    {
      if ( !strcmp(v139, "*") )
      {
        CleanTextFileMemory((TEXT_FILE_STRUCT *)PermitPointer);
      }
      else
      {
        v141 = IsBannedMachineId((int)PermitPointer, (int)v139);
        if ( v141 >= 0 )
          ListMachineSomething((int)PermitPointer, v141);
      }
      WriteTextFileToFile((struct TEXT_FILE_STRUCT *)PermitPointer);
      if ( !player )
        return;
      SendMessage(player, "Permission revoked", 0);
    }
LABEL_443:
    if ( player )
    {
      v171 = ChatText + 1;
      if ( !_strcmpi(ChatText + 1, SysopPassword) )
      {
        WriteSubGameLog("%s> SYSOP LOGGED IN\n", player->Name);
        player->isSysop = 1;
        player->isModerator = 1;
        player->isSuperModerator = 1;
      }
      if ( !_strcmpi(v171, SuperModeratorPassword) )
      {
        WriteSubGameLog("%s> SUPER MODERATOR LOGGED IN\n", player->Name);
        player->isModerator = 1;
        player->isSuperModerator = 1;
      }
      if ( !_strcmpi(v171, ModeratorPassword) )
      {
        WriteSubGameLog("%s> MODERATOR LOGGED IN\n", player->Name);
        player->isModerator = 1;
      }
      if ( !_strcmpi(v171, EnergyPassword) )
      {
        WriteSubGameLog("%s> ENERGY VIEWING TURNED ON/OFF\n", player->Name);
        if ( player->MyArena )
        {
          v172 = player->isEnergyShowing;
          player->isEnergyShowing = v172 == 0;
          if ( v172 )
            SendMessage(player, "Showing Energy OFF", 0);
          else
            SendMessage(player, "Showing Energy ON", 0);
        }
      }
    }
    return;
  }
  v130 = ChatText[6];
  v131 = ChatText + 6;
  ChatText += 6;
  if ( v130 == 32 )
  {
    do
      v132 = *++v131;
    while ( v132 == 32 );
    ChatText = v131;
  }
  if ( *v131 == 95 )
    *v131 = 32;
  if ( player )
  {
    v133 = player->MyArena;
    if ( v133 )
      FormatMessageArena(v133, "%s\n", v131);
  }
  buf[2] = SoundByte;
  buf[0] = 7;
  buf[1] = 0;
  *(_WORD *)&buf[3] = -1;
  strcpy(&buf[5], ChatText);
  v134 = strlen(ChatText) + 1;
  if ( player )
  {
    ArenaSendPacket(player->MyArena, buf, v134 + 5, 1);
    goto LABEL_443;
  }
}
/* Orphan comments:
isModerator != isModerator
*/
// 4149DE: conditional instruction was optimized away because of 'ebp.4!=0'
// 4149F0: conditional instruction was optimized away because of 'ebp.4!=0'
// 414BA9: conditional instruction was optimized away because of 'ecx.4>=1'
// 416F2F: conditional instruction was optimized away because of 'eax.4!=0'
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 42C848: using guessed type char *off_42C848[8];
// 431BE8: using guessed type int RadarValue;
// 431E9C: using guessed type int dword_431E9C[75];
// 431FC8: using guessed type int dword_431FC8[10];
// 431FF4: using guessed type int ArenaArrayLength;
// 431FF8: using guessed type int ServerIterations;
// 432004: using guessed type int RecycleServer;
// 437C18: using guessed type int DoubleValue;
// 437CA4: using guessed type int CurrentLogLine;
// 437CA8: using guessed type int IsServerRunning;
// 4386D4: using guessed type int MachineIdArrayIndex;
// 438B10: using guessed type int ScreenValue;
// 4AC448: using guessed type KICK KickedUsers[1000];
// 4CA810: using guessed type int BillingLogMessages;
// 4D5920: using guessed type int dword_4D5920;
// 4D89C8: using guessed type int Wave;
// 4D8AE4: using guessed type int TotalTemplateSSSEntries;
// 4D8AF4: using guessed type int oldTickCountValue;
// 4D8B18: using guessed type int ChatCounter64Max;

//----- (00418F20) --------------------------------------------------------
void __cdecl SomethingWithSendingChatTypes(PLAYER *player, int TargetPlayerId, signed int PlayerId, char *ChatText, char SoundByte)
{
  signed int v5; // edx
  PLAYER *v6; // ecx
  PLAYER *v7; // esi
  PLAYER **v8; // ebp
  PLAYER *v9; // eax
  const char *v10; // edi
  PLAYER *v11; // ecx
  const char *v12; // [esp-8h] [ebp-424h]
  int v13; // [esp-4h] [ebp-420h]
  PLAYER *v14; // [esp+10h] [ebp-40Ch]
  int v15; // [esp+14h] [ebp-408h]
  int v16; // [esp+18h] [ebp-404h]
  char Dest[512]; // [esp+1Ch] [ebp-400h] BYREF
  char buf[3]; // [esp+21Ch] [ebp-200h] BYREF
  __int16 v19; // [esp+21Fh] [ebp-1FDh]
  char v20[507]; // [esp+221h] [ebp-1FBh] BYREF

  if ( HighestPlayerCountMaybeSomething )
  {
    v5 = PlayerId;
    v15 = -1;
    v14 = 0;
    if ( PlayerId >= 0 && PlayerId < 1024 )
      v14 = ZonePlayerList[PlayerId];
    if ( TargetPlayerId == 3 && (v6 = player) != 0 )
    {
      v15 = player->Frequency;
      v7 = v14;
    }
    else
    {
      v7 = v14;
      if ( TargetPlayerId == 4 && v14 )
        v15 = v14->Frequency;
      v6 = player;
    }
    v16 = 0;
    if ( ZonePlayerCount > 0 )
    {
      v8 = playerPointerList;
      while ( 1 )
      {
        v9 = *v8;
        if ( (*v8)->MyArena )
        {
          if ( v9->field_287 > 0 )
          {
            Dest[0] = 0;
            if ( (TargetPlayerId != 5 || *(_DWORD *)&v9->PlayerId != v5) && v6 != v9 )
            {
              if ( v6 )
              {
                sprintf(Dest, "%s> %s ", v6->Name, ChatText);
                switch ( TargetPlayerId )
                {
                  case 3:
                    v13 = v15;
                    v12 = "(TEAM:%d)";
                    goto LABEL_26;
                  case 4:
                    sprintf(&Dest[strlen(Dest)], "(ENEMYTEAM:%d)", v15);
                    goto LABEL_31;
                  case 5:
                    if ( v7 )
                    {
                      v13 = (int)v7->Name;
                      v12 = "(TO:%s)";
LABEL_26:
                      sprintf(&Dest[strlen(Dest)], v12, v13);
                    }
                    else
                    {
                      v10 = "(TO:----)";
LABEL_30:
                      strcat(Dest, v10);
                    }
LABEL_31:
                    v11 = *v8;
                    if ( player->MyArena == (*v8)->MyArena )
                    {
                      if ( v11->Frequency == v15
                        || (TargetPlayerId == 1 || TargetPlayerId == 2) && *ChatText != '*' && *ChatText != '?'
                        || TargetPlayerId != 5 && v11->field_287 < 2 )
                      {
                        goto LABEL_46;
                      }
                    }
                    else
                    {
                      if ( v11->field_287 < 3 )
                        goto LABEL_46;
                      strcat(Dest, "(SPAWN)");
                    }
                    break;
                  case 7:
                    v10 = "(FIND)";
                    goto LABEL_30;
                  case 9:
                    v10 = "(CHAT)";
                    goto LABEL_30;
                  default:
                    goto LABEL_31;
                }
              }
              else
              {
                if ( v9->field_287 < 4 )
                  goto LABEL_46;
                sprintf(Dest, "*> %s ", ChatText);
              }
              if ( Dest[0] )
              {
                buf[2] = SoundByte;
                buf[0] = 7;
                buf[1] = 6;
                v19 = -1;
                strcpy(v20, Dest);
                SendPlayerReliablePacket(*v8, buf, strlen(Dest) + 6, 1);
              }
            }
          }
        }
LABEL_46:
        ++v8;
        if ( ++v16 >= ZonePlayerCount )
          return;
        v7 = v14;
        v5 = PlayerId;
        v6 = player;
      }
    }
  }
}
// 4D8AF8: using guessed type int HighestPlayerCountMaybeSomething;
// 418F20: using guessed type char Dest[512];

//----- (00419270) --------------------------------------------------------
// updates the points a player has, logging if necessary
FILE *__cdecl UpdatePoints(PLAYER *player, DWORD DiffSinceLastUpdate1, DWORD DiffSinceLastUpdate2)
{
  int v3; // ecx
  FILE *result; // eax
  ARENA *v5; // ecx
  int Str[4]; // [esp+Ch] [ebp-10h] BYREF

  v3 = DiffSinceLastUpdate2 + player->FlagPoints;
  player->KillPoints += DiffSinceLastUpdate1;
  player->FlagPoints = v3;
  if ( MiscLogPoints && BillingConnectionStructPointer )
  {
    result = PointsFileHandle;
    if ( !PointsFileHandle )
    {
      result = fopen("points.log", "ab");
      PointsFileHandle = result;
    }
    v5 = player->MyArena;
    if ( v5 && v5->RecordPointsToLog )
    {
      if ( result )
      {
        Str[0] = player->UserId;
        Str[1] = DiffSinceLastUpdate1;
        Str[2] = DiffSinceLastUpdate2;
        Str[3] = time(0);
        result = (FILE *)fwrite(Str, 0x10u, 1u, PointsFileHandle);
      }
    }
  }
  else
  {
    result = PointsFileHandle;
    if ( PointsFileHandle )
    {
      result = (FILE *)fclose(PointsFileHandle);
      PointsFileHandle = 0;
    }
  }
  return result;
}
// 41CF20: using guessed type _DWORD __cdecl time(_DWORD Time);
// 438B08: using guessed type int MiscLogPoints;

//----- (00419350) --------------------------------------------------------
UINT __cdecl ReadServerINI()
{
  DWORD v0; // edi
  int v1; // eax
  DWORD v2; // edi
  int v3; // eax
  DWORD v4; // edi
  int v5; // eax
  DWORD v6; // edi
  int v7; // eax
  DWORD v8; // esi
  int v9; // eax
  int v10; // eax
  UINT result; // eax
  char Dest[16]; // [esp+Ch] [ebp-10h] BYREF

  CustomArenaMode = GetPrivateProfileIntWrapper("Custom", "ArenaMode", 0, FileName);
  ArenaMaxPlayers = GetPrivateProfileIntWrapper("Arena", "ArenaMaxPlayers", 60, FileName);
  ArenaDesiredPlayers = GetPrivateProfileIntWrapper("Arena", "ArenaDesiredPlayers", 40, FileName);
  ArenaMinimumPlayers = GetPrivateProfileIntWrapper("Arena", "ArenaMinimumPlayers", 15, FileName);
  ArenaSpawnKeepScores = GetPrivateProfileIntWrapper("Arena", "SpawnKeepScores", 0, FileName);
  MaxArenas = GetPrivateProfileIntWrapper("Arena", "MaxArenas", 100, FileName);
  MaxArenasMemory = GetPrivateProfileIntWrapper("Arena", "MaxArenasMemory", 64000, FileName);
  CommsMaxQueueToLogin = GetPrivateProfileIntWrapper("Comms", "MaxQueueToLogin", 16, FileName);
  CommsPacketHistoryMax = GetPrivateProfileIntWrapper("Comms", "PacketHistoryMax", 2000, FileName);
  CommsIncomingBufferSize = GetPrivateProfileIntWrapper("Comms", "IncomingBufferSize", 0x20000, FileName);
  CommsOutgoingBufferSize = GetPrivateProfileIntWrapper("Comms", "OutgoingBufferSize", 0x20000, FileName);
  CommsTransportBufferSize = GetPrivateProfileIntWrapper("Comms", "TransportBufferSize", 160, FileName);
  MiscDisableShareware = 1;
  MiscDisableSharewareShips = 1;
  MiscDisableSharewareScores = 1;
  CommsEncryptMode = 1;
  dword_437B14 = 1;
  BillingLogMessages = 0;
  MiscRegisterKickShareware = 1;
  MiscMaxSharewarePlayer = GetPrivateProfileIntWrapper("Misc", "MaxSharewarePlayers", -1, FileName);
  MiscMaxSharkwareTime = GetPrivateProfileIntWrapper("Misc", "MaxSharewareTime", 90000, FileName);
  MiscMaxPlayers = GetPrivateProfileIntWrapper("Misc", "MaxPlayers", 120, FileName);
  MiscMenuKickOutDelay = GetPrivateProfileIntWrapper("Misc", "MenuKickOutDelay", 12000, FileName);
  MiscLogPoints = GetPrivateProfileIntWrapper("Misc", "LogPoints", 0, FileName);
  MiscPointUpdateDiff = GetPrivateProfileIntWrapper("Misc", "PointUpdateDiff", 500, FileName);
  MiscJackpotBroadcastPoints = GetPrivateProfileIntWrapper("Misc", "JackpotBroadcastPoints", 0, FileName);
  MiscServerLog = GetPrivateProfileIntWrapper("Misc", "ServerLog", 0, FileName);
  MiscKeepAliveDelay = GetPrivateProfileIntWrapper("Misc", "KeepAliveDelay", 400, FileName);
  GetPrivateProfileStringWrapper("Misc", "DefaultLevelFile", "changeme.lvl", MiscDefaultLevelFile, 0x100u, FileName);
  CPUProcessMaxTime = GetPrivateProfileIntWrapper("CPU", "ProcessMaxTime", 4, FileName);
  CPUSleepPerIteration = GetPrivateProfileIntWrapper("CPU", "SleepPerIteration", 0, FileName);
  CPUSleepTime = GetPrivateProfileIntWrapper("CPU", "SleepTime", 0, FileName);
  CPUSlowIterationWarningLevel = GetPrivateProfileIntWrapper("CPU", "SlowIterationWarningLevel", 100, FileName);
  PermissionAllowLowBandwidth = GetPrivateProfileIntWrapper("Permission", "AllowLowBandwidth", 1, FileName);
  PermissionMinimumSecondsToLogin = GetPrivateProfileIntWrapper("Permission", "MinimumSecondsToLogin", 0, FileName);
  PermissionMaxPoints = GetPrivateProfileIntWrapper("Permission", "PermissionMaxPoints", 0, FileName);
  PermissionMode = GetPrivateProfileIntWrapper("Permission", "PermissionMode", 0, FileName);
  AutoPermissionPoints = GetPrivateProfileIntWrapper("Permission", "AutoPermissionPoints", 0, FileName);
  GetPrivateProfileStringWrapper(
    "Permission",
    "AutoPermissionIDList",
    "0",
    PermissionAutoPermissionIDList,
    0x200u,
    FileName);
  GetPrivateProfileStringWrapper(
    "Permission",
    "AutoPermissionMessage",
    "Congratulations",
    PermissionAutoPermissionMessage,
    0x100u,
    FileName);
  v0 = GetTickCount() / 0xA;
  v1 = rand();
  sprintf(Dest, "%d", abs32(v0 + v1));
  GetPrivateProfileStringWrapper("Password", "SysopPassword", Dest, SysopPassword, 0x40u, FileName);
  v2 = GetTickCount() / 0xA;
  v3 = rand();
  sprintf(Dest, "%d", abs32(v2 + v3));
  GetPrivateProfileStringWrapper("Password", "EnergyPassword", Dest, EnergyPassword, 0x40u, FileName);
  v4 = GetTickCount() / 0xA;
  v5 = rand();
  sprintf(Dest, "%d", abs32(v4 + v5));
  GetPrivateProfileStringWrapper("Password", "ModeratorPassword", Dest, ModeratorPassword, 0x40u, FileName);
  v6 = GetTickCount() / 0xA;
  v7 = rand();
  sprintf(Dest, "%d", abs32(v6 + v7));
  GetPrivateProfileStringWrapper("Password", "SuperModeratorPassword", Dest, SuperModeratorPassword, 0x40u, FileName);
  v8 = GetTickCount() / 0xA;
  v9 = rand();
  sprintf(Dest, "%d", abs32(v8 + v9));
  GetPrivateProfileStringWrapper("Password", "VIPPassword", Dest, VIPPassword, 0x40u, FileName);
  GetPrivateProfileStringWrapper("Billing", "IP", "127.0.0.1", BillingIP, 0x80u, FileName);
  GetPrivateProfileStringWrapper("Billing", "Password", "money", BillingPassword, 0x20u, FileName);
  GetPrivateProfileStringWrapper("Billing", "ServerName", "Unknown", BillingServerName, 0x80u, FileName);
  *(_DWORD *)&BillingPort = GetPrivateProfileIntWrapper("Billing", "Port", 900, FileName);
  v10 = rand();
  BillingServerId = GetPrivateProfileIntWrapper("Billing", "ServerId", v10, FileName);
  BillingGroupId = GetPrivateProfileIntWrapper("Billing", "GroupId", 1, FileName);
  BillingScoreId = GetPrivateProfileIntWrapper("Billing", "ScoreId", 0, FileName);
  BillingReconnectTime = GetPrivateProfileIntWrapper("Billing", "ReconnectTime", 12000, FileName);
  BillingAttemptTime = GetPrivateProfileIntWrapper("Billing", "AttemptTime", 10000, FileName);
  AdvertiseSendMode = GetPrivateProfileIntWrapper("Advertise", "SendMode", 0, FileName);
  AdvertiseDisplayMode = GetPrivateProfileIntWrapper("Advertise", "DisplayMode", 2, FileName);
  AdvertiseDuration = GetPrivateProfileIntWrapper("Advertise", "Duration", 12000, FileName);
  GetPrivateProfileStringWrapper("Directory", "IP", "sscentral.vie.com", DirectoryIPAddresses, 0x200u, FileName);
  GetPrivateProfileStringWrapper("Directory", "Description", "None", DirectoryDescription, 0x100u, FileName);
  GetPrivateProfileStringWrapper(
    "Directory",
    "NamePassword",
    (LPSTR)&DirectoryCurrentNamePassword,
    DirectoryNamePassword,
    0x80u,
    FileName);
  result = GetPrivateProfileIntWrapper("Directory", "Port", 4991, FileName);
  DirectoryPort = result;
  return result;
}
// 4314B0: using guessed type int AdvertiseSendMode;
// 431BE0: using guessed type int MiscDisableSharewareShips;
// 431FFC: using guessed type int ArenaMinimumPlayers;
// 437B10: using guessed type int ArenaSpawnKeepScores;
// 437B14: using guessed type int dword_437B14;
// 437C1C: using guessed type int BillingAttemptTime;
// 437CA0: using guessed type int CommsMaxQueueToLogin;
// 4380B0: using guessed type int ArenaMaxPlayers;
// 438138: using guessed type int MiscMaxSharewarePlayer;
// 438B08: using guessed type int MiscLogPoints;
// 438B14: using guessed type int CPUSlowIterationWarningLevel;
// 438B18: using guessed type int MaxArenasMemory;
// 438B1C: using guessed type int PermissionMode;
// 438B20: using guessed type int CommsEncryptMode;
// 438B74: using guessed type int MiscMaxPlayers;
// 438B78: using guessed type int BillingReconnectTime;
// 438B7C: using guessed type int PermissionMinimumSecondsToLogin;
// 4AC438: using guessed type int PermissionMaxPoints;
// 4AF328: using guessed type int MiscKeepAliveDelay;
// 4AF32C: using guessed type int AutoPermissionPoints;
// 4C9F44: using guessed type int CPUSleepPerIteration;
// 4CA60C: using guessed type int MiscPointUpdateDiff;
// 4CA810: using guessed type int BillingLogMessages;
// 4D45C0: using guessed type int CustomArenaMode;
// 4D55CC: using guessed type int MiscServerLog;
// 4D55D4: using guessed type int MiscMaxSharkwareTime;
// 4D55D8: using guessed type int MiscMenuKickOutDelay;
// 4D5900: using guessed type int PermissionAllowLowBandwidth;
// 4D5904: using guessed type int CPUProcessMaxTime;
// 4D5908: using guessed type int MaxArenas;
// 4D590C: using guessed type int MiscJackpotBroadcastPoints;
// 4D5910: using guessed type int MiscRegisterKickShareware;
// 4D5918: using guessed type int MiscDisableShareware;
// 4D5928: using guessed type int ArenaDesiredPlayers;
// 4D8930: using guessed type int AdvertiseDuration;
// 4D8AD8: using guessed type int AdvertiseDisplayMode;
// 4D8AE0: using guessed type int MiscDisableSharewareScores;

//----- (00419B60) --------------------------------------------------------
int __cdecl LoadTemplateSSS()
{
  FILE *v0; // eax
  FILE *v1; // edi
  char *v2; // eax
  char v3; // cl
  char *i; // edx
  char v5; // cl
  char *j; // edx
  char v7; // cl
  char *k; // edx
  char v9; // cl
  char *l; // edx
  char v11; // dl
  char *m; // ecx
  int v13; // eax
  TEMPLATE_SSS *v14; // esi
  char *v15; // esi
  char *v16; // esi
  int v17; // ecx
  int v18; // esi
  int v19; // eax
  int v20; // eax
  char v22; // [esp+8h] [ebp-888h]
  char v23; // [esp+Ch] [ebp-884h]
  char v24[64]; // [esp+10h] [ebp-880h] BYREF
  char Source[64]; // [esp+50h] [ebp-840h] BYREF
  char v26[256]; // [esp+90h] [ebp-800h] BYREF
  char Str[256]; // [esp+190h] [ebp-700h] BYREF
  char v28[512]; // [esp+290h] [ebp-600h] BYREF
  char Buf; // [esp+490h] [ebp-400h] BYREF
  char v30; // [esp+491h] [ebp-3FFh] BYREF

  TotalTemplateSSSEntries = 0;
  v0 = fopen("template.sss", "rt");
  v1 = v0;
  if ( v0 )
  {
    if ( (v0->_flag & 0x10) == 0 )
    {
      do
      {
        if ( fgets(&Buf, 1024, v1) && (isalpha(Buf) || Buf == '*' || Buf == '+') )
        {
          Source[0] = 0;
          v24[0] = 0;
          Str[0] = 0;
          v26[0] = 0;
          v28[0] = 0;
          v2 = &Buf;
          v22 = 0;
          if ( Buf == 42 )
          {
            v22 = 1;
            v2 = &v30;
          }
          v23 = 1;
          if ( *v2 == 43 )
          {
            v23 = 0;
            ++v2;
          }
          v3 = *v2;
          for ( i = Source; v3 != ':'; ++v2 )
          {
            if ( !v3 )
              break;
            *i = v3;
            v3 = v2[1];
            ++i;
          }
          *i = 0;
          if ( v2 )
            ++v2;
          v5 = *v2;
          for ( j = v24; v5 != ':'; ++v2 )
          {
            if ( !v5 )
              break;
            *j = v5;
            v5 = v2[1];
            ++j;
          }
          *j = 0;
          if ( v2 )
            ++v2;
          v7 = *v2;
          for ( k = Str; v7 != ':'; ++v2 )
          {
            if ( !v7 )
              break;
            *k = v7;
            v7 = v2[1];
            ++k;
          }
          *k = 0;
          if ( v2 )
            ++v2;
          v9 = *v2;
          for ( l = v26; v9 != ':'; ++v2 )
          {
            if ( !v9 )
              break;
            *l = v9;
            v9 = v2[1];
            ++l;
          }
          *l = 0;
          if ( v2 )
            ++v2;
          v11 = *v2;
          for ( m = v28; v11 >= ' '; ++v2 )
          {
            *m = v11;
            v11 = v2[1];
            ++m;
          }
          *m = 0;
          v13 = TotalTemplateSSSEntries;
          TotalTemplateSSSList[v13].SomeChar1a = v22;
          TotalTemplateSSSList[v13].SomeChar1b = v23;
          v14 = &TotalTemplateSSSList[v13];
          strncpy(TotalTemplateSSSList[v13].SomeString32, Source, 0x20u);
          v14->SomeString32[31] = 0;
          v15 = (char *)(338 * TotalTemplateSSSEntries + 4426656);
          strncpy(v15, v24, 0x28u);
          v15[39] = 0;
          v16 = (char *)(338 * TotalTemplateSSSEntries + 4426704);
          strncpy(v16, v28, 0x100u);
          v16[255] = 0;
          v17 = TotalTemplateSSSEntries;
          v18 = TotalTemplateSSSEntries;
          if ( Str[0] )
          {
            v19 = atoi(Str);
            v17 = TotalTemplateSSSEntries;
            TotalTemplateSSSList[v18].someInteger = v19;
          }
          else
          {
            TotalTemplateSSSList[TotalTemplateSSSEntries].someInteger = -999;
          }
          if ( v26[0] )
          {
            v20 = atoi(v26);
            v17 = TotalTemplateSSSEntries;
            TotalTemplateSSSList[TotalTemplateSSSEntries].someInteger2 = v20;
          }
          else
          {
            TotalTemplateSSSList[v18].someInteger2 = -999;
          }
          TotalTemplateSSSEntries = v17 + 1;
        }
      }
      while ( (v1->_flag & 0x10) == 0 );
    }
    fclose(v1);
  }
  return printf("Template.sss read, %d entries found\n", TotalTemplateSSSEntries);
}
// 4D8AE4: using guessed type int TotalTemplateSSSEntries;

//----- (00419E50) --------------------------------------------------------
int __cdecl LoadMapSomething()
{
  int v0; // ebx
  char *v1; // eax
  char *v2; // eax
  int result; // eax
  int v4; // ebp
  unsigned int v5; // edx
  int i; // edi
  int j; // esi
  int v8; // ecx
  unsigned int v9; // [esp+10h] [ebp-24h] BYREF
  int v10[4]; // [esp+14h] [ebp-20h] BYREF
  char v11; // [esp+24h] [ebp-10h]
  int v12; // [esp+30h] [ebp-4h]

  v0 = 0;
  if ( _access(MiscDefaultLevelFile, 0) )
  {
    printf(
      "Could not find specified level file (%s), make sure a level file with this name is in the server directory.",
      MiscDefaultLevelFile);
    exit(1);
  }
  v10[0] = 42;
  v10[1] = 0;
  v10[2] = 0;
  v10[3] = 0;
  v11 = 0;
  strcpy((char *)v10 + 1, MiscDefaultLevelFile);
  dword_437B0C = CompressFile(MiscDefaultLevelFile, &dword_4D8AF0, &dword_4386F8, v10, 0x11u, 1, 0);
  v1 = (char *)operator new(0x110u);
  v9 = (unsigned int)v1;
  v12 = 0;
  if ( v1 )
    v2 = LoadBMPHeader(v1, MiscDefaultLevelFile);
  else
    v2 = 0;
  v12 = -1;
  dword_438B70 = v2;
  MapAllocatedMemory = emalloc(0x100000u);
  memset(MapAllocatedMemory, 0, 0x100000u);
  result = sub_406BE0(dword_438B70);
  v4 = result;
  if ( result > 0 )
  {
    do
    {
      GetTileValue((struct BMP_FILE_STRUCT *)dword_438B70, v0, (int *)&v9);
      result = v9;
      if ( (v9 & 0xFF000000) != 0xAA000000 )
      {
        *((_BYTE *)MapAllocatedMemory + 1024 * ((v9 >> 12) & 0xFFF) + (v9 & 0xFFF)) = HIBYTE(v9);
        v5 = v9;
        result = v9 & 0xFF000000;
        if ( (v9 & 0xFF000000) >= 0xD8000000 )
        {
          for ( i = 0; i < 7; ++i )
          {
            for ( j = 0; j < 7; ++j )
            {
              v8 = i + (v5 & 0xFFF);
              result = j + ((v5 >> 12) & 0xFFF);
              if ( v8 < 1024 && result < 1024 )
              {
                result = (int)MapAllocatedMemory + 1024 * result + v8;
                if ( !*(_BYTE *)result )
                {
                  *(_BYTE *)result = -16;
                  v5 = v9;
                }
              }
            }
          }
        }
      }
      ++v0;
    }
    while ( v0 < v4 );
  }
  return result;
}
// 4386F8: using guessed type int dword_4386F8;
// 4D8AF0: using guessed type int dword_4D8AF0;

//----- (0041A040) --------------------------------------------------------
int __cdecl LoadAdvertisements()
{
  int v0; // esi
  HANDLE v1; // ebx
  int v2; // esi
  size_t v3; // edi
  DWORD v4; // ebp
  _DWORD *v5; // ebx
  FILE *v6; // eax
  int v7; // esi
  bool v8; // zf
  int v9; // eax
  int v10; // eax
  int v11; // esi
  HANDLE v12; // ebx
  int v13; // esi
  size_t v14; // edi
  DWORD v15; // ebp
  _DWORD *v16; // ebx
  FILE *v17; // eax
  int v18; // esi
  int v19; // eax
  int v20; // eax
  int v21; // esi
  HANDLE v22; // ebx
  int v23; // esi
  size_t v24; // edi
  DWORD v25; // ebp
  _DWORD *v26; // ebx
  FILE *v27; // eax
  int v28; // esi
  int v29; // eax
  int v30; // eax
  unsigned int v32; // [esp+10h] [ebp-8C0h]
  unsigned int v33; // [esp+10h] [ebp-8C0h]
  unsigned int v34; // [esp+10h] [ebp-8C0h]
  FILE *File; // [esp+14h] [ebp-8BCh]
  FILE *Filea; // [esp+14h] [ebp-8BCh]
  FILE *Fileb; // [esp+14h] [ebp-8BCh]
  char *v38; // [esp+18h] [ebp-8B8h]
  FILE *v39; // [esp+18h] [ebp-8B8h]
  FILE *v40; // [esp+18h] [ebp-8B8h]
  int v41; // [esp+1Ch] [ebp-8B4h]
  int v42; // [esp+1Ch] [ebp-8B4h]
  int v43; // [esp+1Ch] [ebp-8B4h]
  int v44; // [esp+20h] [ebp-8B0h]
  int v45; // [esp+20h] [ebp-8B0h]
  int v46; // [esp+20h] [ebp-8B0h]
  size_t v47; // [esp+24h] [ebp-8ACh]
  size_t v48; // [esp+24h] [ebp-8ACh]
  size_t v49; // [esp+24h] [ebp-8ACh]
  char DstBuf[10]; // [esp+28h] [ebp-8A8h] BYREF
  __int32 Offset; // [esp+32h] [ebp-89Eh]
  char pv[4]; // [esp+38h] [ebp-898h] BYREF
  unsigned int v53; // [esp+3Ch] [ebp-894h]
  int v54; // [esp+40h] [ebp-890h]
  CHAR Dest[128]; // [esp+50h] [ebp-880h] BYREF
  char v56[2048]; // [esp+D0h] [ebp-800h] BYREF

  v0 = 0;
  dword_4D8AFC = 0;
  dword_4D8B00 = 0;
  dword_4D8B04 = 0;
  v44 = 0;
  do
  {
    sprintf(Dest, "b_ad%d.bmp", v0);
    if ( _access(Dest, 0) )
    {
      v10 = dword_4D8B04;
    }
    else
    {
      v1 = LoadImageA(0, Dest, 0, 0, 0, 0x2010u);
      GetObjectA(v1, 24, pv);
      v2 = v54;
      v32 = v53;
      v3 = 4 * ((int)(v53 + 3) / 4);
      v47 = v3;
      DeleteObject(v1);
      v4 = v32 * v2 + 10;
      v5 = emalloc(v4);
      *(_BYTE *)v5 = 48;
      *((_BYTE *)v5 + 1) = AdvertiseDisplayMode;
      *((_WORD *)v5 + 1) = v32;
      *((_WORD *)v5 + 2) = v2;
      *(_DWORD *)((char *)v5 + 6) = AdvertiseDuration;
      v6 = fopen(Dest, "rb");
      File = v6;
      if ( v6 )
      {
        fread(DstBuf, 1u, 0xEu, v6);
        fseek(File, Offset, 0);
        v7 = v2 - 1;
        if ( v7 >= 0 )
        {
          v38 = (char *)v5 + v32 * v7 + 10;
          v41 = v7 + 1;
          while ( 1 )
          {
            fread(v56, 1u, v3, File);
            qmemcpy(v38, v56, v32);
            v8 = v41 == 1;
            v38 -= v32;
            --v41;
            if ( v8 )
              break;
            v3 = v47;
          }
        }
        fclose(File);
      }
      v9 = dword_4D8B04;
      v0 = v44;
      *(&dword_437CB4 + 2 * dword_4D8B04) = v4;
      (&dword_437CB0)[2 * v9] = (char *)v5;
      v10 = v9 + 1;
      dword_4D8B04 = v10;
    }
    v44 = ++v0;
  }
  while ( v0 < 128 );
  printf("%d both advertisements found\n", v10);
  v11 = 0;
  v45 = 0;
  do
  {
    sprintf(Dest, "s_ad%d.bmp", v11);
    if ( _access(Dest, 0) )
    {
      v20 = dword_4D8AFC;
    }
    else
    {
      v12 = LoadImageA(0, Dest, 0, 0, 0, 0x2010u);
      GetObjectA(v12, 24, pv);
      v13 = v54;
      v33 = v53;
      v14 = 4 * ((int)(v53 + 3) / 4);
      v48 = v14;
      DeleteObject(v12);
      v15 = v33 * v13 + 10;
      v16 = emalloc(v15);
      *(_BYTE *)v16 = 48;
      *((_BYTE *)v16 + 1) = AdvertiseDisplayMode;
      *((_WORD *)v16 + 1) = v33;
      *((_WORD *)v16 + 2) = v13;
      *(_DWORD *)((char *)v16 + 6) = AdvertiseDuration;
      v17 = fopen(Dest, "rb");
      v39 = v17;
      if ( v17 )
      {
        fread(DstBuf, 1u, 0xEu, v17);
        fseek(v39, Offset, 0);
        v18 = v13 - 1;
        if ( v18 >= 0 )
        {
          Filea = (FILE *)((char *)v16 + v33 * v18 + 10);
          v42 = v18 + 1;
          while ( 1 )
          {
            fread(v56, 1u, v14, v39);
            qmemcpy(Filea, v56, v33);
            v8 = v42 == 1;
            Filea = (FILE *)((char *)Filea - v33);
            --v42;
            if ( v8 )
              break;
            v14 = v48;
          }
        }
        fclose(v39);
      }
      v19 = dword_4D8AFC;
      v11 = v45;
      *(&len + 2 * dword_4D8AFC) = v15;
      (&buf)[2 * v19] = (char *)v16;
      v20 = v19 + 1;
      dword_4D8AFC = v20;
    }
    v45 = ++v11;
  }
  while ( v11 < 128 );
  printf("%d shareware advertisements found\n", v20);
  v21 = 0;
  v46 = 0;
  do
  {
    sprintf(Dest, "r_ad%d.bmp", v21);
    if ( _access(Dest, 0) )
    {
      v30 = dword_4D8B00;
    }
    else
    {
      v22 = LoadImageA(0, Dest, 0, 0, 0, 0x2010u);
      GetObjectA(v22, 24, pv);
      v23 = v54;
      v34 = v53;
      v24 = 4 * ((int)(v53 + 3) / 4);
      v49 = v24;
      DeleteObject(v22);
      v25 = v34 * v23 + 10;
      v26 = emalloc(v25);
      *(_BYTE *)v26 = 48;
      *((_BYTE *)v26 + 1) = AdvertiseDisplayMode;
      *((_WORD *)v26 + 1) = v34;
      *((_WORD *)v26 + 2) = v23;
      *(_DWORD *)((char *)v26 + 6) = AdvertiseDuration;
      v27 = fopen(Dest, "rb");
      v40 = v27;
      if ( v27 )
      {
        fread(DstBuf, 1u, 0xEu, v27);
        fseek(v40, Offset, 0);
        v28 = v23 - 1;
        if ( v28 >= 0 )
        {
          Fileb = (FILE *)((char *)v26 + v34 * v28 + 10);
          v43 = v28 + 1;
          while ( 1 )
          {
            fread(v56, 1u, v24, v40);
            qmemcpy(Fileb, v56, v34);
            v8 = v43 == 1;
            Fileb = (FILE *)((char *)Fileb - v34);
            --v43;
            if ( v8 )
              break;
            v24 = v49;
          }
        }
        fclose(v40);
      }
      v29 = dword_4D8B00;
      v21 = v46;
      *(&dword_4317BC + 2 * dword_4D8B00) = v25;
      (&dword_4317B8)[2 * v29] = (char *)v26;
      v30 = v29 + 1;
      dword_4D8B00 = v30;
    }
    v46 = ++v21;
  }
  while ( v21 < 128 );
  return printf("%d registered advertisements found\n", v30);
}
// 4D8930: using guessed type int AdvertiseDuration;
// 4D8AD8: using guessed type int AdvertiseDisplayMode;
// 4D8AFC: using guessed type int dword_4D8AFC;
// 4D8B00: using guessed type int dword_4D8B00;
// 4D8B04: using guessed type int dword_4D8B04;

//----- (0041A580) --------------------------------------------------------
int __cdecl CleanUpMemory()
{
  int v0; // esi
  LPVOID *v1; // edi
  int v2; // edi
  LPVOID *v3; // esi
  int result; // eax
  int v5; // edi
  LPVOID *v6; // esi

  v0 = 0;
  if ( dword_4D8B00 > 0 )
  {
    v1 = (LPVOID *)&dword_4317B8;
    do
    {
      if ( *v1 )
        efree(*v1);
      ++v0;
      v1 += 2;
    }
    while ( v0 < dword_4D8B00 );
  }
  v2 = 0;
  dword_4D8B00 = 0;
  if ( dword_4D8AFC > 0 )
  {
    v3 = (LPVOID *)&buf;
    do
    {
      if ( *v3 )
        efree(*v3);
      ++v2;
      v3 += 2;
    }
    while ( v2 < dword_4D8AFC );
  }
  result = dword_4D8B04;
  v5 = 0;
  dword_4D8AFC = 0;
  if ( dword_4D8B04 > 0 )
  {
    v6 = (LPVOID *)&dword_437CB0;
    do
    {
      if ( *v6 )
        efree(*v6);
      result = dword_4D8B04;
      ++v5;
      v6 += 2;
    }
    while ( v5 < dword_4D8B04 );
  }
  dword_4D8B04 = 0;
  return result;
}
// 4D8AFC: using guessed type int dword_4D8AFC;
// 4D8B00: using guessed type int dword_4D8B00;
// 4D8B04: using guessed type int dword_4D8B04;

//----- (0041A630) --------------------------------------------------------
int __cdecl LoadWinsock()
{
  struct WSAData WSAData; // [esp+0h] [ebp-190h] BYREF

  return WSAStartup(0x101u, &WSAData);
}

//----- (0041A660) --------------------------------------------------------
int __thiscall StartServerListener(int this, int a2, int a3, int a4, int ServerListenPort, int OutgoingBufferSize, int IncomingBufferSize, int PacketHistoryMax)
{
  int v8; // eax
  _DWORD *v10; // edi
  int v11; // eax
  int v12; // edi
  char *v13; // eax
  _DWORD *v14; // ecx
  int v15; // edx
  void *v16; // edi
  int v17; // ecx
  int v18; // eax
  SOCKET v19; // eax
  u_short v20; // cx
  SOCKET v22; // [esp-14h] [ebp-34h]
  SOCKET v23; // [esp-14h] [ebp-34h]
  SOCKET v24; // [esp-14h] [ebp-34h]
  u_long argp; // [esp+Ch] [ebp-14h] BYREF
  struct sockaddr name; // [esp+10h] [ebp-10h] BYREF

  v8 = PacketHistoryMax;
  if ( PacketHistoryMax < 1 )
    v8 = 1;
  *(_DWORD *)(this + 44) = v8;
  *(_DWORD *)(this + 48) = 0;
  v10 = emalloc(540 * v8);
  v11 = *(_DWORD *)(this + 44);
  *(_DWORD *)(this + 40) = v10;
  memset(v10, 0, 4 * ((unsigned int)(540 * v11) >> 2));
  *(_DWORD *)this = a2;
  *(_DWORD *)(this + 32) = 0;
  *(_DWORD *)(this + 35920) = 0;
  *(_DWORD *)(this + 4) = a3;
  *(_DWORD *)(this + 12) = a4;
  *(_DWORD *)(this + 8) = ServerListenPort;
  *(_DWORD *)(this + 35916) = GetTickCount() / 0xA;
  *(_DWORD *)(this + 36) = 500;
  *(_DWORD *)(this + 35900) = 0;
  *(_DWORD *)(this + 35904) = 0;
  *(_DWORD *)(this + 35908) = 0;
  *(_DWORD *)(this + 35912) = 0;
  *(_DWORD *)(this + 16) = 0;
  memset((void *)(this + 52), 0, 0x8C00u);
  v12 = *(_DWORD *)(this + 12);
  *(_DWORD *)(this + 35896) = 0;
  *(_DWORD *)(this + 35892) = 0;
  v13 = (char *)operator new(3190 * v12);
  if ( v13 )
  {
    if ( v12 - 1 >= 0 )
    {
      v14 = v13 + 50;
      v15 = v12;
      do
      {
        *v14 = 0;
        v14 = (_DWORD *)((char *)v14 + 3190);
        --v15;
      }
      while ( v15 );
    }
    v16 = v13;
  }
  else
  {
    v16 = 0;
  }
  v17 = *(_DWORD *)(this + 12);
  *(_DWORD *)(this + 20) = v16;
  memset(v16, 0, 3190 * v17);
  v18 = *(_DWORD *)(this + 12);
  *(_DWORD *)(this + 35928) = 0;
  *(_DWORD *)(this + 35924) = emalloc(4 * v18);
  v19 = socket(2, 2, 0);
  *(_DWORD *)(this + 24) = v19;
  argp = 1;
  ioctlsocket(v19, -2147195266, &argp);
  v22 = *(_DWORD *)(this + 24);
  PacketHistoryMax = -1;
  setsockopt(v22, 6, 1, (const char *)&PacketHistoryMax, 4);
  v23 = *(_DWORD *)(this + 24);
  PacketHistoryMax = OutgoingBufferSize;
  setsockopt(v23, 0xFFFF, 4097, (const char *)&PacketHistoryMax, 4);
  v24 = *(_DWORD *)(this + 24);
  PacketHistoryMax = IncomingBufferSize;
  setsockopt(v24, 0xFFFF, 4098, (const char *)&PacketHistoryMax, 4);
  v20 = *(_WORD *)(this + 8);
  name.sa_family = 2;
  *(_WORD *)name.sa_data = htons(v20);
  *(_DWORD *)&name.sa_data[2] = htonl(0);
  bind(*(_DWORD *)(this + 24), &name, 16);
  return this;
}

//----- (0041A870) --------------------------------------------------------
void __thiscall CleanUpPacketAttachment(struct PACKET_ATTACHMENT *packetAttachment)
{
  int v2; // ebx
  int i; // esi
  int v4; // ebx
  LPVOID *v5; // esi

  v2 = 0;
  for ( i = packetAttachment->SomePointer; v2 < packetAttachment->allocateMemorySize; i += 3190 )
  {
    if ( *(_DWORD *)(i + 50) )
      sub_41B7A0(i);
    ++v2;
  }
  closesocket(packetAttachment->Socket);
  operator delete((void *)packetAttachment->SomePointer);
  v4 = 0;
  if ( (int)packetAttachment->SomeCounter > 0 )
  {
    v5 = (LPVOID *)&packetAttachment->gap_36[126];
    do
    {
      if ( *v5 )
      {
        efree(*v5);
        *v5 = 0;
      }
      ++v4;
      v5 += 35;
    }
    while ( v4 < packetAttachment->SomeCounter );
  }
  efree((LPVOID)packetAttachment->memory2);
  efree((LPVOID)packetAttachment->recievePacketBuffer);
}

//----- (0041A910) --------------------------------------------------------
int __thiscall sub_41A910(int this, int a2)
{
  int result; // eax

  result = a2;
  *(_DWORD *)(this + 32) = a2;
  return result;
}

//----- (0041A920) --------------------------------------------------------
ENCRYPTION *__thiscall SomethingBillerServer(_DWORD *this, char *name, u_short hostshort, int ServerKey, int a9)
{
  char *v5; // edi
  int v7; // ebp
  struct hostent *v8; // eax
  int v9; // ecx
  int v10; // edi
  _DWORD *v11; // eax
  ENCRYPTION *v12; // ebx
  __int16 v13; // ax
  int v14; // eax
  int v15; // edi
  int v16; // ecx
  unsigned int v17; // eax
  int v18; // eax
  int v19; // ecx
  int v21; // [esp-10h] [ebp-2Ch]
  int v22; // [esp-Ch] [ebp-28h]
  int v23; // [esp-4h] [ebp-20h]
  int v24; // [esp+10h] [ebp-Ch] BYREF
  __int16 v25; // [esp+14h] [ebp-8h]
  int v26; // [esp+16h] [ebp-6h]

  v5 = name;
  v7 = inet_addr(name);
  if ( v7 == -1 )
  {
    v8 = gethostbyname(v5);
    if ( !v8 )
      return 0;
    v7 = **(_DWORD **)v8->h_addr_list;
  }
  v9 = this[3];
  v10 = 0;
  if ( v9 <= 0 )
  {
LABEL_8:
    v10 = -1;
  }
  else
  {
    v11 = (_DWORD *)(this[5] + 50);
    while ( *v11 )
    {
      ++v10;
      v11 = (_DWORD *)((char *)v11 + 3190);
      if ( v10 >= v9 )
        goto LABEL_8;
    }
  }
  if ( v10 == -1 )
    return 0;
  v23 = a9;
  v12 = (ENCRYPTION *)(this[5] + 3190 * v10);
  v22 = ServerKey;
  v13 = htons(hostshort);
  InitializeEncryption(v12, (int)this, 1, v10, v7, v13, v22, 1, v23);
  v14 = this[8982];
  v15 = 0;
  if ( v14 )
  {
    v16 = v12->ConnectionStatus;
    v25 = v12->word4;
    v24 = v16;
    v21 = v14;
    v17 = this[8981];
    v26 = v12->PlayerId;
    v18 = BinarySearch((int)&v24, v17, v21, 4, DifferentCompareFunction, (unsigned int *)&name);
    v19 = this[8981];
    v15 = (v18 - v19) >> 2;
    memcpy((void *)(v19 + 4 * v15 + 4), (const void *)(v19 + 4 * v15), 4 * (this[8982] + 0x3FFFFFFF * v15));
  }
  *(_DWORD *)(this[8981] + 4 * v15) = v12;
  ++this[8982];
  return v12;
}

//----- (0041AA50) --------------------------------------------------------
void __thiscall DumpPacketHistory(struct PACKET_ATTACHMENT *packetAttachment, const char *Filename)
{
  FILE *v3; // eax
  int v4; // ecx
  char *v5; // ebp
  int v6; // edx
  int v7; // ecx
  int v8; // esi
  int v9; // edi
  struct in_addr *v10; // ebp
  char *v11; // eax
  FILE *File; // [esp+0h] [ebp-4h]
  char *Filenamea; // [esp+8h] [ebp+4h]

  v3 = fopen(Filename, "wt");
  File = v3;
  if ( v3 )
  {
    v4 = packetAttachment->PacketHistoryMax;
    v5 = 0;
    Filenamea = 0;
    if ( v4 > 0 )
    {
      do
      {
        v6 = (int)&v5[packetAttachment->PacketCurrentHistory] % v4;
        v7 = packetAttachment->recievePacketBuffer;
        v8 = 540 * v6;
        v9 = *(__int16 *)(v7 + 540 * v6 + 536);
        if ( v9 > 0 )
        {
          v10 = (struct in_addr *)(v7 + 540 * v6);
          v11 = inet_ntoa(v10[133]);
          fprintf(File, "%16s,%5d %3d: ", v11, *(__int16 *)(packetAttachment->recievePacketBuffer + v8 + 538), v9);
          do
          {
            fprintf(File, "%02x ", v10->S_un.S_un_b.s_b1);
            v10 = (struct in_addr *)((char *)v10 + 1);
            --v9;
          }
          while ( v9 );
          fprintf(File, "\n");
          v5 = Filenamea;
        }
        v4 = packetAttachment->PacketHistoryMax;
        Filenamea = ++v5;
      }
      while ( (int)v5 < v4 );
      v3 = File;
    }
    fclose(v3);
  }
}

//----- (0041AB30) --------------------------------------------------------
int __thiscall PlayerReadPackets(PLAYER *player, DWORD lpdwBytesRead, DWORD *lpdwSrcIPAddress, WORD *lpwSrcPort)
{
  int v5; // eax
  ENCRYPTION *v6; // edx
  int v7; // edi
  int v8; // eax
  int v9; // ecx
  ENCRYPTION *v10; // eax
  int v11; // edx
  int result; // eax
  int fromlen; // [esp+8h] [ebp-14h] BYREF
  struct sockaddr from; // [esp+Ch] [ebp-10h] BYREF

  v5 = player->dword30;
  v6 = player->encryptionPointer;
  fromlen = 16;
  v7 = 540 * v5;
  v8 = recvfrom(player->SubspaceEXEChecksumIndex, (char *)v6 + 540 * v5, 512, 0, &from, &fromlen);
  v9 = v8;
  if ( v8 == -1 )
    return 0;
  *(_WORD *)&player->encryptionPointer->SSEncryptionTable[v7 + 466] = v8;
  v10 = player->encryptionPointer;
  player->dword30 = (player->dword30 + 1) % player->ConnectType;
  *(_DWORD *)&v10->SSEncryptionTable[v7 + 462] = *(_DWORD *)&from.sa_data[2];
  *(_WORD *)&player->encryptionPointer->SSEncryptionTable[v7 + 468] = *(_WORD *)from.sa_data;
  *lpdwSrcIPAddress = *(_DWORD *)&from.sa_data[2];
  *lpwSrcPort = *(_WORD *)from.sa_data;
  *(_DWORD *)lpdwBytesRead = v9;
  v11 = player[41].AttachedToPlayerId;
  player[41].NoPasswordPacketDelayTimer += v9;
  result = (int)player->encryptionPointer + v7;
  player[41].AttachedToPlayerId = v11 + 1;
  return result;
}

//----- (0041AC00) --------------------------------------------------------
// send/recv packets
int __thiscall PlayerDoNetworkOps(PLAYER *this)
{
  __int64 v2; // rax
  DWORD v3; // kr00_4
  int v4; // eax
  int v5; // esi
  __int64 v6; // rax
  DWORD v7; // kr04_4
  int v8; // eax
  int v9; // ebx
  int v10; // esi
  int v11; // eax
  int v12; // eax
  const void *v14; // [esp-8h] [ebp-20h]
  unsigned int v15; // [esp-4h] [ebp-1Ch]
  int a5; // [esp+Ch] [ebp-Ch] BYREF
  int a4; // [esp+10h] [ebp-8h] BYREF
  signed int Size; // [esp+14h] [ebp-4h] BYREF

  v2 = (int)(GetTickCount() / 0xA - (unsigned int)this->MyArena);
  if ( (int)((HIDWORD(v2) ^ v2) - HIDWORD(v2)) > 10 )
  {
    v3 = GetTickCount();
    v4 = this[41].AllowAudioByte2;
    v5 = 0;
    this->MyArena = (ARENA *)(v3 / 0xA);
    if ( v4 > 0 )
    {
      do
        SendBiDirectionalCorePackets(*(struct CONNECTION **)(this[41].YResolution + 4 * v5++));
      while ( v5 < this[41].AllowAudioByte2 );
    }
  }
  if ( this[41].XResolution > 0 )
  {
    v6 = (int)(GetTickCount() / 0xA - this[41].AllowAudioByte1);
    if ( (int)((HIDWORD(v6) ^ v6) - HIDWORD(v6)) >= 100 )
    {
      v7 = GetTickCount();
      v8 = this[41].AllowAudioByte2;
      v9 = 0;
      this[41].AllowAudioByte1 = v7 / 0xA;
      if ( v8 > 0 )
      {
        do
        {
          v10 = *(_DWORD *)(this[41].YResolution + 4 * v9);
          v11 = *(_DWORD *)(v10 + 3090) - v10 - 2706;
          if ( v11 > 2 )
          {
            if ( *(unsigned __int8 *)(v10 + 2708) + 3 == v11 )
            {
              v15 = *(_DWORD *)(v10 + 3090) - v10 - 2709;
              v14 = (const void *)(v10 + 2709);
            }
            else
            {
              v15 = *(_DWORD *)(v10 + 3090) - v10 - 2706;
              v14 = (const void *)(v10 + 2706);
            }
            WriteToNetwork((ENCRYPTION *)v10, v14, v15);
            *(_DWORD *)(v10 + 3090) = v10 + 2706;
          }
          ++v9;
        }
        while ( v9 < this[41].AllowAudioByte2 );
      }
    }
  }
  v12 = PlayerReadPackets(this, (DWORD)&Size, (DWORD *)&a4, (WORD *)&a5);
  if ( !v12 )
    return 0;
  PlayerHandlePacket((int)this, v12, Size, a4, a5);
  return 1;
}

//----- (0041AD60) --------------------------------------------------------
void __thiscall PlayerHandlePacket(int this, int a2, signed int Size, int a4, int a5)
{
  int v6; // eax
  int *v7; // eax
  int v8; // ebp
  int v9; // ebx
  unsigned int v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // eax
  int v14; // edx
  int v15; // ecx
  _DWORD *v16; // eax
  ENCRYPTION *v17; // edi
  int v18; // eax
  int v19; // ebp
  int v20; // ecx
  unsigned int v21; // eax
  int v22; // eax
  int v23; // ecx
  int v24; // eax
  int v25; // ecx
  int v26; // edx
  DWORD v27; // kr00_4
  int v28; // eax
  int v29; // ecx
  int v30; // ecx
  int *v31; // eax
  unsigned int v32; // esi
  int v33; // edx
  int v34; // edi
  int v35; // ecx
  int v36; // ebx
  int *v37; // eax
  unsigned int v38; // esi
  int v39; // edx
  int v40; // edi
  int v41; // ecx
  int v42; // ebx
  unsigned int v43; // [esp-14h] [ebp-38h]
  int v44; // [esp-10h] [ebp-34h]
  _BYTE buf[6]; // [esp+10h] [ebp-14h] BYREF
  int v46; // [esp+18h] [ebp-Ch] BYREF
  __int16 v47; // [esp+1Ch] [ebp-8h]
  int v48; // [esp+1Eh] [ebp-6h]
  int ptr; // [esp+28h] [ebp+4h]

  v46 = a4;
  v6 = *(_DWORD *)(this + 35928);
  v47 = a5;
  v43 = *(_DWORD *)(this + 35924);
  v48 = -1;
  v7 = (int *)BinarySearch((int)&v46, v43, v6, 4, DifferentCompareFunction, (unsigned int *)buf);
  if ( *(_DWORD *)buf )
    v8 = *v7;
  else
    v8 = 0;
  v9 = a2;
  if ( *(_BYTE *)a2 || *(_BYTE *)(a2 + 1) != 1 )
  {
    if ( !v8 )
      return;
    v27 = GetTickCount();
    v28 = *(_DWORD *)(v8 + 62);
    v29 = *(_DWORD *)(v8 + 2670) + 1;
    *(_DWORD *)(v8 + 58) = v27 / 0xA;
    *(_DWORD *)(v8 + 2670) = v29;
    v30 = Size;
    if ( v28 <= 0 )
      goto LABEL_44;
    if ( *(_BYTE *)a2 )
    {
      v37 = (int *)(a2 + 1);
      v38 = a2 + 1 + 4 * ((unsigned int)(Size + 2) >> 2);
      v39 = *(_DWORD *)(v8 + 62);
      if ( a2 + 1 == v38 )
      {
LABEL_44:
        ProcessCorePackets((struct CONNECTION *)v8, (char *)v9, v30, 0);
        return;
      }
      v40 = v8 + 70 - (_DWORD)v37;
      do
      {
        v41 = *v37;
        v42 = v39 ^ *(int *)((char *)v37++ + v40);
        *(v37 - 1) = v41 ^ v42;
        v39 = v41;
      }
      while ( v37 != (int *)v38 );
    }
    else
    {
      if ( *(_BYTE *)(a2 + 1) == 2 )
        goto LABEL_44;
      if ( Size < 2 )
        return;
      v31 = (int *)(a2 + 2);
      v32 = a2 + 2 + 4 * ((unsigned int)(Size + 1) >> 2);
      v33 = *(_DWORD *)(v8 + 62);
      if ( a2 + 2 == v32 )
        goto LABEL_44;
      v34 = v8 + 70 - (_DWORD)v31;
      do
      {
        v35 = *v31;
        v36 = v33 ^ *(int *)((char *)v31++ + v34);
        *(v31 - 1) = v35 ^ v36;
        v33 = v35;
      }
      while ( v31 != (int *)v32 );
    }
    v9 = a2;
    v30 = Size;
    goto LABEL_44;
  }
  ptr = 0;
  if ( Size >= 8 )
    ptr = *(__int16 *)(v9 + 6);
  if ( ptr != 1 )
    goto LABEL_9;
  v11 = *(_DWORD *)(this + 32);
  if ( v11 )
  {
    v12 = v11 - 1;
    if ( !v12 )
    {
      v10 = abs32(*(_DWORD *)(v9 + 2));
      goto LABEL_15;
    }
    if ( v12 == 1 )
    {
LABEL_9:
      v10 = -abs32(*(_DWORD *)(v9 + 2));
LABEL_15:
      *(_DWORD *)(v9 + 2) = v10;
    }
  }
  if ( v8 && (v13 = *(_DWORD *)(v9 + 2), *(_DWORD *)(v8 + 62) == v13) )
  {
    buf[0] = 0;
    buf[1] = 2;
    *(_DWORD *)&buf[2] = v13;
    WriteToNetwork((ENCRYPTION *)v8, buf, 6u);
  }
  else
  {
    v14 = *(_DWORD *)(this + 12);
    v15 = 0;
    if ( v14 <= 0 )
    {
LABEL_23:
      v15 = -1;
    }
    else
    {
      v16 = (_DWORD *)(*(_DWORD *)(this + 20) + 50);
      while ( *v16 )
      {
        ++v15;
        v16 = (_DWORD *)((char *)v16 + 3190);
        if ( v15 >= v14 )
          goto LABEL_23;
      }
    }
    if ( v15 != -1 && *(_DWORD *)this )
    {
      v17 = (ENCRYPTION *)(*(_DWORD *)(this + 20) + 3190 * v15);
      InitializeEncryption(v17, this, 3, v15, a4, a5, *(_DWORD *)(v9 + 2), ptr, 0);
      v17->field_A6E = 1;
      v18 = *(_DWORD *)(this + 35928);
      v19 = 0;
      if ( v18 )
      {
        v20 = v17->ConnectionStatus;
        v47 = v17->word4;
        v46 = v20;
        v44 = v18;
        v21 = *(_DWORD *)(this + 35924);
        v48 = v17->PlayerId;
        v22 = BinarySearch((int)&v46, v21, v44, 4, DifferentCompareFunction, (unsigned int *)&Size);
        v23 = *(_DWORD *)(this + 35924);
        v19 = (v22 - v23) >> 2;
        memcpy(
          (void *)(v23 + 4 * v19 + 4),
          (const void *)(v23 + 4 * v19),
          4 * (*(_DWORD *)(this + 35928) + 0x3FFFFFFF * v19));
      }
      v24 = a5;
      v25 = a4;
      *(_DWORD *)(*(_DWORD *)(this + 35924) + 4 * v19) = v17;
      ++*(_DWORD *)(this + 35928);
      if ( (*(int (__cdecl **)(int, int, ENCRYPTION *))this)(v25, v24, v17) )
      {
        v17->dword32 = 2;
        buf[1] = 2;
        v26 = *(_DWORD *)(v9 + 2);
        buf[0] = 0;
        *(_DWORD *)&buf[2] = v26;
        WriteToNetwork(v17, buf, 6u);
      }
      else
      {
        sub_41B7A0((int)v17);
      }
    }
  }
}
// 41AFE8: conditional instruction was optimized away because of 'al.1==0'

//----- (0041B070) --------------------------------------------------------
void __thiscall ProcessRegularPackets(struct PACKET_ATTACHMENT *packetAttachment, char *buffer, int packetLength, ENCRYPTION *encryption, int a5)
{
  void (__cdecl *v6)(char *, int, ENCRYPTION *); // eax
  char *v7; // ebp
  int v8; // ecx
  char *v9; // esi
  __int16 *v10; // edi

  v6 = (void (__cdecl *)(char *, int, ENCRYPTION *))packetAttachment->dword4;
  if ( v6 )
  {
    v7 = buffer;
    v6(buffer, packetLength, encryption);
  }
  else
  {
    *(_DWORD *)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 130] = packetLength;
    *(_DWORD *)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 134] = encryption;
    if ( a5 )
    {
      v7 = buffer;
      a5 = 0;
      *(_DWORD *)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 126] = buffer;
    }
    else
    {
      v7 = buffer;
      if ( (unsigned int)packetLength >= 0x80 )
      {
        *(_DWORD *)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 126] = emalloc(packetLength);
        v8 = packetLength;
        v9 = buffer;
        v10 = *(__int16 **)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 126];
      }
      else
      {
        v8 = packetLength;
        v9 = buffer;
        *(_DWORD *)&packetAttachment->gap_36[140 * packetAttachment->SomeCounter + 126] = 0;
        v10 = &packetAttachment->char34 + 70 * packetAttachment->SomeCounter;
      }
      qmemcpy(v10, v9, v8);
    }
    ++packetAttachment->SomeCounter;
  }
  if ( a5 )
    efree(v7);
}

//----- (0041B1B0) --------------------------------------------------------
int __thiscall sub_41B1B0(int this, int a2, int a3)
{
  int v4; // ecx
  __int64 v5; // rax
  DWORD v6; // kr00_4
  int v7; // eax
  int v8; // edi
  __int64 v9; // rax
  DWORD v10; // kr04_4
  int v11; // eax
  int v12; // ebx
  int v13; // edi
  int v14; // eax
  int v15; // eax
  int v16; // ecx
  int result; // eax
  int v18; // ecx
  const void *v19; // [esp-8h] [ebp-20h]
  unsigned int v20; // [esp-4h] [ebp-1Ch]
  int a5; // [esp+Ch] [ebp-Ch] BYREF
  int a4; // [esp+10h] [ebp-8h] BYREF
  signed int Size; // [esp+14h] [ebp-4h] BYREF

  v4 = *(_DWORD *)(this + 35892);
  if ( v4 > 0 && *(_DWORD *)(this + 140 * v4 + 40) )
  {
    efree(*(LPVOID *)(this + 140 * v4 + 40));
    *(_DWORD *)(this + 140 * *(_DWORD *)(this + 35892) + 40) = 0;
  }
  if ( *(_DWORD *)(this + 35896) == *(_DWORD *)(this + 35892) )
  {
    *(_DWORD *)(this + 35892) = 0;
    *(_DWORD *)(this + 35896) = 0;
    v5 = (int)(GetTickCount() / 0xA - *(_DWORD *)(this + 28));
    if ( (int)((HIDWORD(v5) ^ v5) - HIDWORD(v5)) > 10 )
    {
      v6 = GetTickCount();
      v7 = *(_DWORD *)(this + 35928);
      v8 = 0;
      *(_DWORD *)(this + 28) = v6 / 0xA;
      if ( v7 > 0 )
      {
        do
          SendBiDirectionalCorePackets(*(struct CONNECTION **)(*(_DWORD *)(this + 35924) + 4 * v8++));
        while ( v8 < *(_DWORD *)(this + 35928) );
      }
    }
    if ( *(int *)(this + 35920) > 0 )
    {
      v9 = (int)(GetTickCount() / 0xA - *(_DWORD *)(this + 35916));
      if ( (int)((HIDWORD(v9) ^ v9) - HIDWORD(v9)) >= 100 )
      {
        v10 = GetTickCount();
        v11 = *(_DWORD *)(this + 35928);
        v12 = 0;
        *(_DWORD *)(this + 35916) = v10 / 0xA;
        if ( v11 > 0 )
        {
          do
          {
            v13 = *(_DWORD *)(*(_DWORD *)(this + 35924) + 4 * v12);
            v14 = *(_DWORD *)(v13 + 3090) - v13 - 2706;
            if ( v14 > 2 )
            {
              if ( *(unsigned __int8 *)(v13 + 2708) + 3 == v14 )
              {
                v20 = *(_DWORD *)(v13 + 3090) - v13 - 2709;
                v19 = (const void *)(v13 + 2709);
              }
              else
              {
                v20 = *(_DWORD *)(v13 + 3090) - v13 - 2706;
                v19 = (const void *)(v13 + 2706);
              }
              WriteToNetwork((ENCRYPTION *)v13, v19, v20);
              *(_DWORD *)(v13 + 3090) = v13 + 2706;
            }
            ++v12;
          }
          while ( v12 < *(_DWORD *)(this + 35928) );
        }
      }
    }
    v15 = PlayerReadPackets((PLAYER *)this, (DWORD)&Size, (DWORD *)&a4, (WORD *)&a5);
    if ( v15 )
      PlayerHandlePacket(this, v15, Size, a4, a5);
  }
  v16 = *(_DWORD *)(this + 35892);
  if ( *(_DWORD *)(this + 35896) == v16 )
    return 0;
  v18 = this + 140 * v16;
  result = *(_DWORD *)(v18 + 180);
  if ( !result )
    result = v18 + 52;
  *(_DWORD *)a2 = *(_DWORD *)(v18 + 184);
  *(_DWORD *)a3 = *(_DWORD *)(this + 140 * (*(_DWORD *)(this + 35892))++ + 188);
  return result;
}

//----- (0041B3D0) --------------------------------------------------------
int __thiscall sub_41B3D0(_DWORD *this)
{
  int result; // eax

  result = 0;
  this[8975] = 0;
  this[8976] = 0;
  this[8977] = 0;
  this[8978] = 0;
  this[4] = 0;
  return result;
}

//----- (0041B3F0) --------------------------------------------------------
void __thiscall GetPacketStatistics(struct PACKET_ATTACHMENT *packetAttachment, int *TotalPacketSendLength, int *TotalPacketSendCalls, int *TotalPacketRecvLength, int *TotalPacketRecvCalls, int *TotalPacketClustersCalls)
{
  *TotalPacketSendLength = packetAttachment->dword8C3C;
  *TotalPacketRecvLength = packetAttachment->dword8C44;
  *TotalPacketSendCalls = packetAttachment->dword8C40;
  *TotalPacketRecvCalls = packetAttachment->dword8C48;
  *TotalPacketClustersCalls = packetAttachment->dword10;
}

//----- (0041B430) --------------------------------------------------------
signed int __thiscall sub_41B430(void *this, signed int CommsTransportBufferSize)
{
  DWORD v3; // kr00_4
  int v4; // eax
  int v5; // edi
  int v6; // esi
  int v7; // eax
  signed int result; // eax
  const void *v9; // [esp-8h] [ebp-14h]
  unsigned int v10; // [esp-4h] [ebp-10h]

  v3 = GetTickCount();
  v4 = *((_DWORD *)this + 8982);
  v5 = 0;
  *((_DWORD *)this + 8979) = v3 / 0xA;
  if ( v4 > 0 )
  {
    do
    {
      v6 = *(_DWORD *)(*((_DWORD *)this + 8981) + 4 * v5);
      v7 = *(_DWORD *)(v6 + 3090) - v6 - 2706;
      if ( v7 > 2 )
      {
        if ( *(unsigned __int8 *)(v6 + 2708) + 3 == v7 )
        {
          v10 = *(_DWORD *)(v6 + 3090) - v6 - 2709;
          v9 = (const void *)(v6 + 2709);
        }
        else
        {
          v10 = *(_DWORD *)(v6 + 3090) - v6 - 2706;
          v9 = (const void *)(v6 + 2706);
        }
        WriteToNetwork((ENCRYPTION *)v6, v9, v10);
        *(_DWORD *)(v6 + 3090) = v6 + 2706;
      }
      ++v5;
    }
    while ( v5 < *((_DWORD *)this + 8982) );
  }
  result = CommsTransportBufferSize;
  if ( CommsTransportBufferSize >= 384 )
    result = 384;
  *((_DWORD *)this + 8980) = result;
  return result;
}

//----- (0041B4E0) --------------------------------------------------------
void __thiscall SendPacketsToEverybody(struct PACKET_ATTACHMENT *packetAttachment)
{
  DWORD v2; // kr00_4
  int v3; // eax
  int v4; // edi
  int v5; // esi
  int v6; // eax
  const void *v7; // [esp-Ch] [ebp-14h]
  unsigned int v8; // [esp-8h] [ebp-10h]

  v2 = GetTickCount();
  v3 = packetAttachment->dword8C58;
  v4 = 0;
  packetAttachment->TickCountDividedBy10 = v2 / 0xA;
  if ( v3 > 0 )
  {
    do
    {
      v5 = *(_DWORD *)(packetAttachment->memory2 + 4 * v4);
      v6 = *(_DWORD *)(v5 + 3090) - v5 - 2706;
      if ( v6 > 2 )
      {
        if ( *(unsigned __int8 *)(v5 + 2708) + 3 == v6 )
        {
          v8 = *(_DWORD *)(v5 + 3090) - v5 - 2709;
          v7 = (const void *)(v5 + 2709);
        }
        else
        {
          v8 = *(_DWORD *)(v5 + 3090) - v5 - 2706;
          v7 = (const void *)(v5 + 2706);
        }
        WriteToNetwork((ENCRYPTION *)v5, v7, v8);
        *(_DWORD *)(v5 + 3090) = v5 + 2706;
      }
      ++v4;
    }
    while ( v4 < packetAttachment->dword8C58 );
  }
}

//----- (0041B570) --------------------------------------------------------
int __stdcall sub_41B570(int a1)
{
  return 1;
}

//----- (0041B580) --------------------------------------------------------
int __cdecl DifferentCompareFunction(int connection, int ConnectionsArray)
{
  unsigned int *v2; // ecx
  unsigned int v3; // esi
  int result; // eax
  int v5; // edx

  v2 = *(unsigned int **)ConnectionsArray;
  v3 = **(_DWORD **)ConnectionsArray;
  if ( *(_DWORD *)connection > v3 )
    return 1;
  if ( *(_DWORD *)connection < v3 )
    return -1;
  v5 = *(_DWORD *)(connection + 6);
  result = *(unsigned __int16 *)(connection + 4) - *((unsigned __int16 *)v2 + 2);
  if ( v5 != -1 && !result )
    result = v5 - *(unsigned int *)((char *)v2 + 46);
  return result;
}

//----- (0041B5D0) --------------------------------------------------------
int __thiscall InitializeEncryption(ENCRYPTION *encryption, int a2, int a3, int a4, int a5, __int16 a6, signed int ServerKey, int a8, int a9)
{
  signed int v10; // edi
  char *v11; // ebp
  int result; // eax
  int v13; // [esp+24h] [ebp+14h]

  v10 = ServerKey;
  encryption->dword42 = a8;
  encryption->dword2A = a2;
  encryption->dword32 = a3;
  encryption->PlayerId = a4;
  encryption->ConnectionStatus = a5;
  encryption->word4 = a6;
  encryption->dword6 = a9;
  encryption->dwordA = 9999999;
  encryption->dwordE = 0;
  encryption->dword12 = 0;
  encryption->dword16 = 0;
  encryption->dword1A = 0;
  encryption->dword1E = 0;
  encryption->dword22 = 0;
  encryption->dword26 = 0;
  encryption->ServerKey = ServerKey;
  v11 = encryption->SSEncryptionTable;
  v13 = 260;
  do
  {
    v10 = 16807 * (v10 % 127773) - 2836 * (v10 / 127773) + 123;
    if ( v10 <= 0 )
      v10 += 0x7FFFFFFF;
    *(_WORD *)v11 = v10;
    v11 += 2;
    --v13;
  }
  while ( v13 );
  encryption->KeepAliveDelayTimer = 0;
  encryption->MenuKickOutDelayTimer = GetTickCount() / 0xA;
  encryption->KeepAliveDelayTimer = GetTickCount() / 0xA;
  encryption->field_24E = 0;
  encryption->field_252 = 0;
  encryption->field_A82 = 0;
  encryption->field_A86 = 0;
  encryption->field_A8A = 0;
  encryption->field_A8E = GetTickCount() / 0xA;
  encryption->field_256 = 0;
  encryption->field_25A = 0;
  encryption->field_25E = 0;
  encryption->field_266 = 0;
  encryption->field_262 = 0;
  memset(encryption->field_26A, 0, sizeof(encryption->field_26A));
  memset(encryption->PacketPointers, 0, sizeof(encryption->PacketPointers));
  encryption->field_A7A = 1000;
  encryption->field_A7E = 1000;
  result = 0;
  encryption->field_A6A = 0;
  encryption->field_A6E = 0;
  encryption->field_A72 = 0;
  encryption->field_A76 = 0;
  encryption->field_C12 = (int)&encryption->field_A92;
  memset(encryption->field_C16, 0, sizeof(encryption->field_C16));
  encryption->field_C66 = 0;
  encryption->field_C6A = 0;
  encryption->field_C6E = 0;
  encryption->field_C72 = 0;
  return result;
}

//----- (0041B7A0) --------------------------------------------------------
void *__thiscall sub_41B7A0(int this)
{
  int v2; // eax
  int v3; // ebp
  int v4; // esi
  void *v5; // eax
  LPVOID *v6; // esi
  int v7; // ebp
  int v8; // esi
  __int16 v9; // dx
  int v10; // eax
  int v11; // edx
  void *result; // eax
  int v13; // ecx
  int v14; // esi
  const void *v15; // [esp-8h] [ebp-28h]
  unsigned int v16; // [esp-4h] [ebp-24h]
  char buf[4]; // [esp+10h] [ebp-10h] BYREF
  int v18; // [esp+14h] [ebp-Ch] BYREF
  __int16 v19; // [esp+18h] [ebp-8h]
  int v20; // [esp+1Ah] [ebp-6h]

  v2 = *(_DWORD *)(this + 3090) - this - 2706;
  if ( v2 > 2 )
  {
    if ( *(unsigned __int8 *)(this + 2708) + 3 == v2 )
    {
      v16 = *(_DWORD *)(this + 3090) - this - 2709;
      v15 = (const void *)(this + 2709);
    }
    else
    {
      v16 = *(_DWORD *)(this + 3090) - this - 2706;
      v15 = (const void *)(this + 2706);
    }
    WriteToNetwork((ENCRYPTION *)this, v15, v16);
    *(_DWORD *)(this + 3090) = this + 2706;
  }
  if ( *(_DWORD *)(this + 50) == 2 )
  {
    buf[0] = 0;
    buf[1] = 7;
    WriteToNetwork((ENCRYPTION *)this, buf, 2u);
  }
  v3 = 0;
  if ( *(int *)(this + 3174) > 0 )
  {
    v4 = this + 3094;
    do
    {
      if ( *(_DWORD *)(v4 + 12) )
        efree(*(LPVOID *)v4);
      ++v3;
      v4 += 20;
    }
    while ( v3 < *(_DWORD *)(this + 3174) );
  }
  v5 = *(void **)(this + 3178);
  *(_DWORD *)(this + 3174) = 0;
  if ( v5 )
    efree(v5);
  *(_DWORD *)(this + 3178) = 0;
  *(_DWORD *)(this + 3182) = 0;
  *(_DWORD *)(this + 3186) = 0;
  v6 = (LPVOID *)(this + 618);
  v7 = 256;
  do
  {
    if ( v6[256] )
    {
      efree(v6[256]);
      v6[256] = 0;
    }
    if ( *v6 )
    {
      efree(*v6);
      *v6 = 0;
    }
    ++v6;
    --v7;
  }
  while ( v7 );
  if ( *(_DWORD *)(this + 594) )
  {
    efree(*(LPVOID *)(this + 594));
    *(_DWORD *)(this + 594) = 0;
  }
  v8 = *(_DWORD *)(this + 42);
  v9 = *(_WORD *)(this + 4);
  v10 = *(_DWORD *)(this + 46);
  v18 = *(_DWORD *)this;
  v19 = v9;
  v11 = *(_DWORD *)(v8 + 35928);
  v20 = v10;
  result = (void *)BinarySearch(
                     (int)&v18,
                     *(_DWORD *)(v8 + 35924),
                     v11,
                     4,
                     DifferentCompareFunction,
                     (unsigned int *)buf);
  if ( *(_DWORD *)buf )
  {
    v13 = *(_DWORD *)(v8 + 35928) - 1;
    *(_DWORD *)(v8 + 35928) = v13;
    v14 = *(_DWORD *)(v8 + 35924);
    result = memcpy(
               (void *)(v14 + 4 * (((int)result - v14) >> 2)),
               (const void *)(v14 + 4 * (((int)result - v14) >> 2) + 4),
               4 * (v13 + 0x3FFFFFFF * (((int)result - v14) >> 2)));
  }
  *(_DWORD *)(this + 50) = 0;
  return result;
}

//----- (0041B950) --------------------------------------------------------
int __thiscall CheckIfBillingServerIsConnected(int this)
{
  return *(_DWORD *)(this + 50);
}

//----- (0041B960) --------------------------------------------------------
int __thiscall sub_41B960(int this)
{
  return *(_DWORD *)(this + 66);
}

//----- (0041B970) --------------------------------------------------------
// NetworkData.GetRelAckDiff()
int __thiscall GetRelAckDiff(ENCRYPTION *encryption, DWORD *out)
{
  if ( out )
    *out = encryption->field_266;
  return encryption->field_25E - encryption->field_262;
}

//----- (0041B9A0) --------------------------------------------------------
void __thiscall WriteToNetwork(ENCRYPTION *encryption, const void *buf, unsigned int len)
{
  int v4; // edx
  const char *v5; // ebp
  char v6; // al
  char *v7; // ecx
  char *v8; // esi
  int v9; // eax
  int v10; // eax
  char *v11; // ecx
  char *v12; // esi
  int v13; // eax
  int v14; // eax
  DWORD v15; // kr00_4
  int v16; // ecx
  int v17; // eax
  __int64 v18; // rax
  int v19; // ecx
  int v20; // edi
  int v21; // edx
  _DWORD *v22; // edi
  __int16 v23; // cx
  int v24; // eax
  SOCKET v25; // [esp-24h] [ebp-43Ch]
  char v26; // [esp+7h] [ebp-411h]
  struct sockaddr to; // [esp+8h] [ebp-410h] BYREF
  char v28; // [esp+18h] [ebp-400h] BYREF
  char v29; // [esp+19h] [ebp-3FFh] BYREF
  char v30[1022]; // [esp+1Ah] [ebp-3FEh] BYREF

  if ( encryption->dword32 != 4 )
  {
    v4 = encryption->ServerKey;
    v5 = (const char *)buf;
    if ( v4 > 0 )
    {
      v26 = *(_BYTE *)buf;
      if ( *(_BYTE *)buf || (v6 = *((_BYTE *)buf + 1), v6 != 1) && v6 != 2 )
      {
        qmemcpy(&v28, buf, len);
        if ( v26 )
        {
          v11 = &v29;
          v12 = &v29 + 4 * ((len + 2) >> 2);
          if ( &v29 != v12 )
          {
            do
            {
              v13 = *(_DWORD *)v11 ^ *(_DWORD *)&v11[encryption->SSEncryptionTable - &v29];
              v11 += 4;
              v14 = v4 ^ v13;
              *((_DWORD *)v11 - 1) = v14;
              v4 = v14;
            }
            while ( v11 != v12 );
          }
        }
        else
        {
          v7 = v30;
          v8 = &v30[4 * ((len + 1) >> 2)];
          if ( v30 != v8 )
          {
            do
            {
              v9 = *(_DWORD *)v7 ^ *(_DWORD *)&v7[encryption->SSEncryptionTable - v30];
              v7 += 4;
              v10 = v4 ^ v9;
              *((_DWORD *)v7 - 1) = v10;
              v4 = v10;
            }
            while ( v7 != v8 );
          }
        }
        v5 = &v28;
      }
    }
    v15 = GetTickCount();
    v16 = encryption->field_A6A;
    v17 = encryption->field_A86;
    encryption->KeepAliveDelayTimer = v15 / 0xA;
    encryption->field_A6A = v16 + 1;
    encryption->field_A86 = len + v17;
    v18 = (int)(encryption->field_A8E - GetTickCount() / 0xA);
    v19 = (HIDWORD(v18) ^ v18) - HIDWORD(v18);
    if ( v19 >= 100 )
    {
      v20 = encryption->field_A86;
      v21 = encryption->field_A8A;
      encryption->field_A8A = v20;
      encryption->field_A82 = 100 * (v20 - v21) / v19;
      encryption->field_A8E = GetTickCount() / 0xA;
    }
    v22 = (_DWORD *)encryption->dword2A;
    v23 = encryption->word4;
    *(_DWORD *)&to.sa_data[2] = encryption->ConnectionStatus;
    v25 = v22[6];
    to.sa_family = 2;
    *(_WORD *)to.sa_data = v23;
    sendto(v25, v5, len, 0, &to, 16);
    v24 = v22[8976] + 1;
    v22[8975] += len;
    v22[8976] = v24;
  }
}
// 41B9A0: using guessed type char var_3FE[1022];

//----- (0041BB70) --------------------------------------------------------
void __thiscall ProcessCorePackets(ENCRYPTION *encryption, char *buffer, int size, int a5)
{
  int v5; // ecx
  char *v6; // esi
  int v7; // edi
  int v8; // esi
  char *v9; // edi
  int v10; // ebx
  int v11; // eax
  int v12; // esi
  int v13; // eax
  int v14; // esi
  int v15; // ecx
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // ecx
  int v20; // eax
  int i; // esi
  int v22; // eax
  int v23; // ebx
  __int16 v24; // di
  _DWORD *v25; // eax
  DWORD v26; // edi
  int v27; // edx
  int v28; // esi
  int v29; // eax
  __int64 v30; // rax
  __int64 v31; // rax
  int v32; // eax
  int v33; // ecx
  int v34; // ecx
  int v35; // edi
  char *v36; // esi
  void *v37; // eax
  int v38; // edi
  char *v39; // esi
  void *v40; // eax
  int v41; // ebx
  char *v42; // eax
  int v43; // eax
  int v44; // ecx
  int v45; // esi
  int v46; // eax
  char *v47; // esi
  char *j; // ebx
  int v49; // edx
  char *v50; // esi
  int v51; // edi
  void *v52; // [esp-Ch] [ebp-28h]
  int v53; // [esp-8h] [ebp-24h]
  char buf; // [esp+10h] [ebp-Ch] BYREF
  char v55; // [esp+11h] [ebp-Bh]
  int v56; // [esp+12h] [ebp-Ah]
  DWORD v57; // [esp+16h] [ebp-6h]

  v5 = encryption->dword32;
  if ( v5 == 4 )
  {
LABEL_12:
    v6 = buffer;
    goto RETURN_FREE_MEMORY;
  }
  v6 = buffer;
  if ( !*buffer )
  {
    v7 = size;
    if ( size <= 1 )
      goto RETURN_FREE_MEMORY;
    switch ( buffer[1] )
    {
      case 2:
        if ( v5 != 1 )
          goto RETURN_FREE_MEMORY;
        v8 = *(_DWORD *)(buffer + 2);
        if ( abs32(encryption->ServerKey) == abs32(v8) )
        {
          encryption->ServerKey = v8;
          v9 = encryption->SSEncryptionTable;
          v10 = 260;
          do
          {
            v8 = 16807 * (v8 % 127773) - 2836 * (v8 / 127773) + 123;
            if ( v8 <= 0 )
              v8 += 0x7FFFFFFF;
            *(_WORD *)v9 = v8;
            v9 += 2;
            --v10;
          }
          while ( v10 );
          encryption->dword32 = 2;
        }
        goto LABEL_12;
      case 3:
        if ( (unsigned int)size < 6 )
          goto RETURN_FREE_MEMORY;
        v16 = *(_DWORD *)(buffer + 2);
        buf = 0;
        v55 = 4;
        v56 = v16;
        SendPacketCluster((struct CONNECTION *)encryption, &buf, 6u);
        v17 = *(_DWORD *)(buffer + 2);
        if ( v17 > encryption->field_25A )
          encryption->field_25A = v17;
        v18 = *(_DWORD *)(buffer + 2);
        v19 = encryption->field_256;
        if ( v19 > v18 )
          goto RETURN_FREE_MEMORY;
        if ( v19 == v18 )
        {
          ProcessCorePackets((struct CONNECTION *)encryption, buffer + 6, v7 - 6, 0);
          v20 = encryption->field_256 + 1;
          encryption->field_256 = v20;
          for ( i = ((v20 >> 31) ^ (unsigned __int8)abs32(v20)) - (v20 >> 31);
                encryption->field_26A[i];
                i = ((v22 >> 31) ^ (unsigned __int8)abs32(v22)) - (v22 >> 31) )
          {
            ProcessCorePackets(
              (struct CONNECTION *)encryption,
              (char *)(encryption->field_26A[i] + 2),
              *(__int16 *)encryption->field_26A[i],
              0);
            efree((LPVOID)encryption->field_26A[i]);
            encryption->field_26A[i] = 0;
            v22 = encryption->field_256 + 1;
            encryption->field_256 = v22;
          }
        }
        else
        {
          v23 = ((v18 >> 31) ^ (unsigned __int8)abs32(v18)) - (v18 >> 31);
          if ( !encryption->field_26A[v23] )
          {
            v24 = v7 - 6;
            v25 = emalloc(v24 + 2);
            encryption->field_26A[v23] = (int)v25;
            *(_WORD *)v25 = v24;
            qmemcpy((void *)(encryption->field_26A[v23] + 2), buffer + 6, v24);
          }
        }
        goto LABEL_12;
      case 4:
        if ( (unsigned int)size < 6 )
          goto RETURN_FREE_MEMORY;
        v11 = *(_DWORD *)(buffer + 2);
        if ( encryption->field_262 > v11 || v11 >= encryption->field_25E )
          goto RETURN_FREE_MEMORY;
        v12 = ((v11 >> 31) ^ (unsigned __int8)abs32(v11)) - (v11 >> 31);
        v13 = encryption->PacketPointers[v12];
        if ( v13 )
        {
          encryption->field_266 -= *(__int16 *)(v13 + 4);
          efree((LPVOID)encryption->PacketPointers[v12]);
          encryption->PacketPointers[v12] = 0;
          v14 = encryption->field_25E;
          if ( encryption->field_262 < v14 )
          {
            do
            {
              v15 = encryption->field_262;
              if ( encryption->PacketPointers[((v15 >> 31) ^ (unsigned __int8)abs32(v15)) - (v15 >> 31)] )
                break;
              encryption->field_262 = v15 + 1;
            }
            while ( v15 + 1 < v14 );
          }
        }
        goto LABEL_12;
      case 5:
        v32 = *(_DWORD *)(buffer + 2);
        buf = 0;
        v55 = 6;
        v56 = v32;
        v57 = GetTickCount() / 0xA;
        WriteToNetwork(encryption, &buf, 0xAu);
        encryption->field_A72 = *(_DWORD *)(buffer + 6);
        encryption->field_A76 = *(_DWORD *)(buffer + 10);
        if ( v7 > 6 )
        {
          v33 = encryption->field_A6A;
          if ( v33 <= 300 )
            encryption->field_A7A = 1000;
          else
            encryption->field_A7A = 1000 * *(_DWORD *)(buffer + 10) / v33;
          v34 = *(_DWORD *)(buffer + 6);
          if ( v34 <= 300 )
            encryption->field_A7E = 1000;
          else
            encryption->field_A7E = 1000 * encryption->field_A6E / v34;
        }
        goto RETURN_FREE_MEMORY;
      case 6:
        v26 = GetTickCount() / 0xA;
        v27 = encryption->dword1E;
        v28 = v26 - *(_DWORD *)(buffer + 2);
        ++encryption->dword1A;
        v29 = encryption->dword22;
        encryption->dword1E = v28 + v27;
        if ( !v29 || v28 < v29 )
          encryption->dword22 = v28;
        if ( v28 > encryption->dword26 )
          encryption->dword26 = v28;
        if ( v28 <= encryption->dwordA + 1
          || (v30 = (int)(GetTickCount() / 0xA - encryption->dword16), (int)((HIDWORD(v30) ^ v30) - HIDWORD(v30)) > 12000) )
        {
          if ( v28 < 2 * encryption->dwordA
            || (v31 = (int)(GetTickCount() / 0xA - encryption->dword16),
                (int)((HIDWORD(v31) ^ v31) - HIDWORD(v31)) > 60000) )
          {
            encryption->dwordE = *(_DWORD *)(buffer + 6)
                               + v28 * (1000 - *(_DWORD *)(encryption->dword2A + 36)) / 1000
                               - v26;
            encryption->dword16 = GetTickCount() / 0xA;
            encryption->dwordA = v28;
          }
        }
        goto LABEL_12;
      case 7:
        goto LABEL_78;
      case 8:
      case 9:
        v41 = encryption->field_24E;
        v53 = size + v41 - 2;
        v52 = (void *)encryption->field_252;
        encryption->field_24E = v53;
        v42 = (char *)ExpandMemory(v52, v53, 1);
        encryption->field_252 = (int)v42;
        qmemcpy(&v42[v41], buffer + 2, v7 - 2);
        if ( buffer[1] == 9 )
        {
          ProcessCorePackets((struct CONNECTION *)encryption, (char *)encryption->field_252, encryption->field_24E, 1);
          encryption->field_252 = 0;
          encryption->field_24E = 0;
        }
        goto LABEL_12;
      case 10:
        if ( (unsigned int)size < 6 )
          goto RETURN_FREE_MEMORY;
        v43 = *(_DWORD *)(buffer + 2);
        if ( v43 < 0 || v43 >= 20971520 )       // 20 Megabytes (if it's in bytes)
        {
LABEL_78:
          encryption->dword32 = 4;
          goto RETURN_FREE_MEMORY;
        }
        v44 = encryption->field_C6A;
        encryption->field_C6E = v43;
        if ( !v44 )
        {
          encryption->field_C6A = (int)emalloc(v43);
          encryption->field_C72 = 0;
        }
        qmemcpy((void *)(encryption->field_C6A + encryption->field_C72), buffer + 6, v7 - 6);
        v45 = v7 - 6 + encryption->field_C72;
        v46 = encryption->field_C6E;
        encryption->field_C72 = v45;
        if ( v45 == v46 )
        {
          ProcessCorePackets((struct CONNECTION *)encryption, (char *)encryption->field_C6A, v46, 1);
          encryption->field_C72 = 0;
          encryption->field_C6E = 0;
          encryption->field_C6A = 0;
        }
        break;
      case 11:
        v35 = 0;
        if ( encryption->field_C66 > 0 )
        {
          v36 = encryption->field_C16;
          do
          {
            if ( *((_DWORD *)v36 + 3) )
              efree(*(LPVOID *)v36);
            ++v35;
            v36 += 20;
          }
          while ( v35 < encryption->field_C66 );
          v6 = buffer;
        }
        v37 = (void *)encryption->field_C6A;
        encryption->field_C66 = 0;
        if ( v37 )
          efree(v37);
        encryption->field_C6A = 0;
        encryption->field_C6E = 0;
        encryption->field_C72 = 0;
        LOWORD(size) = 3072;
        WriteData(encryption, &size, 2, 1);
        goto RETURN_FREE_MEMORY;
      case 12:
        v38 = 0;
        if ( encryption->field_C66 > 0 )
        {
          v39 = encryption->field_C16;
          do
          {
            if ( *((_DWORD *)v39 + 3) )
              efree(*(LPVOID *)v39);
            ++v38;
            v39 += 20;
          }
          while ( v38 < encryption->field_C66 );
          v6 = buffer;
        }
        v40 = (void *)encryption->field_C6A;
        encryption->field_C66 = 0;
        if ( v40 )
          efree(v40);
        encryption->field_C6A = 0;
        encryption->field_C6E = 0;
        encryption->field_C72 = 0;
        goto RETURN_FREE_MEMORY;
      case 14:
        v47 = buffer + 2;
        for ( j = &buffer[size]; v47 < j; v47 = &v50[v51] )
        {
          v49 = (unsigned __int8)*v47;
          v50 = v47 + 1;
          v51 = v49;
          ProcessCorePackets((struct CONNECTION *)encryption, v50, v49, 0);
        }
        goto LABEL_12;
      default:
        goto RETURN_FREE_MEMORY;
    }
    goto LABEL_12;
  }
  ProcessRegularPackets(
    (struct PACKET_ATTACHMENT *)encryption->dword2A,
    buffer,
    size,
    (struct CONNECTION *)encryption,
    a5);
  a5 = 0;
RETURN_FREE_MEMORY:
  if ( a5 )
    efree(v6);
}

//----- (0041C2B0) --------------------------------------------------------
void __thiscall SendBiDirectionalCorePackets(struct CONNECTION *connection)
{
  int v2; // eax
  __int64 v3; // rax
  int v4; // edx
  __int64 v5; // rax
  int v6; // eax
  DWORD v7; // kr00_4
  int v8; // eax
  int v9; // eax
  int v10; // edx
  unsigned int v11; // ebx
  int v12; // ecx
  unsigned int v13; // eax
  int v14; // eax
  signed int v15; // ebx
  DWORD v16; // esi
  int v17; // ecx
  signed int v18; // edi
  int v19; // ebx
  int i; // edi
  int v21; // ecx
  char buf[6]; // [esp+10h] [ebp-210h] BYREF
  int v23; // [esp+16h] [ebp-20Ah]
  int v24; // [esp+1Ah] [ebp-206h]
  char v25[2]; // [esp+20h] [ebp-200h] BYREF
  int v26; // [esp+22h] [ebp-1FEh]
  char v27[506]; // [esp+26h] [ebp-1FAh] BYREF

  v2 = *(_DWORD *)&connection[4].usControl;
  if ( v2 == 1 )
  {
    v3 = (int)(GetTickCount() / 0xA - *(_DWORD *)&connection[4].usTransform);
    if ( (int)((HIDWORD(v3) ^ v3) - HIDWORD(v3)) > 100 )
    {
      v4 = *(_DWORD *)&connection[5].usControl;
      buf[0] = 0;
      buf[1] = 1;
      *(_DWORD *)&buf[2] = v4;
      LOWORD(v23) = 1;
      WriteToNetwork((ENCRYPTION *)connection, buf, 8u);
    }
  }
  else if ( v2 == 2 )
  {
    if ( *(_DWORD *)&connection->usTransform )
    {
      if ( (v5 = (int)(GetTickCount() / 0xA - *(_DWORD *)&connection[1].usTransform),
            v6 = (HIDWORD(v5) ^ v5) - HIDWORD(v5),
            v6 > 2000)
        || v6 > 500 && *(int *)((char *)&connection->lScale + 2) > 300
        || v6 > 50 && *(int *)((char *)&connection->lScale + 2) > 1000 )
      {
        *(_DWORD *)&connection[1].usTransform = GetTickCount() / 0xA;
        buf[0] = 0;
        buf[1] = 5;
        v7 = GetTickCount();
        v8 = *(_DWORD *)&connection[222].usTransform;
        *(_DWORD *)&buf[2] = v7 / 0xA;
        v23 = *(_DWORD *)&connection[222].usControl + 1;
        v24 = v8;
        WriteToNetwork((ENCRYPTION *)connection, buf, 0xEu);
      }
    }
    while ( *(int *)&connection[264].usTransform > 0 )
    {
      v9 = *(_DWORD *)&connection[51].usControl;
      if ( v9 >= 2048
        || *(_DWORD *)&connection[50].usTransform - *(LONG *)((char *)&connection[50].lScale + 2) >= 128
        || *(_DWORD *)&connection[259].usControl && v9 > 256 )
      {
        break;
      }
      v10 = *(_DWORD *)&connection[258].usTransform;
      v26 = *(_DWORD *)&connection[258].usControl;
      v25[0] = 0;
      v25[1] = 10;
      v11 = 480;
      if ( v26 - v10 <= 480 )
        v11 = v26 - v10;
      qmemcpy(
        v27,
        (const void *)(*(_DWORD *)&connection[258].usTransform + *(LONG *)((char *)&connection[257].lScale + 2)),
        v11);
      WriteData((ENCRYPTION *)connection, v25, v11 + 6, 1);
      v12 = *(_DWORD *)&connection[258].usControl;
      v13 = v11 + *(_DWORD *)&connection[258].usTransform;
      *(_DWORD *)&connection[258].usTransform = v13;
      if ( v13 == v12 )
      {
        if ( *(LONG *)((char *)&connection[258].lScale + 2) )
          efree(*(LPVOID *)((char *)&connection[257].lScale + 2));
        v14 = *(_DWORD *)&connection[264].usTransform - 1;
        *(_DWORD *)&connection[264].usTransform = v14;
        memcpy((char *)&connection[257].lScale + 2, &connection[259].usTransform, 20 * v14);
      }
    }
    if ( *(LONG *)((char *)&connection[50].lScale + 2) < *(_DWORD *)&connection[50].usTransform )
    {
      *(_DWORD *)buf = 0;
      v15 = 90;
      v16 = GetTickCount() / 0xA;
      v17 = *(LONG *)((char *)&connection[136].lScale
                    + 4
                    * (((*(int *)((char *)&connection[50].lScale + 2) >> 31) ^ (unsigned __int8)abs32(*(LONG *)((char *)&connection[50].lScale + 2)))
                     - (*(int *)((char *)&connection[50].lScale + 2) >> 31))
                    + 2);
      v18 = *(__int16 *)(v17 + 4);
      if ( v18 > 256 )
        v15 = 170;
      if ( (int)abs32(v16 - *(_DWORD *)v17) <= v15 )
      {
        v19 = *(_DWORD *)buf;
      }
      else
      {
        *(_DWORD *)v17 = v16;
        SendPacketCluster(connection, (const void *)(v17 + 6), v18);
        v19 = 1;
      }
      for ( i = *(LONG *)((char *)&connection[50].lScale + 2) + 1; i < *(_DWORD *)&connection[50].usTransform; ++i )
      {
        if ( v19 >= 3 )
          break;
        v21 = *(LONG *)((char *)&connection[136].lScale + 4 * (((i >> 31) ^ (unsigned __int8)abs32(i)) - (i >> 31)) + 2);
        if ( v21 )
        {
          if ( (int)abs32(v16 - *(_DWORD *)v21) > 200 )
          {
            *(_DWORD *)v21 = v16;
            SendPacketCluster(connection, (const void *)(v21 + 6), *(__int16 *)(v21 + 4));
          }
          ++v19;
        }
      }
    }
  }
}

//----- (0041C5E0) --------------------------------------------------------
// NetworkData.WriteData()
BOOL __thiscall WriteData(ENCRYPTION *encryptionn, void *buf, int buf_sz, BOOL bReliable)
{
  int v4; // edi
  int v6; // esi
  unsigned int v7; // ebp
  int v9; // esi
  DWORD *v10; // eax
  DWORD *v11; // ebp
  DWORD v12; // edx
  _WORD *v13; // ebp
  char *v14; // ebp
  int v15; // edx
  int i; // [esp+10h] [ebp-1FCh]
  unsigned int v17; // [esp+10h] [ebp-1FCh]
  BOOL v18; // [esp+14h] [ebp-1F8h]
  char v19[2]; // [esp+18h] [ebp-1F4h] BYREF
  char v20[498]; // [esp+1Ah] [ebp-1F2h] BYREF

  v4 = buf_sz;
  if ( buf_sz > 496 )
  {
    v6 = 0;
    for ( i = 0; ; v6 = i )
    {
      v7 = v4 - v6;
      if ( v4 - v6 >= 480 )
        v7 = 480;
      v19[1] = (v7 == v4 - v6) + 8;
      v19[0] = 0;
      qmemcpy(v20, (char *)buf + v6, v7);
      if ( !WriteData(encryptionn, v19, v7 + 2, 1) )
        break;
      i += v7;
      if ( i >= buf_sz )
        return 1;
      v4 = buf_sz;
    }
    return 0;
  }
  if ( bReliable )
  {
    if ( encryptionn->field_25E - encryptionn->field_262 >= 255 )
      return 0;
    v18 = encryptionn->field_266 < 4096;
    v17 = buf_sz + 6;
    v9 = ((encryptionn->field_25E >> 31) ^ (unsigned __int8)abs32(encryptionn->field_25E))
       - (encryptionn->field_25E >> 31);
    v10 = emalloc(buf_sz + 12);
    encryptionn->PacketPointers[v9] = (int)v10;
    v11 = v10;
    if ( v18 )
      v12 = GetTickCount() / 0xA;
    else
      v12 = 0;
    *v11 = v12;
    v13 = v11 + 1;
    *v13 = v17;
    v14 = (char *)(v13 + 1);
    *v14 = 0;
    v14[1] = 3;
    *(_DWORD *)(v14 + 2) = encryptionn->field_25E;
    qmemcpy(v14 + 6, buf, buf_sz);
    v15 = encryptionn->field_25E + 1;
    encryptionn->field_266 += v17;
    encryptionn->field_25E = v15;
    if ( v18 )
      SendPacketCluster((struct CONNECTION *)encryptionn, v14, v17);
  }
  else
  {
    SendPacketCluster((struct CONNECTION *)encryptionn, buf, buf_sz);
  }
  return 1;
}
// 41C607: conditional instruction was optimized away because of '%len.4>=1F1'

//----- (0041C7C0) --------------------------------------------------------
// Player.LogReliablePackets()
FILE *__thiscall LogReliablePackets(char *this, char *filename)
{
  char *v2; // edi
  FILE *result; // eax
  FILE *v4; // ebx
  int i; // ebp
  int v6; // esi
  int v7; // edi
  unsigned __int8 *v8; // esi

  v2 = this;
  result = fopen(filename, "wt");
  v4 = result;
  if ( result )
  {
    for ( i = *(_DWORD *)(v2 + 610); i < *(_DWORD *)(v2 + 606); ++i )
    {
      v6 = *(_DWORD *)&v2[4 * (((i >> 31) ^ (unsigned __int8)abs32(i)) - (i >> 31)) + 1642];
      if ( v6 )
      {
        v7 = *(__int16 *)(v6 + 4);
        fprintf(v4, "%10d %4d: ", *(_DWORD *)v6, v7);
        v8 = (unsigned __int8 *)(v6 + 6);
        if ( v7 > 0 )
        {
          do
          {
            fprintf(v4, "%02x ", *v8++);
            --v7;
          }
          while ( v7 );
        }
        fprintf(v4, "\n");
        v2 = this;
      }
      else
      {
        fprintf(v4, "Acknowledged\n");
      }
    }
    result = (FILE *)fclose(v4);
  }
  return result;
}

//----- (0041C890) --------------------------------------------------------
signed int __thiscall GetNewsRequest(int this, int a2, int a3, int a4)
{
  int v4; // eax

  v4 = *(_DWORD *)(this + 3174);
  if ( v4 >= 4 )
    return 0;
  *(_DWORD *)(this + 20 * v4 + 3094) = a2;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3098) = a3;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3102) = 0;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3106) = 1;
  *(_DWORD *)(this + 20 * (*(_DWORD *)(this + 3174))++ + 3110) = a4;
  SendBiDirectionalCorePackets((struct CONNECTION *)this);
  return 1;
}

//----- (0041C920) --------------------------------------------------------
signed int __thiscall GetMapLvlRequest(int this, int a2, int a3, int a4)
{
  int v4; // eax

  v4 = *(_DWORD *)(this + 3174);
  if ( v4 >= 4 )
    return 0;
  *(_DWORD *)(this + 20 * v4 + 3094) = a2;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3098) = a3;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3102) = 0;
  *(_DWORD *)(this + 20 * *(_DWORD *)(this + 3174) + 3106) = 0;
  *(_DWORD *)(this + 20 * (*(_DWORD *)(this + 3174))++ + 3110) = a4;
  SendBiDirectionalCorePackets((struct CONNECTION *)this);
  return 1;
}

//----- (0041C9B0) --------------------------------------------------------
int __thiscall sub_41C9B0(int this, int a2, int a3)
{
  int result; // eax

  *(_DWORD *)a2 = *(_DWORD *)(this + 3182);
  result = *(_DWORD *)(this + 3186);
  *(_DWORD *)a3 = result;
  return result;
}

//----- (0041C9D0) --------------------------------------------------------
void __thiscall GetASyncS2CInfoSomething(struct CONNECTION *encryption, int ASyncS2CEnd, int ASyncS2CStart)
{
  if ( *(int *)&encryption[264].usTransform <= 0 )
  {
    *(_DWORD *)ASyncS2CEnd = 0;
    *(_DWORD *)ASyncS2CStart = 0;
  }
  else
  {
    *(_DWORD *)ASyncS2CEnd = *(_DWORD *)&encryption[258].usControl;
    *(_DWORD *)ASyncS2CStart = *(_DWORD *)&encryption[258].usTransform;
  }
}

//----- (0041CA10) --------------------------------------------------------
int __thiscall sub_41CA10(int this)
{
  return *(_DWORD *)(this + 3174);
}

//----- (0041CA20) --------------------------------------------------------
// NetworkData.something()
void __thiscall SendPacketCluster(ENCRYPTION *encryptionn, const void *buf, unsigned int len)
{
  signed int v4; // ecx
  int v5; // eax
  _BYTE *v6; // ecx
  void *v7; // ecx
  int *v8; // [esp-8h] [ebp-18h]
  unsigned int v9; // [esp-4h] [ebp-14h]

  if ( (int)len > 255 || (v4 = *(_DWORD *)(encryptionn->dword2A + 35920), (int)(len + 3) > v4) )
  {
    WriteToNetwork(encryptionn, buf, len);
  }
  else
  {
    v5 = encryptionn->field_C12 - (_DWORD)encryptionn - 2706;
    if ( (int)(v5 + len + 1) > v4 )
    {
      if ( v5 > 2 && BYTE2(encryptionn->field_A92) + 3 == v5 )
      {
        v9 = encryptionn->field_C12 - (_DWORD)encryptionn - 2709;
        v8 = (int *)((char *)&encryptionn->field_A92 + 3);
      }
      else
      {
        v9 = encryptionn->field_C12 - (_DWORD)encryptionn - 2706;
        v8 = &encryptionn->field_A92;
      }
      WriteToNetwork(encryptionn, v8, v9);
      v5 = 0;
      encryptionn->field_C12 = (int)&encryptionn->field_A92;
    }
    if ( v5 )
    {
      ++*(_DWORD *)(encryptionn->dword2A + 16);
    }
    else
    {
      *(_BYTE *)encryptionn->field_C12 = 0;
      v6 = (_BYTE *)(encryptionn->field_C12 + 1);
      encryptionn->field_C12 = (int)v6;
      *v6 = 14;
      ++encryptionn->field_C12;
    }
    *(_BYTE *)encryptionn->field_C12 = len;
    v7 = (void *)(encryptionn->field_C12 + 1);
    encryptionn->field_C12 = (int)v7;
    qmemcpy(v7, buf, len);
    encryptionn->field_C12 += len;
  }
}

//----- (0041CB20) --------------------------------------------------------
void __thiscall sub_41CB20(int this)
{
  int v2; // eax
  const void *v3; // [esp-8h] [ebp-Ch]
  unsigned int v4; // [esp-4h] [ebp-8h]

  v2 = *(_DWORD *)(this + 3090) - this - 2706;
  if ( v2 > 2 )
  {
    if ( *(unsigned __int8 *)(this + 2708) + 3 == v2 )
    {
      v4 = *(_DWORD *)(this + 3090) - this - 2709;
      v3 = (const void *)(this + 2709);
    }
    else
    {
      v4 = *(_DWORD *)(this + 3090) - this - 2706;
      v3 = (const void *)(this + 2706);
    }
    WriteToNetwork((ENCRYPTION *)this, v3, v4);
    *(_DWORD *)(this + 3090) = this + 2706;
  }
}

//----- (0041CB70) --------------------------------------------------------
int __thiscall sub_41CB70(int this, int a2, int a3)
{
  int result; // eax

  *(_DWORD *)a2 = *(_DWORD *)(this + 2682);
  result = *(_DWORD *)(this + 2686);
  *(_DWORD *)a3 = result;
  return result;
}

//----- (0041CB90) --------------------------------------------------------
void __thiscall GetPacketCountInfoSomething(struct CONNECTION *this, int a2, int a3, int a4, int a5)
{
  *(_DWORD *)a2 = *(_DWORD *)&this[222].usControl;
  *(_DWORD *)a3 = *(_DWORD *)&this[222].usTransform;
  *(_DWORD *)a4 = *(LONG *)((char *)&this[222].lScale + 2);
  *(_DWORD *)a5 = *(_DWORD *)&this[223].usControl;
}

//----- (0041CBD0) --------------------------------------------------------
void __thiscall sub_41CBD0(int this)
{
  *(_DWORD *)(this + 50) = 4;
}

//----- (0041CBE0) --------------------------------------------------------
char *__cdecl GetIPAddressString(struct in_addr in)
{
  return inet_ntoa(in);
}

//----- (0041CBF0) --------------------------------------------------------
char *__cdecl GetSubspaceEXEChecksum(char *Filename)
{
  int v1; // ecx
  char *v2; // eax
  int v4; // [esp+0h] [ebp-4h] BYREF

  v4 = v1;
  v2 = CompressFile(Filename, &v4, (int *)&Filename, 0, 0, 0, 0);
  if ( v2 )
    efree(v2);
  return Filename;
}
// 41CBF0: variable 'v1' is possibly undefined

//----- (0041CC30) --------------------------------------------------------
char *__cdecl CompressFile(const char *Filename, int *OutSize, int *CRC_32, const void *Buffer, unsigned int bytes, int DoFileCompression, int FileSize)
{
  FILE *v7; // eax
  FILE *v8; // edi
  char *result; // eax
  int v10; // eax
  DWORD v11; // ebx
  _DWORD *v12; // esi
  void *v13; // edi
  LPVOID v14; // eax
  _DWORD *v15; // ebp
  void *ptr; // [esp+18h] [ebp+Ch]

  v7 = fopen(Filename, "rb");
  v8 = v7;
  if ( v7 )
  {
    v10 = _fileno(v7);
    v11 = _filelength(v10);
    v12 = emalloc(v11);
    fread(v12, v11, 1u, v8);
    fclose(v8);
    if ( FileSize )
      *(_DWORD *)FileSize = v11;
    if ( CRC_32 )
      *CRC_32 = CRC32((unsigned int)v12, v11);
    if ( DoFileCompression )
    {
      FileSize = (int)(4 * v11) / 3 + 12;
      v13 = ExpandMemory(0, FileSize, 1);
      if ( compress(v13, &FileSize, v12, v11) )
      {
        efree(v13);
        ptr = 0;
      }
      else
      {
        v14 = ExpandMemory(v13, FileSize, 1);
        Filename = (const char *)FileSize;
        ptr = v14;
      }
      *OutSize = (int)&Filename[bytes];
      v15 = emalloc((DWORD)&Filename[bytes]);
      if ( Buffer )
        qmemcpy(v15, Buffer, bytes);
      qmemcpy((char *)v15 + bytes, ptr, (unsigned int)Filename);
      efree(ptr);
    }
    else
    {
      *OutSize = v11 + bytes;
      v15 = emalloc(v11 + bytes);
      if ( Buffer )
        qmemcpy(v15, Buffer, bytes);
      qmemcpy((char *)v15 + bytes, v12, v11);
    }
    efree(v12);
    result = (char *)v15;
  }
  else
  {
    if ( CRC_32 )
      *CRC_32 = 0;
    if ( FileSize )
      *(_DWORD *)FileSize = 0;
    *OutSize = bytes;
    result = (char *)emalloc(bytes);
    if ( Buffer )
      qmemcpy(result, Buffer, bytes);
  }
  return result;
}
// 41CE30: using guessed type int __stdcall compress(_DWORD, _DWORD, _DWORD, _DWORD);
// 41F1B0: using guessed type _DWORD __cdecl _filelength(_DWORD);

//----- (0041CEA0) --------------------------------------------------------
int __cdecl setRNGSeed(int SeedRNG)
{
  int result; // eax

  result = SeedRNG;
  RNGSeed = SeedRNG;
  return result;
}
// 42E458: using guessed type int RNGSeed;

//----- (0041E940) --------------------------------------------------------
int __cdecl RunCommandPrompt(char *argumentsPointer)
{
  int result; // eax
  char *v2; // eax
  int v3[4]; // [esp+0h] [ebp-10h] BYREF

  result = (int)getenv(MEMORY[0x429050]);
  v3[0] = result;
  if ( argumentsPointer )
  {
    v3[1] = (int)&loc_42904B + 1;
    v3[2] = (int)argumentsPointer;
    v3[3] = 0;
    if ( !result
      || (result = _spawnve(0, (char *)result, (int)v3, 0), result == -1) && (dword_4D8B38 == 2 || dword_4D8B38 == 13) )
    {
      v2 = MEMORY[0x429040];
      if ( (dword_4D8B44 & 0x8000) == 0 )
        v2 = "cmd.exe";
      v3[0] = (int)v2;
      result = _spawnvpe(0, v2, (int)v3, 0);
    }
  }
  else if ( result )
  {
    result = _access((LPCSTR)result, 0) == 0;
  }
  return result;
}
// 4D8B38: using guessed type int dword_4D8B38;
// 4D8B44: using guessed type int dword_4D8B44;

//----- (004210C9) --------------------------------------------------------
int __usercall sub_4210C9@<eax>(int a1@<ebp>)
{
  return ExFilterRethrow(*(struct _EXCEPTION_POINTERS **)(a1 - 20));
}

//----- (004210D6) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __usercall sub_4210D6@<eax>(int a1@<ebp>)
{
  *(_DWORD *)(a1 - 44) = 0;
  _local_unwind2(a1 - 16, -1);
  return 0;
}
// 4210FD: positive sp value C has been found
// 4210D6: could not find valid save-restore pair for ebx
// 4210D6: could not find valid save-restore pair for edi
// 4210D6: could not find valid save-restore pair for esi
// 41DEC2: using guessed type _DWORD __cdecl _local_unwind2(_DWORD, _DWORD);

//----- (00421101) --------------------------------------------------------
int __cdecl sub_421101()
{
  return sub_42110A();
}
// 42110A: using guessed type int sub_42110A(void);

//----- (004214B0) --------------------------------------------------------
void __usercall __noreturn sub_4214B0(int a2@<ebx>, int a3@<edi>, int a4@<esi>)
{
  int v4; // [esp-Ch] [ebp-24h] BYREF
  int v5; // [esp-8h] [ebp-20h]
  int v6; // [esp-4h] [ebp-1Ch]
  int *v7; // [esp+0h] [ebp-18h]
  struct _EXCEPTION_REGISTRATION_RECORD *v8; // [esp+8h] [ebp-10h]
  int (__cdecl *v9)(int, PVOID, int); // [esp+Ch] [ebp-Ch]
  int *v10; // [esp+10h] [ebp-8h]
  int v11; // [esp+14h] [ebp-4h]

  v10 = sub_429128;
  v9 = unknown_libname_6;
  v8 = NtCurrentTeb()->NtTib.ExceptionList;
  v6 = a2;
  v5 = a4;
  v4 = a3;
  v7 = &v4;
  v11 = 0;
  if ( dword_4D8BDC )
  {
    v11 = 1;
    dword_4D8BDC(v4, v5, v6, v7);
    v11 = 0;
  }
  v11 = -1;
  j__abort();
}
// 429128: using guessed type int sub_429128[2];
// 4D8BDC: using guessed type int (__cdecl *dword_4D8BDC)(_DWORD, _DWORD, _DWORD, _DWORD);

//----- (00421540) --------------------------------------------------------
void __usercall __noreturn sub_421540(int a1@<ebx>, int a2@<edi>, int a3@<esi>)
{
  int v3; // [esp-Ch] [ebp-24h] BYREF
  int v4; // [esp-8h] [ebp-20h]
  int v5; // [esp-4h] [ebp-1Ch]
  int *v6; // [esp+0h] [ebp-18h]
  struct _EXCEPTION_REGISTRATION_RECORD *v7; // [esp+8h] [ebp-10h]
  int (__cdecl *v8)(int, PVOID, int); // [esp+Ch] [ebp-Ch]
  char *v9; // [esp+10h] [ebp-8h]
  int v10; // [esp+14h] [ebp-4h]

  v9 = &byte_429140;
  v8 = unknown_libname_6;
  v7 = NtCurrentTeb()->NtTib.ExceptionList;
  v5 = a1;
  v4 = a3;
  v3 = a2;
  v6 = &v3;
  v10 = 0;
  if ( off_42E734 )
  {
    v10 = 1;
    off_42E734(v3, v4, v5, v6);
  }
  v10 = -1;
  sub_4215AE(v3, v4, v5, v6);
}
// 4215AE: using guessed type int __cdecl sub_4215AE(_DWORD, _DWORD, _DWORD, _DWORD);
// 429140: using guessed type char byte_429140;
// 42E734: using guessed type int (__cdecl *off_42E734)(_DWORD, _DWORD, _DWORD, _DWORD);

//----- (00423390) --------------------------------------------------------
BOOL __cdecl DateFunction(int a1)
{
  BOOL result; // eax
  int v2; // eax
  int v3; // ecx
  int v4; // eax
  int v5; // [esp-28h] [ebp-30h]
  int v6; // [esp-24h] [ebp-2Ch]
  int v7; // [esp-20h] [ebp-28h]
  int v8; // [esp-1Ch] [ebp-24h]
  int v9; // [esp-18h] [ebp-20h]
  int v10; // [esp-14h] [ebp-1Ch]

  if ( !dword_43099C )
    return 0;
  v2 = *(_DWORD *)(a1 + 20);
  if ( v2 != dword_430A30 || v2 != dword_430A40 )
  {
    if ( dword_4D8C18 )
    {
      if ( TimeZoneInformation.DaylightDate.wYear )
      {
        v10 = TimeZoneInformation.DaylightDate.wDay;
        v9 = 0;
        v8 = 0;
        v7 = TimeZoneInformation.DaylightDate.wMonth;
        v6 = *(_DWORD *)(a1 + 20);
        v5 = 0;
      }
      else
      {
        v10 = 0;
        v9 = TimeZoneInformation.DaylightDate.wDayOfWeek;
        v8 = TimeZoneInformation.DaylightDate.wDay;
        v7 = TimeZoneInformation.DaylightDate.wMonth;
        v6 = *(_DWORD *)(a1 + 20);
        v5 = 1;
      }
      cvtdate(
        1,
        v5,
        v6,
        v7,
        v8,
        v9,
        v10,
        TimeZoneInformation.DaylightDate.wHour,
        TimeZoneInformation.DaylightDate.wMinute,
        TimeZoneInformation.DaylightDate.wSecond,
        TimeZoneInformation.DaylightDate.wMilliseconds);
      if ( TimeZoneInformation.StandardDate.wYear )
        cvtdate(
          0,
          0,
          *(_DWORD *)(a1 + 20),
          TimeZoneInformation.StandardDate.wMonth,
          0,
          0,
          TimeZoneInformation.StandardDate.wDay,
          TimeZoneInformation.StandardDate.wHour,
          TimeZoneInformation.StandardDate.wMinute,
          TimeZoneInformation.StandardDate.wSecond,
          TimeZoneInformation.StandardDate.wMilliseconds);
      else
        cvtdate(
          0,
          1,
          *(_DWORD *)(a1 + 20),
          TimeZoneInformation.StandardDate.wMonth,
          TimeZoneInformation.StandardDate.wDay,
          TimeZoneInformation.StandardDate.wDayOfWeek,
          0,
          TimeZoneInformation.StandardDate.wHour,
          TimeZoneInformation.StandardDate.wMinute,
          TimeZoneInformation.StandardDate.wSecond,
          TimeZoneInformation.StandardDate.wMilliseconds);
    }
    else
    {
      cvtdate(1, 1, v2, 4, 1, 0, 0, 2, 0, 0, 0);
      cvtdate(0, 1, *(_DWORD *)(a1 + 20), 10, 5, 0, 0, 2, 0, 0, 0);
    }
  }
  v3 = *(_DWORD *)(a1 + 28);
  if ( dword_430A34 < dword_430A44 )
  {
    if ( v3 >= dword_430A34 && v3 <= dword_430A44 )
    {
      if ( v3 > dword_430A34 && v3 < dword_430A44 )
        return 1;
      goto LABEL_25;
    }
    return 0;
  }
  if ( v3 < dword_430A44 || v3 > dword_430A34 )
    return 1;
  if ( v3 > dword_430A44 && v3 < dword_430A34 )
    return 0;
LABEL_25:
  v4 = 1000 * (*(_DWORD *)a1 + 60 * (*(_DWORD *)(a1 + 4) + 60 * *(_DWORD *)(a1 + 8)));
  if ( v3 == dword_430A34 )
    result = v4 >= dword_430A38;
  else
    result = v4 < dword_430A48;
  return result;
}
// 423600: using guessed type _DWORD __cdecl cvtdate(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 43099C: using guessed type int dword_43099C;
// 430A30: using guessed type int dword_430A30;
// 430A34: using guessed type int dword_430A34;
// 430A38: using guessed type int dword_430A38;
// 430A40: using guessed type int dword_430A40;
// 430A44: using guessed type int dword_430A44;
// 430A48: using guessed type int dword_430A48;
// 4D8C18: using guessed type int dword_4D8C18;

//----- (00426670) --------------------------------------------------------
int __cdecl sub_426670(int a1, int a2)
{
  return _ld12cvt(a1, a2, dword_430E60);
}
// 4264A0: using guessed type _DWORD __cdecl _ld12cvt(_DWORD, _DWORD, _DWORD);
// 430E60: using guessed type int dword_430E60[6];

//----- (00426690) --------------------------------------------------------
int __cdecl sub_426690(int a1, int a2)
{
  return _ld12cvt(a1, a2, dword_430E78);
}
// 4264A0: using guessed type _DWORD __cdecl _ld12cvt(_DWORD, _DWORD, _DWORD);
// 430E78: using guessed type int dword_430E78[6];

//----- (004266B0) --------------------------------------------------------
int __cdecl _atodbl(_CRT_DOUBLE *Result, char *String)
{
  char v3[12]; // [esp+0h] [ebp-Ch] BYREF

  __strgtold12(v3, &String, String, 0, 0, 0, 0);
  return sub_426670((int)v3, (int)Result);
}
// 427370: using guessed type _DWORD __cdecl __strgtold12(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (004266F0) --------------------------------------------------------
int __cdecl sub_4266F0(int a1, int a2)
{
  char v3[12]; // [esp+0h] [ebp-Ch] BYREF

  __strgtold12(v3, &a2, a2, 0, 0, 0, 0);
  return sub_426690((int)v3, a1);
}
// 427370: using guessed type _DWORD __cdecl __strgtold12(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (004283A0) --------------------------------------------------------
int __cdecl getch()
{
  int result; // eax
  int v1; // esi
  unsigned __int8 *v2; // eax
  DWORD NumberOfEventsRead; // [esp+10h] [ebp-1Ch] BYREF
  DWORD dwMode; // [esp+14h] [ebp-18h] BYREF
  struct _INPUT_RECORD Buffer; // [esp+18h] [ebp-14h] BYREF

  if ( dword_431490 == -1 )
  {
    result = (int)hConsoleHandle;
    if ( hConsoleHandle != (HANDLE)-1 )
    {
      if ( hConsoleHandle == (HANDLE)-2 )
      {
        __initconin();
        result = (int)hConsoleHandle;
      }
      GetConsoleMode((HANDLE)result, &dwMode);
      SetConsoleMode(hConsoleHandle, 0);
      if ( ReadConsoleInputA(hConsoleHandle, &Buffer, 1u, &NumberOfEventsRead) )
      {
        while ( NumberOfEventsRead )
        {
          if ( Buffer.EventType == 1 && Buffer.Event.KeyEvent.bKeyDown )
          {
            v1 = (unsigned __int8)Buffer.Event.KeyEvent.uChar.AsciiChar;
            if ( Buffer.Event.KeyEvent.uChar.AsciiChar )
              goto LABEL_14;
            v2 = (unsigned __int8 *)_getextendedkeycode(&Buffer.Event);
            if ( v2 )
            {
              v1 = *v2;
              dword_431490 = v2[1];
              goto LABEL_14;
            }
          }
          if ( !ReadConsoleInputA(hConsoleHandle, &Buffer, 1u, &NumberOfEventsRead) )
            break;
        }
      }
      v1 = -1;
LABEL_14:
      SetConsoleMode(hConsoleHandle, dwMode);
      result = v1;
    }
  }
  else
  {
    result = (unsigned __int8)dword_431490;
    dword_431490 = -1;
  }
  return result;
}
// 4285A0: using guessed type _DWORD __cdecl _getextendedkeycode(_DWORD);
// 428720: using guessed type int __initconin(void);
// 431490: using guessed type int dword_431490;

//----- (004284B0) --------------------------------------------------------
signed int __cdecl console_input_wrapper()
{
  HANDLE v1; // eax
  int v2; // eax
  void *v3; // esp
  int *v4; // edi
  DWORD v5; // eax
  int *i; // esi
  int v7; // [esp+0h] [ebp-10h] BYREF
  int v8; // [esp+4h] [ebp-Ch] BYREF
  DWORD nLength; // [esp+8h] [ebp-8h] BYREF
  DWORD NumberOfEventsRead; // [esp+Ch] [ebp-4h] BYREF

  if ( dword_431490 != -1 )
    return 1;
  v1 = hConsoleHandle;
  if ( hConsoleHandle == (HANDLE)-2 )
  {
    __initconin();
    v1 = hConsoleHandle;
  }
  if ( v1 != (HANDLE)-1 )
  {
    if ( GetNumberOfConsoleInputEvents(v1, &nLength) )
    {
      if ( nLength )
      {
        v2 = 20 * nLength + 3;
        LOBYTE(v2) = v2 & 0xFC;
        v3 = alloca(v2);
        v4 = &v7;
        if ( &v7 )
        {
          if ( PeekConsoleInputA(hConsoleHandle, (PINPUT_RECORD)&v7, nLength, &NumberOfEventsRead) )
          {
            v5 = NumberOfEventsRead;
            if ( NumberOfEventsRead )
            {
              if ( NumberOfEventsRead <= nLength )
              {
                for ( i = &v8; ; i += 5 )
                {
                  if ( *(_WORD *)v4 == 1 && *i )
                  {
                    if ( *((_BYTE *)i + 10) || _getextendedkeycode(i) )
                      return 1;
                    v5 = NumberOfEventsRead;
                  }
                  --v5;
                  v4 += 5;
                  NumberOfEventsRead = v5;
                  if ( !v5 )
                    return 0;
                }
              }
            }
          }
        }
      }
    }
  }
  return 0;
}
// 428545: conditional instruction was optimized away because of '%NumberOfEventsRead.4!=0'
// 4285A0: using guessed type _DWORD __cdecl _getextendedkeycode(_DWORD);
// 428720: using guessed type int __initconin(void);
// 431490: using guessed type int dword_431490;

// nfuncs=447 queued=188 decompiled=188 lumina nreq=0 worse=0 better=0
// ALL OK, 188 function(s) have been successfully decompiled
